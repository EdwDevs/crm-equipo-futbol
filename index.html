<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>‚≠ê IMPERIO ANDINO - Champions Edition</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  
  :root {
    /* Champions League Colors - Navy Blue Base con Rainbow Accents */
    --champions-navy: #001e47;
    --champions-darkblue: #002b5c;
    --champions-blue: #0066cc;
    --champions-cyan: #00bfff;
    --champions-purple: #8b00ff;
    --champions-pink: #ff006e;
    --champions-orange: #ff6b00;
    --champions-yellow: #ffd700;
    --champions-green: #00ff88;
    
    --primary: var(--champions-navy);
    --primary-dark: var(--champions-darkblue);
    --secondary: var(--champions-blue);
    --success: #28a745;
    --danger: #dc3545;
    --warning: #ffc107;
    --info: #17a2b8;
    --light: #f8f9fa;
    --dark: #0a1628;
    --border: #ddd;
    --shadow: rgba(0, 30, 71, 0.3);
    --container-width: 500px;
    --padding: 10px;
    --font-base: 14px;
    --header-size: 24px;
  }
  
  @media (min-width: 768px) {
    :root {
      --container-width: 1100px;
      --padding: 20px;
      --font-base: 15px;
      --header-size: 28px;
    }
  }
  
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, var(--champions-navy) 0%, var(--champions-darkblue) 50%, var(--champions-blue) 100%);
    min-height: 100vh;
    padding: var(--padding);
    color: var(--dark);
    font-size: var(--font-base);
    line-height: 1.6;
    position: relative;
    overflow-x: hidden;
  }
  
  /* Efecto de estrellas animadas (Champions League starball inspired) */
  body::before {
    content: "";
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-image: 
      radial-gradient(2px 2px at 20% 30%, rgba(255, 215, 0, 0.4), transparent),
      radial-gradient(2px 2px at 60% 70%, rgba(0, 191, 255, 0.4), transparent),
      radial-gradient(1px 1px at 50% 50%, rgba(139, 0, 255, 0.3), transparent),
      radial-gradient(1px 1px at 80% 10%, rgba(255, 0, 110, 0.3), transparent),
      radial-gradient(2px 2px at 90% 60%, rgba(0, 255, 136, 0.3), transparent),
      radial-gradient(1px 1px at 33% 80%, rgba(255, 107, 0, 0.3), transparent);
    background-size: 200% 200%;
    animation: starfield 20s ease-in-out infinite;
    pointer-events: none;
    z-index: 0;
  }
  
  @keyframes starfield {
    0%, 100% { background-position: 0% 0%; }
    50% { background-position: 100% 100%; }
  }
  
  .container {
    max-width: var(--container-width);
    margin: 0 auto;
    background: white;
    border-radius: 15px;
    box-shadow: 0 10px 40px rgba(0, 30, 71, 0.5);
    overflow: hidden;
    display: flex;
    flex-direction: column;
    max-height: 95vh;
    position: relative;
    z-index: 1;
    border: 3px solid transparent;
    background-clip: padding-box;
  }
  
  /* Efecto de borde multicolor (prism effect) */
  .container::before {
    content: "";
    position: absolute;
    top: -3px;
    left: -3px;
    right: -3px;
    bottom: -3px;
    background: linear-gradient(45deg, 
      var(--champions-cyan), 
      var(--champions-purple), 
      var(--champions-pink), 
      var(--champions-orange), 
      var(--champions-yellow), 
      var(--champions-green),
      var(--champions-cyan)
    );
    background-size: 300% 300%;
    border-radius: 15px;
    z-index: -1;
    animation: prismaticGlow 8s ease infinite;
  }
  
  @keyframes prismaticGlow {
    0%, 100% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
  }
  
  /* Efecto de borde multicolor (prism effect) */
  .container::before {
    content: "";
    position: absolute;
    top: -3px;
    left: -3px;
    right: -3px;
    bottom: -3px;
    background: linear-gradient(45deg, 
      var(--champions-cyan), 
      var(--champions-purple), 
      var(--champions-pink), 
      var(--champions-orange), 
      var(--champions-yellow), 
      var(--champions-green),
      var(--champions-cyan)
    );
    background-size: 300% 300%;
    border-radius: 15px;
    z-index: -1;
    animation: prismaticGlow 8s ease infinite;
  }
  
  @keyframes prismaticGlow {
    0%, 100% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
  }
  
  .header {
    background: linear-gradient(135deg, var(--champions-navy) 0%, var(--champions-blue) 100%);
    color: white;
    padding: clamp(20px, 4vw, 30px);
    text-align: center;
    flex-shrink: 0;
    position: relative;
    overflow: hidden;
  }
  
  /* Efecto de luz refractada en el header */
  .header::before {
    content: "";
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(45deg, 
      transparent 30%, 
      rgba(0, 191, 255, 0.1) 40%, 
      rgba(139, 0, 255, 0.1) 45%, 
      rgba(255, 0, 110, 0.1) 50%, 
      transparent 60%
    );
    animation: refraction 10s linear infinite;
  }
  
  @keyframes refraction {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  .header h1 { 
    font-size: clamp(24px, 6vw, 36px);
    margin-bottom: 8px;
    font-weight: 900;
    letter-spacing: 2px;
    text-transform: uppercase;
    position: relative;
    z-index: 1;
    text-shadow: 
      2px 2px 0 rgba(0, 191, 255, 0.5),
      -2px -2px 0 rgba(255, 0, 110, 0.5);
  }
  
  .header .team-name {
    font-size: clamp(20px, 5vw, 28px);
    font-weight: 700;
    margin-top: 5px;
    background: linear-gradient(90deg, 
      var(--champions-cyan), 
      var(--champions-yellow), 
      var(--champions-pink),
      var(--champions-cyan)
    );
    background-size: 200% auto;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    animation: gradientShift 5s ease infinite;
  }
  
  @keyframes gradientShift {
    0%, 100% { background-position: 0% center; }
    50% { background-position: 100% center; }
  }
  
  .header p {
    font-size: calc(var(--font-base) * 0.95);
    opacity: 0.95;
    position: relative;
    z-index: 1;
    margin-top: 8px;
  }
  
  /* Estrella Champions League decorativa */
  .champions-star {
    position: absolute;
    width: 30px;
    height: 30px;
    top: 15px;
    right: 15px;
    opacity: 0.9;
    font-size: 30px;
    animation: twinkle 2s ease-in-out infinite;
    z-index: 2;
  }
  
  @keyframes twinkle {
    0%, 100% { opacity: 1; transform: scale(1) rotate(0deg); }
    50% { opacity: 0.6; transform: scale(1.2) rotate(180deg); }
  }
  
  .nav-tabs {
    display: flex;
    overflow-x: auto;
    background: linear-gradient(to right, var(--champions-navy), var(--champions-darkblue));
    border-bottom: 3px solid var(--champions-blue);
    flex-shrink: 0;
    scrollbar-width: thin;
    scrollbar-color: var(--champions-blue) var(--champions-navy);
  }
  
  .nav-tabs::-webkit-scrollbar { height: 6px; }
  .nav-tabs::-webkit-scrollbar-track { background: var(--champions-navy); }
  .nav-tabs::-webkit-scrollbar-thumb { background: var(--champions-blue); border-radius: 3px; }
  
  .nav-tabs button {
    flex: 0 0 auto;
    min-width: 100px;
    padding: clamp(10px, 2vw, 14px) clamp(12px, 3vw, 16px);
    border: none;
    background: transparent;
    cursor: pointer;
    font-size: calc(var(--font-base) * 0.95);
    font-weight: 600;
    color: rgba(255, 255, 255, 0.7);
    transition: all 0.3s ease;
    white-space: nowrap;
    position: relative;
  }
  
  .nav-tabs button::after {
    content: "";
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 3px;
    background: linear-gradient(90deg, 
      var(--champions-cyan), 
      var(--champions-purple), 
      var(--champions-pink)
    );
    transform: scaleX(0);
    transition: transform 0.3s ease;
  }
  
  .nav-tabs button.active {
    color: white;
    background: rgba(0, 102, 204, 0.3);
  }
  
  .nav-tabs button.active::after {
    transform: scaleX(1);
  }
  
  .nav-tabs button:hover { 
    background: rgba(0, 102, 204, 0.2);
    color: white;
  }
  
  .content {
    padding: clamp(12px, 3vw, 20px);
    overflow-y: auto;
    flex: 1;
    scrollbar-width: thin;
    scrollbar-color: var(--primary) var(--light);
  }
  
  .content::-webkit-scrollbar { width: 8px; }
  .content::-webkit-scrollbar-track { background: var(--light); }
  .content::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 4px; }
  
  .tournament-selector {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: clamp(8px, 2vw, 12px);
    margin-bottom: clamp(15px, 3vw, 25px);
  }
  
  .tournament-selector button {
    padding: clamp(12px, 2vw, 16px);
    border: 2px solid var(--champions-blue);
    background: white;
    color: var(--champions-navy);
    border-radius: 10px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: var(--font-base);
    position: relative;
    overflow: hidden;
  }
  
  .tournament-selector button::before {
    content: "";
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, 
      transparent, 
      rgba(0, 191, 255, 0.3), 
      transparent
    );
    transition: left 0.5s ease;
  }
  
  .tournament-selector button:hover::before {
    left: 100%;
  }
  
  .tournament-selector button.active {
    background: linear-gradient(135deg, var(--champions-navy), var(--champions-blue));
    color: white;
    transform: scale(1.05);
    box-shadow: 0 5px 15px rgba(0, 102, 204, 0.4);
  }
  
  .form-group {
    margin-bottom: clamp(12px, 2.5vw, 18px);
  }
  
  .form-group label {
    display: block;
    margin-bottom: 6px;
    font-weight: 600;
    color: var(--champions-navy);
    font-size: calc(var(--font-base) * 0.95);
  }
  
  .form-group input, 
  .form-group select {
    width: 100%;
    padding: clamp(10px, 2vw, 12px);
    border: 2px solid var(--border);
    border-radius: 8px;
    font-size: var(--font-base);
    transition: all 0.3s ease;
  }
  
  .form-group input:focus, 
  .form-group select:focus {
    outline: none;
    border-color: var(--champions-blue);
    box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
  }
  
  .form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: clamp(8px, 2vw, 12px);
  }
  
  @media (min-width: 768px) {
    .form-grid { grid-template-columns: repeat(2, 1fr); }
  }
  
  .btn {
    width: 100%;
    padding: clamp(12px, 2vw, 16px);
    border: none;
    border-radius: 10px;
    font-weight: bold;
    cursor: pointer;
    font-size: var(--font-base);
    transition: all 0.3s ease;
    margin-top: clamp(8px, 2vw, 12px);
    position: relative;
    overflow: hidden;
    text-transform: uppercase;
    letter-spacing: 1px;
  }
  
  .btn::before {
    content: "";
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.3);
    transform: translate(-50%, -50%);
    transition: width 0.6s ease, height 0.6s ease;
  }
  
  .btn:hover::before {
    width: 300%;
    height: 300%;
  }
  
  .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px var(--shadow);
  }
  
  .btn:active { transform: translateY(0); }
  
  .btn-primary { 
    background: linear-gradient(135deg, var(--champions-navy), var(--champions-blue));
    color: white; 
  }
  
  .btn-success { 
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white; 
  }
  
  .btn-danger { 
    background: linear-gradient(135deg, #dc3545, #ff006e);
    color: white; 
  }
  
  .btn-warning { 
    background: linear-gradient(135deg, #ffc107, #ff6b00);
    color: white;
  }
  
  .btn-info { 
    background: linear-gradient(135deg, #17a2b8, #00bfff);
    color: white; 
  }
  
  .btn-sm {
    padding: 6px 12px;
    font-size: calc(var(--font-base) * 0.85);
    width: auto;
    margin: 0;
  }
  
  .table-container {
    overflow-x: auto;
    margin-top: 20px;
    border-radius: 10px;
    border: 2px solid var(--champions-blue);
    box-shadow: 0 5px 15px rgba(0, 30, 71, 0.2);
  }
  
  .table {
    width: 100%;
    border-collapse: collapse;
    background: white;
  }
  
  .table thead {
    background: linear-gradient(135deg, var(--champions-navy) 0%, var(--champions-blue) 100%);
    color: white;
  }
  
  .table th {
    padding: 14px 12px;
    text-align: left;
    font-weight: 700;
    font-size: calc(var(--font-base) * 0.95);
    white-space: nowrap;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .table td {
    padding: 12px;
    border-bottom: 1px solid var(--border);
    font-size: calc(var(--font-base) * 0.9);
  }
  
  .table tbody tr:hover {
    background: linear-gradient(to right, 
      rgba(0, 191, 255, 0.05), 
      rgba(139, 0, 255, 0.05)
    );
  }
  
  .table tbody tr:last-child td {
    border-bottom: none;
  }
  
  .table .actions {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
  }
  
  .table .progress-bar {
    height: 10px;
    background: #e9ecef;
    border-radius: 5px;
    overflow: hidden;
    margin-top: 4px;
  }
  
  .table .progress-fill {
    height: 100%;
    transition: width 0.3s ease;
    background: linear-gradient(90deg, 
      var(--champions-cyan), 
      var(--champions-blue), 
      var(--champions-purple)
    );
  }
  
  .badge {
    display: inline-block;
    padding: 5px 10px;
    border-radius: 6px;
    font-size: calc(var(--font-base) * 0.8);
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .badge-success { 
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white; 
  }
  
  .badge-warning { 
    background: linear-gradient(135deg, #ffc107, #ff6b00);
    color: white; 
  }
  
  .badge-danger { 
    background: linear-gradient(135deg, #dc3545, #ff006e);
    color: white; 
  }
  
  .badge-info { 
    background: linear-gradient(135deg, #17a2b8, #00bfff);
    color: white; 
  }
  
  .filter-bar {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    flex-wrap: wrap;
    align-items: center;
  }
  
  .filter-bar input {
    flex: 1;
    min-width: 200px;
    padding: 10px 15px;
    border: 2px solid var(--champions-blue);
    border-radius: 8px;
    font-size: var(--font-base);
  }
  
  .filter-bar select {
    padding: 10px 15px;
    border: 2px solid var(--champions-blue);
    border-radius: 8px;
    font-size: var(--font-base);
  }
  
  .modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 30, 71, 0.8);
    backdrop-filter: blur(5px);
    animation: fadeIn 0.3s ease;
  }
  
  .modal.active { display: flex; align-items: center; justify-content: center; }
  
  .modal-content {
    background: white;
    padding: 25px;
    border-radius: 15px;
    max-width: 800px;
    width: 90%;
    max-height: 85vh;
    overflow-y: auto;
    animation: slideUp 0.3s ease;
    border: 3px solid var(--champions-blue);
    box-shadow: 0 10px 40px rgba(0, 30, 71, 0.5);
  }
  
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 3px solid var(--champions-blue);
  }
  
  .modal-header h3 {
    color: var(--champions-navy);
    font-size: calc(var(--font-base) * 1.3);
    font-weight: 700;
  }
  
  .modal-close {
    background: none;
    border: none;
    font-size: 32px;
    cursor: pointer;
    color: #999;
    transition: color 0.3s ease;
    font-weight: bold;
  }
  
  .modal-close:hover { color: var(--danger); }
  
  .payment-history {
    max-height: 250px;
    overflow-y: auto;
    border: 2px solid var(--champions-blue);
    border-radius: 8px;
    padding: 10px;
    margin-top: 10px;
  }
  
  .payment-item {
    display: flex;
    justify-content: space-between;
    padding: 10px;
    margin-bottom: 8px;
    background: var(--light);
    border-radius: 6px;
    align-items: center;
    border-left: 3px solid var(--champions-blue);
  }
  
  .payment-item:last-child { margin-bottom: 0; }
  
  .payment-item-date {
    font-size: calc(var(--font-base) * 0.85);
    color: #666;
    font-weight: 600;
  }
  
  .payment-item-amount {
    font-weight: 700;
    color: var(--success);
    font-size: calc(var(--font-base) * 1.1);
  }
  
  .payment-item-actions {
    display: flex;
    gap: 6px;
  }
  
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: clamp(8px, 2vw, 12px);
    margin-bottom: clamp(15px, 3vw, 25px);
  }
  
  @media (min-width: 768px) {
    .stats-grid { grid-template-columns: repeat(3, 1fr); }
  }
  
  .stat-card {
    background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    color: white;
    padding: clamp(12px, 3vw, 18px);
    border-radius: 10px;
    text-align: center;
    transition: all 0.3s ease;
  }
  
  .stat-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
  }
  
  .stat-card h3 {
    font-size: clamp(24px, 5vw, 32px);
    margin-bottom: 4px;
    font-weight: 700;
  }
  
  .stat-card p {
    font-size: calc(var(--font-base) * 0.85);
    opacity: 0.95;
  }
  
  .match-card {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 12px;
    padding: clamp(15px, 3vw, 20px);
    margin-bottom: clamp(10px, 2vw, 15px);
    border-left: 4px solid var(--champions-blue);
    box-shadow: 0 3px 10px rgba(0, 30, 71, 0.1);
  }
  
  .match-card h4 {
    color: var(--champions-navy);
    margin-bottom: clamp(10px, 2vw, 15px);
    font-size: calc(var(--font-base) * 1.1);
    font-weight: 700;
  }
  
  .alert {
    padding: clamp(12px, 2vw, 16px);
    border-radius: 10px;
    margin-bottom: clamp(12px, 2.5vw, 18px);
    font-size: var(--font-base);
    line-height: 1.6;
    border-left: 4px solid;
  }
  
  .alert-info { 
    background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
    color: #0c5460; 
    border-color: var(--champions-cyan);
  }
  
  .alert-warning { 
    background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
    color: #856404; 
    border-color: var(--champions-yellow);
  }
  
  .alert-success { 
    background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
    color: #155724; 
    border-color: var(--success);
  }
  
  .phase-selector {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
    gap: clamp(6px, 1.5vw, 10px);
    margin-bottom: clamp(12px, 2.5vw, 18px);
  }
  
  .phase-btn {
    padding: clamp(10px, 1.5vw, 14px);
    border: 2px solid var(--champions-blue);
    background: white;
    color: var(--champions-navy);
    border-radius: 8px;
    cursor: pointer;
    font-size: calc(var(--font-base) * 0.9);
    font-weight: bold;
    transition: all 0.3s ease;
  }
  
  .phase-btn.active { 
    background: linear-gradient(135deg, var(--champions-navy), var(--champions-blue));
    color: white; 
  }
  
  .phase-btn:hover { 
    transform: scale(1.05);
    box-shadow: 0 3px 10px rgba(0, 102, 204, 0.3);
  }
  
  .checkbox-group {
    max-height: 250px;
    overflow-y: auto;
    border: 2px solid var(--border);
    border-radius: 8px;
    padding: clamp(8px, 2vw, 12px);
    margin-bottom: clamp(12px, 2.5vw, 18px);
    scrollbar-width: thin;
    scrollbar-color: var(--primary) var(--light);
  }
  
  .checkbox-group::-webkit-scrollbar { width: 6px; }
  .checkbox-group::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 3px; }
  
  .checkbox-item-payment {
    display: grid;
    grid-template-columns: 1fr auto;
    align-items: center;
    padding: clamp(8px, 1.5vw, 10px);
    margin-bottom: 6px;
    background: white;
    border-radius: 6px;
    transition: all 0.2s ease;
    gap: 10px;
  }
  
  .checkbox-item-payment:hover { background: var(--light); }
  
  .checkbox-item-payment .player-name-wrapper {
    display: flex;
    align-items: center;
  }
  
  .checkbox-item-payment .player-name-wrapper input[type="checkbox"] {
    margin-right: 10px;
    width: 20px;
    height: 20px;
    cursor: pointer;
  }
  
  .checkbox-item-payment .player-name-wrapper label {
    margin: 0;
    font-weight: 500;
    cursor: pointer;
    font-size: var(--font-base);
  }
  
  .checkbox-item-payment .payment-checkbox-wrapper {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 4px 10px;
    background: #e9ecef;
    border-radius: 6px;
    white-space: nowrap;
  }
  
  .checkbox-item-payment .payment-checkbox-wrapper input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
  }
  
  .checkbox-item-payment .payment-checkbox-wrapper label {
    margin: 0;
    font-size: calc(var(--font-base) * 0.9);
    font-weight: 600;
    cursor: pointer;
    color: #495057;
  }
  
  .checkbox-item-payment.paid {
    background: #d4edda;
    border-left: 3px solid var(--success);
  }
  
  .checkbox-item-payment.not-paid {
    background: #fff3cd;
    border-left: 3px solid var(--warning);
  }
  
  .summary {
    background: #e9ecef;
    padding: clamp(12px, 3vw, 18px);
    border-radius: 8px;
    margin-top: clamp(12px, 2.5vw, 18px);
  }
  
  .summary-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: clamp(6px, 1.5vw, 10px);
    font-size: var(--font-base);
    gap: 10px;
  }
  
  .summary-row:last-child { margin-bottom: 0; }
  .summary-row strong { color: var(--primary); font-weight: 700; }
  
  .summary-extended {
    background: linear-gradient(135deg, #e9ecef 0%, #f8f9fa 100%);
    padding: clamp(12px, 3vw, 18px);
    border-radius: 8px;
    margin-top: clamp(12px, 2.5vw, 18px);
    border: 2px solid var(--border);
  }
  
  .payment-status-section {
    margin-top: 15px;
    padding-top: 15px;
    border-top: 2px solid var(--border);
  }
  
  .payment-status-title {
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 10px;
    font-size: calc(var(--font-base) * 1.05);
  }
  
  .adjustment-card {
    background: #fff3cd;
    border: 2px solid var(--warning);
    border-radius: 10px;
    padding: clamp(12px, 3vw, 18px);
    margin-bottom: clamp(15px, 3vw, 25px);
  }
  
  .adjustment-card h4 {
    color: #856404;
    margin-bottom: clamp(12px, 2.5vw, 18px);
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: calc(var(--font-base) * 1.1);
  }
  
  .hidden { display: none !important; }
  
  .section-divider {
    border-top: 2px solid var(--border);
    margin: clamp(20px, 4vw, 30px) 0;
    padding-top: clamp(20px, 4vw, 30px);
  }
  
  h3.section-title {
    margin-top: clamp(20px, 4vw, 30px);
    margin-bottom: clamp(12px, 2.5vw, 18px);
    color: var(--primary);
    font-size: calc(var(--font-base) * 1.2);
    font-weight: 700;
  }
  
  h3.section-title:first-child { margin-top: 0; }
  
  .payment-detail {
    margin-top: 10px;
    padding: 10px;
    background: white;
    border-radius: 6px;
    border: 1px solid var(--border);
  }
  
  .payment-detail-title {
    font-weight: 600;
    color: var(--primary);
    margin-bottom: 8px;
    font-size: calc(var(--font-base) * 0.95);
  }
  
  .payment-list { display: grid; gap: 5px; }
  
  .payment-list-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 5px;
    font-size: calc(var(--font-base) * 0.85);
  }
  
  .payment-list-item .player-name { flex: 1; }
  
  .payment-list-item .payment-badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: calc(var(--font-base) * 0.75);
    font-weight: 600;
  }
  
  .payment-badge.paid { background: var(--success); color: white; }
  .payment-badge.pending { background: var(--warning); color: var(--dark); }
  
  .debt-summary {
    background: linear-gradient(135deg, #fff3cd 0%, #ffe5a0 100%);
    border: 2px solid var(--warning);
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
  }
  
  .debt-summary h4 {
    color: #856404;
    margin-bottom: 15px;
    font-size: calc(var(--font-base) * 1.2);
  }
  
  .debt-item {
    display: flex;
    justify-content: space-between;
    padding: 10px;
    margin-bottom: 8px;
    background: white;
    border-radius: 6px;
    align-items: center;
  }
  
  .debt-item-info {
    flex: 1;
  }
  
  .debt-item-name {
    font-weight: 600;
    color: var(--dark);
  }
  
  .debt-item-detail {
    font-size: calc(var(--font-base) * 0.85);
    color: #666;
    margin-top: 4px;
  }
  
  .debt-item-amount {
    font-size: calc(var(--font-base) * 1.1);
    font-weight: 700;
    color: var(--danger);
  }
  
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  
  @keyframes slideUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  .tab-content { animation: fadeIn 0.3s ease; }
  
  @media (max-width: 360px) {
    .tournament-selector { grid-template-columns: 1fr; }
    .stats-grid { grid-template-columns: repeat(2, 1fr); }
    .phase-selector { grid-template-columns: repeat(2, 1fr); }
    .checkbox-item-payment { grid-template-columns: 1fr; }
    .checkbox-item-payment .payment-checkbox-wrapper {
      justify-self: start;
      margin-left: 30px;
    }
  }
  
  @media (min-width: 768px) and (max-width: 1024px) {
    .stats-grid { grid-template-columns: repeat(4, 1fr); }
  }

  .quick-actions {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 999;
  }

  .quick-actions button {
    display: block;
    width: 65px;
    height: 65px;
    border-radius: 50%;
    border: 3px solid var(--champions-blue);
    background: linear-gradient(135deg, var(--champions-navy), var(--champions-blue));
    color: white;
    font-size: 28px;
    cursor: pointer;
    box-shadow: 0 5px 20px rgba(0, 30, 71, 0.4);
    transition: all 0.3s ease;
    margin-bottom: 10px;
  }

  .quick-actions button:hover {
    transform: scale(1.15);
    box-shadow: 0 8px 30px rgba(0, 102, 204, 0.6);
  }
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>‚öΩ CRM F√∫tbol PRO</h1>
    <p id="currentTournamentName">Selecciona un torneo</p>
  </div>
  
  <div class="nav-tabs">
    <button class="active" onclick="showTab('jugadores')">üë• Jugadores</button>
    <button onclick="showTab('pagos')">üí∞ Pagos</button>
    <button onclick="showTab('partidos')">‚öΩ Partidos</button>
    <button onclick="showTab('estadisticas')">üìä Estad√≠sticas</button>
    <button onclick="showTab('config')">‚öôÔ∏è Config</button>
  </div>
  
  <div class="content">
    <!-- JUGADORES -->
    <div id="jugadores" class="tab-content">
      <div class="tournament-selector">
        <button id="torneo1Btn" onclick="selectTournament('torneo1')">üèÜ Torneo 1</button>
        <button id="torneo2Btn" onclick="selectTournament('torneo2')">üèÜ Torneo 2</button>
      </div>
      
      <div class="form-group">
        <label>Nombre del Jugador</label>
        <input type="text" id="playerName" placeholder="Ej: Juan P√©rez" />
      </div>
      
      <div class="form-group">
        <label>N√∫mero de Camiseta</label>
        <input type="number" id="playerNumber" placeholder="Ej: 10" min="1" max="99" />
      </div>
      
      <button class="btn btn-primary" onclick="addPlayer()">‚ûï Agregar Jugador</button>
      
      <h3 class="section-title">Lista de Jugadores</h3>
      
      <div class="filter-bar">
        <input type="text" id="playerFilter" placeholder="üîç Buscar por nombre o n√∫mero..." onkeyup="filterPlayers()">
        <button class="btn btn-sm btn-info" onclick="clearPlayerFilter()">Limpiar</button>
      </div>
      
      <div class="table-container">
        <table class="table">
          <thead>
            <tr>
              <th>Nombre</th>
              <th>#</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="playersTableBody">
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- PAGOS -->
    <div id="pagos" class="tab-content hidden">
      <div class="tournament-selector">
        <button id="torneo1BtnPagos" onclick="selectTournament('torneo1')">üèÜ Torneo 1</button>
        <button id="torneo2BtnPagos" onclick="selectTournament('torneo2')">üèÜ Torneo 2</button>
      </div>
      
      <div class="alert alert-info" id="inscriptionInfo">
        <strong>Valor de Inscripci√≥n:</strong> $0 COP por jugador
      </div>
      
      <div class="form-group">
        <label>Valor Total de Inscripci√≥n del Torneo</label>
        <input type="number" id="totalInscription" placeholder="Ej: 500000" min="0" />
      </div>
      
      <button class="btn btn-success" onclick="setInscriptionValue()">üìä Calcular Inscripci√≥n por Jugador</button>
      
      <h3 class="section-title">Registrar Abono</h3>
      
      <div class="form-group">
        <label>Seleccionar Jugador</label>
        <select id="playerSelectPayment">
          <option value="">-- Seleccionar --</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>Monto del Abono (COP)</label>
        <input type="number" id="paymentAmount" placeholder="Ej: 50000" min="0" />
      </div>
      
      <button class="btn btn-primary" onclick="registerPayment()">üí∞ Registrar Abono</button>
      
      <h3 class="section-title">Estado de Pagos de Inscripci√≥n</h3>
      
      <div class="filter-bar">
        <input type="text" id="paymentFilter" placeholder="üîç Buscar jugador..." onkeyup="filterPayments()">
        <select id="paymentStatusFilter" onchange="filterPayments()">
          <option value="all">Todos los estados</option>
          <option value="complete">Completo</option>
          <option value="pending">Pendiente</option>
        </select>
        <button class="btn btn-sm btn-info" onclick="clearPaymentFilters()">Limpiar</button>
      </div>
      
      <div class="table-container">
        <table class="table" id="paymentsTable">
          <thead>
            <tr>
              <th>Jugador</th>
              <th>#</th>
              <th>Debe Pagar</th>
              <th>Ha Pagado</th>
              <th>Pendiente</th>
              <th>Progreso</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="paymentsTableBody">
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- PARTIDOS -->
    <div id="partidos" class="tab-content hidden">
      <div class="tournament-selector">
        <button id="torneo1BtnPartidos" onclick="selectTournament('torneo1')">üèÜ Torneo 1</button>
        <button id="torneo2BtnPartidos" onclick="selectTournament('torneo2')">üèÜ Torneo 2</button>
      </div>
      
      <h3 class="section-title">Registrar Partido</h3>
      
      <div class="form-grid">
        <div class="form-group">
          <label>‚öΩ Goles Anotados</label>
          <input type="number" id="goalsScored" placeholder="0" value="0" min="0" />
        </div>
        
        <div class="form-group">
          <label>ü•Ö Goles Recibidos</label>
          <input type="number" id="goalsConceded" placeholder="0" value="0" min="0" />
        </div>
      </div>
      
      <div class="form-grid">
        <div class="form-group">
          <label>üü® Tarjetas Amarillas</label>
          <input type="number" id="yellowCards" placeholder="0" value="0" min="0" />
        </div>
        
        <div class="form-group">
          <label>üü¶ Tarjetas Azules</label>
          <input type="number" id="blueCards" placeholder="0" value="0" min="0" />
        </div>
      </div>
      
      <div class="form-group">
        <label>üü• Tarjetas Rojas</label>
        <input type="number" id="redCards" placeholder="0" value="0" min="0" />
      </div>
      
      <div class="form-group">
        <label>üíµ Valor del Arbitraje (COP)</label>
        <input type="number" id="refereeValue" placeholder="Ej: 80000" min="0" />
      </div>
      
      <h4 style="margin-bottom: 10px; color: var(--primary); font-size: calc(var(--font-base) * 1.05);">Jugadores Presentes y Control de Cobro</h4>
      <p style="font-size: calc(var(--font-base) * 0.9); color: #666; margin-bottom: 12px; line-height: 1.5;">
        Marque los jugadores que asistieron al partido y registre si pagaron el arbitraje.
      </p>
      <div class="checkbox-group" id="playersPresent"></div>
      
      <div class="summary-extended" id="refereeSummary">
        <div class="summary-row">
          <span>Total Arbitraje:</span>
          <strong>$0 COP</strong>
        </div>
        <div class="summary-row">
          <span>Jugadores Presentes:</span>
          <strong>0</strong>
        </div>
        <div class="summary-row">
          <span>Por Jugador:</span>
          <strong>$0 COP</strong>
        </div>
        <div class="payment-status-section">
          <div class="payment-status-title">Estado de Cobro:</div>
          <div class="summary-row">
            <span>Jugadores que Pagaron:</span>
            <strong id="playersPaidCount">0</strong>
          </div>
          <div class="summary-row">
            <span>Jugadores Pendientes:</span>
            <strong id="playersPendingCount">0</strong>
          </div>
          <div class="summary-row">
            <span>Total Recaudado:</span>
            <strong id="totalCollectedReferee">$0 COP</strong>
          </div>
          <div class="summary-row">
            <span>Total Pendiente:</span>
            <strong id="totalPendingReferee">$0 COP</strong>
          </div>
        </div>
      </div>
      
      <button class="btn btn-success" onclick="registerMatch()">‚öΩ Registrar Partido</button>
      
      <h3 class="section-title">Historial de Partidos</h3>
      
      <div class="filter-bar">
        <select id="matchResultFilter" onchange="filterMatches()">
          <option value="all">Todos los resultados</option>
          <option value="Victoria">Victorias</option>
          <option value="Empate">Empates</option>
          <option value="Derrota">Derrotas</option>
        </select>
        <select id="matchPaymentFilter" onchange="filterMatches()">
          <option value="all">Todos los pagos</option>
          <option value="complete">Pagos completos</option>
          <option value="pending">Pagos pendientes</option>
        </select>
        <button class="btn btn-sm btn-info" onclick="clearMatchFilters()">Limpiar</button>
      </div>
      
      <div id="matchesList"></div>
    </div>
    
    <!-- ESTAD√çSTICAS -->
    <div id="estadisticas" class="tab-content hidden">
      <div class="tournament-selector">
        <button id="torneo1BtnStats" onclick="selectTournament('torneo1')">üèÜ Torneo 1</button>
        <button id="torneo2BtnStats" onclick="selectTournament('torneo2')">üèÜ Torneo 2</button>
      </div>
      
      <div class="alert alert-info" id="phaseInfo">
        <strong>Fase Actual:</strong> Fase de Grupos
      </div>
      
      <h3 class="section-title">üìä Estad√≠sticas del Equipo</h3>
      
      <div class="table-container">
        <table class="table">
          <thead>
            <tr>
              <th>Categor√≠a</th>
              <th>Valor</th>
              <th>Promedio</th>
            </tr>
          </thead>
          <tbody id="teamStatsTable">
          </tbody>
        </table>
      </div>
      
      <div class="match-card" style="margin-top: 20px;">
        <h4>üíº Finanzas del Equipo</h4>
        <div class="summary-row">
          <span>üí∞ Total Recaudado (Inscripciones):</span>
          <strong id="totalCollected">$0</strong>
        </div>
        <div class="summary-row">
          <span>üìä Inscripci√≥n Total:</span>
          <strong id="totalInscriptionNeeded">$0</strong>
        </div>
        <div class="summary-row">
          <span>‚öΩ Total Arbitrajes Gastados:</span>
          <strong id="totalRefereeSpent">$0</strong>
        </div>
        <div class="summary-row">
          <span>üíµ Total Arbitrajes Recaudados:</span>
          <strong id="totalRefereeCollected">$0</strong>
        </div>
        <div class="summary-row">
          <span>‚è≥ Total Arbitrajes Pendientes:</span>
          <strong id="totalRefereePending">$0</strong>
        </div>
      </div>
      
      <h3 class="section-title" style="margin-top: 30px;">üë• Estad√≠sticas por Jugador</h3>
      
      <div class="filter-bar">
        <input type="text" id="playerStatsFilter" placeholder="üîç Buscar jugador..." onkeyup="filterPlayerStats()">
        <select id="playerStatsSortBy" onchange="sortPlayerStats()">
          <option value="matches">Ordenar por: Partidos</option>
          <option value="goals">Ordenar por: Goles</option>
          <option value="avgGoals">Ordenar por: Promedio Goles</option>
          <option value="yellowCards">Ordenar por: Amarillas</option>
          <option value="blueCards">Ordenar por: Azules</option>
          <option value="redCards">Ordenar por: Rojas</option>
          <option value="attendance">Ordenar por: Asistencia %</option>
        </select>
        <button class="btn btn-sm btn-info" onclick="clearPlayerStatsFilters()">Limpiar</button>
      </div>
      
      <div class="table-container">
        <table class="table">
          <thead>
            <tr>
              <th>Jugador</th>
              <th>#</th>
              <th>Partidos</th>
              <th>Asistencia</th>
              <th>‚öΩ Goles</th>
              <th>Prom. Goles</th>
              <th>üü®</th>
              <th>üü¶</th>
              <th>üü•</th>
              <th>Total Tarjetas</th>
              <th>Prom. Tarjetas</th>
            </tr>
          </thead>
          <tbody id="playerStatsTable">
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- CONFIG -->
    <div id="config" class="tab-content hidden">
      <div class="tournament-selector">
        <button id="torneo1BtnConfig" onclick="selectTournament('torneo1')">üèÜ Torneo 1</button>
        <button id="torneo2BtnConfig" onclick="selectTournament('torneo2')">üèÜ Torneo 2</button>
      </div>
      
      <div class="form-group">
        <label>Nombre del Torneo</label>
        <input type="text" id="tournamentName" placeholder="Ej: Liga de Verano 2025" />
      </div>
      
      <button class="btn btn-primary" onclick="updateTournamentName()">üíæ Guardar Nombre</button>
      
      <h3 class="section-title">Fase del Torneo</h3>
      
      <div class="phase-selector">
        <button class="phase-btn" onclick="setPhase('Fase de Grupos')">Grupos</button>
        <button class="phase-btn" onclick="setPhase('Dieciseisavos de Final')">1/16</button>
        <button class="phase-btn" onclick="setPhase('Octavos de Final')">1/8</button>
        <button class="phase-btn" onclick="setPhase('Cuartos de Final')">1/4</button>
        <button class="phase-btn" onclick="setPhase('Semifinal')">Semifinal</button>
        <button class="phase-btn" onclick="setPhase('Final')">Final</button>
      </div>
      
      <div class="alert alert-warning">
        <strong>‚ö†Ô∏è Fase Actual:</strong> <span id="currentPhase">Fase de Grupos</span>
      </div>
      
      <div class="section-divider">
        <div class="adjustment-card">
          <h4>üìä Ajustar Estad√≠sticas Manualmente</h4>
          <p style="font-size: calc(var(--font-base) * 0.9); color: #856404; margin-bottom: 15px;">
            Usa esta opci√≥n para ingresar datos de partidos ya jugados antes de usar el sistema.
          </p>
          
          <div class="form-grid">
            <div class="form-group">
              <label>Puntos</label>
              <input type="number" id="adjustPoints" placeholder="0" value="0" min="0" />
            </div>
            <div class="form-group">
              <label>Partidos Jugados</label>
              <input type="number" id="adjustMatches" placeholder="0" value="0" min="0" />
            </div>
          </div>
          
          <div class="form-grid">
            <div class="form-group">
              <label>Goles Anotados</label>
              <input type="number" id="adjustGoalsScored" placeholder="0" value="0" min="0" />
            </div>
            <div class="form-group">
              <label>Goles Recibidos</label>
              <input type="number" id="adjustGoalsConceded" placeholder="0" value="0" min="0" />
            </div>
          </div>
          
          <div class="form-grid">
            <div class="form-group">
              <label>Victorias</label>
              <input type="number" id="adjustWins" placeholder="0" value="0" min="0" />
            </div>
            <div class="form-group">
              <label>Empates</label>
              <input type="number" id="adjustDraws" placeholder="0" value="0" min="0" />
            </div>
          </div>
          
          <div class="form-grid">
            <div class="form-group">
              <label>Derrotas</label>
              <input type="number" id="adjustLosses" placeholder="0" value="0" min="0" />
            </div>
            <div class="form-group">
              <label>üü® Amarillas</label>
              <input type="number" id="adjustYellow" placeholder="0" value="0" min="0" />
            </div>
          </div>
          
          <div class="form-grid">
            <div class="form-group">
              <label>üü¶ Azules</label>
              <input type="number" id="adjustBlue" placeholder="0" value="0" min="0" />
            </div>
            <div class="form-group">
              <label>üü• Rojas</label>
              <input type="number" id="adjustRed" placeholder="0" value="0" min="0" />
            </div>
          </div>
          
          <div class="form-group">
            <label>Total Gastado en Arbitrajes (COP)</label>
            <input type="number" id="adjustReferee" placeholder="0" value="0" min="0" />
          </div>
          
          <button class="btn btn-info" onclick="loadCurrentStats()">üì• Cargar Valores Actuales</button>
          <button class="btn btn-success" onclick="saveAdjustedStats()">üíæ Guardar Ajustes</button>
        </div>
      </div>
      
      <h3 class="section-title">Reiniciar Torneo</h3>
      <p style="margin-bottom: 15px; font-size: var(--font-base); color: #666; line-height: 1.6;">
        Esta acci√≥n reiniciar√° todos los valores del torneo actual, incluyendo puntos, goles, pagos, partidos y registros de cobro de arbitraje, pero mantendr√° la lista de jugadores.
      </p>
      <button class="btn btn-danger" onclick="confirmResetTournament()">üîÑ Reiniciar Torneo</button>
      
      <h3 class="section-title">Eliminar Todos los Jugadores</h3>
      <p style="margin-bottom: 15px; font-size: var(--font-base); color: #666; line-height: 1.6;">
        Esta acci√≥n eliminar√° todos los jugadores del torneo actual junto con sus datos.
      </p>
      <button class="btn btn-danger" onclick="confirmDeleteAllPlayers()">üóëÔ∏è Eliminar Todos los Jugadores</button>
    </div>
  </div>
</div>

<!-- Botones de acci√≥n r√°pida -->
<div class="quick-actions">
  <button onclick="openDebtModal()" title="Ver deudas totales">üí≥</button>
</div>

<!-- Modal para gestionar abonos -->
<div id="paymentModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>üí∞ Gestionar Abonos</h3>
      <button class="modal-close" onclick="closePaymentModal()">&times;</button>
    </div>
    <div id="modalPlayerInfo" style="margin-bottom: 20px; padding: 12px; background: var(--light); border-radius: 6px;">
    </div>
    <h4 style="margin-bottom: 10px; color: var(--primary);">Historial de Abonos</h4>
    <div class="payment-history" id="paymentHistoryList">
    </div>
  </div>
</div>

<!-- Modal para editar jugador -->
<div id="editPlayerModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>‚úèÔ∏è Editar Jugador</h3>
      <button class="modal-close" onclick="closeEditPlayerModal()">&times;</button>
    </div>
    <div class="form-group">
      <label>Nombre del Jugador</label>
      <input type="text" id="editPlayerName" placeholder="Nombre del jugador" />
    </div>
    <div class="form-group">
      <label>N√∫mero de Camiseta</label>
      <input type="number" id="editPlayerNumber" placeholder="N√∫mero" min="1" max="99" />
    </div>
    <button class="btn btn-success" onclick="savePlayerEdit()">üíæ Guardar Cambios</button>
  </div>
</div>

<!-- Modal para gestionar partidos -->
<div id="matchModal" class="modal">
  <div class="modal-content" style="max-width: 800px;">
    <div class="modal-header">
      <h3>‚öΩ Gestionar Partido</h3>
      <button class="modal-close" onclick="closeMatchModal()">&times;</button>
    </div>
    <div id="modalMatchInfo" style="margin-bottom: 20px; padding: 12px; background: var(--light); border-radius: 6px;">
    </div>
    
    <h4 style="margin-bottom: 10px; color: var(--primary);">Datos del Partido</h4>
    <div class="form-grid" style="margin-bottom: 20px;">
      <div class="form-group" style="margin-bottom: 10px;">
        <label>‚öΩ Goles Anotados</label>
        <input type="number" id="editGoalsScored" min="0" />
      </div>
      <div class="form-group" style="margin-bottom: 10px;">
        <label>ü•Ö Goles Recibidos</label>
        <input type="number" id="editGoalsConceded" min="0" />
      </div>
      <div class="form-group" style="margin-bottom: 10px;">
        <label>üü® Amarillas (Equipo)</label>
        <input type="number" id="editYellowCards" min="0" />
      </div>
      <div class="form-group" style="margin-bottom: 10px;">
        <label>üü¶ Azules (Equipo)</label>
        <input type="number" id="editBlueCards" min="0" />
      </div>
      <div class="form-group" style="margin-bottom: 10px;">
        <label>üü• Rojas (Equipo)</label>
        <input type="number" id="editRedCards" min="0" />
      </div>
      <div class="form-group" style="margin-bottom: 10px;">
        <label>üíµ Valor Arbitraje</label>
        <input type="number" id="editRefereeValue" min="0" />
      </div>
    </div>
    
    <h4 style="margin-bottom: 10px; color: var(--primary);">Estad√≠sticas Individuales</h4>
    <p style="font-size: 13px; color: #666; margin-bottom: 12px;">
      Registra goles y tarjetas de cada jugador presente en el partido
    </p>
    <div id="playerIndividualStats" style="max-height: 300px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; padding: 10px;">
    </div>
    
    <h4 style="margin-bottom: 10px; margin-top: 20px; color: var(--primary);">Control de Cobro de Arbitraje</h4>
    <div class="payment-history" id="matchPaymentsList" style="max-height: 200px;">
    </div>
    
    <div style="display: flex; gap: 10px; margin-top: 20px;">
      <button class="btn btn-success" onclick="saveMatchChanges()" style="flex: 1;">üíæ Guardar Cambios</button>
      <button class="btn btn-danger" onclick="deleteMatch()" style="flex: 1;">üóëÔ∏è Eliminar Partido</button>
    </div>
  </div>
</div>

<!-- Modal para ver deudas totales -->
<div id="debtModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>üí≥ Reporte de Deudas Totales</h3>
      <button class="modal-close" onclick="closeDebtModal()">&times;</button>
    </div>
    
    <div class="debt-summary" id="debtSummaryTotal">
    </div>
    
    <h4 style="margin-bottom: 15px; color: var(--primary);">Detalle por Jugador</h4>
    <div id="debtDetailsList" style="max-height: 400px; overflow-y: auto;">
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getFirestore, collection, doc, setDoc, getDoc, getDocs, updateDoc, deleteDoc, query, where,
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBXylL77z6EPDy2EuXVLLF_hkW8CyQvns4",
    authDomain: "crm-futbol.firebaseapp.com",
    projectId: "crm-futbol",
    storageBucket: "crm-futbol.firebasestorage.app",
    messagingSenderId: "222709021751",
    appId: "1:222709021751:web:94168589472c2ee938d3b2",
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  let currentTournament = "torneo1";
  let players = [];
  let tournamentData = {};
  let currentEditingPlayer = null;
  let currentEditingMatchIndex = null;
  let filteredPlayers = [];
  let filteredPayments = [];
  let filteredMatches = [];

  window.showTab = function (tabName) {
    document.querySelectorAll(".tab-content").forEach((tab) => tab.classList.add("hidden"));
    document.getElementById(tabName).classList.remove("hidden");
    document.querySelectorAll(".nav-tabs button").forEach((btn) => btn.classList.remove("active"));
    event.target.classList.add("active");
    
    if (tabName === "estadisticas") {
      updateStatistics();
    }
  };

  window.selectTournament = async function (tournament) {
    currentTournament = tournament;
    
    document.querySelectorAll(".tournament-selector button").forEach((btn) => {
      btn.classList.remove("active");
    });
    
    [
      "torneo1Btn", "torneo2Btn", "torneo1BtnPagos", "torneo2BtnPagos",
      "torneo1BtnPartidos", "torneo2BtnPartidos", "torneo1BtnStats", "torneo2BtnStats",
      "torneo1BtnConfig", "torneo2BtnConfig",
    ].forEach((id) => {
      const el = document.getElementById(id);
      if (el) el.classList.toggle("active", id.includes(tournament));
    });

    await loadTournamentData();
    await loadPlayers();
    updateAllViews();
  };

  async function loadTournamentData() {
    const docRef = doc(db, "tournaments", currentTournament);
    const docSnap = await getDoc(docRef);
    
    if (docSnap.exists()) {
      tournamentData = docSnap.data();
    } else {
      tournamentData = {
        name: currentTournament === "torneo1" ? "Torneo 1" : "Torneo 2",
        totalInscription: 0,
        inscriptionPerPlayer: 0,
        phase: "Fase de Grupos",
        matches: [],
        manualMatches: 0,
        stats: {
          points: 0, wins: 0, draws: 0, losses: 0,
          goalsScored: 0, goalsConceded: 0,
          yellowCards: 0, blueCards: 0, redCards: 0,
          totalReferee: 0,
        },
      };
      await setDoc(docRef, tournamentData);
    }
    
    document.getElementById("currentTournamentName").textContent = tournamentData.name;
    document.getElementById("tournamentName").value = tournamentData.name;
    document.getElementById("currentPhase").textContent = tournamentData.phase;
    document.getElementById("phaseInfo").innerHTML = `<strong>Fase Actual:</strong> ${tournamentData.phase}`;
  }

  async function loadPlayers() {
    const q = query(collection(db, "players"), where("tournament", "==", currentTournament));
    const querySnapshot = await getDocs(q);
    players = [];
    
    for (const docSnap of querySnapshot.docs) {
      const playerData = { id: docSnap.id, ...docSnap.data() };
      
      if (playerData.payments && playerData.payments.length > 0) {
        let needsUpdate = false;
        const updatedPayments = playerData.payments.map((payment, index) => {
          if (!payment.id) {
            needsUpdate = true;
            return {
              ...payment,
              id: Date.now().toString() + "_" + index + "_" + Math.random().toString(36).substr(2, 9)
            };
          }
          return payment;
        });
        
        if (needsUpdate) {
          await updateDoc(doc(db, "players", docSnap.id), {
            payments: updatedPayments
          });
          playerData.payments = updatedPayments;
        }
      }
      
      players.push(playerData);
    }
    
    filteredPlayers = [...players];
    filteredPayments = [...players];
  }

  window.addPlayer = async function () {
    const name = document.getElementById("playerName").value.trim();
    const number = document.getElementById("playerNumber").value;
    
    if (!name || !number) {
      alert("Por favor completa todos los campos");
      return;
    }
    
    const playerData = {
      name: name,
      number: parseInt(number),
      tournament: currentTournament,
      payments: [],
      totalPaid: 0,
    };
    
    await setDoc(doc(collection(db, "players")), playerData);
    document.getElementById("playerName").value = "";
    document.getElementById("playerNumber").value = "";
    
    await loadPlayers();
    updateAllViews();
    alert("‚úÖ Jugador agregado exitosamente");
  };

  window.openEditPlayerModal = function(playerId) {
    const player = players.find(p => p.id === playerId);
    if (!player) return;
    
    currentEditingPlayer = player;
    document.getElementById("editPlayerName").value = player.name;
    document.getElementById("editPlayerNumber").value = player.number;
    document.getElementById("editPlayerModal").classList.add("active");
  };

  window.closeEditPlayerModal = function() {
    document.getElementById("editPlayerModal").classList.remove("active");
    currentEditingPlayer = null;
  };

  window.savePlayerEdit = async function() {
    if (!currentEditingPlayer) return;
    
    const newName = document.getElementById("editPlayerName").value.trim();
    const newNumber = parseInt(document.getElementById("editPlayerNumber").value);
    
    if (!newName || !newNumber) {
      alert("Por favor completa todos los campos");
      return;
    }
    
    await updateDoc(doc(db, "players", currentEditingPlayer.id), {
      name: newName,
      number: newNumber,
    });
    
    await loadPlayers();
    closeEditPlayerModal();
    updateAllViews();
    alert("‚úÖ Jugador actualizado exitosamente");
  };

  window.deletePlayer = async function (playerId) {
    if (confirm("¬øEst√°s seguro de eliminar este jugador? Se perder√°n todos sus datos de pagos.")) {
      await deleteDoc(doc(db, "players", playerId));
      await loadPlayers();
      updateAllViews();
      alert("‚úÖ Jugador eliminado exitosamente");
    }
  };

  window.setInscriptionValue = async function () {
    const total = parseFloat(document.getElementById("totalInscription").value);
    
    if (!total || players.length === 0) {
      alert("Ingresa un valor v√°lido y aseg√∫rate de tener jugadores registrados");
      return;
    }
    
    const perPlayer = total / players.length;
    tournamentData.totalInscription = total;
    tournamentData.inscriptionPerPlayer = perPlayer;
    
    await updateDoc(doc(db, "tournaments", currentTournament), {
      totalInscription: total,
      inscriptionPerPlayer: perPlayer,
    });
    
    updateAllViews();
    alert(`‚úÖ Inscripci√≥n calculada: $${perPlayer.toFixed(0)} COP por jugador`);
  };

  window.registerPayment = async function () {
    const playerId = document.getElementById("playerSelectPayment").value;
    const amount = parseFloat(document.getElementById("paymentAmount").value);
    
    if (!playerId || !amount || amount <= 0) {
      alert("Por favor completa todos los campos con valores v√°lidos");
      return;
    }
    
    const player = players.find((p) => p.id === playerId);
    if (!player) {
      alert("Jugador no encontrado");
      return;
    }
    
    const newPayment = {
      id: Date.now().toString() + "_" + Math.random().toString(36).substr(2, 9),
      amount: amount,
      date: new Date().toISOString()
    };
    
    const newPayments = [...(player.payments || []), newPayment];
    const newTotal = newPayments.reduce((sum, p) => sum + p.amount, 0);
    
    await updateDoc(doc(db, "players", playerId), {
      payments: newPayments,
      totalPaid: newTotal,
    });
    
    document.getElementById("playerSelectPayment").value = "";
    document.getElementById("paymentAmount").value = "";
    await loadPlayers();
    updateAllViews();
    alert("‚úÖ Abono registrado exitosamente");
  };

  window.openPaymentModal = function(playerId) {
    currentEditingPlayer = players.find(p => p.id === playerId);
    if (!currentEditingPlayer) return;
    
    const perPlayer = tournamentData.inscriptionPerPlayer || 0;
    const paid = currentEditingPlayer.totalPaid || 0;
    const pending = perPlayer - paid;
    
    document.getElementById("modalPlayerInfo").innerHTML = `
      <strong style="font-size: 1.1em; color: var(--primary);">${currentEditingPlayer.name} - #${currentEditingPlayer.number}</strong><br>
      <div style="margin-top: 8px;">
        <span>Debe pagar: <strong>$${perPlayer.toFixed(0)}</strong></span> | 
        <span>Ha pagado: <strong style="color: var(--success);">$${paid.toFixed(0)}</strong></span> | 
        <span>Pendiente: <strong style="color: var(--warning);">$${pending.toFixed(0)}</strong></span>
      </div>
    `;
    
    updatePaymentHistory();
    document.getElementById("paymentModal").classList.add("active");
  };

  window.closePaymentModal = function() {
    document.getElementById("paymentModal").classList.remove("active");
    currentEditingPlayer = null;
  };

  function updatePaymentHistory() {
    if (!currentEditingPlayer) return;
    
    const payments = currentEditingPlayer.payments || [];
    const historyList = document.getElementById("paymentHistoryList");
    
    if (payments.length === 0) {
      historyList.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No hay abonos registrados</p>';
      return;
    }
    
    historyList.innerHTML = payments.map(payment => {
      const date = new Date(payment.date).toLocaleDateString("es-CO", {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
      });
      
      return `
        <div class="payment-item">
          <div>
            <div class="payment-item-date">${date}</div>
            <div class="payment-item-amount">$${payment.amount.toFixed(0)} COP</div>
          </div>
          <div class="payment-item-actions">
            <button class="btn btn-sm btn-warning" onclick="editPayment('${payment.id}')">‚úèÔ∏è</button>
            <button class="btn btn-sm btn-danger" onclick="deletePayment('${payment.id}')">üóëÔ∏è</button>
          </div>
        </div>
      `;
    }).join('');
  }

  window.editPayment = async function(paymentId) {
    if (!currentEditingPlayer) {
      alert("Error: No hay jugador seleccionado");
      return;
    }
    
    const payment = currentEditingPlayer.payments.find(p => p.id === paymentId);
    if (!payment) {
      alert("Error: Abono no encontrado");
      return;
    }
    
    const dateStr = new Date(payment.date).toLocaleDateString("es-CO", {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });
    
    const newAmount = prompt(`Editar monto del abono\nFecha: ${dateStr}\nMonto actual: $${payment.amount.toFixed(0)}\n\nIngrese el nuevo monto:`, payment.amount);
    
    if (newAmount === null || newAmount === "") return;
    
    const amount = parseFloat(newAmount);
    if (isNaN(amount) || amount <= 0) {
      alert("Por favor ingrese un monto v√°lido mayor a 0");
      return;
    }
    
    const updatedPayments = currentEditingPlayer.payments.map(p => 
      p.id === paymentId ? { ...p, amount: amount } : p
    );
    
    const newTotal = updatedPayments.reduce((sum, p) => sum + p.amount, 0);
    
    await updateDoc(doc(db, "players", currentEditingPlayer.id), {
      payments: updatedPayments,
      totalPaid: newTotal,
    });
    
    await loadPlayers();
    currentEditingPlayer = players.find(p => p.id === currentEditingPlayer.id);
    updatePaymentHistory();
    updateAllViews();
    alert("‚úÖ Abono actualizado exitosamente");
  };

  window.deletePayment = async function(paymentId) {
    if (!currentEditingPlayer) {
      alert("Error: No hay jugador seleccionado");
      return;
    }
    
    const payment = currentEditingPlayer.payments.find(p => p.id === paymentId);
    if (!payment) {
      alert("Error: Abono no encontrado");
      return;
    }
    
    const dateStr = new Date(payment.date).toLocaleDateString("es-CO");
    if (!confirm(`¬øEst√°s seguro de eliminar este abono?\n\nFecha: ${dateStr}\nMonto: $${payment.amount.toFixed(0)}`)) return;
    
    const updatedPayments = currentEditingPlayer.payments.filter(p => p.id !== paymentId);
    const newTotal = updatedPayments.reduce((sum, p) => sum + p.amount, 0);
    
    await updateDoc(doc(db, "players", currentEditingPlayer.id), {
      payments: updatedPayments,
      totalPaid: newTotal,
    });
    
    await loadPlayers();
    currentEditingPlayer = players.find(p => p.id === currentEditingPlayer.id);
    updatePaymentHistory();
    updateAllViews();
    alert("‚úÖ Abono eliminado exitosamente");
  };

  window.registerMatch = async function () {
    const goalsScored = parseInt(document.getElementById("goalsScored").value) || 0;
    const goalsConceded = parseInt(document.getElementById("goalsConceded").value) || 0;
    const yellowCards = parseInt(document.getElementById("yellowCards").value) || 0;
    const blueCards = parseInt(document.getElementById("blueCards").value) || 0;
    const redCards = parseInt(document.getElementById("redCards").value) || 0;
    const refereeValue = parseFloat(document.getElementById("refereeValue").value) || 0;
    
    const presentPlayers = [];
    const refereePayments = {};
    
    document.querySelectorAll("#playersPresent .checkbox-item-payment").forEach((item) => {
      const attendanceCheckbox = item.querySelector('input[name^="attendance_"]');
      const paymentCheckbox = item.querySelector('input[name^="payment_"]');
      
      if (attendanceCheckbox && attendanceCheckbox.checked) {
        const playerId = attendanceCheckbox.value;
        presentPlayers.push(playerId);
        refereePayments[playerId] = paymentCheckbox ? paymentCheckbox.checked : false;
      }
    });
    
    if (presentPlayers.length === 0) {
      alert("Selecciona al menos un jugador presente");
      return;
    }
    
    let points = 0;
    let result = "";
    
    if (goalsScored > goalsConceded) {
      points = 2;
      result = "Victoria";
    } else if (goalsScored === goalsConceded) {
      points = 1;
      result = "Empate";
    } else {
      points = 0;
      result = "Derrota";
    }
    
    const refereePerPlayer = refereeValue / presentPlayers.length;
    
    // Inicializar estad√≠sticas individuales vac√≠as para cada jugador presente
    const playerStats = {};
    presentPlayers.forEach(playerId => {
      playerStats[playerId] = {
        goals: 0,
        yellowCards: 0,
        blueCards: 0,
        redCards: 0
      };
    });
    
    const matchData = {
      date: new Date().toISOString(),
      goalsScored, goalsConceded,
      yellowCards, blueCards, redCards,
      refereeValue, presentPlayers,
      refereePerPlayer, refereePayments,
      points, result,
      playerStats: playerStats // Nueva propiedad para estad√≠sticas por jugador
    };
    
    const newMatches = [...(tournamentData.matches || []), matchData];
    const newStats = {
      points: (tournamentData.stats?.points || 0) + points,
      wins: (tournamentData.stats?.wins || 0) + (result === "Victoria" ? 1 : 0),
      draws: (tournamentData.stats?.draws || 0) + (result === "Empate" ? 1 : 0),
      losses: (tournamentData.stats?.losses || 0) + (result === "Derrota" ? 1 : 0),
      goalsScored: (tournamentData.stats?.goalsScored || 0) + goalsScored,
      goalsConceded: (tournamentData.stats?.goalsConceded || 0) + goalsConceded,
      yellowCards: (tournamentData.stats?.yellowCards || 0) + yellowCards,
      blueCards: (tournamentData.stats?.blueCards || 0) + blueCards,
      redCards: (tournamentData.stats?.redCards || 0) + redCards,
      totalReferee: (tournamentData.stats?.totalReferee || 0) + refereeValue,
    };
    
    await updateDoc(doc(db, "tournaments", currentTournament), {
      matches: newMatches,
      stats: newStats,
    });
    
    document.getElementById("goalsScored").value = "0";
    document.getElementById("goalsConceded").value = "0";
    document.getElementById("yellowCards").value = "0";
    document.getElementById("blueCards").value = "0";
    document.getElementById("redCards").value = "0";
    document.getElementById("refereeValue").value = "";
    document.querySelectorAll("#playersPresent input[type='checkbox']").forEach((cb) => (cb.checked = false));
    
    await loadTournamentData();
    updateAllViews();
    
    const paidCount = Object.values(refereePayments).filter(paid => paid).length;
    const pendingCount = presentPlayers.length - paidCount;
    
    alert(`‚úÖ Partido registrado exitosamente\n\nNota: Ahora puedes editar las estad√≠sticas individuales de cada jugador desde "Gestionar Partido"\n\nResultado: ${result} (${points} puntos)\nJugadores que pagaron arbitraje: ${paidCount}\nJugadores con pago pendiente: ${pendingCount}`);
  };

  window.openMatchModal = function(matchIndex) {
    currentEditingMatchIndex = matchIndex;
    const match = tournamentData.matches[matchIndex];
    if (!match) return;
    
    const date = new Date(match.date).toLocaleDateString("es-CO", {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });
    
    document.getElementById("modalMatchInfo").innerHTML = `
      <strong style="font-size: 1.1em; color: var(--primary);">Partido #${matchIndex + 1} - ${date}</strong><br>
      <div style="margin-top: 8px;">
        <span>Resultado: <strong>${match.result} (${match.points} pts)</strong></span> | 
        <span>Goles: <strong>${match.goalsScored} - ${match.goalsConceded}</strong></span>
      </div>
    `;
    
    document.getElementById("editGoalsScored").value = match.goalsScored;
    document.getElementById("editGoalsConceded").value = match.goalsConceded;
    document.getElementById("editYellowCards").value = match.yellowCards;
    document.getElementById("editBlueCards").value = match.blueCards;
    document.getElementById("editRedCards").value = match.redCards;
    document.getElementById("editRefereeValue").value = match.refereeValue;
    
    // Inicializar playerStats si no existe
    if (!match.playerStats) {
      match.playerStats = {};
      match.presentPlayers.forEach(playerId => {
        match.playerStats[playerId] = {
          goals: 0,
          yellowCards: 0,
          blueCards: 0,
          redCards: 0
        };
      });
    }
    
    updatePlayerIndividualStats();
    updateMatchPaymentsList();
    document.getElementById("matchModal").classList.add("active");
  };

  function updatePlayerIndividualStats() {
    if (currentEditingMatchIndex === null) return;
    
    const match = tournamentData.matches[currentEditingMatchIndex];
    if (!match || !match.presentPlayers) return;
    
    const statsContainer = document.getElementById("playerIndividualStats");
    
    const html = match.presentPlayers.map(playerId => {
      const player = players.find(p => p.id === playerId);
      const playerName = player ? `${player.name} - #${player.number}` : 'Jugador no encontrado';
      
      const stats = match.playerStats?.[playerId] || {
        goals: 0,
        yellowCards: 0,
        blueCards: 0,
        redCards: 0
      };
      
      return `
        <div style="background: white; padding: 12px; margin-bottom: 10px; border-radius: 6px; border-left: 3px solid var(--primary);">
          <div style="font-weight: 600; margin-bottom: 10px; color: var(--dark);">${playerName}</div>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 8px;">
            <div>
              <label style="font-size: 12px; color: #666; display: block; margin-bottom: 4px;">‚öΩ Goles</label>
              <input type="number" 
                     id="player_${playerId}_goals" 
                     value="${stats.goals}" 
                     min="0" 
                     style="width: 100%; padding: 6px; border: 1px solid var(--border); border-radius: 4px;"
                     onchange="updatePlayerStat('${playerId}', 'goals', this.value)">
            </div>
            <div>
              <label style="font-size: 12px; color: #666; display: block; margin-bottom: 4px;">üü® Amarillas</label>
              <input type="number" 
                     id="player_${playerId}_yellow" 
                     value="${stats.yellowCards}" 
                     min="0" 
                     style="width: 100%; padding: 6px; border: 1px solid var(--border); border-radius: 4px;"
                     onchange="updatePlayerStat('${playerId}', 'yellowCards', this.value)">
            </div>
            <div>
              <label style="font-size: 12px; color: #666; display: block; margin-bottom: 4px;">üü¶ Azules</label>
              <input type="number" 
                     id="player_${playerId}_blue" 
                     value="${stats.blueCards}" 
                     min="0" 
                     style="width: 100%; padding: 6px; border: 1px solid var(--border); border-radius: 4px;"
                     onchange="updatePlayerStat('${playerId}', 'blueCards', this.value)">
            </div>
            <div>
              <label style="font-size: 12px; color: #666; display: block; margin-bottom: 4px;">üü• Rojas</label>
              <input type="number" 
                     id="player_${playerId}_red" 
                     value="${stats.redCards}" 
                     min="0" 
                     style="width: 100%; padding: 6px; border: 1px solid var(--border); border-radius: 4px;"
                     onchange="updatePlayerStat('${playerId}', 'redCards', this.value)">
            </div>
          </div>
        </div>
      `;
    }).join('');
    
    statsContainer.innerHTML = html;
  }

  window.updatePlayerStat = function(playerId, stat, value) {
    if (currentEditingMatchIndex === null) return;
    
    const match = tournamentData.matches[currentEditingMatchIndex];
    if (!match || !match.playerStats) return;
    
    if (!match.playerStats[playerId]) {
      match.playerStats[playerId] = {
        goals: 0,
        yellowCards: 0,
        blueCards: 0,
        redCards: 0
      };
    }
    
    match.playerStats[playerId][stat] = parseInt(value) || 0;
  };

  window.closeMatchModal = function() {
    document.getElementById("matchModal").classList.remove("active");
    currentEditingMatchIndex = null;
  };

  function updateMatchPaymentsList() {
    if (currentEditingMatchIndex === null) return;
    
    const match = tournamentData.matches[currentEditingMatchIndex];
    if (!match || !match.refereePayments) return;
    
    const paymentsList = document.getElementById("matchPaymentsList");
    
    const html = match.presentPlayers.map(playerId => {
      const player = players.find(p => p.id === playerId);
      const playerName = player ? `${player.name} - #${player.number}` : 'Jugador no encontrado';
      const isPaid = match.refereePayments[playerId] || false;
      
      return `
        <div class="payment-item">
          <div style="flex: 1;">
            <div style="font-weight: 500;">${playerName}</div>
            <div style="font-size: 0.85em; color: #666;">$${match.refereePerPlayer.toFixed(0)} COP</div>
          </div>
          <div class="payment-item-actions">
            <button class="btn btn-sm ${isPaid ? 'btn-success' : 'btn-warning'}" 
                    onclick="toggleMatchPayment('${playerId}')"
                    style="min-width: 100px;">
              ${isPaid ? '‚úì Pagado' : '‚è≥ Pendiente'}
            </button>
          </div>
        </div>
      `;
    }).join('');
    
    paymentsList.innerHTML = html;
  }

  window.toggleMatchPayment = function(playerId) {
    if (currentEditingMatchIndex === null) return;
    
    const match = tournamentData.matches[currentEditingMatchIndex];
    if (!match || !match.refereePayments) return;
    
    match.refereePayments[playerId] = !match.refereePayments[playerId];
    updateMatchPaymentsList();
  };

  window.saveMatchChanges = async function() {
    if (currentEditingMatchIndex === null) return;
    
    const match = tournamentData.matches[currentEditingMatchIndex];
    const oldStats = { ...tournamentData.stats };
    
    const newGoalsScored = parseInt(document.getElementById("editGoalsScored").value) || 0;
    const newGoalsConceded = parseInt(document.getElementById("editGoalsConceded").value) || 0;
    const newYellowCards = parseInt(document.getElementById("editYellowCards").value) || 0;
    const newBlueCards = parseInt(document.getElementById("editBlueCards").value) || 0;
    const newRedCards = parseInt(document.getElementById("editRedCards").value) || 0;
    const newRefereeValue = parseFloat(document.getElementById("editRefereeValue").value) || 0;
    
    let newPoints = 0;
    let newResult = "";
    if (newGoalsScored > newGoalsConceded) {
      newPoints = 2;
      newResult = "Victoria";
    } else if (newGoalsScored === newGoalsConceded) {
      newPoints = 1;
      newResult = "Empate";
    } else {
      newPoints = 0;
      newResult = "Derrota";
    }
    
    const updatedStats = {
      points: oldStats.points - match.points + newPoints,
      wins: oldStats.wins - (match.result === "Victoria" ? 1 : 0) + (newResult === "Victoria" ? 1 : 0),
      draws: oldStats.draws - (match.result === "Empate" ? 1 : 0) + (newResult === "Empate" ? 1 : 0),
      losses: oldStats.losses - (match.result === "Derrota" ? 1 : 0) + (newResult === "Derrota" ? 1 : 0),
      goalsScored: oldStats.goalsScored - match.goalsScored + newGoalsScored,
      goalsConceded: oldStats.goalsConceded - match.goalsConceded + newGoalsConceded,
      yellowCards: oldStats.yellowCards - match.yellowCards + newYellowCards,
      blueCards: oldStats.blueCards - match.blueCards + newBlueCards,
      redCards: oldStats.redCards - match.redCards + newRedCards,
      totalReferee: oldStats.totalReferee - match.refereeValue + newRefereeValue,
    };
    
    const newRefereePerPlayer = match.presentPlayers.length > 0 ? newRefereeValue / match.presentPlayers.length : 0;
    
    tournamentData.matches[currentEditingMatchIndex] = {
      ...match,
      goalsScored: newGoalsScored,
      goalsConceded: newGoalsConceded,
      yellowCards: newYellowCards,
      blueCards: newBlueCards,
      redCards: newRedCards,
      refereeValue: newRefereeValue,
      refereePerPlayer: newRefereePerPlayer,
      points: newPoints,
      result: newResult,
    };
    
    await updateDoc(doc(db, "tournaments", currentTournament), {
      matches: tournamentData.matches,
      stats: updatedStats,
    });
    
    await loadTournamentData();
    closeMatchModal();
    updateAllViews();
    alert("‚úÖ Partido actualizado exitosamente");
  };

  window.deleteMatch = async function() {
    if (currentEditingMatchIndex === null) return;
    
    if (!confirm("¬øEst√°s seguro de eliminar este partido? Esta acci√≥n no se puede deshacer.")) return;
    
    const match = tournamentData.matches[currentEditingMatchIndex];
    const oldStats = { ...tournamentData.stats };
    
    const updatedStats = {
      points: oldStats.points - match.points,
      wins: oldStats.wins - (match.result === "Victoria" ? 1 : 0),
      draws: oldStats.draws - (match.result === "Empate" ? 1 : 0),
      losses: oldStats.losses - (match.result === "Derrota" ? 1 : 0),
      goalsScored: oldStats.goalsScored - match.goalsScored,
      goalsConceded: oldStats.goalsConceded - match.goalsConceded,
      yellowCards: oldStats.yellowCards - match.yellowCards,
      blueCards: oldStats.blueCards - match.blueCards,
      redCards: oldStats.redCards - match.redCards,
      totalReferee: oldStats.totalReferee - match.refereeValue,
    };
    
    tournamentData.matches.splice(currentEditingMatchIndex, 1);
    
    await updateDoc(doc(db, "tournaments", currentTournament), {
      matches: tournamentData.matches,
      stats: updatedStats,
    });
    
    await loadTournamentData();
    closeMatchModal();
    updateAllViews();
    alert("‚úÖ Partido eliminado exitosamente");
  };

  window.openDebtModal = async function() {
    // Cargar datos de ambos torneos
    const torneo1Doc = await getDoc(doc(db, "tournaments", "torneo1"));
    const torneo2Doc = await getDoc(doc(db, "tournaments", "torneo2"));
    
    const torneo1Data = torneo1Doc.exists() ? torneo1Doc.data() : {};
    const torneo2Data = torneo2Doc.exists() ? torneo2Doc.data() : {};
    
    // Cargar jugadores de ambos torneos
    const q1 = query(collection(db, "players"), where("tournament", "==", "torneo1"));
    const q2 = query(collection(db, "players"), where("tournament", "==", "torneo2"));
    
    const [snapshot1, snapshot2] = await Promise.all([getDocs(q1), getDocs(q2)]);
    
    const allPlayers = new Map();
    
    // Procesar jugadores de torneo 1
    snapshot1.forEach((docSnap) => {
      const player = { id: docSnap.id, ...docSnap.data() };
      const key = player.name + "_" + player.number;
      
      if (!allPlayers.has(key)) {
        allPlayers.set(key, {
          name: player.name,
          number: player.number,
          torneos: []
        });
      }
      
      const inscriptionPending = (torneo1Data.inscriptionPerPlayer || 0) - (player.totalPaid || 0);
      
      allPlayers.get(key).torneos.push({
        tournament: "Torneo 1",
        inscriptionPending: Math.max(0, inscriptionPending),
        playerId: player.id
      });
    });
    
    // Procesar jugadores de torneo 2
    snapshot2.forEach((docSnap) => {
      const player = { id: docSnap.id, ...docSnap.data() };
      const key = player.name + "_" + player.number;
      
      if (!allPlayers.has(key)) {
        allPlayers.set(key, {
          name: player.name,
          number: player.number,
          torneos: []
        });
      }
      
      const inscriptionPending = (torneo2Data.inscriptionPerPlayer || 0) - (player.totalPaid || 0);
      
      allPlayers.get(key).torneos.push({
        tournament: "Torneo 2",
        inscriptionPending: Math.max(0, inscriptionPending),
        playerId: player.id
      });
    });
    
    // Calcular deudas totales
    let totalInscriptionDebt = 0;
    const debts = [];
    
    allPlayers.forEach((playerData) => {
      const totalInscriptionPending = playerData.torneos.reduce((sum, t) => sum + t.inscriptionPending, 0);
      
      if (totalInscriptionPending > 0) {
        debts.push({
          name: playerData.name,
          number: playerData.number,
          totalInscriptionPending: totalInscriptionPending,
          torneos: playerData.torneos.filter(t => t.inscriptionPending > 0)
        });
        
        totalInscriptionDebt += totalInscriptionPending;
      }
    });
    
    document.getElementById("debtSummaryTotal").innerHTML = `
      <h4>üí≥ Resumen Total de Deudas de Inscripci√≥n</h4>
      <p style="font-size: 14px; color: #666; margin-top: 8px; margin-bottom: 15px;">
        Consolidado de inscripciones pendientes en todos los torneos
      </p>
      <div style="text-align: center; background: white; padding: 20px; border-radius: 8px;">
        <div style="font-size: 32px; font-weight: 700; color: var(--danger);">$${totalInscriptionDebt.toFixed(0)}</div>
        <div style="font-size: 14px; color: #666; margin-top: 5px;">Deuda Total de Inscripciones</div>
      </div>
    `;
    
    const detailsList = document.getElementById("debtDetailsList");
    
    if (debts.length === 0) {
      detailsList.innerHTML = '<p style="text-align: center; color: var(--success); padding: 40px; font-size: 18px;">üéâ ¬°No hay deudas de inscripci√≥n pendientes!</p>';
    } else {
      debts.sort((a, b) => b.totalInscriptionPending - a.totalInscriptionPending);
      
      detailsList.innerHTML = debts.map(debt => {
        const torneosDetail = debt.torneos.map(t => 
          `${t.tournament}: $${t.inscriptionPending.toFixed(0)}`
        ).join(' | ');
        
        return `
        <div class="debt-item">
          <div class="debt-item-info">
            <div class="debt-item-name">${debt.name} - #${debt.number}</div>
            <div class="debt-item-detail">${torneosDetail}</div>
          </div>
          <div class="debt-item-amount">$${debt.totalInscriptionPending.toFixed(0)}</div>
        </div>
      `}).join('');
    }
    
    document.getElementById("debtModal").classList.add("active");
  };

  window.closeDebtModal = function() {
    document.getElementById("debtModal").classList.remove("active");
  };

  window.filterPlayers = function() {
    const searchTerm = document.getElementById("playerFilter").value.toLowerCase();
    
    filteredPlayers = players.filter(player => {
      const nameMatch = player.name.toLowerCase().includes(searchTerm);
      const numberMatch = player.number.toString().includes(searchTerm);
      return nameMatch || numberMatch;
    });
    
    updatePlayersTable();
  };

  window.clearPlayerFilter = function() {
    document.getElementById("playerFilter").value = "";
    filteredPlayers = [...players];
    updatePlayersTable();
  };

  window.filterPayments = function() {
    const searchTerm = document.getElementById("paymentFilter").value.toLowerCase();
    const statusFilter = document.getElementById("paymentStatusFilter").value;
    const perPlayer = tournamentData.inscriptionPerPlayer || 0;
    
    filteredPayments = players.filter(player => {
      const nameMatch = player.name.toLowerCase().includes(searchTerm);
      const numberMatch = player.number.toString().includes(searchTerm);
      const searchMatch = nameMatch || numberMatch;
      
      if (!searchMatch) return false;
      
      if (statusFilter === "all") return true;
      
      const paid = player.totalPaid || 0;
      const pending = perPlayer - paid;
      
      if (statusFilter === "complete") return pending <= 0;
      if (statusFilter === "pending") return pending > 0;
      
      return true;
    });
    
    updatePaymentsTable();
  };

  window.clearPaymentFilters = function() {
    document.getElementById("paymentFilter").value = "";
    document.getElementById("paymentStatusFilter").value = "all";
    filteredPayments = [...players];
    updatePaymentsTable();
  };

  window.filterMatches = function() {
    const resultFilter = document.getElementById("matchResultFilter").value;
    const paymentFilter = document.getElementById("matchPaymentFilter").value;
    
    filteredMatches = (tournamentData.matches || []).filter((match, index) => {
      let resultMatch = true;
      let paymentMatch = true;
      
      if (resultFilter !== "all") {
        resultMatch = match.result === resultFilter;
      }
      
      if (paymentFilter !== "all") {
        if (match.refereePayments) {
          const paidCount = Object.values(match.refereePayments).filter(paid => paid).length;
          const allPaid = paidCount === match.presentPlayers.length;
          
          if (paymentFilter === "complete") {
            paymentMatch = allPaid;
          } else if (paymentFilter === "pending") {
            paymentMatch = !allPaid;
          }
        } else {
          paymentMatch = paymentFilter === "pending";
        }
      }
      
      return resultMatch && paymentMatch;
    });
    
    updateMatchesList();
  };

  window.clearMatchFilters = function() {
    document.getElementById("matchResultFilter").value = "all";
    document.getElementById("matchPaymentFilter").value = "all";
    filteredMatches = [...(tournamentData.matches || [])];
    updateMatchesList();
  };

  window.updateTournamentName = async function () {
    const name = document.getElementById("tournamentName").value.trim();
    
    if (!name) {
      alert("Ingresa un nombre v√°lido");
      return;
    }
    
    await updateDoc(doc(db, "tournaments", currentTournament), { name });
    await loadTournamentData();
    alert("‚úÖ Nombre actualizado");
  };

  window.setPhase = async function (phase) {
    await updateDoc(doc(db, "tournaments", currentTournament), { phase });
    await loadTournamentData();
    updateAllViews();
    alert(`‚úÖ Fase actualizada a: ${phase}`);
  };

  window.loadCurrentStats = function () {
    const stats = tournamentData.stats || {};
    const manualMatches = tournamentData.manualMatches || 0;
    
    document.getElementById("adjustPoints").value = stats.points || 0;
    document.getElementById("adjustMatches").value = manualMatches;
    document.getElementById("adjustGoalsScored").value = stats.goalsScored || 0;
    document.getElementById("adjustGoalsConceded").value = stats.goalsConceded || 0;
    document.getElementById("adjustWins").value = stats.wins || 0;
    document.getElementById("adjustDraws").value = stats.draws || 0;
    document.getElementById("adjustLosses").value = stats.losses || 0;
    document.getElementById("adjustYellow").value = stats.yellowCards || 0;
    document.getElementById("adjustBlue").value = stats.blueCards || 0;
    document.getElementById("adjustRed").value = stats.redCards || 0;
    document.getElementById("adjustReferee").value = stats.totalReferee || 0;
    
    alert("‚úÖ Valores actuales cargados en el formulario");
  };

  window.saveAdjustedStats = async function () {
    if (!confirm("¬øEst√°s seguro de ajustar las estad√≠sticas? Esto sobrescribir√° los valores actuales.")) return;
    
    const newStats = {
      points: parseInt(document.getElementById("adjustPoints").value) || 0,
      wins: parseInt(document.getElementById("adjustWins").value) || 0,
      draws: parseInt(document.getElementById("adjustDraws").value) || 0,
      losses: parseInt(document.getElementById("adjustLosses").value) || 0,
      goalsScored: parseInt(document.getElementById("adjustGoalsScored").value) || 0,
      goalsConceded: parseInt(document.getElementById("adjustGoalsConceded").value) || 0,
      yellowCards: parseInt(document.getElementById("adjustYellow").value) || 0,
      blueCards: parseInt(document.getElementById("adjustBlue").value) || 0,
      redCards: parseInt(document.getElementById("adjustRed").value) || 0,
      totalReferee: parseFloat(document.getElementById("adjustReferee").value) || 0,
    };
    
    const manualMatches = parseInt(document.getElementById("adjustMatches").value) || 0;
    
    await updateDoc(doc(db, "tournaments", currentTournament), {
      stats: newStats,
      manualMatches: manualMatches,
    });
    
    await loadTournamentData();
    updateAllViews();
    alert("‚úÖ Estad√≠sticas ajustadas exitosamente");
  };

  window.confirmResetTournament = async function () {
    if (!confirm("¬øEst√°s seguro de reiniciar el torneo? Se perder√°n todos los datos de partidos, pagos, estad√≠sticas y registros de cobro de arbitraje.")) return;
    
    for (const player of players) {
      await updateDoc(doc(db, "players", player.id), {
        payments: [],
        totalPaid: 0,
      });
    }
    
    await updateDoc(doc(db, "tournaments", currentTournament), {
      totalInscription: 0,
      inscriptionPerPlayer: 0,
      phase: "Fase de Grupos",
      matches: [],
      manualMatches: 0,
      stats: {
        points: 0, wins: 0, draws: 0, losses: 0,
        goalsScored: 0, goalsConceded: 0,
        yellowCards: 0, blueCards: 0, redCards: 0,
        totalReferee: 0,
      },
    });
    
    await loadTournamentData();
    await loadPlayers();
    updateAllViews();
    alert("‚úÖ Torneo reiniciado exitosamente");
  };

  window.confirmDeleteAllPlayers = async function () {
    if (!confirm("¬øEst√°s seguro de eliminar TODOS los jugadores del torneo actual?")) return;
    
    for (const player of players) {
      await deleteDoc(doc(db, "players", player.id));
    }
    
    await loadPlayers();
    updateAllViews();
    alert("‚úÖ Todos los jugadores han sido eliminados");
  };

  function updateAllViews() {
    updatePlayersTable();
    updatePaymentsTable();
    updatePlayerSelectors();
    filterMatches();
    updateStatistics();
    updateInscriptionInfo();
  }

  function updatePlayersTable() {
    const tbody = document.getElementById("playersTableBody");
    
    if (filteredPlayers.length === 0) {
      tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: #999; padding: 20px;">No hay jugadores registrados</td></tr>';
      return;
    }
    
    tbody.innerHTML = filteredPlayers.map(player => `
      <tr>
        <td><strong>${player.name}</strong></td>
        <td>${player.number}</td>
        <td>
          <div class="actions">
            <button class="btn btn-sm btn-warning" onclick="openEditPlayerModal('${player.id}')">‚úèÔ∏è Editar</button>
            <button class="btn btn-sm btn-danger" onclick="deletePlayer('${player.id}')">üóëÔ∏è</button>
          </div>
        </td>
      </tr>
    `).join('');
  }

  function updatePaymentsTable() {
    const tbody = document.getElementById("paymentsTableBody");
    
    if (filteredPayments.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #999; padding: 20px;">No hay jugadores para mostrar</td></tr>';
      return;
    }
    
    const perPlayer = tournamentData.inscriptionPerPlayer || 0;
    
    tbody.innerHTML = filteredPayments.map((player) => {
      const paid = player.totalPaid || 0;
      const pending = perPlayer - paid;
      const percentage = perPlayer > 0 ? ((paid / perPlayer) * 100).toFixed(1) : 0;
      const statusBadge = pending <= 0 
        ? '<span class="badge badge-success">Completo</span>'
        : '<span class="badge badge-warning">Pendiente</span>';
      
      return `
      <tr>
        <td><strong>${player.name}</strong></td>
        <td>${player.number}</td>
        <td>$${perPlayer.toFixed(0)}</td>
        <td style="color: var(--success); font-weight: 600;">$${paid.toFixed(0)}</td>
        <td style="color: var(--warning); font-weight: 600;">$${pending.toFixed(0)}</td>
        <td>
          ${statusBadge}
          <div class="progress-bar">
            <div class="progress-fill" style="width: ${percentage}%; background: ${pending <= 0 ? 'var(--success)' : 'var(--warning)'};"></div>
          </div>
          <small>${percentage}%</small>
        </td>
        <td>
          <div class="actions">
            <button class="btn btn-sm btn-info" onclick="openPaymentModal('${player.id}')">üìù Gestionar</button>
          </div>
        </td>
      </tr>
    `;
    }).join('');
  }

  function updatePlayerSelectors() {
    const select = document.getElementById("playerSelectPayment");
    select.innerHTML =
      '<option value="">-- Seleccionar --</option>' +
      players.map((p) => `<option value="${p.id}">${p.name} - #${p.number}</option>`).join("");
    
    const checkboxContainer = document.getElementById("playersPresent");
    checkboxContainer.innerHTML = players
      .map(
        (p) => `
      <div class="checkbox-item-payment">
        <div class="player-name-wrapper">
          <input type="checkbox" id="attendance_${p.id}" name="attendance_${p.id}" value="${p.id}" onchange="updateRefereeSummary()" />
          <label for="attendance_${p.id}">${p.name} - #${p.number}</label>
        </div>
        <div class="payment-checkbox-wrapper">
          <input type="checkbox" id="payment_${p.id}" name="payment_${p.id}" onchange="updateRefereeSummary()" />
          <label for="payment_${p.id}">üíµ Pag√≥</label>
        </div>
      </div>
    `
      )
      .join("");
  }

  window.updateRefereeSummary = function () {
    const refereeValue = parseFloat(document.getElementById("refereeValue").value) || 0;
    
    let presentCount = 0;
    let paidCount = 0;
    
    document.querySelectorAll("#playersPresent .checkbox-item-payment").forEach((item) => {
      const attendanceCheckbox = item.querySelector('input[name^="attendance_"]');
      const paymentCheckbox = item.querySelector('input[name^="payment_"]');
      
      if (attendanceCheckbox && attendanceCheckbox.checked) {
        presentCount++;
        
        if (paymentCheckbox && paymentCheckbox.checked) {
          paidCount++;
          item.classList.add('paid');
          item.classList.remove('not-paid');
        } else {
          item.classList.add('not-paid');
          item.classList.remove('paid');
        }
      } else {
        item.classList.remove('paid', 'not-paid');
        if (paymentCheckbox) {
          paymentCheckbox.checked = false;
        }
      }
    });
    
    const perPlayer = presentCount > 0 ? refereeValue / presentCount : 0;
    const pendingCount = presentCount - paidCount;
    const totalCollected = paidCount * perPlayer;
    const totalPending = pendingCount * perPlayer;
    
    const summary = document.getElementById("refereeSummary");
    summary.innerHTML = `
      <div class="summary-row">
        <span>Total Arbitraje:</span>
        <strong>$${refereeValue.toFixed(0)} COP</strong>
      </div>
      <div class="summary-row">
        <span>Jugadores Presentes:</span>
        <strong>${presentCount}</strong>
      </div>
      <div class="summary-row">
        <span>Por Jugador:</span>
        <strong>$${perPlayer.toFixed(0)} COP</strong>
      </div>
      <div class="payment-status-section">
        <div class="payment-status-title">Estado de Cobro:</div>
        <div class="summary-row">
          <span>Jugadores que Pagaron:</span>
          <strong id="playersPaidCount">${paidCount}</strong>
        </div>
        <div class="summary-row">
          <span>Jugadores Pendientes:</span>
          <strong id="playersPendingCount">${pendingCount}</strong>
        </div>
        <div class="summary-row">
          <span>Total Recaudado:</span>
          <strong id="totalCollectedReferee">$${totalCollected.toFixed(0)} COP</strong>
        </div>
        <div class="summary-row">
          <span>Total Pendiente:</span>
          <strong id="totalPendingReferee">$${totalPending.toFixed(0)} COP</strong>
        </div>
      </div>
    `;
  };

  document.getElementById("refereeValue")?.addEventListener("input", updateRefereeSummary);

  function updateMatchesList() {
    const container = document.getElementById("matchesList");
    const matchesToShow = filteredMatches;
    
    if (matchesToShow.length === 0) {
      container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No hay partidos para mostrar</p>';
      return;
    }
    
    container.innerHTML = matchesToShow
      .map((match) => {
        const originalIndex = tournamentData.matches.indexOf(match);
        const date = new Date(match.date).toLocaleDateString("es-CO");
        
        let paymentDetailsHTML = '';
        if (match.refereePayments) {
          const paymentList = match.presentPlayers.map(playerId => {
            const player = players.find(p => p.id === playerId);
            const playerName = player ? `${player.name} - #${player.number}` : 'Jugador no encontrado';
            const paid = match.refereePayments[playerId];
            const badge = paid 
              ? '<span class="payment-badge paid">‚úì Pagado</span>' 
              : '<span class="payment-badge pending">‚è≥ Pendiente</span>';
            
            return `
              <div class="payment-list-item">
                <span class="player-name">${playerName}</span>
                ${badge}
              </div>
            `;
          }).join('');
          
          const paidCount = Object.values(match.refereePayments).filter(paid => paid).length;
          const pendingCount = match.presentPlayers.length - paidCount;
          
          paymentDetailsHTML = `
            <div class="payment-detail">
              <div class="payment-detail-title">Control de Cobro (${paidCount} pagaron / ${pendingCount} pendientes)</div>
              <div class="payment-list">
                ${paymentList}
              </div>
            </div>
          `;
        }
        
        return `
      <div class="match-card">
        <h4 style="color: var(--primary); margin-bottom: 10px;">Partido #${originalIndex + 1} - ${date}</h4>
        <div class="summary-row">
          <span>Resultado:</span>
          <strong>${match.result} (${match.points} pts)</strong>
        </div>
        <div class="summary-row">
          <span>Goles:</span>
          <strong>${match.goalsScored} - ${match.goalsConceded}</strong>
        </div>
        <div class="summary-row">
          <span>Tarjetas:</span>
          <strong>üü®${match.yellowCards} üü¶${match.blueCards} üü•${match.redCards}</strong>
        </div>
        <div class="summary-row">
          <span>Arbitraje Total:</span>
          <strong>$${match.refereeValue.toFixed(0)}</strong>
        </div>
        <div class="summary-row">
          <span>Por Jugador:</span>
          <strong>$${match.refereePerPlayer.toFixed(0)} (${match.presentPlayers.length} presentes)</strong>
        </div>
        ${paymentDetailsHTML}
        <button class="btn btn-info" onclick="openMatchModal(${originalIndex})" style="margin-top: 10px;">
          üìù Gestionar Partido
        </button>
      </div>
    `;
      })
      .join("");
  }

  let filteredPlayerStats = [];

  function updateStatistics() {
    const stats = tournamentData.stats || {};
    const matches = tournamentData.matches || [];
    const manualMatches = tournamentData.manualMatches || 0;
    const totalMatches = matches.length + manualMatches;
    
    // Tabla de estad√≠sticas del equipo
    const teamStatsTable = document.getElementById("teamStatsTable");
    
    const avgGoalsScored = totalMatches > 0 ? (stats.goalsScored || 0) / totalMatches : 0;
    const avgGoalsConceded = totalMatches > 0 ? (stats.goalsConceded || 0) / totalMatches : 0;
    const winPercent = totalMatches > 0 ? ((stats.wins || 0) / totalMatches) * 100 : 0;
    const drawPercent = totalMatches > 0 ? ((stats.draws || 0) / totalMatches) * 100 : 0;
    const lossPercent = totalMatches > 0 ? ((stats.losses || 0) / totalMatches) * 100 : 0;
    const goalDifference = (stats.goalsScored || 0) - (stats.goalsConceded || 0);
    const totalCards = (stats.yellowCards || 0) + (stats.blueCards || 0) + (stats.redCards || 0);
    const avgCards = totalMatches > 0 ? totalCards / totalMatches : 0;
    
    teamStatsTable.innerHTML = `
      <tr>
        <td><strong>‚öΩ Partidos Jugados</strong></td>
        <td>${totalMatches}</td>
        <td>-</td>
      </tr>
      <tr>
        <td><strong>üèÜ Puntos</strong></td>
        <td>${stats.points || 0}</td>
        <td>${totalMatches > 0 ? ((stats.points || 0) / totalMatches).toFixed(2) : 0} pts/partido</td>
      </tr>
      <tr style="background: #d4edda;">
        <td><strong>‚úÖ Victorias</strong></td>
        <td>${stats.wins || 0}</td>
        <td>${winPercent.toFixed(1)}%</td>
      </tr>
      <tr style="background: #fff3cd;">
        <td><strong>ü§ù Empates</strong></td>
        <td>${stats.draws || 0}</td>
        <td>${drawPercent.toFixed(1)}%</td>
      </tr>
      <tr style="background: #f8d7da;">
        <td><strong>‚ùå Derrotas</strong></td>
        <td>${stats.losses || 0}</td>
        <td>${lossPercent.toFixed(1)}%</td>
      </tr>
      <tr>
        <td><strong>‚öΩ Goles Anotados</strong></td>
        <td>${stats.goalsScored || 0}</td>
        <td>${avgGoalsScored.toFixed(2)} goles/partido</td>
      </tr>
      <tr>
        <td><strong>ü•Ö Goles Recibidos</strong></td>
        <td>${stats.goalsConceded || 0}</td>
        <td>${avgGoalsConceded.toFixed(2)} goles/partido</td>
      </tr>
      <tr style="background: ${goalDifference >= 0 ? '#d4edda' : '#f8d7da'};">
        <td><strong>üìä Diferencia de Goles</strong></td>
        <td>${goalDifference >= 0 ? '+' : ''}${goalDifference}</td>
        <td>-</td>
      </tr>
      <tr style="background: #fff3cd;">
        <td><strong>üü® Tarjetas Amarillas</strong></td>
        <td>${stats.yellowCards || 0}</td>
        <td>${totalMatches > 0 ? ((stats.yellowCards || 0) / totalMatches).toFixed(2) : 0} por partido</td>
      </tr>
      <tr style="background: #d1ecf1;">
        <td><strong>üü¶ Tarjetas Azules</strong></td>
        <td>${stats.blueCards || 0}</td>
        <td>${totalMatches > 0 ? ((stats.blueCards || 0) / totalMatches).toFixed(2) : 0} por partido</td>
      </tr>
      <tr style="background: #f8d7da;">
        <td><strong>üü• Tarjetas Rojas</strong></td>
        <td>${stats.redCards || 0}</td>
        <td>${totalMatches > 0 ? ((stats.redCards || 0) / totalMatches).toFixed(2) : 0} por partido</td>
      </tr>
      <tr>
        <td><strong>üìã Total Tarjetas</strong></td>
        <td>${totalCards}</td>
        <td>${avgCards.toFixed(2)} por partido</td>
      </tr>
    `;
    
    // Calcular estad√≠sticas por jugador
    const playerStatsMap = new Map();
    
    players.forEach(player => {
      playerStatsMap.set(player.id, {
        id: player.id,
        name: player.name,
        number: player.number,
        matchesPlayed: 0,
        goals: 0,
        yellowCards: 0,
        blueCards: 0,
        redCards: 0
      });
    });
    
    matches.forEach(match => {
      if (match.presentPlayers) {
        match.presentPlayers.forEach(playerId => {
          if (playerStatsMap.has(playerId)) {
            const playerStat = playerStatsMap.get(playerId);
            playerStat.matchesPlayed++;
            
            // Sumar estad√≠sticas individuales si existen
            if (match.playerStats && match.playerStats[playerId]) {
              const stats = match.playerStats[playerId];
              playerStat.goals += stats.goals || 0;
              playerStat.yellowCards += stats.yellowCards || 0;
              playerStat.blueCards += stats.blueCards || 0;
              playerStat.redCards += stats.redCards || 0;
            }
          }
        });
      }
    });
    
    filteredPlayerStats = Array.from(playerStatsMap.values());
    sortPlayerStats();
    
    // Finanzas
    const totalPaid = players.reduce((sum, p) => sum + (p.totalPaid || 0), 0);
    document.getElementById("totalCollected").textContent = `$${totalPaid.toFixed(0)}`;
    document.getElementById("totalInscriptionNeeded").textContent = `$${(tournamentData.totalInscription || 0).toFixed(0)}`;
    document.getElementById("totalRefereeSpent").textContent = `$${(stats.totalReferee || 0).toFixed(0)}`;
    
    let totalRefereeCollected = 0;
    let totalRefereePending = 0;
    
    matches.forEach(match => {
      if (match.refereePayments) {
        const paidCount = Object.values(match.refereePayments).filter(paid => paid).length;
        const pendingCount = match.presentPlayers.length - paidCount;
        
        totalRefereeCollected += paidCount * match.refereePerPlayer;
        totalRefereePending += pendingCount * match.refereePerPlayer;
      }
    });
    
    document.getElementById("totalRefereeCollected").textContent = `$${totalRefereeCollected.toFixed(0)}`;
    document.getElementById("totalRefereePending").textContent = `$${totalRefereePending.toFixed(0)}`;
  }

  function updatePlayerStatsTable() {
    const tbody = document.getElementById("playerStatsTable");
    const totalMatches = (tournamentData.matches || []).length + (tournamentData.manualMatches || 0);
    
    if (filteredPlayerStats.length === 0) {
      tbody.innerHTML = '<tr><td colspan="11" style="text-align: center; color: #999; padding: 20px;">No hay estad√≠sticas de jugadores</td></tr>';
      return;
    }
    
    tbody.innerHTML = filteredPlayerStats.map(player => {
      const avgGoals = player.matchesPlayed > 0 ? (player.goals / player.matchesPlayed).toFixed(2) : '0.00';
      const totalCards = player.yellowCards + player.blueCards + player.redCards;
      const avgCards = player.matchesPlayed > 0 ? (totalCards / player.matchesPlayed).toFixed(2) : '0.00';
      const attendancePercent = totalMatches > 0 ? ((player.matchesPlayed / totalMatches) * 100).toFixed(1) : '0.0';
      
      return `
        <tr>
          <td><strong>${player.name}</strong></td>
          <td>${player.number}</td>
          <td>${player.matchesPlayed}</td>
          <td>
            <span class="badge ${attendancePercent >= 80 ? 'badge-success' : attendancePercent >= 50 ? 'badge-warning' : 'badge-danger'}">
              ${attendancePercent}%
            </span>
          </td>
          <td><strong style="color: var(--success);">${player.goals}</strong></td>
          <td>${avgGoals}</td>
          <td>${player.yellowCards}</td>
          <td>${player.blueCards}</td>
          <td>${player.redCards}</td>
          <td><strong>${totalCards}</strong></td>
          <td>${avgCards}</td>
        </tr>
      `;
    }).join('');
  }

  window.filterPlayerStats = function() {
    const searchTerm = document.getElementById("playerStatsFilter").value.toLowerCase();
    
    const playerStatsMap = new Map();
    
    players.forEach(player => {
      playerStatsMap.set(player.id, {
        id: player.id,
        name: player.name,
        number: player.number,
        matchesPlayed: 0,
        goals: 0,
        yellowCards: 0,
        blueCards: 0,
        redCards: 0
      });
    });
    
    const matches = tournamentData.matches || [];
    
    matches.forEach(match => {
      if (match.presentPlayers) {
        match.presentPlayers.forEach(playerId => {
          if (playerStatsMap.has(playerId)) {
            const playerStat = playerStatsMap.get(playerId);
            playerStat.matchesPlayed++;
            
            if (match.playerStats && match.playerStats[playerId]) {
              const stats = match.playerStats[playerId];
              playerStat.goals += stats.goals || 0;
              playerStat.yellowCards += stats.yellowCards || 0;
              playerStat.blueCards += stats.blueCards || 0;
              playerStat.redCards += stats.redCards || 0;
            }
          }
        });
      }
    });
    
    filteredPlayerStats = Array.from(playerStatsMap.values()).filter(player => {
      const nameMatch = player.name.toLowerCase().includes(searchTerm);
      const numberMatch = player.number.toString().includes(searchTerm);
      return nameMatch || numberMatch;
    });
    
    sortPlayerStats();
  };

  window.sortPlayerStats = function() {
    const sortBy = document.getElementById("playerStatsSortBy").value;
    const totalMatches = (tournamentData.matches || []).length + (tournamentData.manualMatches || 0);
    
    filteredPlayerStats.sort((a, b) => {
      switch(sortBy) {
        case 'matches':
          return b.matchesPlayed - a.matchesPlayed;
        case 'goals':
          return b.goals - a.goals;
        case 'avgGoals':
          const avgA = a.matchesPlayed > 0 ? a.goals / a.matchesPlayed : 0;
          const avgB = b.matchesPlayed > 0 ? b.goals / b.matchesPlayed : 0;
          return avgB - avgA;
        case 'yellowCards':
          return b.yellowCards - a.yellowCards;
        case 'blueCards':
          return b.blueCards - a.blueCards;
        case 'redCards':
          return b.redCards - a.redCards;
        case 'attendance':
          const attA = totalMatches > 0 ? a.matchesPlayed / totalMatches : 0;
          const attB = totalMatches > 0 ? b.matchesPlayed / totalMatches : 0;
          return attB - attA;
        default:
          return 0;
      }
    });
    
    updatePlayerStatsTable();
  };

  window.clearPlayerStatsFilters = function() {
    document.getElementById("playerStatsFilter").value = "";
    document.getElementById("playerStatsSortBy").value = "matches";
    filterPlayerStats();
  };

  function updateInscriptionInfo() {
    const perPlayer = tournamentData.inscriptionPerPlayer || 0;
    const total = tournamentData.totalInscription || 0;
    
    document.getElementById("inscriptionInfo").innerHTML = `
      <strong>Valor de Inscripci√≥n:</strong> $${perPlayer.toFixed(0)} COP por jugador<br>
      <strong>Inscripci√≥n Total del Torneo:</strong> $${total.toFixed(0)} COP
    `;
  }

  window.addEventListener("load", async () => {
    await selectTournament("torneo1");
  });
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>‚≠ê IMPERIO ANDINO - Champions Edition</title>
  
  <!-- Fuentes e Iconos -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;500;600;700;800&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    /* ===== SISTEMA DE DISE√ëO CHAMPIONS PRO ===== */
    :root {
      /* Paleta Principal */
      --bg-app: #0f172a;          
      --bg-card: #1e293b;        
      --bg-table-header: rgba(30, 41, 59, 0.98);
      --bg-input: #0f172a;
      
      /* Colores de Marca */
      --accent-blue: #3b82f6;    
      --accent-gold: #f59e0b;    
      
      /* Sem√°ntica */
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --info: #06b6d4;
      
      /* Texto */
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --text-muted: #64748b;
      
      /* Bordes y Efectos */
      --glass-border: 1px solid rgba(255, 255, 255, 0.08);
      --shadow-card: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
      
      /* Layout */
      --radius-md: 12px;
      --radius-lg: 16px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--bg-app);
      background-image: 
        radial-gradient(circle at 0% 0%, rgba(59, 130, 246, 0.15) 0%, transparent 50%),
        radial-gradient(circle at 100% 100%, rgba(245, 158, 11, 0.1) 0%, transparent 50%);
      background-attachment: fixed;
      color: var(--text-primary);
      min-height: 100vh;
      padding-bottom: 100px;
      font-size: 14px;
      line-height: 1.5;
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }

    /* ===== HEADER ===== */
    .app-header {
      background: rgba(15, 23, 42, 0.9);
      backdrop-filter: blur(16px);
      position: sticky;
      top: 0;
      z-index: 100;
      border-bottom: var(--glass-border);
      padding: 16px 0;
      margin-bottom: 24px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }

    .header-content { display: flex; justify-content: space-between; align-items: center; }

    .logo-area h1 {
      font-family: 'Exo 2', sans-serif;
      font-weight: 800;
      font-size: 22px;
      text-transform: uppercase;
      letter-spacing: 1px;
      background: linear-gradient(to right, #fff, var(--accent-gold));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin: 0;
    }
    .logo-area p { font-size: 11px; color: var(--text-secondary); font-weight: 500; margin: 0; }

    .connection-status {
        font-size: 11px;
        padding: 4px 8px;
        border-radius: 12px;
        background: rgba(0,0,0,0.3);
        display: flex;
        align-items: center;
        gap: 6px;
        margin-left: 10px;
    }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #64748b; }
    .status-dot.connected { background: var(--success); box-shadow: 0 0 8px var(--success); }
    .status-dot.error { background: var(--danger); box-shadow: 0 0 8px var(--danger); }

    .tournament-switch {
      background: rgba(0,0,0,0.3);
      padding: 4px;
      border-radius: 8px;
      border: var(--glass-border);
      display: flex;
      gap: 4px;
    }
    .t-btn {
      background: transparent;
      border: none;
      color: var(--text-secondary);
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    .t-btn.active {
      background: var(--accent-blue);
      color: #fff;
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.4);
    }

    /* ===== NAVEGACI√ìN ===== */
    .nav-container {
      display: flex;
      gap: 10px;
      overflow-x: auto;
      padding: 4px 4px 12px 4px;
      margin-bottom: 20px;
    }
    .nav-btn {
      background: rgba(30, 41, 59, 0.7);
      border: var(--glass-border);
      color: var(--text-secondary);
      padding: 10px 20px;
      border-radius: 30px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .nav-btn.active {
      background: var(--accent-blue);
      color: #fff;
      border-color: var(--accent-blue);
      box-shadow: 0 0 15px rgba(59, 130, 246, 0.4);
    }

    /* ===== TARJETAS UI ===== */
    .card {
      background: var(--bg-card);
      border: var(--glass-border);
      border-radius: var(--radius-lg);
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: var(--shadow-card);
      position: relative;
      overflow: hidden;
    }
    .section-title {
      font-family: 'Exo 2', sans-serif;
      font-size: 18px;
      font-weight: 700;
      color: #fff;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .section-title::before {
      content: '';
      display: block;
      width: 4px;
      height: 18px;
      background: var(--accent-gold);
      border-radius: 2px;
      box-shadow: 0 0 10px var(--accent-gold);
    }

    /* ===== TABLAS PRO ===== */
    .table-responsive {
      overflow-x: auto;
      border-radius: var(--radius-md);
      border: var(--glass-border);
      background: rgba(15, 23, 42, 0.4);
    }
    .table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 14px; white-space: nowrap; }
    .table th {
      background: var(--bg-table-header);
      color: var(--text-secondary);
      font-weight: 700;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      padding: 16px 20px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      position: sticky; top: 0; z-index: 10;
    }
    .table td {
      padding: 14px 20px;
      border-bottom: 1px solid rgba(255,255,255,0.03);
      color: var(--text-primary);
      vertical-align: middle;
    }
    .table tbody tr:hover td { background-color: rgba(59, 130, 246, 0.08); }
    .numeric { text-align: right; font-feature-settings: "tnum"; }

    /* Barritas de progreso en tabla */
    .stat-bar-container {
      width: 100%;
      max-width: 100px;
      height: 6px;
      background: rgba(255,255,255,0.1);
      border-radius: 3px;
      display: inline-block;
      vertical-align: middle;
      margin-left: 8px;
      overflow: hidden;
    }
    .stat-bar-fill { height: 100%; border-radius: 3px; }
    .bar-blue { background: var(--accent-blue); }
    .bar-gold { background: var(--accent-gold); }
    .bar-green { background: var(--success); }
    .bar-red { background: var(--danger); }

    /* ===== INPUTS & BOTONES ===== */
    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; margin-bottom: 20px; }
    .form-group label { display: block; font-size: 12px; color: var(--text-muted); margin-bottom: 8px; font-weight: 600; text-transform: uppercase; }
    input, select {
      width: 100%;
      background: var(--bg-input);
      border: 1px solid rgba(255,255,255,0.1);
      color: #fff;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s;
    }
    input:focus, select:focus { outline: none; border-color: var(--accent-blue); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15); }

    .btn {
      border: none; border-radius: 8px; padding: 12px 20px; font-weight: 600; font-size: 14px;
      cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 8px;
      transition: all 0.2s;
    }
    .btn-primary { background: linear-gradient(135deg, var(--accent-blue), #2563eb); color: white; }
    .btn-success { background: linear-gradient(135deg, #10b981, #059669); color: white; }
    .btn-danger { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }
    .btn-warning { background: linear-gradient(135deg, #f59e0b, #d97706); color: #fff; }
    .btn-info { background: rgba(255,255,255,0.1); color: var(--text-secondary); border: 1px solid rgba(255,255,255,0.1); }
    .btn-sm { padding: 6px 12px; font-size: 12px; }

    /* ===== GRID ASISTENCIA ===== */
    .attendance-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
      gap: 12px;
      margin-top: 10px;
      max-height: 350px;
      overflow-y: auto;
      padding-right: 5px;
    }
    .player-card-check {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 10px;
      padding: 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      transition: all 0.2s;
      cursor: pointer;
      position: relative;
    }
    .player-card-check:hover { background: rgba(255,255,255,0.06); }
    .player-card-check.present {
      background: rgba(59, 130, 246, 0.1);
      border-color: var(--accent-blue);
      box-shadow: 0 0 15px rgba(59, 130, 246, 0.1);
    }
    .player-avatar-placeholder {
      width: 40px; height: 40px;
      border-radius: 50%;
      background: rgba(255,255,255,0.1);
      display: flex; align-items: center; justify-content: center;
      font-weight: 700; color: var(--text-muted);
      margin-bottom: 8px;
    }
    .player-card-check.present .player-avatar-placeholder {
      background: var(--accent-blue);
      color: #fff;
    }
    .player-info-check h5 { margin: 0; font-size: 13px; color: #fff; }
    .player-info-check span { font-size: 11px; color: var(--text-secondary); }
    
    .pay-toggle-btn {
      margin-top: 10px;
      width: 100%;
      padding: 6px;
      border-radius: 6px;
      border: none;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      background: rgba(0,0,0,0.3);
      color: var(--text-muted);
      display: none;
    }
    .player-card-check.present .pay-toggle-btn { display: block; }
    .pay-toggle-btn.paid {
      background: var(--success);
      color: #fff;
    }

    /* ===== ESTAD√çSTICAS WIDGETS ===== */
    .stats-dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }
    .stat-widget {
      background: var(--bg-card);
      border: var(--glass-border);
      border-radius: 16px;
      padding: 20px;
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .widget-icon {
      width: 50px; height: 50px;
      border-radius: 12px;
      display: flex; align-items: center; justify-content: center;
      font-size: 24px;
    }
    .widget-content div:first-child { font-size: 11px; text-transform: uppercase; color: var(--text-muted); font-weight: 700; letter-spacing: 1px; }
    .widget-content div:nth-child(2) { font-size: 18px; font-weight: 800; color: #fff; font-family: 'Exo 2', sans-serif; margin: 2px 0; }
    .widget-content div:last-child { font-size: 12px; color: var(--text-secondary); }

    .form-guide { display: flex; gap: 6px; margin-top: 5px; }
    .match-dot {
      width: 24px; height: 24px;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 10px; font-weight: 800; color: #fff;
    }
    .dot-w { background: var(--success); }
    .dot-d { background: #9ca3af; color: #000; }
    .dot-l { background: var(--danger); }

    /* ===== MVP CARD & GENERAL ===== */
    .mvp-card {
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(15, 23, 42, 0.4));
      border: 1px solid rgba(245, 158, 11, 0.3);
      border-radius: var(--radius-lg);
      padding: 24px;
      margin-bottom: 24px;
      display: flex; align-items: center; gap: 20px;
      position: relative; overflow: hidden;
    }
    .mvp-icon {
      width: 60px; height: 60px;
      background: rgba(245, 158, 11, 0.1);
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 30px; color: var(--accent-gold);
      box-shadow: 0 0 20px rgba(245, 158, 11, 0.2);
      z-index: 1;
    }
    .fab {
      position: fixed; bottom: 30px; right: 30px;
      width: 60px; height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent-gold), #d97706);
      color: #fff;
      display: flex; align-items: center; justify-content: center;
      font-size: 24px;
      box-shadow: 0 10px 25px rgba(245, 158, 11, 0.4);
      cursor: pointer; border: none; z-index: 999;
      transition: transform 0.3s;
    }
    .fab:hover { transform: scale(1.1) rotate(10deg); }

    /* Utilidades */
    .hidden { display: none !important; }
    .text-gold { color: var(--accent-gold); }
    .text-success { color: var(--success); }
    .text-danger { color: var(--danger); }
    .text-info { color: var(--info); }
    .text-warning { color: var(--warning); }
    
    /* Modales */
    .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); z-index: 1000; display: none; justify-content: center; align-items: center; padding: 20px; }
    .modal.active { display: flex; }
    .modal-content { background: #1e293b; width: 100%; max-width: 600px; border-radius: 20px; padding: 30px; border: 1px solid rgba(255,255,255,0.08); max-height: 85vh; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid rgba(255,255,255,0.08); }

    /* Toast */
    #toast-container { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 2000; display: flex; flex-direction: column; gap: 12px; width: 90%; max-width: 400px; pointer-events: none; }
    .toast { background: rgba(30, 41, 59, 0.95); color: #fff; padding: 14px 20px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(10px); display: flex; align-items: center; gap: 12px; animation: slideUp 0.4s; }
    @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    /* ESTILOS PREVIEW MODAL */
    .preview-scoreboard {
        text-align: center; 
        background: rgba(0,0,0,0.3); 
        padding: 20px; 
        border-radius: 15px; 
        margin-bottom: 20px;
        border: 1px solid rgba(255,255,255,0.1);
    }
    .preview-score {
        font-family: 'Exo 2', sans-serif;
        font-size: 48px;
        font-weight: 800;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 20px;
        color: #fff;
    }
    .preview-result {
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 2px;
        font-weight: 700;
        margin-top: 5px;
    }
    .preview-list-item {
        display: flex; 
        justify-content: space-between; 
        padding: 8px 0; 
        border-bottom: 1px solid rgba(255,255,255,0.05);
        font-size: 13px;
    }
    .preview-player-chip {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        background: rgba(255,255,255,0.1);
        padding: 4px 8px;
        border-radius: 4px;
        margin: 2px;
        font-size: 11px;
    }
    .preview-player-chip.paid { border: 1px solid var(--success); color: var(--success); }
    .preview-player-chip.not-paid { border: 1px solid var(--danger); color: var(--danger); }

  </style>
</head>
<body>

  <!-- HEADER -->
  <header class="app-header">
    <div class="container header-content">
      <div class="logo-area">
        <h1><i class="fa-solid fa-star text-gold" style="font-size:18px; margin-right:6px;"></i>IMPERIO ANDINO</h1>
        <div style="display: flex; align-items: center; gap: 10px;">
            <p id="currentTournamentName">Selecciona un torneo</p>
            <div id="connectionStatus" class="connection-status">
                <div class="status-dot"></div>
                <span id="connectionText">Conectando...</span>
            </div>
        </div>
      </div>
      <div class="tournament-switch">
        <button class="t-btn active" id="torneo1Global" onclick="selectTournament('torneo1')">T1</button>
        <button class="t-btn" id="torneo2Global" onclick="selectTournament('torneo2')">T2</button>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- NAVEGACI√ìN -->
    <nav class="nav-container">
      <button class="nav-btn active" onclick="showTab('jugadores')"><i class="fa-solid fa-users"></i> Jugadores</button>
      <button class="nav-btn" onclick="showTab('pagos')"><i class="fa-solid fa-money-bill-wave"></i> Pagos</button>
      <button class="nav-btn" onclick="showTab('partidos')"><i class="fa-solid fa-futbol"></i> Partidos</button>
      <button class="nav-btn" onclick="showTab('estadisticas')"><i class="fa-solid fa-chart-pie"></i> Stats</button>
      <button class="nav-btn" onclick="showTab('config')"><i class="fa-solid fa-gear"></i> Config</button>
    </nav>

    <!-- VISTA: JUGADORES -->
    <div id="jugadores" class="tab-content">
      <div class="card">
        <h3 class="section-title">Nuevo Jugador</h3>
        <div class="form-grid">
          <div class="form-group">
            <label>Nombre</label>
            <input type="text" id="playerName" placeholder="Ej: Leo Messi">
          </div>
          <div class="form-group">
            <label>Dorsal (#)</label>
            <input type="number" id="playerNumber" placeholder="10" min="1" max="99">
          </div>
          <div class="form-group" style="display: flex; align-items: end; gap: 10px;">
            <button class="btn btn-primary" onclick="addPlayer()" style="flex: 1;"><i class="fa-solid fa-plus"></i> Agregar</button>
            <button class="btn btn-info" onclick="openTeamGenerator()" title="Sorteo de Equipos"><i class="fa-solid fa-dice"></i></button>
          </div>
        </div>
      </div>

      <div class="card" style="padding-bottom: 10px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
           <h3 class="section-title" style="margin:0">Plantilla</h3>
           <button class="btn btn-sm btn-info" onclick="exportToCSV('players')" style="width: auto;"><i class="fa-solid fa-file-csv"></i> Exportar</button>
        </div>
        <div class="form-group" style="margin-bottom: 20px;">
          <input type="text" id="playerFilter" placeholder="üîç Buscar jugador..." onkeyup="filterPlayers()" style="background: rgba(255,255,255,0.03);">
        </div>
        
        <div class="table-responsive">
          <table class="table">
            <thead>
              <tr>
                <th>Jugador</th>
                <th class="numeric">Dorsal</th>
                <th style="text-align: center">Acciones</th>
              </tr>
            </thead>
            <tbody id="playersTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- VISTA: PAGOS -->
    <div id="pagos" class="tab-content hidden">
      <div class="card">
        <div class="alert" style="background: rgba(6, 182, 212, 0.1); padding: 12px 16px; border-radius: 8px; border-left: 4px solid var(--info); margin-bottom: 20px; display:flex; align-items:center; gap:10px;">
          <i class="fa-solid fa-circle-info text-info" style="font-size:16px;"></i>
          <span id="inscriptionInfo" style="font-size: 13px; color: var(--text-secondary);">Cargando info...</span>
        </div>
        
        <h3 class="section-title">Registrar Abono</h3>
        <div class="form-grid">
          <div class="form-group">
            <label>Jugador</label>
            <select id="playerSelectPayment"><option value="">Seleccionar...</option></select>
          </div>
          <div class="form-group">
            <label>Monto (COP)</label>
            <input type="number" id="paymentAmount" placeholder="$">
          </div>
          <div class="form-group" style="display: flex; align-items: end;">
            <button class="btn btn-success" onclick="registerPayment()" style="flex:1;"><i class="fa-solid fa-check"></i> Registrar</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
           <h3 class="section-title" style="margin:0">Estado Financiero</h3>
           <button class="btn btn-sm btn-info" onclick="exportToCSV('payments')" style="width: auto;"><i class="fa-solid fa-file-csv"></i> Exportar</button>
        </div>
        <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
          <input type="text" id="paymentFilter" placeholder="üîç Buscar..." onkeyup="filterPayments()" style="flex: 2; min-width: 150px; background: rgba(255,255,255,0.03);">
          <select id="paymentStatusFilter" onchange="filterPayments()" style="flex: 1; min-width: 150px; background: rgba(255,255,255,0.03);">
            <option value="all">Todos</option>
            <option value="complete">Completos</option>
            <option value="pending">Pendientes</option>
          </select>
        </div>

        <div class="table-responsive">
          <table class="table" id="paymentsTable">
            <thead>
              <tr>
                <th>Jugador</th>
                <th class="numeric">Debe</th>
                <th class="numeric">Pagado</th>
                <th class="numeric">Resta</th>
                <th>Estado</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="paymentsTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- VISTA: PARTIDOS -->
    <div id="partidos" class="tab-content hidden">
      <div class="card">
        <h3 class="section-title">Registrar Partido</h3>
        
        <div class="form-grid" style="margin-bottom: 20px;">
          <div class="form-group">
            <label><i class="fa-solid fa-futbol text-gold"></i> Goles Favor</label>
            <input type="number" id="goalsScored" value="0" min="0" style="font-size: 22px; font-weight: 700; text-align: center;">
          </div>
          <div class="form-group">
            <label><i class="fa-solid fa-shield-halved text-danger"></i> Goles Contra</label>
            <input type="number" id="goalsConceded" value="0" min="0" style="font-size: 22px; font-weight: 700; text-align: center;">
          </div>
        </div>

        <div class="form-grid" style="margin-bottom: 20px; grid-template-columns: repeat(3, 1fr);">
          <div class="form-group">
            <label class="text-warning" style="text-align:center">üü®</label>
            <input type="number" id="yellowCards" value="0" min="0" style="text-align:center;">
          </div>
          <div class="form-group">
            <label class="text-info" style="text-align:center">üü¶</label>
            <input type="number" id="blueCards" value="0" min="0" style="text-align:center;">
          </div>
          <div class="form-group">
            <label class="text-danger" style="text-align:center">üü•</label>
            <input type="number" id="redCards" value="0" min="0" style="text-align:center;">
          </div>
        </div>

        <div class="form-group" style="margin-bottom: 20px;">
          <label><i class="fa-solid fa-money-bill"></i> Costo Arbitraje Total</label>
          <input type="number" id="refereeValue" placeholder="Ej: 80000">
        </div>

        <!-- ASISTENCIA -->
        <div style="background: rgba(30, 41, 59, 0.5); padding: 20px; border-radius: 12px; margin-bottom: 24px; border: 1px solid rgba(255,255,255,0.05);">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
             <h4 style="font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); margin:0;">Asistencia y Cobro</h4>
             <div style="font-size: 12px;">
               <span id="selectedCount" class="text-info">0</span> Seleccionados
             </div>
          </div>
          
          <div class="attendance-grid" id="playersPresentGrid"></div>
          
          <div id="refereeSummary" style="margin-top: 20px; font-size: 13px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
              <span style="color: var(--text-secondary);">Costo por Jugador:</span>
              <strong id="refereePerPlayerDisplay" class="text-gold">$0</strong>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span style="color: var(--text-secondary);">Pagado:</span>
              <strong id="refereePaidTotal" class="text-success">$0</strong>
            </div>
          </div>
        </div>

        <!-- CAMBIO: Ahora llama a openMatchPreview en lugar de registerMatch directamente -->
        <button class="btn btn-primary" onclick="openMatchPreview()" style="width: 100%; font-size: 16px; padding: 14px;">
          <i class="fa-solid fa-eye"></i> Verificar & Guardar
        </button>
      </div>

      <div class="card">
        <h3 class="section-title">Historial</h3>
        <div id="matchesList"></div>
      </div>
    </div>

    <!-- VISTA: ESTAD√çSTICAS (MEJORADA CON TABLAS) -->
    <div id="estadisticas" class="tab-content hidden">
      
      <!-- WIDGETS DESTACADOS -->
      <div class="stats-dashboard">
        <div class="stat-widget">
           <div class="widget-icon" style="background: rgba(255,255,255,0.05);"><i class="fa-solid fa-arrow-trend-up text-success"></i></div>
           <div class="widget-content">
             <div>Racha</div>
             <div class="form-guide" id="formGuideContainer"><span style="color:grey; font-size:11px;">Sin partidos</span></div>
           </div>
        </div>
        <div class="stat-widget">
           <div class="widget-icon" style="background: rgba(245, 158, 11, 0.1); color: var(--accent-gold);"><i class="fa-solid fa-person-running"></i></div>
           <div class="widget-content">
             <div>M√°s Activo</div>
             <div id="topScorerName">--</div>
             <div id="topScorerValue">0 PJ</div>
           </div>
        </div>
      </div>

      <!-- TABLA DE RENDIMIENTO DETALLADO -->
      <div class="card">
        <h3 class="section-title">M√©tricas de Rendimiento</h3>
        <div class="table-responsive">
           <table class="table" id="detailedStatsTable">
             <!-- Renderizado JS -->
           </table>
        </div>
      </div>

      <!-- STATS INDIVIDUALES -->
      <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h3 class="section-title" style="margin:0;">Estad√≠sticas Jugadores</h3>
          <select id="playerStatsSortBy" onchange="sortPlayerStats()" style="width: auto; padding: 8px; font-size: 12px;">
            <option value="matches">Partidos</option>
          </select>
        </div>
        <div class="table-responsive">
          <table class="table">
            <thead>
              <tr>
                <th>Jugador</th>
                <th class="numeric">PJ</th>
                <th class="numeric" style="width: 100px;">Rendimiento</th>
              </tr>
            </thead>
            <tbody id="playerStatsTable"></tbody>
          </table>
        </div>
      </div>
      
      <!-- BALANCE -->
      <div class="card">
        <h3 class="section-title">Balance Financiero</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
           <div style="background: rgba(16, 185, 129, 0.05); padding: 16px; border-radius: 12px; border: 1px solid rgba(16, 185, 129, 0.1);">
             <div class="stat-label text-success">Recaudado (Insc)</div>
             <div style="font-size: 20px; font-weight: 700; color: #fff; font-family: 'Exo 2', sans-serif;" id="totalCollected">$0</div>
           </div>
           <div style="background: rgba(245, 158, 11, 0.05); padding: 16px; border-radius: 12px; border: 1px solid rgba(245, 158, 11, 0.1);">
             <div class="stat-label text-warning">Pendiente (Arbit)</div>
             <div style="font-size: 20px; font-weight: 700; color: #fff; font-family: 'Exo 2', sans-serif;" id="totalRefereePending">$0</div>
           </div>
        </div>
      </div>
    </div>

    <!-- VISTA: CONFIGURACI√ìN -->
    <div id="config" class="tab-content hidden">
      <div class="card">
        <h3 class="section-title">Configuraci√≥n Torneo</h3>
        <div class="form-group"><label>Nombre Torneo</label><input type="text" id="tournamentName"></div>
        <button class="btn btn-info" onclick="updateTournamentName()" style="margin-top:12px;">Actualizar Nombre</button>
      </div>
      <div class="card">
        <h3 class="section-title">Diagn√≥stico</h3>
        <div class="alert" style="background: rgba(59, 130, 246, 0.1); padding: 12px; border-radius: 8px; margin-bottom: 12px; font-size: 13px;">
            Si no ves tus datos antiguos, es porque esta versi√≥n usa una base de datos segura (artifacts) diferente a la anterior.
        </div>
        <button class="btn btn-primary" onclick="testConnection()" style="width: 100%;">üß™ Probar Conexi√≥n a Base de Datos</button>
      </div>
      <div class="card">
        <h3 class="section-title">Finanzas</h3>
        <div class="form-group"><label>Costo Total Inscripci√≥n Torneo</label><input type="number" id="totalInscription"></div>
        <button class="btn btn-success" onclick="setInscriptionValue()" style="margin-top:12px;">Calcular por Jugador</button>
      </div>
      <div class="card" style="border: 1px solid rgba(239, 68, 68, 0.2); background: rgba(239, 68, 68, 0.02);">
        <h3 class="section-title text-danger">Zona de Peligro</h3>
        <div style="display: grid; gap: 12px;">
           <button class="btn btn-warning" onclick="openDebtModal()">üí≥ Ver Reporte de Deudas</button>
           <button class="btn btn-danger" onclick="confirmResetTournament()">üîÑ Reiniciar Torneo Actual</button>
        </div>
      </div>
    </div>
  </main>

  <!-- FAB -->
  <button class="fab" onclick="openDebtModal()" title="Ver Deudas"><i class="fa-solid fa-sack-dollar"></i></button>

  <!-- MODALES -->
  <div id="paymentModal" class="modal">
    <div class="modal-content">
      <div class="modal-header"><h3>Gestionar Pagos</h3><button class="btn-sm btn-info" onclick="closePaymentModal()"><i class="fa-solid fa-xmark"></i></button></div>
      <div id="modalPlayerInfo" style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: 10px; margin-bottom: 20px;"></div>
      <h4 class="section-title" style="margin-top: 20px; font-size: 14px;">Historial</h4>
      <div id="paymentHistoryList" style="max-height: 200px; overflow-y: auto;"></div>
    </div>
  </div>

  <div id="editPlayerModal" class="modal">
    <div class="modal-content">
      <div class="modal-header"><h3>Editar Jugador</h3><button class="btn-sm btn-info" onclick="closeEditPlayerModal()"><i class="fa-solid fa-xmark"></i></button></div>
      <div class="form-group"><label>Nombre</label><input type="text" id="editPlayerName"></div>
      <div class="form-group"><label>N√∫mero</label><input type="number" id="editPlayerNumber"></div>
      <button class="btn btn-success" onclick="savePlayerEdit()" style="width: 100%; margin-top: 20px;">Guardar Cambios</button>
    </div>
  </div>

  <div id="matchModal" class="modal">
    <div class="modal-content">
      <div class="modal-header"><h3>Editar Partido</h3><button class="btn-sm btn-info" onclick="closeMatchModal()"><i class="fa-solid fa-xmark"></i></button></div>
      <div id="modalMatchInfo" style="margin-bottom: 20px; color: var(--text-secondary); font-size: 13px;"></div>
      <div class="form-grid" style="margin: 15px 0;">
         <div class="form-group"><label>GF</label><input type="number" id="editGoalsScored"></div>
         <div class="form-group"><label>GC</label><input type="number" id="editGoalsConceded"></div>
         <div class="form-group"><label>Amarillas</label><input type="number" id="editYellowCards"></div>
         <div class="form-group"><label>Arbitraje</label><input type="number" id="editRefereeValue"></div>
      </div>
      <div style="display: flex; gap: 10px; margin-top: 20px;">
         <button class="btn btn-success" onclick="saveMatchChanges()" style="flex: 1;">Guardar</button>
         <button class="btn btn-danger" onclick="deleteMatch()" style="flex: 1;">Eliminar</button>
      </div>
    </div>
  </div>

  <div id="debtModal" class="modal">
    <div class="modal-content">
      <div class="modal-header"><h3>Reporte de Deudas</h3><button class="btn-sm btn-info" onclick="closeDebtModal()"><i class="fa-solid fa-xmark"></i></button></div>
      <div id="debtSummaryTotal"></div>
      <div id="debtDetailsList" style="margin-top: 15px;"></div>
    </div>
  </div>

  <div id="teamGeneratorModal" class="modal">
    <div class="modal-content">
      <div class="modal-header"><h3>üé≤ Generador de Equipos</h3><button class="btn-sm btn-info" onclick="document.getElementById('teamGeneratorModal').classList.remove('active')"><i class="fa-solid fa-xmark"></i></button></div>
      <p style="color:var(--text-muted); font-size:13px; margin-bottom:15px;">Se usar√°n los jugadores filtrados actualmente.</p>
      <button class="btn btn-primary" onclick="generateTeams()" style="margin-bottom: 20px; width: 100%;">Mezclar y Dividir</button>
      <div class="form-grid">
         <div class="card" style="margin:0; border-top: 3px solid var(--info); padding: 16px;"><h4 style="text-align:center; margin-bottom:12px; color: var(--info);">Equipo A</h4><div id="teamAList" style="font-size:13px; line-height:1.6;"></div></div>
         <div class="card" style="margin:0; border-top: 3px solid var(--warning); padding: 16px;"><h4 style="text-align:center; margin-bottom:12px; color: var(--warning);">Equipo B</h4><div id="teamBList" style="font-size:13px; line-height:1.6;"></div></div>
      </div>
    </div>
  </div>
  
  <!-- NUEVO MODAL DE PREVISUALIZACI√ìN -->
  <div id="previewMatchModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Confirmar Partido</h3>
            <button class="btn-sm btn-info" onclick="document.getElementById('previewMatchModal').classList.remove('active')"><i class="fa-solid fa-xmark"></i></button>
        </div>
        
        <div class="preview-scoreboard">
            <div class="preview-score">
                <span class="text-success" id="prevGF">0</span>
                <span style="font-size: 20px; opacity: 0.5;">vs</span>
                <span class="text-danger" id="prevGC">0</span>
            </div>
            <div class="preview-result" id="prevResult">EMPATE</div>
        </div>

        <div style="margin-bottom: 20px;">
            <div class="preview-list-item">
                <span class="text-muted">Tarjetas</span>
                <span id="prevCards">0</span>
            </div>
            <div class="preview-list-item">
                <span class="text-muted">Arbitraje Total</span>
                <strong id="prevTotalRef"></strong>
            </div>
            <div class="preview-list-item">
                <span class="text-muted">Costo x Jugador</span>
                <strong class="text-gold" id="prevPerPlayer"></strong>
            </div>
            <div class="preview-list-item">
                <span class="text-muted">Recaudado</span>
                <strong class="text-success" id="prevPaid"></strong>
            </div>
        </div>

        <div style="margin-bottom: 20px;">
            <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 8px;">Asistencia (<span id="prevCount"></span>)</div>
            <div id="prevPlayerList" style="max-height: 150px; overflow-y: auto; display: flex; flex-wrap: wrap;"></div>
        </div>

        <div style="display: flex; gap: 10px;">
            <button class="btn btn-info" onclick="document.getElementById('previewMatchModal').classList.remove('active')" style="flex:1;">Corregir</button>
            <button class="btn btn-success" onclick="confirmMatchSave()" style="flex:2;"><i class="fa-solid fa-floppy-disk"></i> CONFIRMAR</button>
        </div>
    </div>
  </div>

  <div id="toast-container"></div>

  <!-- SCRIPTS -->
  <script>
    const toast = {
      show: (msg, type='info', duration=3000) => {
        const el = document.createElement('div');
        el.className = 'toast';
        let icon = type === 'success' ? '<i class="fa-solid fa-check text-success"></i>' : type === 'error' ? '<i class="fa-solid fa-circle-exclamation text-danger"></i>' : '<i class="fa-solid fa-info-circle text-info"></i>';
        el.innerHTML = `${icon} <span>${msg}</span>`;
        document.getElementById('toast-container').appendChild(el);
        setTimeout(() => { el.style.opacity='0'; setTimeout(()=>el.remove(), 300); }, duration);
      }
    };
  </script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, getDoc, getDocs, updateDoc, deleteDoc, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // --- CONFIGURACI√ìN CR√çTICA ---
    // Usamos la configuraci√≥n del entorno (__firebase_config) si existe.
    // Esto asegura que la autenticaci√≥n con __initial_auth_token funcione.
    // Si no existe (ej. uso local), se usa la configuraci√≥n hardcodeada del usuario.
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
      apiKey: "AIzaSyBXylL77z6EPDy2EuXVLLF_hkW8CyQvns4",
      authDomain: "crm-futbol.firebaseapp.com",
      projectId: "crm-futbol",
      storageBucket: "crm-futbol.firebasestorage.app",
      messagingSenderId: "222709021751",
      appId: "1:222709021751:web:94168589472c2ee938d3b2",
    };

    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- HELPER PARA RUTAS ---
    // IMPORTANTE: Todas las colecciones deben estar bajo /artifacts/{appId}/public/data/
    // para cumplir con las reglas de seguridad del entorno.
    const getCollection = (name) => collection(db, 'artifacts', appId, 'public', 'data', name);

    let currentTournament = "torneo1";
    let players = [];
    let tournamentData = {};
    let filteredPlayers = [];
    let filteredPayments = [];
    let currentEditingPlayer = null;
    let currentEditingMatchIndex = null;
    let playerStatsGlobal = [];
    let attendanceState = {};
    
    // Variable temporal para almacenar los datos antes de guardar
    let tempMatchData = null;

    // --- MANEJO ESTADO CONEXION VISUAL ---
    function updateConnectionStatus(status, type) {
        const dot = document.querySelector('.status-dot');
        const text = document.getElementById('connectionText');
        
        dot.className = 'status-dot';
        if (type === 'connected') {
            dot.classList.add('connected');
            text.textContent = "Conectado";
            text.style.color = "var(--success)";
        } else if (type === 'error') {
            dot.classList.add('error');
            text.textContent = status;
            text.style.color = "var(--danger)";
        } else {
            text.textContent = status;
            text.style.color = "var(--text-muted)";
        }
    }

    // AUTH INIT
    async function initAuth() {
        try {
            updateConnectionStatus("Autenticando...", "loading");
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        } catch (e) {
            console.error("Auth failed", e);
            updateConnectionStatus("Error Auth", "error");
            toast.show("Error de conexi√≥n: " + e.message, "error");
        }
    }

    window.showTab = function (tabName) {
      document.querySelectorAll(".tab-content").forEach(t => t.classList.add("hidden"));
      document.getElementById(tabName).classList.remove("hidden");
      document.querySelectorAll(".nav-btn").forEach(b => b.classList.remove("active"));
      event.currentTarget.classList.add("active");
      if(tabName === 'estadisticas') updateStatistics();
    };

    window.selectTournament = async function (t) {
      if (!auth.currentUser) return; // Guard clause
      currentTournament = t;
      document.querySelectorAll(".t-btn").forEach(b => b.classList.remove("active"));
      const btn = document.getElementById(t + "Global");
      if(btn) btn.classList.add("active");
      await loadTournamentData();
      await loadPlayers();
      toast.show(`Cargado: ${tournamentData.name || t}`, "success");
      updateAllViews();
    };

    async function loadTournamentData() {
      try {
          const docRef = doc(getCollection("tournaments"), currentTournament);
          const snap = await getDoc(docRef);
          if (snap.exists()) {
            tournamentData = snap.data();
            console.log("Torneo cargado:", tournamentData);
          } else {
            console.log("Creando nuevo torneo...");
            tournamentData = { name: "Nuevo Torneo", totalInscription: 0, matches: [], stats: {} };
            await setDoc(docRef, tournamentData);
          }
          document.getElementById("currentTournamentName").textContent = tournamentData.name;
          document.getElementById("tournamentName").value = tournamentData.name;
          document.getElementById("totalInscription").value = tournamentData.totalInscription || 0;
      } catch (error) {
          console.error("Error cargando torneo:", error);
          toast.show("Error cargando datos: " + error.code, "error");
      }
    }

    async function loadPlayers() {
      try {
          const q = query(getCollection("players"), where("tournament", "==", currentTournament));
          const snap = await getDocs(q);
          console.log(`Jugadores encontrados: ${snap.docs.length}`);
          players = snap.docs.map(d => ({ id: d.id, ...d.data() }));
          players.sort((a,b) => a.number - b.number);
          filteredPlayers = [...players];
          filteredPayments = [...players];
      } catch (error) {
          console.error("Error cargando jugadores:", error);
      }
    }

    window.testConnection = async () => {
        try {
            const testId = "test_" + Date.now();
            await setDoc(doc(getCollection("diagnostics"), testId), { timestamp: new Date(), status: "OK" });
            const snap = await getDoc(doc(getCollection("diagnostics"), testId));
            if (snap.exists()) {
                toast.show("‚úÖ Conexi√≥n EXITOSA. Base de datos responde.", "success");
            } else {
                toast.show("‚ö†Ô∏è Escritura exitosa pero lectura fall√≥.", "warning");
            }
        } catch (error) {
            console.error(error);
            toast.show("‚ùå Error de conexi√≥n: " + error.code, "error");
        }
    };

    window.addPlayer = async function () {
      const name = document.getElementById("playerName").value;
      const num = document.getElementById("playerNumber").value;
      if (!name || !num) return toast.show("Faltan datos", "error");
      // Usamos getCollection("players")
      await setDoc(doc(getCollection("players")), { name, number: parseInt(num), tournament: currentTournament, payments: [], totalPaid: 0 });
      document.getElementById("playerName").value = "";
      document.getElementById("playerNumber").value = "";
      await loadPlayers();
      updateAllViews();
      toast.show("Jugador Agregado", "success");
    };

    window.filterPlayers = function() {
      const term = document.getElementById("playerFilter").value.toLowerCase();
      filteredPlayers = players.filter(p => p.name.toLowerCase().includes(term) || p.number.toString().includes(term));
      updatePlayersTable();
    };

    function updatePlayersTable() {
      const tbody = document.getElementById("playersTableBody");
      tbody.innerHTML = filteredPlayers.map(p => `
        <tr>
          <td><strong style="color:#fff">${p.name}</strong></td>
          <td class="numeric">#${p.number}</td>
          <td style="text-align: center">
            <button class="btn btn-sm btn-warning" onclick="openEditPlayerModal('${p.id}')" style="display:inline-block; width:auto"><i class="fa-solid fa-pen"></i></button>
            <button class="btn btn-sm btn-danger" onclick="deletePlayer('${p.id}')" style="display:inline-block; width:auto"><i class="fa-solid fa-trash"></i></button>
          </td>
        </tr>
      `).join('');
    }

    window.deletePlayer = async (id) => {
      if(!confirm("¬øEliminar jugador?")) return;
      // Usamos getCollection("players")
      await deleteDoc(doc(getCollection("players"), id));
      await loadPlayers();
      updateAllViews();
    };

    window.openEditPlayerModal = (id) => {
      currentEditingPlayer = players.find(p => p.id === id);
      document.getElementById("editPlayerName").value = currentEditingPlayer.name;
      document.getElementById("editPlayerNumber").value = currentEditingPlayer.number;
      document.getElementById("editPlayerModal").classList.add("active");
    };
    window.closeEditPlayerModal = () => document.getElementById("editPlayerModal").classList.remove("active");
    window.savePlayerEdit = async () => {
      const name = document.getElementById("editPlayerName").value;
      const number = parseInt(document.getElementById("editPlayerNumber").value);
      // Usamos getCollection("players")
      await updateDoc(doc(getCollection("players"), currentEditingPlayer.id), { name, number });
      closeEditPlayerModal();
      await loadPlayers();
      updateAllViews();
    };

    window.setInscriptionValue = async () => {
      const total = parseFloat(document.getElementById("totalInscription").value);
      if(!total || players.length === 0) return toast.show("Error en datos", "error");
      const perPlayer = total / players.length;
      tournamentData.totalInscription = total;
      tournamentData.inscriptionPerPlayer = perPlayer;
      // Usamos getCollection("tournaments")
      await updateDoc(doc(getCollection("tournaments"), currentTournament), { totalInscription: total, inscriptionPerPlayer: perPlayer });
      updateAllViews();
      toast.show("Inscripci√≥n recalculada", "success");
    };

    window.registerPayment = async () => {
      const id = document.getElementById("playerSelectPayment").value;
      const amount = parseFloat(document.getElementById("paymentAmount").value);
      if(!id || !amount) return toast.show("Datos incompletos", "error");
      const p = players.find(pl => pl.id === id);
      const newPay = { id: Date.now().toString(), amount, date: new Date().toISOString() };
      const payments = [...(p.payments || []), newPay];
      const totalPaid = payments.reduce((sum, x) => sum + x.amount, 0);
      // Usamos getCollection("players")
      await updateDoc(doc(getCollection("players"), id), { payments, totalPaid });
      document.getElementById("paymentAmount").value = "";
      await loadPlayers();
      updateAllViews();
      toast.show("Pago registrado", "success");
    };

    window.filterPayments = () => {
      const term = document.getElementById("paymentFilter").value.toLowerCase();
      const status = document.getElementById("paymentStatusFilter").value;
      const cost = tournamentData.inscriptionPerPlayer || 0;
      filteredPayments = players.filter(p => {
        const matchName = p.name.toLowerCase().includes(term);
        if(!matchName) return false;
        const debt = cost - (p.totalPaid || 0);
        if(status === 'complete' && debt > 0) return false;
        if(status === 'pending' && debt <= 0) return false;
        return true;
      });
      updatePaymentsTable();
    };

    function updatePaymentsTable() {
      const tbody = document.getElementById("paymentsTableBody");
      const cost = tournamentData.inscriptionPerPlayer || 0;
      tbody.innerHTML = filteredPayments.map(p => {
        const paid = p.totalPaid || 0;
        const debt = cost - paid;
        const status = debt <= 0 ? '<span class="badge badge-success">OK</span>' : '<span class="badge badge-warning">Pend</span>';
        return `<tr><td>${p.name}</td><td class="numeric">$${cost.toLocaleString()}</td><td class="numeric text-success">$${paid.toLocaleString()}</td><td class="numeric text-danger">$${debt > 0 ? debt.toLocaleString() : 0}</td><td>${status}</td><td style="width: 50px;"><button class="btn btn-sm btn-info" onclick="openPaymentHistory('${p.id}')"><i class="fa-solid fa-list"></i></button></td></tr>`;
      }).join('');
      const sel = document.getElementById("playerSelectPayment");
      sel.innerHTML = '<option value="">Seleccionar...</option>' + players.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
      document.getElementById("inscriptionInfo").textContent = `Costo por jugador: $${cost.toLocaleString()}`;
    }

    document.getElementById("refereeValue").addEventListener("input", () => updateRefereeCalc());

    function renderAttendanceGrid() {
      const container = document.getElementById("playersPresentGrid");
      container.innerHTML = players.map(p => {
        const state = attendanceState[p.id] || { present: false, paid: false };
        const cardClass = state.present ? 'present' : '';
        const btnClass = state.paid ? 'paid' : '';
        const btnText = state.paid ? 'PAGADO' : 'NO PAGADO';

        return `
          <div class="player-card-check ${cardClass}" onclick="toggleAttendance('${p.id}')">
             <div class="player-avatar-placeholder">${p.number}</div>
             <div class="player-info-check">
               <h5>${p.name}</h5>
               <span>${state.present ? 'Presente' : 'Ausente'}</span>
             </div>
             <button class="pay-toggle-btn ${btnClass}" onclick="event.stopPropagation(); toggleRefPayment('${p.id}')">
                <i class="fa-solid fa-money-bill"></i> ${btnText}
             </button>
          </div>
        `;
      }).join('');
      updateRefereeCalc();
    }

    window.toggleAttendance = (id) => {
       if(!attendanceState[id]) attendanceState[id] = { present: false, paid: false };
       attendanceState[id].present = !attendanceState[id].present;
       if(!attendanceState[id].present) attendanceState[id].paid = false;
       renderAttendanceGrid();
    };

    window.toggleRefPayment = (id) => {
       if(!attendanceState[id]) attendanceState[id] = { present: false, paid: false };
       attendanceState[id].paid = !attendanceState[id].paid;
       renderAttendanceGrid();
    };

    function updateRefereeCalc() {
      const val = parseFloat(document.getElementById("refereeValue").value) || 0;
      const presentIds = Object.keys(attendanceState).filter(id => attendanceState[id].present);
      const count = presentIds.length;
      const perPlayer = count > 0 ? val / count : 0;
      const paidCount = presentIds.filter(id => attendanceState[id].paid).length;
      const totalPaid = paidCount * perPlayer;
      document.getElementById("refereePerPlayerDisplay").textContent = "$" + perPlayer.toLocaleString();
      document.getElementById("refereePaidTotal").textContent = "$" + totalPaid.toLocaleString();
      document.getElementById("selectedCount").textContent = count;
    }

    // === NUEVA FUNCIONALIDAD: PREVISUALIZAR ===
    window.openMatchPreview = () => {
      const gf = parseInt(document.getElementById("goalsScored").value) || 0;
      const gc = parseInt(document.getElementById("goalsConceded").value) || 0;
      const yc = parseInt(document.getElementById("yellowCards").value) || 0;
      const bc = parseInt(document.getElementById("blueCards").value) || 0;
      const rc = parseInt(document.getElementById("redCards").value) || 0;
      const refVal = parseFloat(document.getElementById("refereeValue").value) || 0;
      
      const presentIds = Object.keys(attendanceState).filter(id => attendanceState[id].present);
      if(presentIds.length === 0) return toast.show("Selecciona jugadores", "warning");

      let pts = 0, res = "Derrota";
      if(gf > gc) { pts = 3; res = "Victoria"; }
      else if(gf === gc) { pts = 1; res = "Empate"; }

      const refPayments = {};
      let paidCount = 0;
      presentIds.forEach(id => { 
          refPayments[id] = attendanceState[id].paid;
          if(attendanceState[id].paid) paidCount++;
      });
      
      const perPlayer = refVal / presentIds.length;
      const totalPaid = paidCount * perPlayer;

      // Guardar en variable temporal
      tempMatchData = {
         date: new Date().toISOString(),
         goalsScored: gf,
         goalsConceded: gc,
         yellowCards: yc,
         blueCards: bc,
         redCards: rc,
         refereeValue: refVal,
         refereePerPlayer: perPlayer,
         presentPlayers: presentIds,
         refereePayments: refPayments,
         points: pts,
         result: res
      };

      // Llenar Modal
      document.getElementById("prevGF").textContent = gf;
      document.getElementById("prevGC").textContent = gc;
      const resEl = document.getElementById("prevResult");
      resEl.textContent = res;
      resEl.style.color = res === 'Victoria' ? 'var(--success)' : res === 'Empate' ? 'var(--warning)' : 'var(--danger)';
      
      document.getElementById("prevCards").innerHTML = `üü® ${yc} | üü¶ ${bc} | üü• ${rc}`;
      document.getElementById("prevTotalRef").textContent = `$${refVal.toLocaleString()}`;
      document.getElementById("prevPerPlayer").textContent = `$${perPlayer.toLocaleString()}`;
      document.getElementById("prevPaid").textContent = `$${totalPaid.toLocaleString()}`;
      document.getElementById("prevCount").textContent = presentIds.length;

      // Generar lista de jugadores visual
      const playerHTML = presentIds.map(pid => {
          const p = players.find(pl => pl.id === pid);
          const isPaid = attendanceState[pid].paid;
          return `<div class="preview-player-chip ${isPaid ? 'paid' : 'not-paid'}">
              ${p.name} ${isPaid ? '<i class="fa-solid fa-check"></i>' : '<i class="fa-solid fa-xmark"></i>'}
          </div>`;
      }).join('');
      document.getElementById("prevPlayerList").innerHTML = playerHTML;

      // Mostrar Modal
      document.getElementById("previewMatchModal").classList.add("active");
    };

    // === NUEVA FUNCIONALIDAD: GUARDAR FINALMENTE ===
    window.confirmMatchSave = async () => {
      if(!tempMatchData) return;

      const newMatches = [...(tournamentData.matches || []), tempMatchData];
      
      const stats = tournamentData.stats || {};
      stats.points = (stats.points||0) + tempMatchData.points;
      stats.goalsScored = (stats.goalsScored||0) + tempMatchData.goalsScored;
      stats.goalsConceded = (stats.goalsConceded||0) + tempMatchData.goalsConceded;
      stats.yellowCards = (stats.yellowCards||0) + tempMatchData.yellowCards;
      stats.blueCards = (stats.blueCards||0) + tempMatchData.blueCards;
      stats.redCards = (stats.redCards||0) + tempMatchData.redCards;
      
      // Usamos getCollection("tournaments")
      await updateDoc(doc(getCollection("tournaments"), currentTournament), { matches: newMatches, stats });
      
      // Limpieza
      document.getElementById("goalsScored").value = 0;
      document.getElementById("goalsConceded").value = 0;
      document.getElementById("yellowCards").value = 0;
      document.getElementById("blueCards").value = 0;
      document.getElementById("redCards").value = 0;
      attendanceState = {};
      renderAttendanceGrid();
      
      document.getElementById("previewMatchModal").classList.remove("active");
      tempMatchData = null;

      await loadTournamentData();
      updateAllViews();
      toast.show("Partido Guardado Exitosamente", "success");
    };

    function updateMatchesList() {
      const list = document.getElementById("matchesList");
      const matches = (tournamentData.matches || []).slice().reverse();
      list.innerHTML = matches.map((m, idx) => {
        const realIdx = matches.length - 1 - idx;
        const color = m.result === 'Victoria' ? 'border-left: 4px solid var(--success)' : m.result === 'Empate' ? 'border-left: 4px solid var(--warning)' : 'border-left: 4px solid var(--danger)';
        return `<div class="card" style="${color}; padding: 15px; margin-bottom: 10px; background: rgba(30, 41, 59, 0.6);"><div style="display:flex; justify-content:space-between; align-items:center;"><div><span style="font-size:11px; color:var(--text-muted); text-transform:uppercase;">${new Date(m.date).toLocaleDateString()}</span><div style="font-size:20px; font-weight:800; margin-top:2px;">${m.goalsScored} - ${m.goalsConceded}</div><div style="font-size:12px; color:var(--text-secondary);">${m.result}</div></div><div style="text-align:right"><button class="btn btn-sm btn-info" onclick="openMatchModal(${realIdx})">Editar</button></div></div></div>`;
      }).join('');
    }

    function updateStatistics() {
       const matches = tournamentData.matches || [];
       const stats = tournamentData.stats || {};
       const manualMatches = tournamentData.manualMatches || 0;
       const totalMatches = matches.length + manualMatches;
       
       // RACHA
       const last5 = matches.slice(-5);
       const formContainer = document.getElementById("formGuideContainer");
       if(last5.length === 0) formContainer.innerHTML = '<span style="color:grey; font-size:11px;">Sin partidos</span>';
       else formContainer.innerHTML = last5.map(m => { let cls = 'dot-l', txt='P'; if(m.result === 'Victoria') { cls = 'dot-w'; txt='G'; } else if(m.result === 'Empate') { cls = 'dot-d'; txt='E'; } return `<div class="match-dot ${cls}">${txt}</div>`; }).join('');

       // FINANCIAL
       const paid = players.reduce((s, p) => s + (p.totalPaid||0), 0);
       let refPending = 0;
       matches.forEach(m => { if(m.refereePayments) { const pendingCount = m.presentPlayers.filter(pid => !m.refereePayments[pid]).length; refPending += pendingCount * m.refereePerPlayer; } });
       document.getElementById("totalCollected").textContent = "$" + paid.toLocaleString();
       document.getElementById("totalRefereePending").textContent = "$" + refPending.toLocaleString();

       // DETAILED AVERAGES TABLE
       const avgGF = totalMatches > 0 ? (stats.goalsScored / totalMatches).toFixed(2) : "0.00";
       const avgGC = totalMatches > 0 ? (stats.goalsConceded / totalMatches).toFixed(2) : "0.00";
       const avgPts = totalMatches > 0 ? (stats.points / totalMatches).toFixed(2) : "0.00";
       
       let cleanSheets = 0;
       let failedToScore = 0;
       let totalCards = (stats.yellowCards||0) + (stats.blueCards||0) + (stats.redCards||0);
       const avgCards = totalMatches > 0 ? (totalCards / totalMatches).toFixed(2) : "0.00";

       matches.forEach(m => {
          if(m.goalsConceded === 0) cleanSheets++;
          if(m.goalsScored === 0) failedToScore++;
       });

       const cleanSheetPct = totalMatches > 0 ? Math.round((cleanSheets/totalMatches)*100) : 0;
       const failedScorePct = totalMatches > 0 ? Math.round((failedToScore/totalMatches)*100) : 0;

       // Visual scale calc (Goals > 3/match is high)
       const scaleGF = Math.min((avgGF / 3) * 100, 100);
       const scaleGC = Math.min((avgGC / 3) * 100, 100);
       const scalePts = Math.min((avgPts / 3) * 100, 100);

       const detailedTableHTML = `
          <thead><tr><th>M√©trica</th><th class="numeric">Total</th><th class="numeric">Promedio / %</th></tr></thead>
          <tbody>
             <tr><td><strong class="text-success">Goles a Favor</strong></td><td class="numeric">${stats.goalsScored || 0}</td><td class="numeric"><span style="margin-right:8px;">${avgGF}</span><div class="stat-bar-container"><div class="stat-bar-fill bar-green" style="width:${scaleGF}%"></div></div></td></tr>
             <tr><td><strong class="text-danger">Goles en Contra</strong></td><td class="numeric">${stats.goalsConceded || 0}</td><td class="numeric"><span style="margin-right:8px;">${avgGC}</span><div class="stat-bar-container"><div class="stat-bar-fill bar-red" style="width:${scaleGC}%"></div></div></td></tr>
             <tr><td><strong class="text-gold">Puntos</strong></td><td class="numeric">${stats.points || 0}</td><td class="numeric"><span style="margin-right:8px;">${avgPts}</span><div class="stat-bar-container"><div class="stat-bar-fill bar-gold" style="width:${scalePts}%"></div></div></td></tr>
             <tr><td>Valla Invicta (Clean Sheets)</td><td class="numeric">${cleanSheets}</td><td class="numeric">${cleanSheetPct}%</td></tr>
             <tr><td>Sin Anotar</td><td class="numeric">${failedToScore}</td><td class="numeric">${failedScorePct}%</td></tr>
             <tr><td>Disciplina (Tarjetas)</td><td class="numeric">${totalCards}</td><td class="numeric">${avgCards}</td></tr>
          </tbody>
       `;
       document.getElementById("detailedStatsTable").innerHTML = detailedTableHTML;

       // PLAYER STATS
       playerStatsGlobal = players.map(p => {
         let played = 0;
         matches.forEach(m => { if(m.presentPlayers && m.presentPlayers.includes(p.id)) played++; });
         return { ...p, played, goals: 0, cards: 0 }; 
       });
       
       // MVP logic (Simplified by matches played for now)
       if (playerStatsGlobal.length > 0) {
         const mvp = playerStatsGlobal.reduce((prev, current) => (prev.played > current.played) ? prev : current);
         document.getElementById("topScorerName").textContent = mvp.name;
         document.getElementById("topScorerValue").textContent = mvp.played + " PJ"; 
       }

       renderPlayerStatsTable();
    }

    window.sortPlayerStats = () => {
       const sortBy = document.getElementById("playerStatsSortBy").value;
       if(sortBy === 'matches') playerStatsGlobal.sort((a,b) => b.played - a.played);
       renderPlayerStatsTable();
    }

    function renderPlayerStatsTable() {
       const tbody = document.getElementById("playerStatsTable");
       const maxPlayed = Math.max(...playerStatsGlobal.map(p => p.played)) || 1;
       tbody.innerHTML = playerStatsGlobal.map(p => {
         const barWidth = (p.played / maxPlayed) * 100;
         return `<tr><td><strong style="color:#fff">${p.name}</strong></td><td class="numeric">${p.played}<div class="stat-bar-container"><div class="stat-bar-fill bar-blue" style="width:${barWidth}%;"></div></div></td><td class="numeric text-success">--</td></tr>`;
       }).join('');
    }

    window.exportToCSV = (type) => {
      let csvContent = "data:text/csv;charset=utf-8,";
      let filename = "export.csv";
      if (type === 'players') {
        csvContent += "Nombre,Numero,Pagado\r\n";
        players.forEach(p => csvContent += `${p.name},${p.number},${p.totalPaid}\r\n`);
        filename = "jugadores.csv";
      } else if (type === 'payments') {
        csvContent += "Jugador,Debe,Pagado,Deuda\r\n";
        const cost = tournamentData.inscriptionPerPlayer || 0;
        players.forEach(p => csvContent += `${p.name},${cost},${p.totalPaid},${cost - p.totalPaid}\r\n`);
        filename = "pagos.csv";
      }
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", filename);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    };

    window.openTeamGenerator = () => {
       document.getElementById("teamGeneratorModal").classList.add("active");
       document.getElementById("teamAList").innerHTML = '<span style="color:grey">Esperando...</span>';
       document.getElementById("teamBList").innerHTML = '<span style="color:grey">Esperando...</span>';
    };

    window.generateTeams = () => {
       let pool = filteredPlayers.length > 0 ? [...filteredPlayers] : [...players];
       if (pool.length < 2) return toast.show("Se necesitan al menos 2 jugadores", "error");
       for (let i = pool.length - 1; i > 0; i--) {
           const j = Math.floor(Math.random() * (i + 1));
           [pool[i], pool[j]] = [pool[j], pool[i]];
       }
       const mid = Math.ceil(pool.length / 2);
       const teamA = pool.slice(0, mid);
       const teamB = pool.slice(mid);
       const renderList = (arr) => arr.map(p => `<div>‚Ä¢ ${p.name}</div>`).join('');
       document.getElementById("teamAList").innerHTML = renderList(teamA);
       document.getElementById("teamBList").innerHTML = renderList(teamB);
       toast.show("¬°Equipos generados!", "success");
    };

    window.openPaymentHistory = (id) => {
      const p = players.find(pl => pl.id === id);
      const list = document.getElementById("paymentHistoryList");
      list.innerHTML = (p.payments || []).map(pay => `<div style="display:flex; justify-content:space-between; padding:12px; border-bottom:1px solid rgba(255,255,255,0.05)"><span>${new Date(pay.date).toLocaleDateString()}</span><span class="text-success" style="font-weight:bold;">$${pay.amount.toLocaleString()}</span></div>`).join('') || '<p style="text-align:center; color:grey; padding:20px;">Sin pagos registrados</p>';
      document.getElementById("modalPlayerInfo").innerHTML = `<strong>${p.name}</strong> <span style="color:var(--text-secondary)">#${p.number}</span>`;
      document.getElementById("paymentModal").classList.add("active");
    };
    window.closePaymentModal = () => document.getElementById("paymentModal").classList.remove("active");

    window.openMatchModal = (idx) => {
      currentEditingMatchIndex = idx;
      document.getElementById("matchModal").classList.add("active");
    };
    window.closeMatchModal = () => document.getElementById("matchModal").classList.remove("active");

    window.openDebtModal = async () => {
      document.getElementById("debtModal").classList.add("active");
      document.getElementById("debtSummaryTotal").innerHTML = '<div style="text-align:center; padding:40px;"><i class="fa-solid fa-spinner fa-spin fa-2x"></i><br><br>Analizando deudas...</div>';
      try {
        const [t1Snap, t2Snap] = await Promise.all([
            getDoc(doc(getCollection("tournaments"), "torneo1")), 
            getDoc(doc(getCollection("tournaments"), "torneo2"))
        ]);
        const tournaments = { "torneo1": t1Snap.exists() ? t1Snap.data() : {}, "torneo2": t2Snap.exists() ? t2Snap.data() : {} };
        const playersSnap = await getDocs(getCollection("players"));
        const allPlayers = playersSnap.docs.map(d => ({id: d.id, ...d.data()}));
        let grandTotalDebt = 0;
        const playerMap = new Map();
        const normalize = (str) => str.trim().toLowerCase();
        for (const p of allPlayers) {
          const tKey = p.tournament;
          const tData = tournaments[tKey];
          if (!tData) continue;
          let inscriptionDebt = Math.max(0, (tData.inscriptionPerPlayer || 0) - (p.totalPaid || 0));
          let refereeDebt = 0;
          const matches = tData.matches || [];
          matches.forEach(m => {
            if (m.presentPlayers && m.presentPlayers.includes(p.id)) {
               if (!m.refereePayments || !m.refereePayments[p.id]) refereeDebt += (m.refereePerPlayer || 0);
            }
          });
          const total = inscriptionDebt + refereeDebt;
          if (total > 0) {
            const key = `${normalize(p.name)}_${p.number}`;
            if (!playerMap.has(key)) playerMap.set(key, { name: p.name, number: p.number, total: 0, inscription: 0, referee: 0, breakdown: [] });
            const entry = playerMap.get(key);
            entry.total += total;
            entry.inscription += inscriptionDebt;
            entry.referee += refereeDebt;
            entry.breakdown.push({ tournament: tKey === 'torneo1' ? 'T1' : 'T2', amount: total });
            grandTotalDebt += total;
          }
        }
        const debtReport = Array.from(playerMap.values());
        document.getElementById("debtSummaryTotal").innerHTML = `<div class="card" style="text-align:center; border: 1px solid var(--danger); background: rgba(239, 68, 68, 0.1); padding: 20px; margin-bottom: 0;"><div style="font-size:12px; color:var(--text-secondary); text-transform: uppercase; letter-spacing: 1px;">Deuda Total Acumulada</div><div style="font-size:36px; font-weight:800; color:#fff; font-family: 'Exo 2', sans-serif;">$${grandTotalDebt.toLocaleString()}</div><div style="font-size:13px; margin-top:5px; color: var(--danger); font-weight: 600;">${debtReport.length} Jugadores con pendientes</div></div>`;
        if (debtReport.length === 0) {
           document.getElementById("debtDetailsList").innerHTML = '<div style="text-align:center; padding:40px; color:var(--success)"><i class="fa-solid fa-check-circle fa-3x"></i><br><br>¬°Estamos al d√≠a!</div>';
        } else {
           debtReport.sort((a,b) => b.total - a.total);
           const rows = debtReport.map(d => {
             const breakdownText = d.breakdown.map(b => `<span class="badge badge-warning" style="font-size:10px;">${b.tournament}: $${b.amount.toLocaleString()}</span>`).join(' ');
             return `<div style="display:flex; justify-content:space-between; align-items:center; padding:14px; border-bottom:1px solid rgba(255,255,255,0.05); font-size:13px;"><div><div style="font-weight:bold; color:#fff; font-size: 14px;">${d.name}</div><div style="margin-top:6px; display:flex; gap:6px;">${breakdownText}</div><div style="color:var(--text-muted); font-size:11px; margin-top:4px;">(Insc: $${d.inscription.toLocaleString()} | Arb: $${d.referee.toLocaleString()})</div></div><div style="font-weight:bold; color:var(--danger); font-size:16px;">$${d.total.toLocaleString()}</div></div>`;
           }).join('');
           document.getElementById("debtDetailsList").innerHTML = `<div style="max-height:300px; overflow-y:auto; background: rgba(0,0,0,0.2); border-radius:12px; border: 1px solid rgba(255,255,255,0.05);">${rows}</div>`;
        }
      } catch (e) {
        console.error(e);
        document.getElementById("debtSummaryTotal").innerHTML = '<div class="text-danger text-center">Error cargando reporte.</div>';
      }
    };
    window.closeDebtModal = () => document.getElementById("debtModal").classList.remove("active");

    function updateAllViews() {
       updatePlayersTable();
       updatePaymentsTable();
       renderAttendanceGrid();
       updateMatchesList();
       updateStatistics();
    }

    window.onload = async () => {
      await initAuth();
      onAuthStateChanged(auth, (user) => {
          if (user) {
              updateConnectionStatus("Conectado", "connected");
              selectTournament("torneo1");
          } else {
             updateConnectionStatus("Desconectado", "error");
             toast.show("No se pudo iniciar sesi√≥n", "error");
          }
      });
    };

    window.updateTournamentName = async () => {
       const name = document.getElementById("tournamentName").value;
       // Usamos getCollection("tournaments")
       await updateDoc(doc(getCollection("tournaments"), currentTournament), { name });
       toast.show("Nombre actualizado", "success");
    };
    
    window.confirmResetTournament = async () => {
       if(!confirm("¬øSeguro? Se borrar√° todo menos jugadores.")) return;
       // Usamos getCollection("tournaments")
       await updateDoc(doc(getCollection("tournaments"), currentTournament), { matches: [], stats: {}, totalInscription: 0 });
       // Usamos getCollection("players")
       for(let p of players) { await updateDoc(doc(getCollection("players"), p.id), { payments: [], totalPaid: 0 }); }
       await selectTournament(currentTournament);
    };
  </script>
</body>
</html>

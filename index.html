<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CONSTRU-SANTAMARIA | CRM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Outfit', 'sans-serif'] },
                    colors: {
                        dark: '#0F172A', surface: '#1E293B', primary: '#F59E0B', secondary: '#3B82F6',
                        success: '#10B981', danger: '#EF4444', warning: '#F59E0B'
                    }
                }
            }
        }
        // ChartJS defaults
        Chart.defaults.color = '#94a3b8';
        Chart.defaults.borderColor = '#334155';
        Chart.defaults.font.family = "'Outfit', sans-serif";
    </script>
    <style>
        body { background-color: #0F172A; color: #E2E8F0; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.05); }
        .nav-item.active { background: rgba(245, 158, 11, 0.15); color: #FCD34D; border-left: 3px solid #F59E0B; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        .fade-in-up { animation: fadeInUp 0.3s ease-out; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .badge-tournament { font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; background: rgba(255,255,255,0.1); margin-left: auto; }
        .badge-source { font-size: 0.6rem; padding: 1px 4px; border-radius: 3px; margin-left: 4px; opacity: 0.7; }
        
        /* Estilos Cancha */
        .soccer-pitch {
            background-color: #2f855a;
            background-image: 
                linear-gradient(rgba(255,255,255,0.1) 2px, transparent 2px),
                linear-gradient(90deg, rgba(255,255,255,0.1) 2px, transparent 2px),
                linear-gradient(rgba(255,255,255,0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 100px 100px, 100px 100px, 20px 20px, 20px 20px;
            background-position: -2px -2px, -2px -2px, -1px -1px, -1px -1px;
            border: 2px solid rgba(255,255,255,0.3);
            position: relative; overflow: hidden; border-radius: 8px;
        }
        .pitch-center-circle { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 80px; height: 80px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; }
        .pitch-half-line { position: absolute; top: 50%; left: 0; width: 100%; height: 2px; background: rgba(255,255,255,0.3); }
        .pitch-area-top { position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 40%; height: 15%; border: 2px solid rgba(255,255,255,0.3); border-top: none; }
        .pitch-area-bottom { position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 40%; height: 15%; border: 2px solid rgba(255,255,255,0.3); border-bottom: none; }
        .player-node { position: absolute; transform: translate(-50%, -50%); width: 44px; height: 44px; background: #1E293B; border: 2px solid #F59E0B; color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.3); transition: all 0.2s; z-index: 10; }
        .player-node:hover { transform: translate(-50%, -50%) scale(1.1); background: #F59E0B; color: #0F172A; }
        .player-node-label { position: absolute; bottom: -20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); padding: 2px 6px; border-radius: 4px; font-size: 10px; white-space: nowrap; color: white; pointer-events: none; }
        
        /* Table Styles */
        .stat-header { @apply text-[10px] uppercase text-gray-500 font-bold tracking-wider pb-2 text-center; }
        .stat-cell { @apply py-3 text-center text-sm border-b border-gray-800; }
    </style>
</head>
<body class="h-screen flex overflow-hidden text-sm">

    <aside class="w-64 bg-surface border-r border-gray-800 flex-shrink-0 hidden md:flex flex-col">
        <div class="p-6 flex items-center gap-3">
            <div class="w-10 h-10 rounded-lg bg-primary flex items-center justify-center text-dark font-bold text-xl shadow-lg shadow-amber-500/20">
                <i class="fa-solid fa-helmet-safety"></i>
            </div>
            <div><h1 class="font-bold text-sm tracking-wide text-white leading-tight">CONSTRU<br>SANTAMARIA</h1></div>
        </div>

        <div class="px-4 mb-6">
            <div class="bg-dark p-4 rounded-xl border border-gray-700">
                <div class="text-[10px] text-gray-500 uppercase font-bold tracking-wider mb-2">Torneos Detectados</div>
                <div id="tournamentButtons" class="flex flex-col gap-2 max-h-40 overflow-y-auto">
                    <div class="text-xs text-gray-500 text-center py-2"><i class="fa-solid fa-spinner fa-spin"></i> Buscando datos...</div>
                </div>
                <div class="mt-2 pt-2 border-t border-gray-700">
                     <button onclick="window.createOfficialTournament('Interempresas anillo vial')" class="w-full text-left text-[10px] text-primary hover:text-white py-1">+ Interempresas anillo vial</button>
                     <button onclick="window.createOfficialTournament('Intercompany HIC')" class="w-full text-left text-[10px] text-primary hover:text-white py-1">+ Intercompany HIC</button>
                </div>
            </div>
        </div>

        <nav class="flex-1 px-2 space-y-1 overflow-y-auto">
            <button id="nav-dashboard" onclick="window.showView('dashboard')" class="nav-item active w-full flex items-center gap-3 px-4 py-3 text-gray-400 hover:text-white rounded-lg transition"><i class="fa-solid fa-chart-pie w-5 text-center"></i> Dashboard</button>
            <button id="nav-tactics" onclick="window.showView('tactics')" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-gray-400 hover:text-white rounded-lg transition"><i class="fa-solid fa-clipboard-list w-5 text-center"></i> Pizarra T치ctica</button>
            <button id="nav-players" onclick="window.showView('players')" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-gray-400 hover:text-white rounded-lg transition"><i class="fa-solid fa-users w-5 text-center"></i> Jugadores</button>
            <button id="nav-matches" onclick="window.showView('matches')" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-gray-400 hover:text-white rounded-lg transition"><i class="fa-solid fa-futbol w-5 text-center"></i> Partidos</button>
            <button id="nav-stats" onclick="window.showView('stats')" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-gray-400 hover:text-white rounded-lg transition"><i class="fa-solid fa-chart-simple w-5 text-center"></i> Estad칤sticas</button>
            <button id="nav-finances" onclick="window.showView('finances')" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-gray-400 hover:text-white rounded-lg transition"><i class="fa-solid fa-money-bill-wave w-5 text-center"></i> Finanzas</button>
            <button id="nav-settings" onclick="window.showView('settings')" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-gray-400 hover:text-white rounded-lg transition"><i class="fa-solid fa-gear w-5 text-center"></i> Configuraci칩n</button>
        </nav>
        <div class="p-4"><div id="connectionStatus" class="text-xs text-center text-gray-500 bg-gray-900 py-2 rounded border border-gray-800"><i class="fa-solid fa-circle-notch fa-spin mr-1"></i> Iniciando...</div></div>
    </aside>

    <div class="md:hidden fixed top-0 w-full bg-surface z-50 flex justify-between items-center p-4 border-b border-gray-800 shadow-lg">
        <div class="flex items-center gap-2"><i class="fa-solid fa-helmet-safety text-primary"></i><div><span class="font-bold text-white block leading-none text-xs">CONSTRU-SANTAMARIA</span><div id="mobileTournamentBadge" class="text-[10px] text-primary font-bold mt-0.5">CARGANDO...</div></div></div>
        <button onclick="document.querySelector('aside').classList.toggle('hidden'); document.querySelector('aside').classList.toggle('absolute'); document.querySelector('aside').classList.toggle('z-50'); document.querySelector('aside').classList.toggle('h-full');" class="text-white text-xl"><i class="fa-solid fa-bars"></i></button>
    </div>

    <main class="flex-1 overflow-y-auto bg-dark relative md:pt-0 pt-20">
        
        <div id="view-dashboard" class="p-6 max-w-6xl mx-auto fade-in-up">
            <div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold text-white flex items-center gap-2"><i class="fa-solid fa-chart-line text-primary"></i> Resumen General</h2><span id="dashTournamentName" class="text-xs font-mono text-gray-500 bg-gray-800 px-2 py-1 rounded">...</span></div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                <div class="glass p-5 rounded-2xl border-l-4 border-success"><div class="text-gray-400 text-xs uppercase tracking-wide mb-1">Recaudado</div><div class="text-2xl font-bold text-white" id="dashCollected">$0</div><div class="text-[10px] text-gray-500 mt-1">Inscripciones</div></div>
                <div class="glass p-5 rounded-2xl border-l-4 border-danger"><div class="text-gray-400 text-xs uppercase tracking-wide mb-1">Deuda Total</div><div class="text-2xl font-bold text-white" id="dashDebt">$0</div><div class="text-[10px] text-gray-500 mt-1">Inscripci칩n + Multas</div></div>
                <div class="glass p-5 rounded-2xl border-l-4 border-primary relative"><div class="text-gray-400 text-xs uppercase tracking-wide mb-1">Promedio Goles</div><div class="flex justify-between items-end"><div><div class="text-xl font-bold text-success"><i class="fa-solid fa-arrow-up text-xs mr-1"></i><span id="dashAvgGF">0.0</span></div><div class="text-[10px] text-gray-500">Anotados/P</div></div><div class="text-right"><div class="text-xl font-bold text-red-400"><i class="fa-solid fa-arrow-down text-xs mr-1"></i><span id="dashAvgGC">0.0</span></div><div class="text-[10px] text-gray-500">Recibidos/P</div></div></div></div>
                <div class="glass p-5 rounded-2xl border-l-4 border-yellow-500"><div class="text-gray-400 text-xs uppercase tracking-wide mb-1">Disciplina</div><div class="flex justify-between items-center"><div><div class="text-2xl font-bold text-white" id="dashAvgCards">0.0</div><div class="text-[10px] text-gray-500">Tarjetas/Partido</div></div><div class="text-right"><div class="text-xs font-bold text-white truncate w-20" id="dashBadBoyName">-</div><div class="text-[10px] text-yellow-500"><span id="dashBadBoyAvg">0.0</span>/P (M치s Alto)</div></div></div></div>
            </div>

            <div class="glass p-6 rounded-2xl mb-8 border border-gray-700 relative overflow-hidden group">
                <div class="absolute top-0 right-0 p-4 opacity-5 group-hover:opacity-10 transition duration-500">
                    <i class="fa-solid fa-trophy text-9xl text-white transform rotate-12"></i>
                </div>
                <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2 relative z-10">
                    <i class="fa-solid fa-ranking-star text-primary"></i> Rendimiento del Equipo
                </h3>
                
                <div class="overflow-x-auto relative z-10">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="border-b border-gray-700">
                                <th class="stat-header text-left pl-4">Equipo</th>
                                <th class="stat-header" title="Partidos Jugados">PJ</th>
                                <th class="stat-header text-success" title="Partidos Ganados">PG</th>
                                <th class="stat-header text-yellow-500" title="Partidos Empatados">PE</th>
                                <th class="stat-header text-red-500" title="Partidos Perdidos">PP</th>
                                <th class="stat-header" title="Goles a Favor">GF</th>
                                <th class="stat-header" title="Goles en Contra">GC</th>
                                <th class="stat-header" title="Diferencia de Gol">DG</th>
                                <th class="stat-header text-primary text-base">PTS</th>
                            </tr>
                        </thead>
                        <tbody id="teamStatsTableBody" class="text-gray-300">
                            <tr><td colspan="9" class="text-center py-4 text-xs text-gray-500">Cargando datos...</td></tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="mt-4 relative z-10">
                    <div class="flex justify-between text-[10px] text-gray-400 mb-1 uppercase font-bold tracking-wider">
                        <span>Victorias</span>
                        <span>Empates</span>
                        <span>Derrotas</span>
                    </div>
                    <div class="w-full h-2 bg-gray-800 rounded-full flex overflow-hidden" id="performanceBar">
                        <div class="bg-success h-full w-0" id="barWins"></div>
                        <div class="bg-yellow-500 h-full w-0" id="barDraws"></div>
                        <div class="bg-danger h-full w-0" id="barLosses"></div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="glass rounded-2xl p-6"><h3 class="text-lg font-bold text-white mb-4">Top Goleadores</h3><div class="overflow-x-auto"><table class="w-full text-left border-collapse"><tbody id="topScorersTable" class="text-gray-300 divide-y divide-gray-800"></tbody></table></div></div>
                <div class="glass rounded-2xl p-6"><h3 class="text-lg font-bold text-white mb-4">Racha Reciente</h3><div id="recentMatchesList" class="space-y-3"></div></div>
            </div>
        </div>

        <div id="view-tactics" class="p-6 max-w-4xl mx-auto hidden fade-in-up">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-white">Pizarra T치ctica</h2>
                <div class="flex gap-3"><select id="formationSelect" onchange="window.renderFormation()" class="bg-dark border border-gray-700 text-white rounded px-3 py-1 text-sm"></select><button onclick="window.saveLineup()" class="bg-primary text-dark px-3 py-1 rounded text-sm font-bold hover:bg-amber-600">Guardar</button></div>
            </div>
            <div class="text-xs text-gray-400 mb-2 flex gap-2 items-center"><i class="fa-solid fa-circle-info"></i> <span id="tacticsInfo">Detectando...</span></div>
            <div class="relative w-full aspect-[2/3] md:aspect-[3/4] lg:aspect-[4/3] max-h-[600px] mx-auto soccer-pitch rounded-xl shadow-2xl shadow-green-900/20" id="pitchContainer"><div class="pitch-half-line"></div><div class="pitch-center-circle"></div><div class="pitch-area-top"></div><div class="pitch-area-bottom"></div></div>
            <div class="mt-6"><h3 class="text-white font-bold mb-2">Suplentes / No Convocados</h3><div id="benchList" class="flex flex-wrap gap-2"></div></div>
        </div>

        <div id="view-stats" class="p-6 max-w-7xl mx-auto hidden fade-in-up">
            <h2 class="text-2xl font-bold text-white mb-6">An치lisis Detallado</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="glass p-4 rounded-xl border border-gray-700">
                    <h4 class="text-xs font-bold text-gray-400 mb-2 uppercase text-center">Balance de Resultados</h4>
                    <div class="h-40 relative"><canvas id="resultsChart"></canvas></div>
                </div>
                <div class="glass p-4 rounded-xl border border-gray-700 col-span-1 md:col-span-2">
                    <h4 class="text-xs font-bold text-gray-400 mb-2 uppercase text-center">Evoluci칩n de Goles</h4>
                    <div class="h-40 w-full"><canvas id="goalsTrendChart"></canvas></div>
                </div>
                <div class="glass p-4 rounded-xl border border-gray-700">
                    <h4 class="text-xs font-bold text-gray-400 mb-2 uppercase text-center">Estado Financiero</h4>
                    <div class="h-40 relative"><canvas id="financeChart"></canvas></div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <div class="glass p-4 rounded-xl border border-gray-700">
                    <h4 class="text-xs font-bold text-gray-400 mb-2 uppercase text-center">Top Goleadores</h4>
                    <div class="h-60 w-full"><canvas id="scorersChart"></canvas></div>
                </div>
                <div class="glass p-4 rounded-xl border border-gray-700">
                    <h4 class="text-xs font-bold text-gray-400 mb-2 uppercase text-center">Disciplina (Tarjetas)</h4>
                    <div class="h-60 w-full"><canvas id="cardsChart"></canvas></div>
                </div>
            </div>

            <div class="glass p-4 rounded-xl border border-gray-700 mb-8">
                <h4 class="text-xs font-bold text-gray-400 mb-2 uppercase text-center">Asistencia a Partidos</h4>
                <div class="h-48 w-full"><canvas id="attendanceChart"></canvas></div>
            </div>

            <div class="glass rounded-2xl p-6 overflow-x-auto">
                <h3 class="text-lg font-bold text-white mb-4">Tabla Estad칤stica General</h3>
                <table class="w-full text-left text-sm text-gray-300">
                    <thead class="text-xs uppercase text-gray-500 border-b border-gray-700">
                        <tr>
                            <th class="pb-3 pl-2">Jugador</th>
                            <th class="pb-3 text-center">PJ</th>
                            <th class="pb-3 text-center text-success">G</th>
                            <th class="pb-3 text-center text-gray-400 text-[10px]">Prom G</th>
                            <th class="pb-3 text-center text-yellow-500">A</th>
                            <th class="pb-3 text-center text-blue-400">Az</th>
                            <th class="pb-3 text-center text-red-500">R</th>
                            <th class="pb-3 text-right text-danger">Deuda Multas</th>
                        </tr>
                    </thead>
                    <tbody id="statsTableBody" class="divide-y divide-gray-800"></tbody>
                </table>
            </div>
        </div>

        <div id="view-players" class="p-6 max-w-6xl mx-auto hidden fade-in-up">
             <div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold text-white">Plantilla</h2><button onclick="window.openPlayerModal()" class="bg-primary hover:bg-amber-600 text-dark px-4 py-2 rounded-lg font-bold transition shadow-lg shadow-amber-900/20"><i class="fa-solid fa-plus mr-2"></i> Nuevo</button></div>
             <div class="glass rounded-2xl p-4 mb-6 sticky top-0 z-10 backdrop-blur-xl"><input type="text" id="searchPlayer" placeholder="Buscar..." class="w-full bg-dark border border-gray-700 rounded-lg pl-4 py-3 text-white focus:border-primary focus:outline-none transition" onkeyup="window.renderPlayers()"></div>
             <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4" id="playersGrid"></div>
        </div>

        <div id="view-matches" class="p-6 max-w-4xl mx-auto hidden fade-in-up">
            <h2 class="text-2xl font-bold text-white mb-6">Gesti칩n de Partidos</h2>
            <div class="glass rounded-2xl p-6 mb-8 border-t-4 border-primary" id="matchFormCard">
                <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-white text-lg" id="matchFormTitle">Registrar Resultado</h3><button onclick="window.resetMatchForm()" class="text-xs text-gray-400 hover:text-white bg-gray-800 px-3 py-1 rounded-full">Limpiar</button></div>
                <div class="flex items-center justify-center gap-4 md:gap-8 mb-8">
                    <div class="text-center"><div class="text-[10px] md:text-xs text-primary mb-2 font-bold tracking-wider">CONSTRU</div><input type="number" id="gf" class="w-16 h-16 md:w-20 md:h-20 text-3xl md:text-4xl font-bold text-center bg-dark border border-gray-700 rounded-xl text-success focus:outline-none" value="0" min="0"></div>
                    <span class="text-xl md:text-2xl font-bold text-gray-600">VS</span>
                    <div class="text-center"><div class="text-[10px] md:text-xs text-gray-400 mb-2 font-bold tracking-wider">RIVAL</div><input type="number" id="gc" class="w-16 h-16 md:w-20 md:h-20 text-3xl md:text-4xl font-bold text-center bg-dark border border-gray-700 rounded-xl text-danger focus:outline-none" value="0" min="0"></div>
                </div>
                <div class="mb-6"><label class="block text-xs text-gray-400 mb-1 font-bold uppercase">Costo Arbitraje Total</label><input type="number" id="refPrice" class="w-full bg-dark border border-gray-700 rounded-lg px-4 py-2 text-white font-mono text-primary text-lg" placeholder="$" oninput="window.calcRef()"></div>
                <div class="grid grid-cols-3 gap-2 mb-6 text-center">
                    <div><label class="text-[10px] text-yellow-500 font-bold">AMARILLAS</label><input id="yc" type="number" class="w-full bg-dark border border-gray-700 rounded text-center text-white" value="0"></div>
                    <div><label class="text-[10px] text-blue-400 font-bold">AZULES</label><input id="bc" type="number" class="w-full bg-dark border border-gray-700 rounded text-center text-white" value="0"></div>
                    <div><label class="text-[10px] text-red-500 font-bold">ROJAS</label><input id="rc" type="number" class="w-full bg-dark border border-gray-700 rounded text-center text-white" value="0"></div>
                </div>
                <div class="bg-dark/50 rounded-xl p-4 border border-gray-700/50 mb-6">
                    <div class="flex justify-between items-center mb-4"><span class="text-sm font-bold text-gray-300 flex items-center gap-2">Convocatoria</span><span class="text-xs text-primary bg-primary/10 px-2 py-1 rounded" id="convocadosCount">0 seleccionados</span></div>
                    <button onclick="window.openPlayerStatsModal()" class="w-full bg-gray-700 hover:bg-gray-600 text-white py-2 rounded-lg mb-4 text-xs font-bold border border-gray-600 flex items-center justify-center gap-2">游닇 Registrar Goles y Tarjetas Individuales</button>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 max-h-80 overflow-y-auto p-1" id="matchPlayersGrid"></div>
                    <div class="mt-4 flex justify-between items-center text-xs md:text-sm border-t border-gray-700 pt-3">
                        <div><div class="text-gray-400">Costo/Jugador: <span id="costPerPlayer" class="text-white font-bold ml-1">$0</span></div></div>
                        <div class="text-right"><div class="text-gray-400">Arbitraje: <span id="totalCollectedMatch" class="text-success font-bold ml-1">$0</span></div><div class="text-gray-400">Multas: <span id="totalFinesCollectedMatch" class="text-warning font-bold ml-1">$0</span></div></div>
                    </div>
                </div>
                <input type="hidden" id="editingMatchId" value="">
                <button onclick="window.saveMatch()" class="w-full bg-gradient-to-r from-amber-600 to-amber-500 hover:from-amber-500 hover:to-amber-400 text-white font-bold py-3 rounded-xl shadow-lg transition flex justify-center items-center gap-2"><span id="saveMatchBtnText">Guardar Partido</span></button>
            </div>
            <div class="flex justify-between items-end mb-4"><h3 class="text-lg font-bold text-white">Historial Completo</h3><span class="text-xs text-gray-500" id="totalMatchesCount">0 partidos</span></div>
            <div id="fullMatchesList" class="space-y-4 pb-10"></div>
        </div>

        <div id="view-finances" class="p-6 max-w-6xl mx-auto hidden fade-in-up">
            <h2 class="text-2xl font-bold text-white mb-6">Control Financiero</h2>
            <div class="glass rounded-2xl p-6 mb-6">
                <h3 class="text-lg font-bold text-white mb-4">Registrar Abono</h3>
                <div class="flex flex-col md:flex-row gap-4 items-end"><div class="flex-1 w-full"><label class="block text-xs text-gray-400 mb-1">Jugador</label><select id="payPlayerSelect" class="w-full bg-dark border border-gray-700 rounded-lg px-4 py-2.5 text-white focus:border-primary outline-none"></select></div><div class="w-full md:w-48"><label class="block text-xs text-gray-400 mb-1">Monto</label><input type="number" id="payAmount" class="w-full bg-dark border border-gray-700 rounded-lg px-4 py-2.5 text-white focus:border-primary outline-none" placeholder="$"></div><button onclick="window.addPayment()" class="w-full md:w-auto bg-success hover:bg-emerald-600 text-white px-6 py-2.5 rounded-lg font-medium transition">Registrar</button></div>
            </div>
            <div class="glass rounded-2xl p-6 overflow-x-auto"><table class="w-full text-left text-sm text-gray-300"><thead class="text-xs uppercase text-gray-500 border-b border-gray-700"><tr><th class="pb-3 pl-2">Jugador</th><th class="pb-3 text-right">Costo Insc.</th><th class="pb-3 text-right">Abonado</th><th class="pb-3 text-right">Deuda Insc.</th><th class="pb-3 text-right text-danger font-bold">Deuda Multas</th><th class="pb-3 text-right">Total Deuda</th><th class="pb-3 text-center">Acci칩n</th></tr></thead><tbody id="financesTableBody" class="divide-y divide-gray-800"></tbody></table></div>
        </div>

        <div id="view-settings" class="p-6 max-w-2xl mx-auto hidden fade-in-up">
            <h2 class="text-2xl font-bold text-white mb-6">Configuraci칩n</h2>
            <div class="glass rounded-2xl p-6 space-y-6">
                <div><label class="block text-sm text-gray-400 mb-1">Nombre del Torneo</label><input type="text" id="confName" class="w-full bg-dark border border-gray-700 rounded-lg px-4 py-2 text-white mb-4"><label class="block text-sm text-gray-400 mb-1">Costo Inscripci칩n Total</label><input type="number" id="confPrice" class="w-full bg-dark border border-gray-700 rounded-lg px-4 py-2 text-white"><p class="text-xs text-gray-500 mt-2 mb-4">Se dividir치 entre los jugadores.</p><button onclick="window.saveConfiguration()" class="w-full bg-primary hover:bg-amber-600 text-dark font-bold py-3 rounded-lg transition">Guardar y Recalcular Cuotas</button></div>
                <div class="pt-6 border-t border-gray-700 mt-6"><h4 class="text-danger font-bold mb-2">Zona de Peligro</h4><div class="flex flex-col gap-2"><button onclick="window.confirmResetTournament()" class="text-xs bg-red-900/30 text-red-400 border border-red-900 hover:bg-red-900/50 px-4 py-3 rounded transition w-full text-left flex items-center gap-2"><i class="fa-solid fa-eraser"></i> Reiniciar Datos</button><button onclick="window.purgeTrashTournaments()" class="text-xs bg-red-600 text-white border border-red-500 hover:bg-red-700 px-4 py-3 rounded transition w-full text-left flex items-center gap-2 font-bold"><i class="fa-solid fa-broom"></i> 游빛 Eliminar Torneos Basura</button><button onclick="window.deleteCurrentTournament()" class="text-xs bg-red-600 text-white border border-red-500 hover:bg-red-700 px-4 py-3 rounded transition w-full text-left flex items-center gap-2 font-bold"><i class="fa-solid fa-trash"></i> Eliminar ESTE Torneo</button></div></div>
            </div>
        </div>
    </main>

    <div id="playerModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden z-[60] flex items-center justify-center p-4"><div class="bg-surface border border-gray-700 rounded-2xl w-full max-w-md p-6 relative shadow-2xl"><button onclick="window.closeModal('playerModal')" class="absolute top-4 right-4 text-gray-400 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button><h3 class="text-xl font-bold text-white mb-4" id="playerModalTitle">Nuevo Jugador</h3><input type="hidden" id="editPlayerId"><div class="space-y-4"><div><label class="block text-xs text-gray-400 mb-1">Nombre</label><input type="text" id="playerModalName" class="w-full bg-dark border border-gray-700 rounded-lg px-4 py-2 text-white"></div><div><label class="block text-xs text-gray-400 mb-1">Dorsal</label><input type="number" id="playerModalNum" class="w-full bg-dark border border-gray-700 rounded-lg px-4 py-2 text-white"></div><button onclick="window.savePlayerForm()" class="w-full bg-primary hover:bg-amber-600 text-dark py-2 rounded-lg font-bold mt-2">Guardar</button></div></div></div>
    
    <div id="playerStatsModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden z-[80] flex items-center justify-center p-4"><div class="bg-surface border border-gray-700 rounded-2xl w-full max-w-lg p-0 relative shadow-2xl h-[80vh] flex flex-col"><div class="bg-dark p-4 border-b border-gray-700 flex justify-between items-center"><h3 class="font-bold text-white">Estad칤sticas Individuales</h3><button onclick="window.closeModal('playerStatsModal')" class="text-gray-400 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button></div><div class="p-4 flex-1 overflow-y-auto" id="playerStatsInputs"></div><div class="p-4 bg-dark border-t border-gray-700"><button onclick="window.closeModal('playerStatsModal'); window.renderMatchSelector(); window.autoSumGlobalStats();" class="w-full bg-success hover:bg-emerald-600 text-white py-3 rounded-lg font-bold">Confirmar y Volver</button></div></div></div>
    
    <div id="historyModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden z-[60] flex items-center justify-center p-4"><div class="bg-surface border border-gray-700 rounded-2xl w-full max-w-md p-6 relative shadow-2xl h-[500px] flex flex-col"><button onclick="window.closeModal('historyModal')" class="absolute top-4 right-4 text-gray-400 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button><h3 class="text-xl font-bold text-white mb-1" id="historyModalTitle">Historial</h3><div class="flex-1 overflow-y-auto pr-2" id="historyList"></div></div></div>
    <div id="matchDetailModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden z-[60] flex items-center justify-center p-4"><div class="bg-surface border border-gray-700 rounded-2xl w-full max-w-lg p-0 relative shadow-2xl overflow-hidden"><div class="bg-dark p-4 border-b border-gray-700 flex justify-between items-center"><h3 class="font-bold text-white">Detalles del Partido</h3><button onclick="window.closeModal('matchDetailModal')" class="text-gray-400 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button></div><div class="p-6 max-h-[70vh] overflow-y-auto"><div class="flex justify-center items-center mb-6 text-center"><div><div class="text-4xl font-bold text-white" id="mdScore"></div><div class="text-xs text-gray-500 mt-1" id="mdDate"></div></div></div><div class="grid grid-cols-3 gap-2 text-center mb-6 bg-gray-800/50 p-3 rounded-xl"><div><div class="text-xs text-yellow-500 font-bold">Ama</div><div id="mdYC" class="text-white font-mono">0</div></div><div><div class="text-xs text-blue-400 font-bold">Azul</div><div id="mdBC" class="text-white font-mono">0</div></div><div><div class="text-xs text-red-500 font-bold">Roja</div><div id="mdRC" class="text-white font-mono">0</div></div></div><div class="space-y-2" id="mdPlayerList"></div><div class="mt-6 pt-4 border-t border-gray-700 flex justify-between items-center text-sm"><span class="text-gray-400">Costo Total Arbitraje:</span><span class="text-white font-bold" id="mdRefTotal">$0</span></div></div></div></div>
    <div id="playerPickModal" class="fixed inset-0 bg-black/90 backdrop-blur-sm hidden z-[90] flex items-center justify-center p-4"><div class="bg-surface border border-gray-700 rounded-2xl w-full max-w-xs p-4"><h3 class="text-center text-white font-bold mb-4">Seleccionar Jugador</h3><div id="playerPickList" class="space-y-2 max-h-60 overflow-y-auto"></div><button onclick="window.closeModal('playerPickModal')" class="w-full mt-4 bg-gray-700 text-white py-2 rounded">Cancelar</button></div></div>
    <div id="toast" class="fixed bottom-5 left-1/2 transform -translate-x-1/2 bg-surface border border-gray-700 text-white px-6 py-3 rounded-xl shadow-2xl flex items-center gap-3 opacity-0 pointer-events-none transition-opacity duration-300 z-[70]"><i class="fa-solid fa-info-circle text-primary"></i><span id="toastMsg">Mensaje</span></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, doc, onSnapshot, setDoc, updateDoc, deleteDoc, query, where, getDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, setPersistence, inMemoryPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBXylL77z6EPDy2EuXVLLF_hkW8CyQvns4",
            authDomain: "crm-futbol.firebaseapp.com",
            projectId: "crm-futbol",
            storageBucket: "crm-futbol.firebasestorage.app",
            messagingSenderId: "222709021751",
            appId: "1:222709021751:web:94168589472c2ee938d3b2"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const getCollection = (name) => collection(db, name);

        const FINE_VALUES = { yellow: 5000, red: 10000, blue: 15000 };
        const formatCOP = (amount) => new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(amount);
        const OFFICIAL_TOURNAMENTS = ["Interempresas anillo vial", "Intercompany HIC"];
        const FORMATIONS = { 5: [{ id: '1-2-1', name: '1-2-1 (Diamante)', pos: [[50, 85], [20, 50], [80, 50], [50, 20]] }, { id: '2-2', name: '2-2 (Cuadrado)', pos: [[30, 75], [70, 75], [30, 25], [70, 25]] }, { id: '3-1', name: '3-1 (Muro)', pos: [[50, 80], [20, 60], [80, 60], [50, 20]] }], 6: [{ id: '2-2-1', name: '2-2-1 (Equilibrio)', pos: [[30, 80], [70, 80], [20, 45], [80, 45], [50, 20]] }, { id: '3-1-1', name: '3-1-1 (Defensiva)', pos: [[50, 80], [20, 70], [80, 70], [50, 45], [50, 20]] }, { id: '2-1-2', name: '2-1-2 (Ofensiva)', pos: [[30, 80], [70, 80], [50, 50], [30, 20], [70, 20]] }, { id: '1-3-1', name: '1-3-1 (Posesi칩n)', pos: [[50, 80], [20, 50], [50, 50], [80, 50], [50, 15]] }] };

        let currentTournament = null;
        let currentTournamentCollection = "tournaments"; 
        let currentPlayersCollection = "players"; 
        let players = [];
        let tournamentData = {};
        let matchSelection = {}; 
        let currentLineup = {};
        let activePosIndex = null;
        let charts = {};

        const safeText = (id, txt) => { const el = document.getElementById(id); if(el) el.textContent = txt; };
        const safeVal = (id, val) => { const el = document.getElementById(id); if(el) el.value = val; };

        window.selectTournament = (tId, tColl = "tournaments", pColl = "players") => {
            currentTournament = tId;
            currentTournamentCollection = tColl;
            currentPlayersCollection = pColl;
            loadData();
            loadTournamentsList(); 
        };

        window.showView = (viewName) => {
            document.querySelectorAll('main > div').forEach(div => div.classList.add('hidden'));
            const target = document.getElementById('view-' + viewName);
            if(target) target.classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(btn => btn.classList.remove('active', 'text-white'));
            const activeBtn = document.getElementById('nav-' + viewName);
            if(activeBtn) activeBtn.classList.add('active', 'text-white');
            
            if(viewName === 'tactics') window.initTactics();
            if(viewName === 'stats') setTimeout(window.renderStatsCharts, 100);
        };

        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
        window.showToast = (msg, isError = false) => {
            const el = document.getElementById('toast'); 
            if(el) {
                document.getElementById('toastMsg').textContent = msg;
                el.className = `fixed bottom-5 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-xl shadow-2xl flex items-center gap-3 transition-opacity duration-300 z-[70] ${isError ? 'bg-red-900/90 border-red-500 text-white' : 'bg-surface border-gray-700 text-white'} opacity-100`;
                setTimeout(() => el.classList.add('opacity-0'), 3000);
            }
        };

        // --- DATA LOGIC ---
        async function loadTournamentsList() {
            try {
                const container = document.getElementById('tournamentButtons');
                if(container) container.innerHTML = '<div class="text-xs text-gray-500 text-center py-2"><i class="fa-solid fa-spinner fa-spin"></i> Buscando datos...</div>';

                const found = [];
                const qRoot = query(collection(db, "tournaments"));
                const snapRoot = await getDocs(qRoot);
                snapRoot.forEach(d => found.push({id: d.id, ...d.data(), sourceColl: "tournaments", playerColl: "players"}));

                try {
                    const qLegacy = query(collection(db, "torneos"));
                    const snapLegacy = await getDocs(qLegacy);
                    snapLegacy.forEach(d => found.push({id: d.id, ...d.data(), sourceColl: "torneos", playerColl: "jugadores"}));
                } catch(e) { }

                if(container) {
                    container.innerHTML = '';
                    if (found.length === 0) {
                        container.innerHTML = '<div class="text-xs text-red-400 text-center p-2">No se encontraron datos.</div>';
                        return;
                    }

                    found.forEach(t => {
                        const btn = document.createElement('button');
                        const isActive = t.id === currentTournament;
                        const sourceLabel = t.sourceColl === "torneos" ? '<span class="badge-source bg-yellow-500 text-black">Legacy</span>' : '';

                        btn.className = `w-full text-left px-3 py-2 rounded text-xs font-bold transition mb-1 flex justify-between items-center ${isActive ? 'bg-primary text-dark' : 'bg-gray-700 text-gray-300 hover:bg-gray-600'}`;
                        btn.innerHTML = `<div class="truncate">${t.name || t.id}</div> <div>${sourceLabel} ${isActive ? '<i class="fa-solid fa-check ml-1"></i>' : ''}</div>`;
                        btn.onclick = () => window.selectTournament(t.id, t.sourceColl, t.playerColl);
                        container.appendChild(btn);
                    });
                }

                if (!currentTournament && found.length > 0) {
                    window.selectTournament(found[0].id, found[0].sourceColl, found[0].playerColl);
                }
            } catch(e) { console.error(e); }
        }

        function loadData() {
            if(!currentTournament) return;

            const q = query(collection(db, currentPlayersCollection), where("tournament", "==", currentTournament));
            onSnapshot(q, (snapshot) => {
                players = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()})).sort((a,b) => a.number - b.number);
                window.renderAll();
            });

            onSnapshot(doc(collection(db, currentTournamentCollection), currentTournament), (docSnap) => {
                if(docSnap.exists()) {
                    tournamentData = docSnap.data();
                    const name = tournamentData.name || "Torneo";
                    safeText('activeTournamentDisplay', name);
                    safeText('mobileTournamentBadge', name.toUpperCase());
                    safeText('dashTournamentName', name);
                    safeVal('confName', name);
                    safeVal('confPrice', tournamentData.totalInscription || 0);
                    
                    if(tournamentData.matches && tournamentData.matches.some(m => !m.id)) {
                         const fixedMatches = tournamentData.matches.map(m => (!m.id ? {...m, id: crypto.randomUUID()} : m));
                         updateDoc(docSnap.ref, { matches: fixedMatches });
                    }
                    window.renderAll();
                }
            });
        }

        window.createOfficialTournament = async (name) => {
            const newId = "tourn_" + name.replace(/\s+/g, '_').toLowerCase();
            await setDoc(doc(db, "tournaments", newId), { name: name, totalInscription: 0, matches: [], stats: {} });
            loadTournamentsList();
            window.showToast("Torneo creado en Ra칤z");
        };
        
        window.deleteCurrentTournament = async () => {
            if(!currentTournament) return;
            if(!confirm("쮼LIMINAR TORNEO ACTUAL? SE BORRAR츼 TODO.")) return;
            try {
                const q = query(collection(db, currentPlayersCollection), where("tournament", "==", currentTournament));
                const snap = await getDocs(q);
                const batchPromises = snap.docs.map(d => deleteDoc(d.ref));
                await Promise.all(batchPromises);
                await deleteDoc(doc(collection(db, currentTournamentCollection), currentTournament));
                window.showToast("Torneo eliminado");
                currentTournament = null;
                loadTournamentsList(); 
            } catch(e) { console.error(e); window.showToast("Error: " + e.message, true); }
        };
        
        window.purgeTrashTournaments = async () => {
            if(!confirm("쮹orrar torneos NO oficiales?")) return;
            const snap = await getDocs(collection(db, "tournaments"));
            const batchPromises = [];
            snap.forEach(d => {
                if(!OFFICIAL_TOURNAMENTS.includes(d.data().name)) {
                    batchPromises.push(deleteDoc(d.ref));
                }
            });
            await Promise.all(batchPromises);
            window.showToast("Limpieza completada");
            loadTournamentsList();
        };

        async function recalculateAllDebts() {
            if (!tournamentData.matches) return;
            const playerDebts = {};
            players.forEach(p => playerDebts[p.id] = 0);
            const matches = [...tournamentData.matches].sort((a,b) => new Date(a.date) - new Date(b.date));

            matches.forEach(m => {
                const details = m.playerDetails || {};
                const payments = m.refereePayments || {};
                const present = m.presentPlayers || [];

                present.forEach(pid => {
                    if (playerDebts[pid] === undefined) playerDebts[pid] = 0;
                    const stats = details[pid] || { yellow: 0, blue: 0, red: 0 };
                    let fine = 0;
                    fine += (stats.yellow || 0) * FINE_VALUES.yellow;
                    fine += (stats.blue || 0) * FINE_VALUES.blue;
                    fine += (stats.red || 0) * FINE_VALUES.red;
                    playerDebts[pid] += fine;
                    if (payments[pid] && payments[pid].paidFines) { playerDebts[pid] = 0; }
                });
            });

            const batchUpdates = [];
            Object.keys(playerDebts).forEach(pid => {
                const p = players.find(x => x.id === pid);
                if (p && p.cardDebt !== playerDebts[pid]) {
                    batchUpdates.push(updateDoc(doc(collection(db, currentPlayersCollection), pid), { cardDebt: playerDebts[pid] }));
                }
            });
            if (batchUpdates.length > 0) await Promise.all(batchUpdates);
        }

        // --- CHARTS RENDERER ---
        window.renderStatsCharts = () => {
            const matches = tournamentData.matches || [];
            if(!matches) return;

            // Destroy old charts
            if(charts.results) charts.results.destroy();
            if(charts.goals) charts.goals.destroy();
            if(charts.cards) charts.cards.destroy();
            if(charts.scorers) charts.scorers.destroy();
            if(charts.attendance) charts.attendance.destroy();
            if(charts.finance) charts.finance.destroy();
            if(charts.goalsTrend) charts.goalsTrend.destroy();

            let wins=0, draws=0, losses=0;
            let gf=[], gc=[], labels=[];
            let yellow=0, blue=0, red=0;

            matches.forEach((m, idx) => {
                if(m.result === 'Victoria') wins++;
                else if(m.result === 'Empate') draws++;
                else losses++;

                labels.push(`P${idx+1}`);
                gf.push(m.goalsScored);
                gc.push(m.goalsConceded);
                yellow += m.yellowCards || 0;
                blue += m.blueCards || 0;
                red += m.redCards || 0;
            });

            // 1. Results Chart
            const ctxResults = document.getElementById('resultsChart');
            if(ctxResults) {
                charts.results = new Chart(ctxResults, {
                    type: 'doughnut',
                    data: {
                        labels: ['Victorias', 'Empates', 'Derrotas'],
                        datasets: [{
                            data: [wins, draws, losses],
                            backgroundColor: ['#10B981', '#F59E0B', '#EF4444'],
                            borderWidth: 0
                        }]
                    },
                    options: { responsive: true, plugins: { legend: { position: 'bottom', labels: { color: '#94a3b8' } } } }
                });
            }

            // 2. Goals Evolution
            const ctxGoals = document.getElementById('goalsChart');
            if(ctxGoals) {
                charts.goals = new Chart(ctxGoals, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            { label: 'A Favor', data: gf, backgroundColor: '#10B981' },
                            { label: 'En Contra', data: gc, backgroundColor: '#EF4444' }
                        ]
                    },
                    options: { 
                        responsive: true, 
                        scales: { x: { ticks: { color: '#94a3b8' } }, y: { ticks: { color: '#94a3b8' } } },
                        plugins: { legend: { labels: { color: '#94a3b8' } } }
                    }
                });
            }

            // 3. Cards
            const ctxCards = document.getElementById('cardsChart');
            if(ctxCards) {
                charts.cards = new Chart(ctxCards, {
                    type: 'polarArea',
                    data: {
                        labels: ['Amarillas', 'Azules', 'Rojas'],
                        datasets: [{
                            data: [yellow, blue, red],
                            backgroundColor: ['rgba(245, 158, 11, 0.8)', 'rgba(59, 130, 246, 0.8)', 'rgba(239, 68, 68, 0.8)'],
                            borderWidth: 0
                        }]
                    },
                    options: { 
                        responsive: true, 
                        scales: { r: { grid: { color: '#334155' }, ticks: { display: false } } },
                        plugins: { legend: { position: 'bottom', labels: { color: '#94a3b8' } } } 
                    }
                });
            }

            // Data for new charts
            const playerStats = [];
            let totalPaid = 0;
            let totalDebt = 0;
            const cost = tournamentData.totalInscription || 0;
            
            players.forEach(p => {
                let goals = 0;
                let matchesPlayed = 0;
                // Calculate individual stats
                matches.forEach(m => {
                    if(m.presentPlayers && m.presentPlayers.includes(p.id)) {
                        matchesPlayed++;
                        if(m.playerDetails && m.playerDetails[p.id]) {
                            goals += (m.playerDetails[p.id].goals || 0);
                        }
                    }
                });
                playerStats.push({ name: p.name, goals: goals, matches: matchesPlayed });
                
                // Finances
                totalPaid += (p.totalPaid || 0);
                // Approx total individual cost
                const indCost = players.length > 0 ? cost / players.length : 0;
                const debt = Math.max(0, indCost - (p.totalPaid || 0));
                totalDebt += debt + (p.cardDebt || 0);
            });

            // 4. Top Scorers (Horizontal Bar)
            const ctxScorers = document.getElementById('scorersChart');
            if(ctxScorers) {
                const sortedScorers = [...playerStats].sort((a,b) => b.goals - a.goals).slice(0, 10);
                charts.scorers = new Chart(ctxScorers, {
                    type: 'bar',
                    indexAxis: 'y',
                    data: {
                        labels: sortedScorers.map(p => p.name),
                        datasets: [{
                            label: 'Goles',
                            data: sortedScorers.map(p => p.goals),
                            backgroundColor: '#F59E0B',
                            barThickness: 15
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { x: { ticks: { color: '#94a3b8' } }, y: { ticks: { color: '#94a3b8' } } },
                        plugins: { legend: { display: false } }
                    }
                });
            }

            // 5. Attendance (Bar)
            const ctxAttendance = document.getElementById('attendanceChart');
            if(ctxAttendance) {
                const sortedAttendance = [...playerStats].sort((a,b) => b.matches - a.matches).slice(0, 15);
                charts.attendance = new Chart(ctxAttendance, {
                    type: 'bar',
                    data: {
                        labels: sortedAttendance.map(p => p.name),
                        datasets: [{
                            label: 'Partidos Jugados',
                            data: sortedAttendance.map(p => p.matches),
                            backgroundColor: '#3B82F6',
                            barThickness: 10
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { x: { ticks: { color: '#94a3b8', font: {size: 10} } }, y: { ticks: { color: '#94a3b8' } } },
                        plugins: { legend: { display: false } }
                    }
                });
            }

            // 6. Finance (Doughnut)
            const ctxFinance = document.getElementById('financeChart');
            if(ctxFinance) {
                charts.finance = new Chart(ctxFinance, {
                    type: 'doughnut',
                    data: {
                        labels: ['Recaudado', 'Por Cobrar'],
                        datasets: [{
                            data: [totalPaid, totalDebt],
                            backgroundColor: ['#10B981', '#EF4444'],
                            borderWidth: 0
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: '#94a3b8' } } } }
                });
            }

            // 7. Goals Trend (Line) - Diff Goals
            const ctxTrend = document.getElementById('goalsTrendChart');
            if(ctxTrend) {
                // Calculate cumulative goal difference
                let cumDiff = 0;
                const trendData = labels.map((_, i) => {
                    const diff = gf[i] - gc[i];
                    cumDiff += diff;
                    return cumDiff;
                });
                
                charts.goalsTrend = new Chart(ctxTrend, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Diferencia de Gol Acumulada',
                            data: trendData,
                            borderColor: '#F59E0B',
                            tension: 0.3,
                            fill: true,
                            backgroundColor: 'rgba(245, 158, 11, 0.1)'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { x: { ticks: { color: '#94a3b8' } }, y: { ticks: { color: '#94a3b8' } } },
                        plugins: { legend: { display: false } }
                    }
                });
            }
        }

        window.initTactics = () => {
            const tName = tournamentData.name || "";
            const is5v5 = tName.includes("HIC");
            const type = is5v5 ? 5 : 6;
            safeText('tacticsInfo', is5v5 ? "Modo: Futbol 5 (HIC)" : "Modo: Futbol 6 (Anillo Vial)");
            const select = document.getElementById('formationSelect');
            if(select) {
                select.innerHTML = '';
                FORMATIONS[type].forEach((f, i) => { const opt = document.createElement('option'); opt.value = i; opt.textContent = f.name; select.appendChild(opt); });
            }
            currentLineup = tournamentData.savedLineup || {};
            window.renderFormation();
        };

        window.renderFormation = () => {
            const tName = tournamentData.name || "";
            const is5v5 = tName.includes("HIC");
            const type = is5v5 ? 5 : 6;
            const formSelect = document.getElementById('formationSelect');
            if(!formSelect) return;
            const formIndex = formSelect.value || 0;
            const formation = FORMATIONS[type][formIndex];
            const container = document.getElementById('pitchContainer');
            if(!container) return;
            
            const nodes = container.querySelectorAll('.player-node, .player-node-label'); nodes.forEach(n => n.remove());
            window.createNode(container, 50, 90, 'gk');
            formation.pos.forEach((pos, i) => { window.createNode(container, pos[0], pos[1], i); });
            window.renderBench();
        };

        window.createNode = (container, left, top, index) => {
            const playerId = currentLineup[index];
            const player = players.find(p => p.id === playerId);
            const node = document.createElement('div'); node.className = 'player-node'; node.style.left = left + '%'; node.style.top = top + '%';
            node.textContent = player ? player.number : (index === 'gk' ? 'GK' : '+');
            if(player) { node.style.background = '#F59E0B'; node.style.color = '#0F172A'; node.style.border = '2px solid #fff'; }
            node.onclick = () => window.openPlayerPick(index);
            if(player) { const label = document.createElement('div'); label.className = 'player-node-label'; label.textContent = player.name.split(' ')[0]; label.style.left = left + '%'; label.style.top = (top + 6) + '%'; container.appendChild(label); }
            container.appendChild(node);
        };
        
        window.openPlayerPick = (posIndex) => {
            activePosIndex = posIndex;
            const list = document.getElementById('playerPickList');
            if(list) {
                list.innerHTML = '<button onclick="window.selectPlayerForPos(null)" class="w-full text-left p-2 hover:bg-gray-700 rounded text-gray-400 text-xs">--- Vac칤o ---</button>';
                const usedIds = Object.values(currentLineup);
                players.forEach(p => { if (!usedIds.includes(p.id) || currentLineup[activePosIndex] === p.id) { const btn = document.createElement('button'); btn.className = 'w-full text-left p-2 hover:bg-gray-700 rounded text-white text-sm border-b border-gray-800'; btn.innerHTML = `<b>${p.number}</b> ${p.name}`; btn.onclick = () => window.selectPlayerForPos(p.id); list.appendChild(btn); } });
                const modal = document.getElementById('playerPickModal');
                if(modal) modal.classList.remove('hidden');
            }
        };
        
        window.selectPlayerForPos = (pid) => { if(pid) currentLineup[activePosIndex] = pid; else delete currentLineup[activePosIndex]; window.closeModal('playerPickModal'); window.renderFormation(); };
        
        window.renderBench = () => {
            const benchDiv = document.getElementById('benchList');
            if(!benchDiv) return;
            benchDiv.innerHTML = '';
            const usedIds = Object.values(currentLineup);
            const bench = players.filter(p => !usedIds.includes(p.id));
            if(bench.length === 0) { benchDiv.innerHTML = '<span class="text-xs text-gray-500">Todos convocados</span>'; return; }
            bench.forEach(p => { const tag = document.createElement('div'); tag.className = 'text-xs bg-gray-800 px-2 py-1 rounded text-gray-300 border border-gray-700'; tag.textContent = `${p.number}. ${p.name}`; benchDiv.appendChild(tag); });
        };
        
        window.saveLineup = async () => { try { await updateDoc(doc(collection(db, currentTournamentCollection), currentTournament), { savedLineup: currentLineup }); window.showToast("Alineaci칩n guardada"); } catch(e) { console.error(e); } };

        // --- RENDERIZADORES ---
        window.renderAll = () => {
            window.renderPlayers(); window.renderMatchSelector(); window.renderMatchesList(); window.renderFinances(); window.renderDashboard(); window.renderStatsTable();
        };

        window.renderPlayers = () => {
            const input = document.getElementById('searchPlayer');
            if(!input) return;
            const filter = input.value.toLowerCase();
            const grid = document.getElementById('playersGrid');
            const sel = document.getElementById('payPlayerSelect');
            if(grid) grid.innerHTML = ''; 
            if(sel) sel.innerHTML = '<option value="">Seleccionar Jugador...</option>';
            players.forEach(p => {
                if(p.name.toLowerCase().includes(filter) || p.number.toString().includes(filter)) {
                    const debt = p.cardDebt || 0;
                    const cardDebtHtml = debt > 0 ? `<div class="text-xs text-danger font-bold mt-1">Multas: ${formatCOP(debt)}</div>` : '';
                    const card = document.createElement('div');
                    card.className = 'glass p-4 rounded-xl border border-gray-800 hover:border-gray-600 transition group relative';
                    card.innerHTML = `<div class="flex justify-between items-start"><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-full bg-gray-700 flex items-center justify-center font-bold text-gray-300">${p.number}</div><div><div class="font-bold text-white leading-tight">${p.name}</div><div class="text-xs text-gray-500">Abonado: ${formatCOP(p.totalPaid || 0)}</div>${cardDebtHtml}</div></div><div class="flex gap-2 opacity-0 group-hover:opacity-100 transition"><button onclick="window.openPlayerModal('${p.id}')" class="text-gray-500 hover:text-primary"><i class="fa-solid fa-pen"></i></button><button onclick="window.deletePlayer('${p.id}')" class="text-gray-500 hover:text-danger"><i class="fa-solid fa-trash"></i></button></div></div>`;
                    if(grid) grid.appendChild(card);
                }
                if(sel) { const opt = document.createElement('option'); opt.value = p.id; opt.textContent = `${p.number}. ${p.name}`; sel.appendChild(opt); }
            });
        };

        window.renderMatchesList = () => {
            const list = document.getElementById('fullMatchesList'); const recentList = document.getElementById('recentMatchesList');
            if(list) list.innerHTML = ''; if(recentList) recentList.innerHTML = '';
            const matches = (tournamentData.matches || []).slice().reverse(); 
            safeText('totalMatchesCount', `${matches.length} partidos`);
            if(matches.length === 0) { if(list) list.innerHTML = '<div class="text-center text-gray-500 py-4">No hay partidos registrados</div>'; return; }
            matches.forEach(m => {
                const item = document.createElement('div');
                item.className = 'glass p-4 rounded-xl border-l-4 border-gray-700 flex justify-between items-center';
                if (m.result === 'Victoria') item.classList.add('border-l-success'); else if (m.result === 'Derrota') item.classList.add('border-l-danger'); else item.classList.add('border-l-primary');
                item.innerHTML = `<div class="cursor-pointer flex-1" onclick="window.viewMatchDetails('${m.id}')"><div class="text-xs text-gray-500 mb-1">${new Date(m.date).toLocaleDateString()}</div><div class="text-lg font-bold text-white"><span class="${m.result === 'Victoria' ? 'text-success' : ''}">${m.goalsScored}</span> - <span class="${m.result === 'Derrota' ? 'text-danger' : ''}">${m.goalsConceded}</span></div><div class="text-xs font-bold uppercase text-gray-400 mt-1">${m.result}</div></div><div class="flex gap-2 items-center"><button onclick="window.viewMatchDetails('${m.id}')" class="bg-gray-800 hover:bg-gray-700 text-gray-300 w-8 h-8 rounded-full transition"><i class="fa-solid fa-eye"></i></button><button onclick="window.editMatch('${m.id}')" class="bg-gray-800 hover:bg-primary hover:text-dark text-white w-8 h-8 rounded-full transition"><i class="fa-solid fa-pen"></i></button><button onclick="window.deleteMatch('${m.id}')" class="bg-gray-800 hover:bg-danger text-white w-8 h-8 rounded-full transition"><i class="fa-solid fa-trash"></i></button></div>`;
                if(list) list.appendChild(item);
                if (recentList && recentList.children.length < 5) {
                    const miniItem = item.cloneNode(true); miniItem.querySelector('.flex.gap-2').remove(); 
                    const clickDiv = miniItem.querySelector('div'); clickDiv.onclick = () => viewMatchDetails(m.id);
                    miniItem.classList.remove('glass', 'p-4', 'rounded-xl'); miniItem.classList.add('py-2', 'border-b', 'border-gray-800'); recentList.appendChild(miniItem);
                }
            });
        };

        window.renderMatchSelector = () => {
            const grid = document.getElementById('matchPlayersGrid');
            if(!grid) return;
            grid.innerHTML = '';
            players.forEach(p => {
                if(!matchSelection[p.id]) matchSelection[p.id] = { selected: false, paidRef: false, paidFines: false, stats: { goals:0, yellow:0, blue:0, red:0 } };
                const state = matchSelection[p.id];
                const hasDebt = (p.cardDebt || 0) > 0;
                const div = document.createElement('div');
                div.className = `p-3 rounded-lg border cursor-pointer transition flex flex-col relative ${state.selected ? 'bg-blue-900/20 border-secondary' : 'bg-gray-800/50 border-transparent hover:bg-gray-800'}`;
                div.onclick = (e) => { if(e.target.tagName !== 'BUTTON' && e.target.tagName !== 'I') window.toggleMatchSelection(p.id); };
                let content = `<div class="flex justify-between items-center mb-2"><span class="text-xs font-bold text-gray-300">${p.number}. ${p.name}</span>${state.selected ? '<i class="fa-solid fa-circle-check text-success"></i>' : '<i class="fa-regular fa-circle text-gray-600"></i>'}</div>`;
                if(state.selected) {
                    content += `<button onclick="window.toggleMatchPayRef('${p.id}')" class="w-full text-[10px] px-2 py-1 mb-1 rounded border ${state.paidRef ? 'bg-success text-white border-success' : 'bg-transparent text-gray-400 border-gray-600'}">Arbitraje: ${state.paidRef ? 'PAGADO' : 'PEND'}</button>`;
                    if (hasDebt) content += `<button onclick="window.toggleMatchPayFines('${p.id}')" class="w-full text-[10px] px-2 py-1 rounded border ${state.paidFines ? 'bg-warning text-dark border-warning font-bold' : 'bg-transparent text-danger border-danger'}">Multa: ${formatCOP(p.cardDebt)} ${state.paidFines ? '(OK)' : ''}</button>`;
                    const s = state.stats;
                    if(s.goals > 0 || s.yellow > 0 || s.blue > 0 || s.red > 0) content += `<div class="mt-2 pt-1 border-t border-gray-700 flex gap-1 text-[10px] justify-center">${s.goals > 0 ? `<span class="text-success">丘${s.goals}</span>` : ''}${s.yellow > 0 ? `<span class="text-yellow-500">游릳${s.yellow}</span>` : ''}${s.blue > 0 ? `<span class="text-blue-400">游릱${s.blue}</span>` : ''}${s.red > 0 ? `<span class="text-red-500">游린${s.red}</span>` : ''}</div>`;
                }
                div.innerHTML = content;
                grid.appendChild(div);
            });
            window.calcRef();
        };

        window.renderFinances = () => {
            const tbody = document.getElementById('financesTableBody');
            if(!tbody) return;
            tbody.innerHTML = '';
            const cost = tournamentData.inscriptionPerPlayer || 0;
            players.forEach(p => {
                const paid = p.totalPaid || 0; const debt = cost - paid; const status = debt <= 0 ? '<span class="text-success text-xs bg-green-900/30 px-2 py-1 rounded">Al d칤a</span>' : '<span class="text-warning text-xs bg-yellow-900/30 px-2 py-1 rounded">Pendiente</span>';
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="py-3 pl-2 font-medium text-white">${p.name}</td><td class="py-3 text-right text-gray-400">${formatCOP(cost)}</td><td class="py-3 text-right text-success">${formatCOP(paid)}</td><td class="py-3 text-right ${debt > 0 ? 'text-danger font-bold' : 'text-gray-500'}">${formatCOP(Math.max(0, debt))}</td><td class="py-3 text-right text-danger font-bold">${p.cardDebt > 0 ? formatCOP(p.cardDebt) : '-'}</td><td class="py-3 text-right font-bold text-white">${formatCOP(Math.max(0, debt) + (p.cardDebt || 0))}</td><td class="py-3 text-center"><button onclick="window.openPaymentHistory('${p.id}')" class="text-xs bg-gray-700 hover:bg-secondary text-white px-3 py-1 rounded transition">Ver</button></td>`;
                tbody.appendChild(tr);
            });
        };

        window.renderDashboard = () => {
            const matches = tournamentData.matches || [];
            const totalPaid = players.reduce((acc, p) => acc + (p.totalPaid || 0), 0);
            const totalDebt = Math.max(0, (players.length * (tournamentData.inscriptionPerPlayer || 0)) - totalPaid);
            const totalFinesDebt = players.reduce((acc, p) => acc + (p.cardDebt || 0), 0);
            
            // Match Stats
            let totalGF = 0, totalGC = 0, totalCards = 0;
            // NEW: Team Stats Logic
            let teamStats = { pj: 0, pg: 0, pe: 0, pp: 0, pts: 0 };
            
            matches.forEach(m => {
                totalGF += (m.goalsScored || 0);
                totalGC += (m.goalsConceded || 0);
                totalCards += (m.yellowCards || 0) + (m.blueCards || 0) + (m.redCards || 0);
                
                // Calculate Record
                if (m.result) {
                    teamStats.pj++;
                    if (m.result === 'Victoria') { teamStats.pg++; teamStats.pts += 2; }
                    else if (m.result === 'Empate') { teamStats.pe++; teamStats.pts += 1; }
                    else if (m.result === 'Derrota') { teamStats.pp++; }
                }
            });
            const avgGF = matches.length > 0 ? (totalGF / matches.length).toFixed(1) : "0.0";
            const avgGC = matches.length > 0 ? (totalGC / matches.length).toFixed(1) : "0.0";
            const avgCards = matches.length > 0 ? (totalCards / matches.length).toFixed(1) : "0.0";

            // Player Stats for Dashboard
            const playerStats = {};
            players.forEach(p => playerStats[p.id] = {name: p.name, cards:0, matches:0, goals:0});
            matches.forEach(m => {
                const details = m.playerDetails || {};
                const present = m.presentPlayers || [];
                present.forEach(pid => {
                    if (playerStats[pid]) {
                        playerStats[pid].matches++;
                        if (details[pid]) {
                            playerStats[pid].goals += (details[pid].goals || 0);
                            playerStats[pid].cards += (details[pid].yellow || 0) + (details[pid].blue || 0) + (details[pid].red || 0);
                        }
                    }
                });
            });

            // Find Most Cautioned
            let badBoy = { name: "-", avg: "0.0", total: 0 };
            Object.values(playerStats).forEach(s => {
                if (s.cards > badBoy.total) {
                    badBoy = { name: s.name, total: s.cards, avg: s.matches > 0 ? (s.cards/s.matches).toFixed(1) : "0.0" };
                }
            });

            // UI Updates
            safeText('dashCollected', formatCOP(totalPaid));
            safeText('dashDebt', formatCOP(totalDebt + totalFinesDebt));
            safeText('dashMatches', matches.length);
            safeText('dashAvgGF', avgGF);
            safeText('dashAvgGC', avgGC);
            safeText('dashAvgCards', avgCards);
            safeText('dashBadBoyName', badBoy.name);
            safeText('dashBadBoyAvg', badBoy.avg);
            
            // --- NUEVO: Render Team Stats Table ---
            const statsTable = document.getElementById('teamStatsTableBody');
            if (statsTable) {
                const diff = totalGF - totalGC;
                const diffClass = diff > 0 ? 'text-success' : (diff < 0 ? 'text-danger' : 'text-gray-400');
                const tName = tournamentData.name || "CONSTRU-SANTAMARIA";
                
                statsTable.innerHTML = `
                    <tr class="hover:bg-gray-800/50 transition">
                        <td class="stat-cell text-left pl-4 font-bold text-white">${tName}</td>
                        <td class="stat-cell font-mono">${teamStats.pj}</td>
                        <td class="stat-cell text-success font-bold">${teamStats.pg}</td>
                        <td class="stat-cell text-yellow-500 font-bold">${teamStats.pe}</td>
                        <td class="stat-cell text-red-500 font-bold">${teamStats.pp}</td>
                        <td class="stat-cell text-gray-400">${totalGF}</td>
                        <td class="stat-cell text-gray-400">${totalGC}</td>
                        <td class="stat-cell ${diffClass} font-bold">${diff > 0 ? '+'+diff : diff}</td>
                        <td class="stat-cell text-primary font-bold text-lg">${teamStats.pts}</td>
                    </tr>
                `;
                
                // Update Performance Bar
                const totalPlayed = teamStats.pj || 1; // avoid div by zero
                document.getElementById('barWins').style.width = ((teamStats.pg / totalPlayed) * 100) + '%';
                document.getElementById('barDraws').style.width = ((teamStats.pe / totalPlayed) * 100) + '%';
                document.getElementById('barLosses').style.width = ((teamStats.pp / totalPlayed) * 100) + '%';
            }

            const table = document.getElementById('topScorersTable');
            if(table) {
                const sortedScorers = Object.values(playerStats).sort((a,b) => b.goals - a.goals).slice(0, 5);
                table.innerHTML = sortedScorers.map(p => `<tr><td class="py-2 text-sm border-b border-gray-800">${p.name}</td><td class="text-right font-bold text-success border-b border-gray-800">${p.goals} Goles</td></tr>`).join('');
            }
        };

        window.renderStatsTable = () => {
            const tbody = document.getElementById('statsTableBody');
            if(!tbody) return;
            tbody.innerHTML = '';
            const matches = tournamentData.matches || [];
            const statsMap = {}; 
            players.forEach(p => statsMap[p.id] = { pj:0, g:0, y:0, b:0, r:0, name: p.name, debt: p.cardDebt || 0 });
            matches.forEach(m => {
                if(m.playerDetails) {
                    Object.keys(m.playerDetails).forEach(pid => { if(statsMap[pid]) { const details = m.playerDetails[pid]; statsMap[pid].pj++; statsMap[pid].g += (details.goals || 0); statsMap[pid].y += (details.yellow || 0); statsMap[pid].b += (details.blue || 0); statsMap[pid].r += (details.red || 0); } });
                } else if (m.presentPlayers) { m.presentPlayers.forEach(pid => { if(statsMap[pid]) statsMap[pid].pj++; }); }
            });
            const sorted = Object.values(statsMap).sort((a,b) => b.g - a.g); 
            sorted.forEach(s => {
                let avgGoals = s.pj > 0 ? (s.g / s.pj).toFixed(2) : "0.00";
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="py-2 pl-2 font-medium text-white">${s.name}</td><td class="text-center text-gray-400">${s.pj}</td><td class="text-center font-bold text-success">${s.g}</td><td class="text-center text-gray-400 text-[10px]">${avgGoals}</td><td class="text-center text-yellow-500">${s.y}</td><td class="text-center text-blue-400">${s.b}</td><td class="text-center text-red-500">${s.r}</td><td class="text-right text-danger font-mono pr-2">${s.debt > 0 ? formatCOP(s.debt) : '-'}</td>`;
                tbody.appendChild(tr);
            });
        };

        // --- CRUD ACTIONS ---
        window.openPlayerModal = (playerId = null) => {
            const modal = document.getElementById('playerModal'); const nameIn = document.getElementById('playerModalName'); const numIn = document.getElementById('playerModalNum'); const idIn = document.getElementById('editPlayerId');
            if (playerId) { const p = players.find(x => x.id === playerId); document.getElementById('playerModalTitle').textContent = "Editar Jugador"; nameIn.value = p.name; numIn.value = p.number; idIn.value = p.id; } else { document.getElementById('playerModalTitle').textContent = "Nuevo Jugador"; nameIn.value = ""; numIn.value = ""; idIn.value = ""; }
            modal.classList.remove('hidden');
        };
        window.savePlayerForm = async () => {
            const id = document.getElementById('editPlayerId').value; const name = document.getElementById('playerModalName').value; const number = parseInt(document.getElementById('playerModalNum').value);
            if(!name || !number) return window.showToast("Faltan datos", true);
            if(id) await updateDoc(doc(collection(db, currentPlayersCollection), id), { name, number });
            else await setDoc(doc(collection(db, currentPlayersCollection)), { name, number, tournament: currentTournament, totalPaid: 0, payments: [], cardDebt: 0 });
            window.closeModal('playerModal'); setTimeout(() => window.autoRecalculateFees(), 500); window.showToast(id ? 'Actualizado' : 'Creado');
        };
        window.deletePlayer = async (id) => { if(confirm("쮼liminar?")) { await deleteDoc(doc(collection(db, currentPlayersCollection), id)); window.showToast("Eliminado"); setTimeout(() => window.autoRecalculateFees(), 500); } };
        window.addPayment = async () => {
            const id = document.getElementById('payPlayerSelect').value; const amount = parseFloat(document.getElementById('payAmount').value);
            if(!id || !amount) return window.showToast("Datos incompletos", true);
            const p = players.find(x => x.id === id); const newPay = { id: crypto.randomUUID(), date: new Date().toISOString(), amount };
            await updateDoc(doc(collection(db, currentPlayersCollection), id), { totalPaid: (p.totalPaid||0) + amount, payments: [...(p.payments||[]), newPay] });
            document.getElementById('payAmount').value = ''; window.showToast('Pago registrado');
        };
        window.openPaymentHistory = (playerId) => {
            const p = players.find(x => x.id === playerId); const list = document.getElementById('historyList'); document.getElementById('historyModalTitle').textContent = p.name;
            if(!p.payments || p.payments.length === 0) list.innerHTML = '<div class="text-center text-gray-500 mt-10">Sin pagos registrados</div>';
            else list.innerHTML = p.payments.map(pay => `<div class="flex justify-between items-center bg-dark p-3 rounded-lg mb-2 border border-gray-700"><div><div class="font-bold text-success">${formatCOP(pay.amount)}</div><div class="text-xs text-gray-500">${new Date(pay.date).toLocaleDateString()}</div></div><button onclick="window.deletePayment('${playerId}', '${pay.id}')" class="text-gray-500 hover:text-danger px-2"><i class="fa-solid fa-trash"></i></button></div>`).join('');
            document.getElementById('historyModal').classList.remove('hidden');
        };
        window.deletePayment = async (playerId, paymentId) => {
            if(!confirm("쮹orrar?")) return;
            const p = players.find(x => x.id === playerId); const newPayments = p.payments.filter(pay => pay.id !== paymentId); const newTotal = newPayments.reduce((sum, pay) => sum + pay.amount, 0);
            await updateDoc(doc(collection(db, currentPlayersCollection), playerId), { totalPaid: newTotal, payments: newPayments });
            p.payments = newPayments; p.totalPaid = newTotal; window.openPaymentHistory(playerId); window.showToast("Pago eliminado");
        };
        window.toggleMatchSelection = (id) => {
            if(!matchSelection[id]) matchSelection[id] = { selected: false, paidRef: false, paidFines: false, stats: {goals:0, yellow:0, blue:0, red:0} };
            matchSelection[id].selected = !matchSelection[id].selected; if(!matchSelection[id].selected) { matchSelection[id].paidRef = false; matchSelection[id].paidFines = false; }
            window.renderMatchSelector();
        };
        window.toggleMatchPayRef = (id) => { if(matchSelection[id]) { matchSelection[id].paidRef = !matchSelection[id].paidRef; window.renderMatchSelector(); } };
        window.toggleMatchPayFines = (id) => { if(matchSelection[id]) { matchSelection[id].paidFines = !matchSelection[id].paidFines; window.renderMatchSelector(); } };
        window.calcRef = () => {
            const total = parseFloat(document.getElementById('refPrice').value) || 0; const selectedIds = Object.keys(matchSelection).filter(k => matchSelection[k].selected); const count = selectedIds.length; const perPlayer = count > 0 ? total / count : 0; const paidRefCount = selectedIds.filter(k => matchSelection[k].paidRef).length; const collectedRef = paidRefCount * perPlayer;
            let collectedFines = 0; selectedIds.forEach(pid => { if (matchSelection[pid].paidFines) { const p = players.find(x => x.id === pid); if(p) collectedFines += (p.cardDebt || 0); } });
            safeText('convocadosCount', `${count} Jugadores`); safeText('costPerPlayer', formatCOP(perPlayer)); safeText('totalCollectedMatch', formatCOP(collectedRef)); safeText('totalFinesCollectedMatch', formatCOP(collectedFines));
        };
        window.openPlayerStatsModal = () => { window.renderPlayerStatsInputs(); document.getElementById('playerStatsModal').classList.remove('hidden'); };
        window.renderPlayerStatsInputs = () => {
            const container = document.getElementById('playerStatsInputs'); container.innerHTML = '';
            const selectedIds = Object.keys(matchSelection).filter(id => matchSelection[id].selected);
            if(selectedIds.length === 0) { container.innerHTML = '<div class="text-center text-gray-500 mt-10">Selecciona jugadores primero.</div>'; return; }
            selectedIds.forEach(pid => {
                const p = players.find(x => x.id === pid); const stats = matchSelection[pid].stats || { goals:0, yellow:0, blue:0, red:0 };
                const row = document.createElement('div'); row.className = "flex items-center justify-between bg-gray-800/50 p-3 rounded-lg mb-2";
                row.innerHTML = `<div class="w-1/3 font-bold text-gray-300 text-sm">${p.name}</div><div class="flex gap-3"><div class="flex flex-col items-center"><span class="text-[10px] text-success mb-1">Goles</span><input type="number" min="0" class="w-10 bg-dark border border-gray-600 rounded text-center text-white" value="${stats.goals}" onchange="window.updateStat('${pid}', 'goals', this.value)"></div><div class="flex flex-col items-center"><span class="text-[10px] text-yellow-500 mb-1">Ama</span><input type="number" min="0" class="w-10 bg-dark border border-gray-600 rounded text-center text-white" value="${stats.yellow}" onchange="window.updateStat('${pid}', 'yellow', this.value)"></div><div class="flex flex-col items-center"><span class="text-[10px] text-blue-400 mb-1">Azul</span><input type="number" min="0" class="w-10 bg-dark border border-gray-600 rounded text-center text-white" value="${stats.blue}" onchange="window.updateStat('${pid}', 'blue', this.value)"></div><div class="flex flex-col items-center"><span class="text-[10px] text-red-500 mb-1">Roja</span><input type="number" min="0" class="w-10 bg-dark border border-gray-600 rounded text-center text-white" value="${stats.red}" onchange="window.updateStat('${pid}', 'red', this.value)"></div></div>`;
                container.appendChild(row);
            });
        };
        window.updateStat = (pid, stat, val) => { if(matchSelection[pid] && matchSelection[pid].stats) matchSelection[pid].stats[stat] = parseInt(val) || 0; };

        // --- FUNCION AGREGADA: AUTO-SUMA ---
        window.autoSumGlobalStats = () => {
            let totalG = 0, totalY = 0, totalB = 0, totalR = 0;
            
            Object.values(matchSelection).forEach(p => {
                if(p.selected && p.stats) {
                    totalG += (p.stats.goals || 0);
                    totalY += (p.stats.yellow || 0);
                    totalB += (p.stats.blue || 0);
                    totalR += (p.stats.red || 0);
                }
            });

            document.getElementById('gf').value = totalG;
            document.getElementById('yc').value = totalY;
            document.getElementById('bc').value = totalB;
            document.getElementById('rc').value = totalR;
            
            window.showToast("Marcador Global Sincronizado");
        };

        window.saveMatch = async () => {
            try {
                const gf = parseInt(document.getElementById('gf').value); const gc = parseInt(document.getElementById('gc').value); const editId = document.getElementById('editingMatchId').value; const refValue = parseFloat(document.getElementById('refPrice').value) || 0; const selectedIds = Object.keys(matchSelection).filter(k => matchSelection[k].selected);
                if(selectedIds.length === 0) return window.showToast('Selecciona al menos 1 jugador', true);
                
                let result = 'Derrota'; let points = 0; if(gf > gc) { result = 'Victoria'; points = 2; } else if (gf === gc) { result = 'Empate'; points = 1; }
                const playerDetailsMap = {}; selectedIds.forEach(pid => { playerDetailsMap[pid] = matchSelection[pid].stats || { goals:0, yellow:0, blue:0, red:0 }; });
                const matchObj = { id: editId || crypto.randomUUID(), date: new Date().toISOString(), goalsScored: gf, goalsConceded: gc, yellowCards: parseInt(document.getElementById('yc').value)||0, blueCards: parseInt(document.getElementById('bc').value)||0, redCards: parseInt(document.getElementById('rc').value)||0, refereeValue: refValue, presentPlayers: selectedIds, refereePayments: matchSelection, playerDetails: playerDetailsMap, result, points };
                let newMatches = [...(tournamentData.matches || [])];
                if(editId) { const idx = newMatches.findIndex(m => m.id === editId); if(idx >= 0) newMatches[idx] = matchObj; } else { newMatches.push(matchObj); }
                const batchUpdates = [];
                for (const pid of selectedIds) {
                    const p = players.find(x => x.id === pid); if(!p) continue;
                    let currentDebt = p.cardDebt || 0; const stats = matchSelection[pid].stats || { goals:0, yellow:0, blue:0, red:0 };
                    if (!editId) { if(stats.yellow) currentDebt += (stats.yellow * FINE_VALUES.yellow); if(stats.blue) currentDebt += (stats.blue * FINE_VALUES.blue); if(stats.red) currentDebt += (stats.red * FINE_VALUES.red); }
                    if (matchSelection[pid].paidFines) { currentDebt = 0; if (!editId) { if(stats.yellow) currentDebt += (stats.yellow * FINE_VALUES.yellow); if(stats.blue) currentDebt += (stats.blue * FINE_VALUES.blue); if(stats.red) currentDebt += (stats.red * FINE_VALUES.red); } }
                    batchUpdates.push(updateDoc(doc(collection(db, currentPlayersCollection), pid), { cardDebt: currentDebt }));
                }
                await Promise.all(batchUpdates);
                await updateDoc(doc(collection(db, currentTournamentCollection), currentTournament), { matches: newMatches });
                await recalculateAllDebts();
                window.resetMatchForm(); window.showToast('Partido guardado y deudas recalculadas');
            } catch(e) { console.error(e); window.showToast("Error: " + e.message, true); }
        };

        window.viewMatchDetails = (matchId) => {
            const m = tournamentData.matches.find(x => x.id === matchId);
            if(!m) return;
            document.getElementById('mdScore').innerHTML = `<span class="${m.result === 'Victoria' ? 'text-success' : ''}">${m.goalsScored}</span> - <span class="${m.result === 'Derrota' ? 'text-danger' : ''}">${m.goalsConceded}</span>`;
            document.getElementById('mdDate').textContent = new Date(m.date).toLocaleDateString();
            document.getElementById('mdYC').textContent = m.yellowCards || 0; document.getElementById('mdBC').textContent = m.blueCards || 0; document.getElementById('mdRC').textContent = m.redCards || 0;
            document.getElementById('mdRefTotal').textContent = formatCOP(m.refereeValue || 0);
            const list = document.getElementById('mdPlayerList');
            const details = m.playerDetails || {};
            const payments = m.refereePayments || {};
            list.innerHTML = (m.presentPlayers || []).map(pid => {
                const p = players.find(x => x.id === pid) || {name: 'Desconocido'};
                const stats = details[pid] || { goals:0, yellow:0, blue:0, red:0 };
                const payInfo = payments[pid] || { paidRef: false };
                let statsHtml = '';
                if(stats.goals) statsHtml += `<span class="ml-1 text-success">丘${stats.goals}</span>`;
                if(stats.yellow) statsHtml += `<span class="ml-1 text-yellow-500">游릳${stats.yellow}</span>`;
                if(stats.red) statsHtml += `<span class="ml-1 text-red-500">游린${stats.red}</span>`;
                return `<div class="flex justify-between items-center py-1 border-b border-gray-800/50"><div class="text-gray-300">${p.name} ${statsHtml}</div><span class="text-xs px-2 py-0.5 rounded ${payInfo.paidRef ? 'bg-success/20 text-success' : 'bg-danger/20 text-danger'}">${payInfo.paidRef ? 'PAGADO' : 'DEBE'}</span></div>`;
            }).join('');
            document.getElementById('matchDetailModal').classList.remove('hidden');
        };

        // --- FUNCION CORREGIDA: EDIT MATCH ---
        window.editMatch = (matchId) => {
            const match = tournamentData.matches.find(m => m.id === matchId);
            if(!match) return;
            
            document.getElementById('gf').value = match.goalsScored; 
            document.getElementById('gc').value = match.goalsConceded;
            document.getElementById('yc').value = match.yellowCards || 0; 
            document.getElementById('bc').value = match.blueCards || 0; 
            document.getElementById('rc').value = match.redCards || 0;
            document.getElementById('refPrice').value = match.refereeValue || 0;
            
            document.getElementById('editingMatchId').value = match.id;
            document.getElementById('saveMatchBtnText').textContent = "Actualizar Partido";
            document.getElementById('matchFormTitle').textContent = "Editar Partido";
            document.getElementById('matchFormCard').classList.add('border-amber-500');
            
            matchSelection = match.refereePayments || {};
            const savedStats = match.playerDetails || {}; // Recuperamos los goles/tarjetas reales
            
            Object.keys(matchSelection).forEach(k => { 
                if(!matchSelection[k].stats) matchSelection[k].stats = {goals:0, yellow:0, blue:0, red:0};
                if (savedStats[k]) {
                    matchSelection[k].stats = { ...savedStats[k] };
                }
            });

            window.renderMatchSelector();
            document.querySelector('main').scrollTo({ top: 0, behavior: 'smooth' });
            window.showToast("Modo edici칩n activado", false);
        };

        window.deleteMatch = async (matchId) => {
            if (!matchId || matchId === 'undefined') { window.showToast("Error: ID inv치lido", true); return; }
            if(!confirm("쮼liminar este partido definitivamente?")) return;
            const newMatches = tournamentData.matches.filter(m => String(m.id) !== String(matchId));
            await updateDoc(doc(collection(db, currentTournamentCollection), currentTournament), { matches: newMatches });
            await recalculateAllDebts();
            window.showToast("Partido eliminado correctamente");
        };

        window.resetMatchForm = () => {
            document.getElementById('gf').value = 0; document.getElementById('gc').value = 0;
            document.getElementById('yc').value = 0; document.getElementById('bc').value = 0; document.getElementById('rc').value = 0;
            document.getElementById('refPrice').value = ''; document.getElementById('editingMatchId').value = '';
            document.getElementById('saveMatchBtnText').textContent = "Guardar Partido";
            document.getElementById('matchFormTitle').textContent = "Registrar Resultado";
            document.getElementById('matchFormCard').classList.remove('border-amber-500');
            matchSelection = {};
            window.renderMatchSelector();
        };

        window.saveConfName = async () => { await updateDoc(doc(collection(db, currentTournamentCollection), currentTournament), { name: document.getElementById('confName').value }); window.showToast('Actualizado'); };
        window.saveConfiguration = async () => { const name = document.getElementById('confName').value; const total = parseFloat(document.getElementById('confPrice').value); if (!name) return window.showToast("Nombre vac칤o", true); await updateDoc(doc(collection(db, currentTournamentCollection), currentTournament), { name: name }); await window.autoRecalculateFees(total); window.showToast('Guardado'); };
        window.autoRecalculateFees = async (explicitTotal = null) => { try { const total = explicitTotal !== null ? parseFloat(explicitTotal) : (tournamentData.totalInscription || 0); if (players.length > 0 && total > 0) { const newPerPlayer = total / players.length; await updateDoc(doc(collection(db, currentTournamentCollection), currentTournament), { totalInscription: total, inscriptionPerPlayer: newPerPlayer }); window.showToast(`Cuota: ${formatCOP(newPerPlayer)}`); } } catch(e) { console.error(e); } };
        window.confirmResetTournament = async () => { if(!confirm("쯉eguro?")) return; await updateDoc(doc(collection(db, currentTournamentCollection), currentTournament), { matches: [], stats: {}, totalInscription: 0 }); for(let p of players) { await updateDoc(doc(collection(db, currentPlayersCollection), p.id), { payments: [], totalPaid: 0, cardDebt: 0 }); } window.showToast("Reiniciado"); };

        // START
        async function init() {
            try { await setPersistence(auth, inMemoryPersistence); } catch(e) {}
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    document.getElementById('connectionStatus').innerHTML = '<i class="fa-solid fa-circle text-success text-[8px] mr-2"></i> Conectado';
                    loadTournamentsList();
                } else {
                    signInAnonymously(auth).then(() => loadTournamentsList()).catch(() => { 
                        document.getElementById('connectionStatus').innerHTML = '<i class="fa-solid fa-circle text-danger text-[8px] mr-2"></i> Offline';
                        loadTournamentsList(); 
                    });
                }
            });
        }
        init();
    </script>
</body>
</html>
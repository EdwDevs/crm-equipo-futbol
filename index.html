<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Imperio Andino CRM | Pro</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Outfit', 'sans-serif'] },
                    colors: {
                        dark: '#0B1120',
                        surface: '#151E32',
                        primary: '#3B82F6',
                        accent: '#F59E0B',
                        success: '#10B981',
                        danger: '#EF4444'
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #0B1120; color: #E2E8F0; }
        .glass { background: rgba(21, 30, 50, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.05); }
        .nav-item.active { background: rgba(59, 130, 246, 0.15); color: #60A5FA; border-left: 3px solid #3B82F6; }
        .loader { border: 3px solid rgba(255,255,255,0.1); border-left-color: #3B82F6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
    </style>
</head>
<body class="h-screen flex overflow-hidden text-sm">

    <!-- SIDEBAR -->
    <aside class="w-64 bg-surface border-r border-gray-800 flex-shrink-0 hidden md:flex flex-col">
        <div class="p-6 flex items-center gap-3">
            <i class="fa-solid fa-star text-accent text-xl"></i>
            <div>
                <h1 class="font-bold text-lg tracking-wide text-white">IMPERIO</h1>
                <p class="text-xs text-gray-400 tracking-widest">ANDINO CRM</p>
            </div>
        </div>

        <div class="px-4 mb-6">
            <div class="bg-dark p-3 rounded-xl border border-gray-700 flex justify-between items-center">
                <span id="activeTournamentName" class="font-semibold text-gray-300">Cargando...</span>
                <div class="flex gap-1">
                    <button onclick="selectTournament('torneo1')" class="text-xs px-2 py-1 rounded bg-gray-700 hover:bg-primary transition" id="btn-t1">T1</button>
                    <button onclick="selectTournament('torneo2')" class="text-xs px-2 py-1 rounded bg-gray-700 hover:bg-primary transition" id="btn-t2">T2</button>
                </div>
            </div>
        </div>

        <nav class="flex-1 px-2 space-y-1">
            <button onclick="showView('dashboard')" class="nav-item active w-full flex items-center gap-3 px-4 py-3 text-gray-400 hover:text-white rounded-lg transition">
                <i class="fa-solid fa-chart-pie w-5"></i> Dashboard
            </button>
            <button onclick="showView('players')" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-gray-400 hover:text-white rounded-lg transition">
                <i class="fa-solid fa-users w-5"></i> Jugadores
            </button>
            <button onclick="showView('matches')" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-gray-400 hover:text-white rounded-lg transition">
                <i class="fa-solid fa-futbol w-5"></i> Partidos
            </button>
            <button onclick="showView('finances')" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-gray-400 hover:text-white rounded-lg transition">
                <i class="fa-solid fa-money-bill-wave w-5"></i> Finanzas
            </button>
            <button onclick="showView('settings')" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-gray-400 hover:text-white rounded-lg transition">
                <i class="fa-solid fa-gear w-5"></i> Configuración
            </button>
        </nav>

        <div class="p-4">
            <div id="connectionStatus" class="text-xs text-center text-gray-500 bg-gray-900 py-2 rounded border border-gray-800">
                <i class="fa-solid fa-circle-notch fa-spin mr-1"></i> Conectando...
            </div>
        </div>
    </aside>

    <!-- MOBILE HEADER -->
    <div class="md:hidden fixed top-0 w-full bg-surface z-50 flex justify-between items-center p-4 border-b border-gray-800">
        <span class="font-bold text-accent">IMPERIO ANDINO</span>
        <button onclick="document.querySelector('aside').classList.toggle('hidden'); document.querySelector('aside').classList.toggle('absolute'); document.querySelector('aside').classList.toggle('z-50'); document.querySelector('aside').classList.toggle('h-full');" class="text-white"><i class="fa-solid fa-bars"></i></button>
    </div>

    <!-- MAIN CONTENT -->
    <main class="flex-1 overflow-y-auto bg-dark relative md:pt-0 pt-16">
        
        <!-- VISTA: DASHBOARD -->
        <div id="view-dashboard" class="p-6 max-w-6xl mx-auto fade-in">
            <h2 class="text-2xl font-bold text-white mb-6">Resumen General</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="glass p-6 rounded-2xl border-l-4 border-success">
                    <div class="text-gray-400 text-xs uppercase tracking-wide mb-1">Recaudado</div>
                    <div class="text-3xl font-bold text-white" id="dashCollected">$0</div>
                </div>
                <div class="glass p-6 rounded-2xl border-l-4 border-danger">
                    <div class="text-gray-400 text-xs uppercase tracking-wide mb-1">Deuda Total</div>
                    <div class="text-3xl font-bold text-white" id="dashDebt">$0</div>
                </div>
                <div class="glass p-6 rounded-2xl border-l-4 border-primary">
                    <div class="text-gray-400 text-xs uppercase tracking-wide mb-1">Partidos Jugados</div>
                    <div class="text-3xl font-bold text-white" id="dashMatches">0</div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Tabla Goleadores/Asistencia -->
                <div class="glass rounded-2xl p-6">
                    <h3 class="text-lg font-bold text-white mb-4">Top Asistencia</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <tbody id="topPlayersTable" class="text-gray-300 divide-y divide-gray-800"></tbody>
                        </table>
                    </div>
                </div>
                <!-- Últimos Partidos -->
                <div class="glass rounded-2xl p-6">
                    <h3 class="text-lg font-bold text-white mb-4">Racha Reciente</h3>
                    <div id="recentMatchesList" class="space-y-3"></div>
                </div>
            </div>
        </div>

        <!-- VISTA: JUGADORES -->
        <div id="view-players" class="p-6 max-w-6xl mx-auto hidden fade-in">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-white">Plantilla</h2>
                <button onclick="openModal('playerModal')" class="bg-primary hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-medium transition shadow-lg shadow-blue-900/20">
                    <i class="fa-solid fa-plus mr-2"></i> Nuevo
                </button>
            </div>

            <div class="glass rounded-2xl p-4 mb-6">
                <input type="text" id="searchPlayer" placeholder="Buscar por nombre o dorsal..." class="w-full bg-dark border border-gray-700 rounded-lg px-4 py-3 text-white focus:border-primary focus:outline-none transition" onkeyup="renderPlayers()">
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4" id="playersGrid">
                <!-- Cards renderizadas por JS -->
            </div>
        </div>

        <!-- VISTA: PARTIDOS -->
        <div id="view-matches" class="p-6 max-w-4xl mx-auto hidden fade-in">
            <h2 class="text-2xl font-bold text-white mb-6">Registrar Encuentro</h2>
            
            <div class="glass rounded-2xl p-6 mb-8">
                <!-- Marcador -->
                <div class="flex items-center justify-center gap-8 mb-8">
                    <div class="text-center">
                        <div class="text-xs text-gray-400 mb-2">NOSOTROS</div>
                        <input type="number" id="gf" class="w-20 h-20 text-4xl font-bold text-center bg-dark border border-gray-700 rounded-xl text-success focus:border-success focus:outline-none" value="0" min="0">
                    </div>
                    <span class="text-2xl font-bold text-gray-600">VS</span>
                    <div class="text-center">
                        <div class="text-xs text-gray-400 mb-2">RIVAL</div>
                        <input type="number" id="gc" class="w-20 h-20 text-4xl font-bold text-center bg-dark border border-gray-700 rounded-xl text-danger focus:border-danger focus:outline-none" value="0" min="0">
                    </div>
                </div>

                <!-- Tarjetas y Costo -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div>
                        <label class="block text-xs text-yellow-500 mb-1 text-center font-bold">Amarillas</label>
                        <input type="number" id="yc" class="w-full bg-dark border border-gray-700 rounded-lg px-3 py-2 text-center text-white" value="0">
                    </div>
                    <div>
                        <label class="block text-xs text-blue-400 mb-1 text-center font-bold">Azules</label>
                        <input type="number" id="bc" class="w-full bg-dark border border-gray-700 rounded-lg px-3 py-2 text-center text-white" value="0">
                    </div>
                    <div>
                        <label class="block text-xs text-red-500 mb-1 text-center font-bold">Rojas</label>
                        <input type="number" id="rc" class="w-full bg-dark border border-gray-700 rounded-lg px-3 py-2 text-center text-white" value="0">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-400 mb-1 text-center font-bold">Arbitraje Total</label>
                        <input type="number" id="refPrice" class="w-full bg-dark border border-gray-700 rounded-lg px-3 py-2 text-center text-white" placeholder="$" oninput="calcRef()">
                    </div>
                </div>

                <!-- Selección Jugadores -->
                <div class="bg-dark rounded-xl p-4 border border-gray-800">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-sm font-bold text-gray-300">Convocatoria y Pagos</span>
                        <span class="text-xs text-gray-500" id="convocadosCount">0 seleccionados</span>
                    </div>
                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2 max-h-60 overflow-y-auto p-1" id="matchPlayersGrid">
                        <!-- Render JS -->
                    </div>
                    <div class="mt-4 flex justify-between items-center text-sm border-t border-gray-800 pt-3">
                        <span class="text-gray-400">Costo por jugador: <span id="costPerPlayer" class="text-white font-bold">$0</span></span>
                        <span class="text-gray-400">Recaudado: <span id="totalCollectedMatch" class="text-success font-bold">$0</span></span>
                    </div>
                </div>

                <button onclick="previewMatch()" class="w-full mt-6 bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 text-white font-bold py-3 rounded-xl shadow-lg shadow-blue-900/30 transition">
                    Guardar Partido
                </button>
            </div>
        </div>

        <!-- VISTA: FINANZAS -->
        <div id="view-finances" class="p-6 max-w-6xl mx-auto hidden fade-in">
            <h2 class="text-2xl font-bold text-white mb-6">Control Financiero</h2>
            
            <div class="glass rounded-2xl p-6 mb-6">
                <h3 class="text-lg font-bold text-white mb-4">Registrar Abono</h3>
                <div class="flex flex-col md:flex-row gap-4 items-end">
                    <div class="flex-1 w-full">
                        <label class="block text-xs text-gray-400 mb-1">Jugador</label>
                        <select id="payPlayerSelect" class="w-full bg-dark border border-gray-700 rounded-lg px-4 py-2.5 text-white focus:border-primary outline-none"></select>
                    </div>
                    <div class="w-full md:w-48">
                        <label class="block text-xs text-gray-400 mb-1">Monto</label>
                        <input type="number" id="payAmount" class="w-full bg-dark border border-gray-700 rounded-lg px-4 py-2.5 text-white focus:border-primary outline-none" placeholder="$">
                    </div>
                    <button onclick="addPayment()" class="w-full md:w-auto bg-success hover:bg-emerald-600 text-white px-6 py-2.5 rounded-lg font-medium transition">
                        Registrar
                    </button>
                </div>
            </div>

            <div class="glass rounded-2xl p-6 overflow-x-auto">
                <table class="w-full text-left text-sm text-gray-300">
                    <thead class="text-xs uppercase text-gray-500 border-b border-gray-700">
                        <tr>
                            <th class="pb-3">Jugador</th>
                            <th class="pb-3 text-right">Debe</th>
                            <th class="pb-3 text-right">Pagado</th>
                            <th class="pb-3 text-right">Saldo</th>
                            <th class="pb-3 text-center">Estado</th>
                        </tr>
                    </thead>
                    <tbody id="financesTableBody" class="divide-y divide-gray-800"></tbody>
                </table>
            </div>
        </div>

        <!-- VISTA: CONFIGURACIÓN -->
        <div id="view-settings" class="p-6 max-w-2xl mx-auto hidden fade-in">
            <h2 class="text-2xl font-bold text-white mb-6">Configuración</h2>
            <div class="glass rounded-2xl p-6 space-y-6">
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Nombre del Torneo</label>
                    <div class="flex gap-2">
                        <input type="text" id="confName" class="flex-1 bg-dark border border-gray-700 rounded-lg px-4 py-2 text-white">
                        <button onclick="saveConfName()" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">Guardar</button>
                    </div>
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Costo Inscripción Total</label>
                    <div class="flex gap-2">
                        <input type="number" id="confPrice" class="flex-1 bg-dark border border-gray-700 rounded-lg px-4 py-2 text-white">
                        <button onclick="saveConfPrice()" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">Calcular</button>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Esto dividirá el costo entre todos los jugadores registrados.</p>
                </div>
            </div>
        </div>

    </main>

    <!-- MODAL ADD PLAYER -->
    <div id="playerModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden z-[60] flex items-center justify-center p-4">
        <div class="bg-surface border border-gray-700 rounded-2xl w-full max-w-md p-6 relative shadow-2xl">
            <button onclick="closeModal('playerModal')" class="absolute top-4 right-4 text-gray-400 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
            <h3 class="text-xl font-bold text-white mb-4">Nuevo Jugador</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs text-gray-400 mb-1">Nombre</label>
                    <input type="text" id="newPlayerName" class="w-full bg-dark border border-gray-700 rounded-lg px-4 py-2 text-white focus:border-primary outline-none">
                </div>
                <div>
                    <label class="block text-xs text-gray-400 mb-1">Dorsal</label>
                    <input type="number" id="newPlayerNum" class="w-full bg-dark border border-gray-700 rounded-lg px-4 py-2 text-white focus:border-primary outline-none">
                </div>
                <button onclick="createNewPlayer()" class="w-full bg-primary hover:bg-blue-600 text-white py-2 rounded-lg font-bold mt-2">Guardar Jugador</button>
            </div>
        </div>
    </div>

    <!-- TOAST -->
    <div id="toast" class="fixed bottom-5 left-1/2 transform -translate-x-1/2 bg-surface border border-gray-700 text-white px-6 py-3 rounded-xl shadow-2xl flex items-center gap-3 opacity-0 pointer-events-none transition-opacity duration-300 z-[70]">
        <i class="fa-solid fa-info-circle text-primary"></i>
        <span id="toastMsg">Mensaje</span>
    </div>

    <!-- FIREBASE LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, doc, onSnapshot, setDoc, updateDoc, deleteDoc, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, setPersistence, inMemoryPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBXylL77z6EPDy2EuXVLLF_hkW8CyQvns4",
            authDomain: "crm-futbol.firebaseapp.com",
            projectId: "crm-futbol",
            storageBucket: "crm-futbol.firebasestorage.app",
            messagingSenderId: "222709021751",
            appId: "1:222709021751:web:94168589472c2ee938d3b2"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // State
        let currentTournament = 'torneo1';
        let players = [];
        let tournamentData = {};
        let matchSelection = {}; // {playerId: {selected: bool, paid: bool}}

        // DOM Elements
        const statusEl = document.getElementById('connectionStatus');

        // Auth & Init
        async function init() {
            // Set persistence first to handle sandboxed environments correctly
            try {
                await setPersistence(auth, inMemoryPersistence);
            } catch(e) {
                console.log("Persistence error ignored", e);
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    statusEl.innerHTML = '<i class="fa-solid fa-circle text-success text-[8px] mr-2"></i> Conectado';
                    statusEl.className = 'text-xs text-center text-success bg-green-900/20 py-2 rounded border border-green-900/30';
                    loadData();
                } else {
                    signInAnonymously(auth).catch((error) => {
                        console.error("Auth Error:", error);
                        
                        // Show specific error about domains
                        let errorMsg = "Error Auth";
                        if (error.code === 'auth/configuration-not-found' || error.code === 'auth/unauthorized-domain') {
                             errorMsg = "Bloqueo de Dominio";
                             showToast("⚠️ Error: Este dominio no está autorizado en Firebase Console", true);
                        } else if (error.code === 'auth/operation-not-allowed') {
                             errorMsg = "Anon Auth Disabled";
                             showToast("⚠️ Error: Habilita 'Anónimo' en Authentication > Sign-in method", true);
                        } else {
                             showToast(`Error de Auth: ${error.code}`, true);
                        }

                        statusEl.innerHTML = `<i class="fa-solid fa-circle text-danger text-[8px] mr-2"></i> ${errorMsg}`;
                        statusEl.className = 'text-xs text-center text-danger bg-red-900/20 py-2 rounded border border-red-900/30';
                        
                        // TRY TO LOAD DATA ANYWAY (For public rules)
                        loadData();
                    });
                }
            });
        }

        function loadData() {
            console.log("Intentando cargar datos...");
            // Listen to Players
            const q = query(collection(db, "players"), where("tournament", "==", currentTournament));
            onSnapshot(q, (snapshot) => {
                players = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()})).sort((a,b) => a.number - b.number);
                renderAll();
            }, (error) => {
                console.error("Error loading players:", error);
                if (error.code === 'permission-denied') {
                    showToast("⚠️ Permisos insuficientes: Revisa tus reglas de Firestore", true);
                }
            });

            // Listen to Tournament
            onSnapshot(doc(db, "tournaments", currentTournament), (doc) => {
                if(doc.exists()) {
                    tournamentData = doc.data();
                    document.getElementById('activeTournamentName').textContent = tournamentData.name;
                    document.getElementById('confName').value = tournamentData.name;
                    document.getElementById('confPrice').value = tournamentData.totalInscription || 0;
                    renderDashboard();
                } else {
                    // Create if not exists (Only works if we have write permission)
                    setDoc(doc.ref, { name: "Nuevo Torneo", totalInscription: 0, matches: [], stats: {} }).catch(e => console.warn("Cannot create initial doc", e));
                }
            }, (error) => {
                 console.error("Error loading tournament:", error);
            });
        }

        // GLOBAL FUNCTIONS
        window.selectTournament = (tId) => {
            currentTournament = tId;
            document.querySelectorAll('[id^="btn-t"]').forEach(b => b.classList.remove('bg-primary', 'text-white'));
            document.getElementById('btn-' + (tId === 'torneo1' ? 't1' : 't2')).classList.add('bg-primary', 'text-white');
            loadData(); // Reload listeners
        };

        window.showView = (viewName) => {
            document.querySelectorAll('main > div').forEach(div => div.classList.add('hidden'));
            document.getElementById('view-' + viewName).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(btn => btn.classList.remove('active', 'text-white', 'bg-blue-500/10'));
            // Simple active state logic for demo, in real app use IDs
            event.currentTarget.classList.add('active', 'text-white');
        };

        // RENDER FUNCTIONS
        function renderAll() {
            renderPlayers();
            renderMatchSelector();
            renderFinances();
            renderDashboard();
        }

        window.renderPlayers = () => {
            const filter = document.getElementById('searchPlayer').value.toLowerCase();
            const grid = document.getElementById('playersGrid');
            const sel = document.getElementById('payPlayerSelect');
            
            grid.innerHTML = '';
            sel.innerHTML = '<option value="">Seleccionar Jugador...</option>';

            players.forEach(p => {
                if(p.name.toLowerCase().includes(filter) || p.number.toString().includes(filter)) {
                    // Card
                    const card = document.createElement('div');
                    card.className = 'glass p-4 rounded-xl border border-gray-800 hover:border-gray-600 transition group relative';
                    card.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-gray-700 flex items-center justify-center font-bold text-gray-300">${p.number}</div>
                                <div>
                                    <div class="font-bold text-white leading-tight">${p.name}</div>
                                    <div class="text-xs text-gray-500">Pagado: $${(p.totalPaid || 0).toLocaleString()}</div>
                                </div>
                            </div>
                            <button onclick="deletePlayer('${p.id}')" class="text-gray-600 hover:text-red-500 opacity-0 group-hover:opacity-100 transition"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    `;
                    grid.appendChild(card);
                }
                // Select option
                const opt = document.createElement('option');
                opt.value = p.id;
                opt.textContent = `${p.number}. ${p.name}`;
                sel.appendChild(opt);
            });
        };

        function renderMatchSelector() {
            const grid = document.getElementById('matchPlayersGrid');
            grid.innerHTML = '';
            
            players.forEach(p => {
                const state = matchSelection[p.id] || { selected: false, paid: false };
                const div = document.createElement('div');
                div.className = `p-2 rounded-lg border cursor-pointer transition flex flex-col items-center text-center relative ${state.selected ? 'bg-blue-900/30 border-blue-500' : 'bg-gray-800/50 border-transparent hover:bg-gray-800'}`;
                div.onclick = () => toggleMatchSelection(p.id);
                
                div.innerHTML = `
                    <div class="text-xs font-bold text-gray-300 mb-1">${p.name}</div>
                    ${state.selected ? 
                        `<button onclick="event.stopPropagation(); toggleMatchPay('${p.id}')" class="text-[10px] px-2 py-0.5 rounded ${state.paid ? 'bg-success text-white' : 'bg-gray-700 text-gray-400'}">
                            ${state.paid ? '$ PAGADO' : '$ DEBE'}
                        </button>` : ''
                    }
                `;
                grid.appendChild(div);
            });
            window.calcRef();
        }

        function renderFinances() {
            const tbody = document.getElementById('financesTableBody');
            tbody.innerHTML = '';
            const cost = tournamentData.inscriptionPerPlayer || 0;

            players.forEach(p => {
                const paid = p.totalPaid || 0;
                const debt = cost - paid;
                const status = debt <= 0 ? '<span class="text-success text-xs bg-green-900/30 px-2 py-1 rounded">Al día</span>' : '<span class="text-warning text-xs bg-yellow-900/30 px-2 py-1 rounded">Pendiente</span>';
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="py-3 font-medium text-white">${p.name}</td>
                    <td class="py-3 text-right text-gray-400">$${cost.toLocaleString()}</td>
                    <td class="py-3 text-right text-success">$${paid.toLocaleString()}</td>
                    <td class="py-3 text-right ${debt > 0 ? 'text-danger font-bold' : 'text-gray-500'}">$${Math.max(0, debt).toLocaleString()}</td>
                    <td class="py-3 text-center">${status}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderDashboard() {
            // Stats
            const matches = tournamentData.matches || [];
            const totalPaid = players.reduce((acc, p) => acc + (p.totalPaid || 0), 0);
            // Calc debt roughly (simple version)
            const totalDebt = players.length * (tournamentData.inscriptionPerPlayer || 0) - totalPaid;

            document.getElementById('dashCollected').textContent = `$${totalPaid.toLocaleString()}`;
            document.getElementById('dashDebt').textContent = `$${Math.max(0, totalDebt).toLocaleString()}`;
            document.getElementById('dashMatches').textContent = matches.length;

            // Recent Matches
            const recentDiv = document.getElementById('recentMatchesList');
            recentDiv.innerHTML = matches.slice(-4).reverse().map(m => `
                <div class="flex justify-between items-center border-b border-gray-800 pb-2 last:border-0">
                    <div>
                        <div class="text-sm font-bold text-white">${m.goalsScored} - ${m.goalsConceded}</div>
                        <div class="text-xs text-gray-500">${new Date(m.date).toLocaleDateString()}</div>
                    </div>
                    <div class="text-xs font-bold ${m.result === 'Victoria' ? 'text-success' : m.result === 'Derrota' ? 'text-danger' : 'text-gray-400'}">${m.result}</div>
                </div>
            `).join('');

            // Simple MVP (Most Played)
            const sorted = [...players].map(p => {
                const played = matches.filter(m => m.presentPlayers.includes(p.id)).length;
                return { ...p, played };
            }).sort((a,b) => b.played - a.played).slice(0, 5);

            document.getElementById('topPlayersTable').innerHTML = sorted.map(p => `
                <tr><td class="py-2 text-sm">${p.name}</td><td class="text-right font-bold text-primary">${p.played} PJ</td></tr>
            `).join('');
        }

        // ACTIONS
        window.openModal = (id) => document.getElementById(id).classList.remove('hidden');
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');

        window.createNewPlayer = async () => {
            const name = document.getElementById('newPlayerName').value;
            const num = document.getElementById('newPlayerNum').value;
            if(!name || !num) return showToast('Completa los campos', true);
            
            await setDoc(doc(collection(db, "players")), {
                name, number: parseInt(num), tournament: currentTournament, totalPaid: 0, payments: []
            });
            document.getElementById('newPlayerName').value = '';
            closeModal('playerModal');
            showToast('Jugador creado');
        };

        window.deletePlayer = async (id) => {
            if(confirm("¿Eliminar jugador?")) await deleteDoc(doc(db, "players", id));
        };

        window.addPayment = async () => {
            const id = document.getElementById('payPlayerSelect').value;
            const amount = parseFloat(document.getElementById('payAmount').value);
            if(!id || !amount) return;

            const p = players.find(x => x.id === id);
            const newTotal = (p.totalPaid || 0) + amount;
            const newPayments = [...(p.payments || []), { date: new Date().toISOString(), amount }];

            await updateDoc(doc(db, "players", id), { totalPaid: newTotal, payments: newPayments });
            document.getElementById('payAmount').value = '';
            showToast('Pago registrado exitosamente');
        };

        window.saveConfName = async () => {
            await updateDoc(doc(db, "tournaments", currentTournament), { name: document.getElementById('confName').value });
            showToast('Nombre actualizado');
        };

        window.saveConfPrice = async () => {
            const total = parseFloat(document.getElementById('confPrice').value);
            if(players.length === 0) return;
            const perPlayer = total / players.length;
            await updateDoc(doc(db, "tournaments", currentTournament), { totalInscription: total, inscriptionPerPlayer: perPlayer });
            showToast('Precios recalculados');
        };

        // MATCH LOGIC
        window.toggleMatchSelection = (id) => {
            if(!matchSelection[id]) matchSelection[id] = { selected: false, paid: false };
            matchSelection[id].selected = !matchSelection[id].selected;
            if(!matchSelection[id].selected) matchSelection[id].paid = false;
            renderMatchSelector();
        };

        window.toggleMatchPay = (id) => {
            if(matchSelection[id]) {
                matchSelection[id].paid = !matchSelection[id].paid;
                renderMatchSelector();
            }
        };

        window.calcRef = () => {
            const total = parseFloat(document.getElementById('refPrice').value) || 0;
            const selected = Object.keys(matchSelection).filter(k => matchSelection[k].selected);
            const count = selected.length;
            const perPlayer = count > 0 ? total / count : 0;
            
            const paidCount = selected.filter(k => matchSelection[k].paid).length;
            
            document.getElementById('convocadosCount').textContent = `${count} Jugadores`;
            document.getElementById('costPerPlayer').textContent = `$${Math.round(perPlayer).toLocaleString()}`;
            document.getElementById('totalCollectedMatch').textContent = `$${Math.round(paidCount * perPlayer).toLocaleString()}`;
        };

        window.previewMatch = async () => {
            const gf = parseInt(document.getElementById('gf').value);
            const gc = parseInt(document.getElementById('gc').value);
            const refValue = parseFloat(document.getElementById('refPrice').value) || 0;
            
            const selected = Object.keys(matchSelection).filter(k => matchSelection[k].selected);
            if(selected.length === 0) return showToast('Selecciona jugadores', true);

            let result = 'Derrota';
            let points = 0;
            if(gf > gc) { result = 'Victoria'; points = 3; }
            else if (gf === gc) { result = 'Empate'; points = 1; }

            const newMatch = {
                date: new Date().toISOString(),
                goalsScored: gf,
                goalsConceded: gc,
                yellowCards: parseInt(document.getElementById('yc').value) || 0,
                blueCards: parseInt(document.getElementById('bc').value) || 0,
                redCards: parseInt(document.getElementById('rc').value) || 0,
                refereeValue: refValue,
                presentPlayers: selected,
                refereePayments: matchSelection, // Save full state
                result, points
            };

            const currentMatches = tournamentData.matches || [];
            const currentStats = tournamentData.stats || {};

            // Update Stats Aggregation
            const newStats = {
                points: (currentStats.points || 0) + points,
                goalsScored: (currentStats.goalsScored || 0) + gf,
                goalsConceded: (currentStats.goalsConceded || 0) + gc
            };

            await updateDoc(doc(db, "tournaments", currentTournament), {
                matches: [...currentMatches, newMatch],
                stats: newStats
            });

            // Reset
            matchSelection = {};
            document.getElementById('gf').value = 0;
            document.getElementById('gc').value = 0;
            renderMatchSelector();
            showToast('Partido registrado!');
            showView('dashboard');
        };

        function showToast(msg, isError = false) {
            const el = document.getElementById('toast');
            document.getElementById('toastMsg').textContent = msg;
            el.className = `fixed bottom-5 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-xl shadow-2xl flex items-center gap-3 transition-opacity duration-300 z-[70] ${isError ? 'bg-red-900/90 border-red-500 text-white' : 'bg-surface border-gray-700 text-white'} opacity-100`;
            setTimeout(() => el.classList.add('opacity-0'), 3000);
        }

        // Start
        init();
    </script>
</body>
</html>

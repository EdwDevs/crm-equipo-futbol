<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>‚öΩ CRM F√∫tbol Avanzado</title>
<style>
  /* Reset y configuraci√≥n base */
  * { 
    margin: 0; 
    padding: 0; 
    box-sizing: border-box; 
  }
  
  :root {
    --primary: #667eea;
    --primary-dark: #5568d3;
    --secondary: #764ba2;
    --success: #28a745;
    --danger: #dc3545;
    --warning: #ffc107;
    --info: #17a2b8;
    --light: #f8f9fa;
    --dark: #333;
    --border: #ddd;
    --shadow: rgba(0, 0, 0, 0.1);
    --container-width: 500px;
    --padding: 10px;
    --font-base: 14px;
    --header-size: 24px;
  }
  
  @media (min-width: 768px) {
    :root {
      --container-width: 1000px;
      --padding: 20px;
      --font-base: 15px;
      --header-size: 28px;
    }
  }
  
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    min-height: 100vh;
    padding: var(--padding);
    color: var(--dark);
    font-size: var(--font-base);
    line-height: 1.6;
  }
  
  .container {
    max-width: var(--container-width);
    margin: 0 auto;
    background: white;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    overflow: hidden;
    display: flex;
    flex-direction: column;
    max-height: 95vh;
  }
  
  .header {
    background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    color: white;
    padding: clamp(15px, 3vw, 25px);
    text-align: center;
    flex-shrink: 0;
  }
  
  .header h1 { 
    font-size: var(--header-size);
    margin-bottom: 8px;
    font-weight: 700;
  }
  
  .header p {
    font-size: calc(var(--font-base) * 0.9);
    opacity: 0.95;
  }
  
  .nav-tabs {
    display: flex;
    overflow-x: auto;
    background: var(--light);
    border-bottom: 2px solid var(--border);
    flex-shrink: 0;
    scrollbar-width: thin;
    scrollbar-color: var(--primary) var(--light);
  }
  
  .nav-tabs::-webkit-scrollbar { height: 6px; }
  .nav-tabs::-webkit-scrollbar-track { background: var(--light); }
  .nav-tabs::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 3px; }
  
  .nav-tabs button {
    flex: 0 0 auto;
    min-width: 100px;
    padding: clamp(10px, 2vw, 14px) clamp(12px, 3vw, 16px);
    border: none;
    background: transparent;
    cursor: pointer;
    font-size: calc(var(--font-base) * 0.95);
    font-weight: 600;
    color: #666;
    transition: all 0.3s ease;
    white-space: nowrap;
  }
  
  .nav-tabs button.active {
    background: white;
    color: var(--primary);
    border-bottom: 3px solid var(--primary);
  }
  
  .nav-tabs button:hover { background: rgba(255, 255, 255, 0.5); }
  
  .content {
    padding: clamp(12px, 3vw, 20px);
    overflow-y: auto;
    flex: 1;
    scrollbar-width: thin;
    scrollbar-color: var(--primary) var(--light);
  }
  
  .content::-webkit-scrollbar { width: 8px; }
  .content::-webkit-scrollbar-track { background: var(--light); }
  .content::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 4px; }
  
  .tournament-selector {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: clamp(8px, 2vw, 12px);
    margin-bottom: clamp(15px, 3vw, 25px);
  }
  
  .tournament-selector button {
    padding: clamp(10px, 2vw, 14px);
    border: 2px solid var(--primary);
    background: white;
    color: var(--primary);
    border-radius: 8px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: var(--font-base);
  }
  
  .tournament-selector button.active {
    background: var(--primary);
    color: white;
    transform: scale(1.05);
  }
  
  .form-group {
    margin-bottom: clamp(12px, 2.5vw, 18px);
  }
  
  .form-group label {
    display: block;
    margin-bottom: 6px;
    font-weight: 600;
    color: #555;
    font-size: calc(var(--font-base) * 0.95);
  }
  
  .form-group input, 
  .form-group select {
    width: 100%;
    padding: clamp(10px, 2vw, 12px);
    border: 2px solid var(--border);
    border-radius: 8px;
    font-size: var(--font-base);
    transition: all 0.3s ease;
  }
  
  .form-group input:focus, 
  .form-group select:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }
  
  .form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: clamp(8px, 2vw, 12px);
  }
  
  @media (min-width: 768px) {
    .form-grid { grid-template-columns: repeat(2, 1fr); }
  }
  
  .btn {
    width: 100%;
    padding: clamp(10px, 2vw, 14px);
    border: none;
    border-radius: 8px;
    font-weight: bold;
    cursor: pointer;
    font-size: var(--font-base);
    transition: all 0.3s ease;
    margin-top: clamp(8px, 2vw, 12px);
  }
  
  .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px var(--shadow);
  }
  
  .btn:active { transform: translateY(0); }
  .btn-primary { background: var(--primary); color: white; }
  .btn-primary:hover { background: var(--primary-dark); }
  .btn-success { background: var(--success); color: white; }
  .btn-success:hover { background: #218838; }
  .btn-danger { background: var(--danger); color: white; }
  .btn-danger:hover { background: #c82333; }
  .btn-warning { background: var(--warning); color: var(--dark); }
  .btn-warning:hover { background: #e0a800; }
  .btn-info { background: var(--info); color: white; }
  .btn-info:hover { background: #138496; }
  
  .btn-sm {
    padding: 6px 12px;
    font-size: calc(var(--font-base) * 0.85);
    width: auto;
    margin: 0;
  }
  
  /* Estilos de tabla */
  .table-container {
    overflow-x: auto;
    margin-top: 20px;
    border-radius: 8px;
    border: 1px solid var(--border);
  }
  
  .table {
    width: 100%;
    border-collapse: collapse;
    background: white;
  }
  
  .table thead {
    background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    color: white;
  }
  
  .table th {
    padding: 12px;
    text-align: left;
    font-weight: 600;
    font-size: calc(var(--font-base) * 0.95);
    white-space: nowrap;
  }
  
  .table td {
    padding: 12px;
    border-bottom: 1px solid var(--border);
    font-size: calc(var(--font-base) * 0.9);
  }
  
  .table tbody tr:hover {
    background: var(--light);
  }
  
  .table tbody tr:last-child td {
    border-bottom: none;
  }
  
  .table .actions {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
  }
  
  .table .progress-bar {
    height: 8px;
    background: #e9ecef;
    border-radius: 4px;
    overflow: hidden;
    margin-top: 4px;
  }
  
  .table .progress-fill {
    height: 100%;
    transition: width 0.3s ease;
  }
  
  .badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: calc(var(--font-base) * 0.8);
    font-weight: 600;
  }
  
  .badge-success { background: var(--success); color: white; }
  .badge-warning { background: var(--warning); color: var(--dark); }
  .badge-info { background: var(--info); color: white; }
  
  /* Modal */
  .modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    animation: fadeIn 0.3s ease;
  }
  
  .modal.active { display: flex; align-items: center; justify-content: center; }
  
  .modal-content {
    background: white;
    padding: 25px;
    border-radius: 12px;
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    animation: slideUp 0.3s ease;
  }
  
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid var(--border);
  }
  
  .modal-header h3 {
    color: var(--primary);
    font-size: calc(var(--font-base) * 1.3);
  }
  
  .modal-close {
    background: none;
    border: none;
    font-size: 28px;
    cursor: pointer;
    color: #999;
    transition: color 0.3s ease;
  }
  
  .modal-close:hover { color: var(--danger); }
  
  .payment-history {
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 10px;
    margin-top: 10px;
  }
  
  .payment-item {
    display: flex;
    justify-content: space-between;
    padding: 8px;
    margin-bottom: 8px;
    background: var(--light);
    border-radius: 4px;
    align-items: center;
  }
  
  .payment-item:last-child { margin-bottom: 0; }
  
  .payment-item-date {
    font-size: calc(var(--font-base) * 0.85);
    color: #666;
  }
  
  .payment-item-amount {
    font-weight: 600;
    color: var(--success);
  }
  
  .payment-item-actions {
    display: flex;
    gap: 6px;
  }
  
  .player-card {
    background: var(--light);
    border-radius: 10px;
    padding: clamp(12px, 3vw, 18px);
    margin-bottom: clamp(8px, 2vw, 12px);
    border-left: 4px solid var(--primary);
    transition: all 0.3s ease;
  }
  
  .player-card:hover {
    box-shadow: 0 4px 12px var(--shadow);
    transform: translateX(4px);
  }
  
  .player-card h3 {
    color: var(--primary);
    margin-bottom: clamp(8px, 2vw, 12px);
    font-size: calc(var(--font-base) * 1.1);
    word-break: break-word;
  }
  
  .player-actions {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
    gap: clamp(6px, 1.5vw, 10px);
  }
  
  .player-actions button {
    padding: clamp(8px, 1.5vw, 10px);
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: calc(var(--font-base) * 0.85);
    font-weight: bold;
    transition: all 0.3s ease;
  }
  
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: clamp(8px, 2vw, 12px);
    margin-bottom: clamp(15px, 3vw, 25px);
  }
  
  @media (min-width: 768px) {
    .stats-grid { grid-template-columns: repeat(3, 1fr); }
  }
  
  .stat-card {
    background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    color: white;
    padding: clamp(12px, 3vw, 18px);
    border-radius: 10px;
    text-align: center;
    transition: all 0.3s ease;
  }
  
  .stat-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
  }
  
  .stat-card h3 {
    font-size: clamp(24px, 5vw, 32px);
    margin-bottom: 4px;
    font-weight: 700;
  }
  
  .stat-card p {
    font-size: calc(var(--font-base) * 0.85);
    opacity: 0.95;
  }
  
  .match-card {
    background: var(--light);
    border-radius: 10px;
    padding: clamp(12px, 3vw, 18px);
    margin-bottom: clamp(8px, 2vw, 12px);
    border: 1px solid var(--border);
  }
  
  .match-card h4 {
    color: var(--primary);
    margin-bottom: clamp(8px, 2vw, 12px);
    font-size: calc(var(--font-base) * 1.05);
  }
  
  .alert {
    padding: clamp(10px, 2vw, 14px);
    border-radius: 8px;
    margin-bottom: clamp(12px, 2.5vw, 18px);
    font-size: var(--font-base);
    line-height: 1.5;
  }
  
  .alert-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
  .alert-warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
  .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
  
  .phase-selector {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
    gap: clamp(6px, 1.5vw, 10px);
    margin-bottom: clamp(12px, 2.5vw, 18px);
  }
  
  .phase-btn {
    padding: clamp(8px, 1.5vw, 12px);
    border: 2px solid var(--primary);
    background: white;
    color: var(--primary);
    border-radius: 6px;
    cursor: pointer;
    font-size: calc(var(--font-base) * 0.85);
    font-weight: bold;
    transition: all 0.3s ease;
  }
  
  .phase-btn.active { background: var(--primary); color: white; }
  .phase-btn:hover { transform: scale(1.05); }
  
  .checkbox-group {
    max-height: 250px;
    overflow-y: auto;
    border: 2px solid var(--border);
    border-radius: 8px;
    padding: clamp(8px, 2vw, 12px);
    margin-bottom: clamp(12px, 2.5vw, 18px);
    scrollbar-width: thin;
    scrollbar-color: var(--primary) var(--light);
  }
  
  .checkbox-group::-webkit-scrollbar { width: 6px; }
  .checkbox-group::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 3px; }
  
  .checkbox-item-payment {
    display: grid;
    grid-template-columns: 1fr auto;
    align-items: center;
    padding: clamp(8px, 1.5vw, 10px);
    margin-bottom: 6px;
    background: white;
    border-radius: 6px;
    transition: all 0.2s ease;
    gap: 10px;
  }
  
  .checkbox-item-payment:hover { background: var(--light); }
  
  .checkbox-item-payment .player-name-wrapper {
    display: flex;
    align-items: center;
  }
  
  .checkbox-item-payment .player-name-wrapper input[type="checkbox"] {
    margin-right: 10px;
    width: 20px;
    height: 20px;
    cursor: pointer;
  }
  
  .checkbox-item-payment .player-name-wrapper label {
    margin: 0;
    font-weight: 500;
    cursor: pointer;
    font-size: var(--font-base);
  }
  
  .checkbox-item-payment .payment-checkbox-wrapper {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 4px 10px;
    background: #e9ecef;
    border-radius: 6px;
    white-space: nowrap;
  }
  
  .checkbox-item-payment .payment-checkbox-wrapper input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
  }
  
  .checkbox-item-payment .payment-checkbox-wrapper label {
    margin: 0;
    font-size: calc(var(--font-base) * 0.9);
    font-weight: 600;
    cursor: pointer;
    color: #495057;
  }
  
  .checkbox-item-payment.paid {
    background: #d4edda;
    border-left: 3px solid var(--success);
  }
  
  .checkbox-item-payment.not-paid {
    background: #fff3cd;
    border-left: 3px solid var(--warning);
  }
  
  .summary {
    background: #e9ecef;
    padding: clamp(12px, 3vw, 18px);
    border-radius: 8px;
    margin-top: clamp(12px, 2.5vw, 18px);
  }
  
  .summary-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: clamp(6px, 1.5vw, 10px);
    font-size: var(--font-base);
    gap: 10px;
  }
  
  .summary-row:last-child { margin-bottom: 0; }
  .summary-row strong { color: var(--primary); font-weight: 700; }
  
  .summary-extended {
    background: linear-gradient(135deg, #e9ecef 0%, #f8f9fa 100%);
    padding: clamp(12px, 3vw, 18px);
    border-radius: 8px;
    margin-top: clamp(12px, 2.5vw, 18px);
    border: 2px solid var(--border);
  }
  
  .payment-status-section {
    margin-top: 15px;
    padding-top: 15px;
    border-top: 2px solid var(--border);
  }
  
  .payment-status-title {
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 10px;
    font-size: calc(var(--font-base) * 1.05);
  }
  
  .adjustment-card {
    background: #fff3cd;
    border: 2px solid var(--warning);
    border-radius: 10px;
    padding: clamp(12px, 3vw, 18px);
    margin-bottom: clamp(15px, 3vw, 25px);
  }
  
  .adjustment-card h4 {
    color: #856404;
    margin-bottom: clamp(12px, 2.5vw, 18px);
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: calc(var(--font-base) * 1.1);
  }
  
  .hidden { display: none !important; }
  
  .section-divider {
    border-top: 2px solid var(--border);
    margin: clamp(20px, 4vw, 30px) 0;
    padding-top: clamp(20px, 4vw, 30px);
  }
  
  h3.section-title {
    margin-top: clamp(20px, 4vw, 30px);
    margin-bottom: clamp(12px, 2.5vw, 18px);
    color: var(--primary);
    font-size: calc(var(--font-base) * 1.2);
    font-weight: 700;
  }
  
  h3.section-title:first-child { margin-top: 0; }
  
  .payment-detail {
    margin-top: 10px;
    padding: 10px;
    background: white;
    border-radius: 6px;
    border: 1px solid var(--border);
  }
  
  .payment-detail-title {
    font-weight: 600;
    color: var(--primary);
    margin-bottom: 8px;
    font-size: calc(var(--font-base) * 0.95);
  }
  
  .payment-list { display: grid; gap: 5px; }
  
  .payment-list-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 5px;
    font-size: calc(var(--font-base) * 0.85);
  }
  
  .payment-list-item .player-name { flex: 1; }
  
  .payment-list-item .payment-badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: calc(var(--font-base) * 0.75);
    font-weight: 600;
  }
  
  .payment-badge.paid { background: var(--success); color: white; }
  .payment-badge.pending { background: var(--warning); color: var(--dark); }
  
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  
  @keyframes slideUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  .tab-content { animation: fadeIn 0.3s ease; }
  
  @media (max-width: 360px) {
    .tournament-selector { grid-template-columns: 1fr; }
    .stats-grid { grid-template-columns: repeat(2, 1fr); }
    .phase-selector { grid-template-columns: repeat(2, 1fr); }
    .checkbox-item-payment { grid-template-columns: 1fr; }
    .checkbox-item-payment .payment-checkbox-wrapper {
      justify-self: start;
      margin-left: 30px;
    }
  }
  
  @media (min-width: 768px) and (max-width: 1024px) {
    .stats-grid { grid-template-columns: repeat(4, 1fr); }
  }
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>‚öΩ CRM F√∫tbol Avanzado</h1>
    <p id="currentTournamentName">Selecciona un torneo</p>
  </div>
  
  <div class="nav-tabs">
    <button class="active" onclick="showTab('jugadores')">üë• Jugadores</button>
    <button onclick="showTab('pagos')">üí∞ Pagos</button>
    <button onclick="showTab('partidos')">‚öΩ Partidos</button>
    <button onclick="showTab('estadisticas')">üìä Estad√≠sticas</button>
    <button onclick="showTab('config')">‚öôÔ∏è Config</button>
  </div>
  
  <div class="content">
    <!-- JUGADORES -->
    <div id="jugadores" class="tab-content">
      <div class="tournament-selector">
        <button id="torneo1Btn" onclick="selectTournament('torneo1')">üèÜ Torneo 1</button>
        <button id="torneo2Btn" onclick="selectTournament('torneo2')">üèÜ Torneo 2</button>
      </div>
      
      <div class="form-group">
        <label>Nombre del Jugador</label>
        <input type="text" id="playerName" placeholder="Ej: Juan P√©rez" />
      </div>
      
      <div class="form-group">
        <label>N√∫mero de Camiseta</label>
        <input type="number" id="playerNumber" placeholder="Ej: 10" min="1" max="99" />
      </div>
      
      <button class="btn btn-primary" onclick="addPlayer()">‚ûï Agregar Jugador</button>
      
      <h3 class="section-title">Lista de Jugadores</h3>
      <div id="playersList"></div>
    </div>
    
    <!-- PAGOS -->
    <div id="pagos" class="tab-content hidden">
      <div class="tournament-selector">
        <button id="torneo1BtnPagos" onclick="selectTournament('torneo1')">üèÜ Torneo 1</button>
        <button id="torneo2BtnPagos" onclick="selectTournament('torneo2')">üèÜ Torneo 2</button>
      </div>
      
      <div class="alert alert-info" id="inscriptionInfo">
        <strong>Valor de Inscripci√≥n:</strong> $0 COP por jugador
      </div>
      
      <div class="form-group">
        <label>Valor Total de Inscripci√≥n del Torneo</label>
        <input type="number" id="totalInscription" placeholder="Ej: 500000" min="0" />
      </div>
      
      <button class="btn btn-success" onclick="setInscriptionValue()">üìä Calcular Inscripci√≥n por Jugador</button>
      
      <h3 class="section-title">Registrar Abono</h3>
      
      <div class="form-group">
        <label>Seleccionar Jugador</label>
        <select id="playerSelectPayment">
          <option value="">-- Seleccionar --</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>Monto del Abono (COP)</label>
        <input type="number" id="paymentAmount" placeholder="Ej: 50000" min="0" />
      </div>
      
      <button class="btn btn-primary" onclick="registerPayment()">üí∞ Registrar Abono</button>
      
      <h3 class="section-title">Estado de Pagos de Inscripci√≥n</h3>
      <div class="table-container">
        <table class="table" id="paymentsTable">
          <thead>
            <tr>
              <th>Jugador</th>
              <th>#</th>
              <th>Debe Pagar</th>
              <th>Ha Pagado</th>
              <th>Pendiente</th>
              <th>Progreso</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="paymentsTableBody">
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- PARTIDOS -->
    <div id="partidos" class="tab-content hidden">
      <div class="tournament-selector">
        <button id="torneo1BtnPartidos" onclick="selectTournament('torneo1')">üèÜ Torneo 1</button>
        <button id="torneo2BtnPartidos" onclick="selectTournament('torneo2')">üèÜ Torneo 2</button>
      </div>
      
      <h3 class="section-title">Registrar Partido</h3>
      
      <div class="form-grid">
        <div class="form-group">
          <label>‚öΩ Goles Anotados</label>
          <input type="number" id="goalsScored" placeholder="0" value="0" min="0" />
        </div>
        
        <div class="form-group">
          <label>ü•Ö Goles Recibidos</label>
          <input type="number" id="goalsConceded" placeholder="0" value="0" min="0" />
        </div>
      </div>
      
      <div class="form-grid">
        <div class="form-group">
          <label>üü® Tarjetas Amarillas</label>
          <input type="number" id="yellowCards" placeholder="0" value="0" min="0" />
        </div>
        
        <div class="form-group">
          <label>üü¶ Tarjetas Azules</label>
          <input type="number" id="blueCards" placeholder="0" value="0" min="0" />
        </div>
      </div>
      
      <div class="form-group">
        <label>üü• Tarjetas Rojas</label>
        <input type="number" id="redCards" placeholder="0" value="0" min="0" />
      </div>
      
      <div class="form-group">
        <label>üíµ Valor del Arbitraje (COP)</label>
        <input type="number" id="refereeValue" placeholder="Ej: 80000" min="0" />
      </div>
      
      <h4 style="margin-bottom: 10px; color: var(--primary); font-size: calc(var(--font-base) * 1.05);">Jugadores Presentes y Control de Cobro</h4>
      <p style="font-size: calc(var(--font-base) * 0.9); color: #666; margin-bottom: 12px; line-height: 1.5;">
        Marque los jugadores que asistieron al partido y registre si pagaron el arbitraje.
      </p>
      <div class="checkbox-group" id="playersPresent"></div>
      
      <div class="summary-extended" id="refereeSummary">
        <div class="summary-row">
          <span>Total Arbitraje:</span>
          <strong>$0 COP</strong>
        </div>
        <div class="summary-row">
          <span>Jugadores Presentes:</span>
          <strong>0</strong>
        </div>
        <div class="summary-row">
          <span>Por Jugador:</span>
          <strong>$0 COP</strong>
        </div>
        <div class="payment-status-section">
          <div class="payment-status-title">Estado de Cobro:</div>
          <div class="summary-row">
            <span>Jugadores que Pagaron:</span>
            <strong id="playersPaidCount">0</strong>
          </div>
          <div class="summary-row">
            <span>Jugadores Pendientes:</span>
            <strong id="playersPendingCount">0</strong>
          </div>
          <div class="summary-row">
            <span>Total Recaudado:</span>
            <strong id="totalCollectedReferee">$0 COP</strong>
          </div>
          <div class="summary-row">
            <span>Total Pendiente:</span>
            <strong id="totalPendingReferee">$0 COP</strong>
          </div>
        </div>
      </div>
      
      <button class="btn btn-success" onclick="registerMatch()">‚öΩ Registrar Partido</button>
      
      <h3 class="section-title">Historial de Partidos</h3>
      <div id="matchesList"></div>
    </div>
    
    <!-- ESTAD√çSTICAS -->
    <div id="estadisticas" class="tab-content hidden">
      <div class="tournament-selector">
        <button id="torneo1BtnStats" onclick="selectTournament('torneo1')">üèÜ Torneo 1</button>
        <button id="torneo2BtnStats" onclick="selectTournament('torneo2')">üèÜ Torneo 2</button>
      </div>
      
      <div class="alert alert-info" id="phaseInfo">
        <strong>Fase Actual:</strong> Fase de Grupos
      </div>
      
      <div class="stats-grid">
        <div class="stat-card">
          <h3 id="totalPoints">0</h3>
          <p>Puntos</p>
        </div>
        <div class="stat-card">
          <h3 id="totalMatches">0</h3>
          <p>Partidos</p>
        </div>
        <div class="stat-card">
          <h3 id="totalGoalsScored">0</h3>
          <p>Goles Anotados</p>
        </div>
        <div class="stat-card">
          <h3 id="totalGoalsConceded">0</h3>
          <p>Goles Recibidos</p>
        </div>
        <div class="stat-card">
          <h3 id="avgGoalsScored">0</h3>
          <p>Promedio Goles Anotados</p>
        </div>
        <div class="stat-card">
          <h3 id="avgGoalsConceded">0</h3>
          <p>Promedio Goles Recibidos</p>
        </div>
        <div class="stat-card">
          <h3 id="totalWins">0</h3>
          <p>Victorias</p>
        </div>
        <div class="stat-card">
          <h3 id="winPercent">0%</h3>
          <p>% Victorias</p>
        </div>
        <div class="stat-card">
          <h3 id="totalDraws">0</h3>
          <p>Empates</p>
        </div>
        <div class="stat-card">
          <h3 id="drawPercent">0%</h3>
          <p>% Empates</p>
        </div>
        <div class="stat-card">
          <h3 id="totalLosses">0</h3>
          <p>Derrotas</p>
        </div>
        <div class="stat-card">
          <h3 id="lossPercent">0%</h3>
          <p>% Derrotas</p>
        </div>
        <div class="stat-card">
          <h3 id="goalDifference">0</h3>
          <p>Diferencia de Goles</p>
        </div>
      </div>
      
      <div class="match-card">
        <h4>üìã Tarjetas Acumuladas</h4>
        <div class="summary-row">
          <span>üü® Amarillas:</span>
          <strong id="totalYellow">0</strong>
        </div>
        <div class="summary-row">
          <span>üü¶ Azules:</span>
          <strong id="totalBlue">0</strong>
        </div>
        <div class="summary-row">
          <span>üü• Rojas:</span>
          <strong id="totalRed">0</strong>
        </div>
        <div class="summary-row">
          <span>Promedio Tarjetas por Partido:</span>
          <strong id="avgCards">0</strong>
        </div>
      </div>
      
      <div class="match-card">
        <h4>üíº Finanzas</h4>
        <div class="summary-row">
          <span>üí∞ Total Recaudado (Inscripciones):</span>
          <strong id="totalCollected">$0</strong>
        </div>
        <div class="summary-row">
          <span>üìä Inscripci√≥n Total:</span>
          <strong id="totalInscriptionNeeded">$0</strong>
        </div>
        <div class="summary-row">
          <span>‚öΩ Total Arbitrajes Gastados:</span>
          <strong id="totalRefereeSpent">$0</strong>
        </div>
        <div class="summary-row">
          <span>üíµ Total Arbitrajes Recaudados:</span>
          <strong id="totalRefereeCollected">$0</strong>
        </div>
        <div class="summary-row">
          <span>‚è≥ Total Arbitrajes Pendientes:</span>
          <strong id="totalRefereePending">$0</strong>
        </div>
      </div>
    </div>
    
    <!-- CONFIG -->
    <div id="config" class="tab-content hidden">
      <div class="tournament-selector">
        <button id="torneo1BtnConfig" onclick="selectTournament('torneo1')">üèÜ Torneo 1</button>
        <button id="torneo2BtnConfig" onclick="selectTournament('torneo2')">üèÜ Torneo 2</button>
      </div>
      
      <div class="form-group">
        <label>Nombre del Torneo</label>
        <input type="text" id="tournamentName" placeholder="Ej: Liga de Verano 2025" />
      </div>
      
      <button class="btn btn-primary" onclick="updateTournamentName()">üíæ Guardar Nombre</button>
      
      <h3 class="section-title">Fase del Torneo</h3>
      
      <div class="phase-selector">
        <button class="phase-btn" onclick="setPhase('Fase de Grupos')">Grupos</button>
        <button class="phase-btn" onclick="setPhase('Dieciseisavos de Final')">1/16</button>
        <button class="phase-btn" onclick="setPhase('Octavos de Final')">1/8</button>
        <button class="phase-btn" onclick="setPhase('Cuartos de Final')">1/4</button>
        <button class="phase-btn" onclick="setPhase('Semifinal')">Semifinal</button>
        <button class="phase-btn" onclick="setPhase('Final')">Final</button>
      </div>
      
      <div class="alert alert-warning">
        <strong>‚ö†Ô∏è Fase Actual:</strong> <span id="currentPhase">Fase de Grupos</span>
      </div>
      
      <div class="section-divider">
        <div class="adjustment-card">
          <h4>üìä Ajustar Estad√≠sticas Manualmente</h4>
          <p style="font-size: calc(var(--font-base) * 0.9); color: #856404; margin-bottom: 15px;">
            Usa esta opci√≥n para ingresar datos de partidos ya jugados antes de usar el sistema.
          </p>
          
          <div class="form-grid">
            <div class="form-group">
              <label>Puntos</label>
              <input type="number" id="adjustPoints" placeholder="0" value="0" min="0" />
            </div>
            <div class="form-group">
              <label>Partidos Jugados</label>
              <input type="number" id="adjustMatches" placeholder="0" value="0" min="0" />
            </div>
          </div>
          
          <div class="form-grid">
            <div class="form-group">
              <label>Goles Anotados</label>
              <input type="number" id="adjustGoalsScored" placeholder="0" value="0" min="0" />
            </div>
            <div class="form-group">
              <label>Goles Recibidos</label>
              <input type="number" id="adjustGoalsConceded" placeholder="0" value="0" min="0" />
            </div>
          </div>
          
          <div class="form-grid">
            <div class="form-group">
              <label>Victorias</label>
              <input type="number" id="adjustWins" placeholder="0" value="0" min="0" />
            </div>
            <div class="form-group">
              <label>Empates</label>
              <input type="number" id="adjustDraws" placeholder="0" value="0" min="0" />
            </div>
          </div>
          
          <div class="form-grid">
            <div class="form-group">
              <label>Derrotas</label>
              <input type="number" id="adjustLosses" placeholder="0" value="0" min="0" />
            </div>
            <div class="form-group">
              <label>üü® Amarillas</label>
              <input type="number" id="adjustYellow" placeholder="0" value="0" min="0" />
            </div>
          </div>
          
          <div class="form-grid">
            <div class="form-group">
              <label>üü¶ Azules</label>
              <input type="number" id="adjustBlue" placeholder="0" value="0" min="0" />
            </div>
            <div class="form-group">
              <label>üü• Rojas</label>
              <input type="number" id="adjustRed" placeholder="0" value="0" min="0" />
            </div>
          </div>
          
          <div class="form-group">
            <label>Total Gastado en Arbitrajes (COP)</label>
            <input type="number" id="adjustReferee" placeholder="0" value="0" min="0" />
          </div>
          
          <button class="btn btn-info" onclick="loadCurrentStats()">üì• Cargar Valores Actuales</button>
          <button class="btn btn-success" onclick="saveAdjustedStats()">üíæ Guardar Ajustes</button>
        </div>
      </div>
      
      <h3 class="section-title">Reiniciar Torneo</h3>
      <p style="margin-bottom: 15px; font-size: var(--font-base); color: #666; line-height: 1.6;">
        Esta acci√≥n reiniciar√° todos los valores del torneo actual, incluyendo puntos, goles, pagos, partidos y registros de cobro de arbitraje, pero mantendr√° la lista de jugadores.
      </p>
      <button class="btn btn-danger" onclick="confirmResetTournament()">üîÑ Reiniciar Torneo</button>
      
      <h3 class="section-title">Eliminar Todos los Jugadores</h3>
      <p style="margin-bottom: 15px; font-size: var(--font-base); color: #666; line-height: 1.6;">
        Esta acci√≥n eliminar√° todos los jugadores del torneo actual junto con sus datos.
      </p>
      <button class="btn btn-danger" onclick="confirmDeleteAllPlayers()">üóëÔ∏è Eliminar Todos los Jugadores</button>
    </div>
  </div>
</div>

<!-- Modal para gestionar abonos -->
<div id="paymentModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>üí∞ Gestionar Abonos</h3>
      <button class="modal-close" onclick="closePaymentModal()">&times;</button>
    </div>
    <div id="modalPlayerInfo" style="margin-bottom: 20px; padding: 12px; background: var(--light); border-radius: 6px;">
    </div>
    <h4 style="margin-bottom: 10px; color: var(--primary);">Historial de Abonos</h4>
    <div class="payment-history" id="paymentHistoryList">
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getFirestore,
    collection,
    doc,
    setDoc,
    getDoc,
    getDocs,
    updateDoc,
    deleteDoc,
    query,
    where,
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBXylL77z6EPDy2EuXVLLF_hkW8CyQvns4",
    authDomain: "crm-futbol.firebaseapp.com",
    projectId: "crm-futbol",
    storageBucket: "crm-futbol.firebasestorage.app",
    messagingSenderId: "222709021751",
    appId: "1:222709021751:web:94168589472c2ee938d3b2",
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  let currentTournament = "torneo1";
  let players = [];
  let tournamentData = {};
  let currentEditingPlayer = null;

  window.showTab = function (tabName) {
    document.querySelectorAll(".tab-content").forEach((tab) => tab.classList.add("hidden"));
    document.getElementById(tabName).classList.remove("hidden");
    document.querySelectorAll(".nav-tabs button").forEach((btn) => btn.classList.remove("active"));
    event.target.classList.add("active");
    
    if (tabName === "estadisticas") {
      updateStatistics();
    }
  };

  window.selectTournament = async function (tournament) {
    currentTournament = tournament;
    
    document.querySelectorAll(".tournament-selector button").forEach((btn) => {
      btn.classList.remove("active");
    });
    
    [
      "torneo1Btn", "torneo2Btn", "torneo1BtnPagos", "torneo2BtnPagos",
      "torneo1BtnPartidos", "torneo2BtnPartidos", "torneo1BtnStats", "torneo2BtnStats",
      "torneo1BtnConfig", "torneo2BtnConfig",
    ].forEach((id) => {
      const el = document.getElementById(id);
      if (el) el.classList.toggle("active", id.includes(tournament));
    });

    await loadTournamentData();
    await loadPlayers();
    updateAllViews();
  };

  async function loadTournamentData() {
    const docRef = doc(db, "tournaments", currentTournament);
    const docSnap = await getDoc(docRef);
    
    if (docSnap.exists()) {
      tournamentData = docSnap.data();
    } else {
      tournamentData = {
        name: currentTournament === "torneo1" ? "Torneo 1" : "Torneo 2",
        totalInscription: 0,
        inscriptionPerPlayer: 0,
        phase: "Fase de Grupos",
        matches: [],
        manualMatches: 0,
        stats: {
          points: 0, wins: 0, draws: 0, losses: 0,
          goalsScored: 0, goalsConceded: 0,
          yellowCards: 0, blueCards: 0, redCards: 0,
          totalReferee: 0,
        },
      };
      await setDoc(docRef, tournamentData);
    }
    
    document.getElementById("currentTournamentName").textContent = tournamentData.name;
    document.getElementById("tournamentName").value = tournamentData.name;
    document.getElementById("currentPhase").textContent = tournamentData.phase;
    document.getElementById("phaseInfo").innerHTML = `<strong>Fase Actual:</strong> ${tournamentData.phase}`;
  }

  async function loadPlayers() {
    const q = query(collection(db, "players"), where("tournament", "==", currentTournament));
    const querySnapshot = await getDocs(q);
    players = [];
    
    for (const docSnap of querySnapshot.docs) {
      const playerData = { id: docSnap.id, ...docSnap.data() };
      
      // Migraci√≥n: agregar IDs a pagos que no los tengan
      if (playerData.payments && playerData.payments.length > 0) {
        let needsUpdate = false;
        const updatedPayments = playerData.payments.map((payment, index) => {
          if (!payment.id) {
            needsUpdate = true;
            return {
              ...payment,
              id: Date.now().toString() + "_" + index + "_" + Math.random().toString(36).substr(2, 9)
            };
          }
          return payment;
        });
        
        if (needsUpdate) {
          await updateDoc(doc(db, "players", docSnap.id), {
            payments: updatedPayments
          });
          playerData.payments = updatedPayments;
        }
      }
      
      players.push(playerData);
    }
  }

  window.addPlayer = async function () {
    const name = document.getElementById("playerName").value.trim();
    const number = document.getElementById("playerNumber").value;
    
    if (!name || !number) {
      alert("Por favor completa todos los campos");
      return;
    }
    
    const playerData = {
      name: name,
      number: parseInt(number),
      tournament: currentTournament,
      payments: [],
      totalPaid: 0,
    };
    
    await setDoc(doc(collection(db, "players")), playerData);
    document.getElementById("playerName").value = "";
    document.getElementById("playerNumber").value = "";
    
    await loadPlayers();
    updateAllViews();
  };

  window.deletePlayer = async function (playerId) {
    if (confirm("¬øEst√°s seguro de eliminar este jugador?")) {
      await deleteDoc(doc(db, "players", playerId));
      await loadPlayers();
      updateAllViews();
    }
  };

  window.editPlayer = async function (playerId) {
    const player = players.find((p) => p.id === playerId);
    if (!player) return;
    
    const newName = prompt("Nuevo nombre:", player.name);
    const newNumber = prompt("Nuevo n√∫mero:", player.number);
    
    if (newName && newNumber) {
      await updateDoc(doc(db, "players", playerId), {
        name: newName,
        number: parseInt(newNumber),
      });
      await loadPlayers();
      updateAllViews();
    }
  };

  window.setInscriptionValue = async function () {
    const total = parseFloat(document.getElementById("totalInscription").value);
    
    if (!total || players.length === 0) {
      alert("Ingresa un valor v√°lido y aseg√∫rate de tener jugadores registrados");
      return;
    }
    
    const perPlayer = total / players.length;
    tournamentData.totalInscription = total;
    tournamentData.inscriptionPerPlayer = perPlayer;
    
    await updateDoc(doc(db, "tournaments", currentTournament), {
      totalInscription: total,
      inscriptionPerPlayer: perPlayer,
    });
    
    updateAllViews();
    alert(`Inscripci√≥n calculada: $${perPlayer.toFixed(0)} COP por jugador`);
  };

  window.registerPayment = async function () {
    const playerId = document.getElementById("playerSelectPayment").value;
    const amount = parseFloat(document.getElementById("paymentAmount").value);
    
    if (!playerId || !amount || amount <= 0) {
      alert("Por favor completa todos los campos con valores v√°lidos");
      return;
    }
    
    const player = players.find((p) => p.id === playerId);
    if (!player) {
      alert("Jugador no encontrado");
      return;
    }
    
    const newPayment = {
      id: Date.now().toString() + "_" + Math.random().toString(36).substr(2, 9),
      amount: amount,
      date: new Date().toISOString()
    };
    
    const newPayments = [...(player.payments || []), newPayment];
    const newTotal = newPayments.reduce((sum, p) => sum + p.amount, 0);
    
    await updateDoc(doc(db, "players", playerId), {
      payments: newPayments,
      totalPaid: newTotal,
    });
    
    document.getElementById("playerSelectPayment").value = "";
    document.getElementById("paymentAmount").value = "";
    await loadPlayers();
    updateAllViews();
    alert("Abono registrado exitosamente");
  };

  window.openPaymentModal = function(playerId) {
    currentEditingPlayer = players.find(p => p.id === playerId);
    if (!currentEditingPlayer) return;
    
    const perPlayer = tournamentData.inscriptionPerPlayer || 0;
    const paid = currentEditingPlayer.totalPaid || 0;
    const pending = perPlayer - paid;
    
    document.getElementById("modalPlayerInfo").innerHTML = `
      <strong style="font-size: 1.1em; color: var(--primary);">${currentEditingPlayer.name} - #${currentEditingPlayer.number}</strong><br>
      <div style="margin-top: 8px;">
        <span>Debe pagar: <strong>$${perPlayer.toFixed(0)}</strong></span> | 
        <span>Ha pagado: <strong style="color: var(--success);">$${paid.toFixed(0)}</strong></span> | 
        <span>Pendiente: <strong style="color: var(--warning);">$${pending.toFixed(0)}</strong></span>
      </div>
    `;
    
    updatePaymentHistory();
    document.getElementById("paymentModal").classList.add("active");
  };

  window.closePaymentModal = function() {
    document.getElementById("paymentModal").classList.remove("active");
    currentEditingPlayer = null;
  };

  function updatePaymentHistory() {
    if (!currentEditingPlayer) return;
    
    const payments = currentEditingPlayer.payments || [];
    const historyList = document.getElementById("paymentHistoryList");
    
    if (payments.length === 0) {
      historyList.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No hay abonos registrados</p>';
      return;
    }
    
    historyList.innerHTML = payments.map(payment => {
      const date = new Date(payment.date).toLocaleDateString("es-CO", {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
      });
      
      return `
        <div class="payment-item">
          <div>
            <div class="payment-item-date">${date}</div>
            <div class="payment-item-amount">$${payment.amount.toFixed(0)} COP</div>
          </div>
          <div class="payment-item-actions">
            <button class="btn btn-sm btn-warning" onclick="editPayment('${payment.id}')">‚úèÔ∏è</button>
            <button class="btn btn-sm btn-danger" onclick="deletePayment('${payment.id}')">üóëÔ∏è</button>
          </div>
        </div>
      `;
    }).join('');
  }

  window.editPayment = async function(paymentId) {
    if (!currentEditingPlayer) {
      alert("Error: No hay jugador seleccionado");
      return;
    }
    
    const payment = currentEditingPlayer.payments.find(p => p.id === paymentId);
    if (!payment) {
      alert("Error: Abono no encontrado");
      return;
    }
    
    const dateStr = new Date(payment.date).toLocaleDateString("es-CO", {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });
    
    const newAmount = prompt(`Editar monto del abono\nFecha: ${dateStr}\nMonto actual: $${payment.amount.toFixed(0)}\n\nIngrese el nuevo monto:`, payment.amount);
    
    if (newAmount === null || newAmount === "") return;
    
    const amount = parseFloat(newAmount);
    if (isNaN(amount) || amount <= 0) {
      alert("Por favor ingrese un monto v√°lido mayor a 0");
      return;
    }
    
    const updatedPayments = currentEditingPlayer.payments.map(p => 
      p.id === paymentId ? { ...p, amount: amount } : p
    );
    
    const newTotal = updatedPayments.reduce((sum, p) => sum + p.amount, 0);
    
    await updateDoc(doc(db, "players", currentEditingPlayer.id), {
      payments: updatedPayments,
      totalPaid: newTotal,
    });
    
    await loadPlayers();
    currentEditingPlayer = players.find(p => p.id === currentEditingPlayer.id);
    updatePaymentHistory();
    updateAllViews();
    alert("Abono actualizado exitosamente");
  };

  window.deletePayment = async function(paymentId) {
    if (!currentEditingPlayer) {
      alert("Error: No hay jugador seleccionado");
      return;
    }
    
    const payment = currentEditingPlayer.payments.find(p => p.id === paymentId);
    if (!payment) {
      alert("Error: Abono no encontrado");
      return;
    }
    
    const dateStr = new Date(payment.date).toLocaleDateString("es-CO");
    if (!confirm(`¬øEst√°s seguro de eliminar este abono?\n\nFecha: ${dateStr}\nMonto: $${payment.amount.toFixed(0)}`)) return;
    
    const updatedPayments = currentEditingPlayer.payments.filter(p => p.id !== paymentId);
    const newTotal = updatedPayments.reduce((sum, p) => sum + p.amount, 0);
    
    await updateDoc(doc(db, "players", currentEditingPlayer.id), {
      payments: updatedPayments,
      totalPaid: newTotal,
    });
    
    await loadPlayers();
    currentEditingPlayer = players.find(p => p.id === currentEditingPlayer.id);
    updatePaymentHistory();
    updateAllViews();
    alert("Abono eliminado exitosamente");
  };

  window.registerMatch = async function () {
    const goalsScored = parseInt(document.getElementById("goalsScored").value) || 0;
    const goalsConceded = parseInt(document.getElementById("goalsConceded").value) || 0;
    const yellowCards = parseInt(document.getElementById("yellowCards").value) || 0;
    const blueCards = parseInt(document.getElementById("blueCards").value) || 0;
    const redCards = parseInt(document.getElementById("redCards").value) || 0;
    const refereeValue = parseFloat(document.getElementById("refereeValue").value) || 0;
    
    const presentPlayers = [];
    const refereePayments = {};
    
    document.querySelectorAll("#playersPresent .checkbox-item-payment").forEach((item) => {
      const attendanceCheckbox = item.querySelector('input[name^="attendance_"]');
      const paymentCheckbox = item.querySelector('input[name^="payment_"]');
      
      if (attendanceCheckbox && attendanceCheckbox.checked) {
        const playerId = attendanceCheckbox.value;
        presentPlayers.push(playerId);
        refereePayments[playerId] = paymentCheckbox ? paymentCheckbox.checked : false;
      }
    });
    
    if (presentPlayers.length === 0) {
      alert("Selecciona al menos un jugador presente");
      return;
    }
    
    let points = 0;
    let result = "";
    
    if (goalsScored > goalsConceded) {
      points = 2;
      result = "Victoria";
    } else if (goalsScored === goalsConceded) {
      points = 1;
      result = "Empate";
    } else {
      points = 0;
      result = "Derrota";
    }
    
    const refereePerPlayer = refereeValue / presentPlayers.length;
    
    const matchData = {
      date: new Date().toISOString(),
      goalsScored, goalsConceded,
      yellowCards, blueCards, redCards,
      refereeValue, presentPlayers,
      refereePerPlayer, refereePayments,
      points, result,
    };
    
    const newMatches = [...(tournamentData.matches || []), matchData];
    const newStats = {
      points: (tournamentData.stats?.points || 0) + points,
      wins: (tournamentData.stats?.wins || 0) + (result === "Victoria" ? 1 : 0),
      draws: (tournamentData.stats?.draws || 0) + (result === "Empate" ? 1 : 0),
      losses: (tournamentData.stats?.losses || 0) + (result === "Derrota" ? 1 : 0),
      goalsScored: (tournamentData.stats?.goalsScored || 0) + goalsScored,
      goalsConceded: (tournamentData.stats?.goalsConceded || 0) + goalsConceded,
      yellowCards: (tournamentData.stats?.yellowCards || 0) + yellowCards,
      blueCards: (tournamentData.stats?.blueCards || 0) + blueCards,
      redCards: (tournamentData.stats?.redCards || 0) + redCards,
      totalReferee: (tournamentData.stats?.totalReferee || 0) + refereeValue,
    };
    
    await updateDoc(doc(db, "tournaments", currentTournament), {
      matches: newMatches,
      stats: newStats,
    });
    
    document.getElementById("goalsScored").value = "0";
    document.getElementById("goalsConceded").value = "0";
    document.getElementById("yellowCards").value = "0";
    document.getElementById("blueCards").value = "0";
    document.getElementById("redCards").value = "0";
    document.getElementById("refereeValue").value = "";
    document.querySelectorAll("#playersPresent input[type='checkbox']").forEach((cb) => (cb.checked = false));
    
    await loadTournamentData();
    updateAllViews();
    
    const paidCount = Object.values(refereePayments).filter(paid => paid).length;
    const pendingCount = presentPlayers.length - paidCount;
    
    alert(`Partido registrado exitosamente\n\nResultado: ${result} (${points} puntos)\nJugadores que pagaron arbitraje: ${paidCount}\nJugadores con pago pendiente: ${pendingCount}`);
  };

  window.updateTournamentName = async function () {
    const name = document.getElementById("tournamentName").value.trim();
    
    if (!name) {
      alert("Ingresa un nombre v√°lido");
      return;
    }
    
    await updateDoc(doc(db, "tournaments", currentTournament), { name });
    await loadTournamentData();
    alert("Nombre actualizado");
  };

  window.setPhase = async function (phase) {
    await updateDoc(doc(db, "tournaments", currentTournament), { phase });
    await loadTournamentData();
    updateAllViews();
    alert(`Fase actualizada a: ${phase}`);
  };

  window.loadCurrentStats = function () {
    const stats = tournamentData.stats || {};
    const manualMatches = tournamentData.manualMatches || 0;
    
    document.getElementById("adjustPoints").value = stats.points || 0;
    document.getElementById("adjustMatches").value = manualMatches;
    document.getElementById("adjustGoalsScored").value = stats.goalsScored || 0;
    document.getElementById("adjustGoalsConceded").value = stats.goalsConceded || 0;
    document.getElementById("adjustWins").value = stats.wins || 0;
    document.getElementById("adjustDraws").value = stats.draws || 0;
    document.getElementById("adjustLosses").value = stats.losses || 0;
    document.getElementById("adjustYellow").value = stats.yellowCards || 0;
    document.getElementById("adjustBlue").value = stats.blueCards || 0;
    document.getElementById("adjustRed").value = stats.redCards || 0;
    document.getElementById("adjustReferee").value = stats.totalReferee || 0;
    
    alert("Valores actuales cargados en el formulario");
  };

  window.saveAdjustedStats = async function () {
    if (!confirm("¬øEst√°s seguro de ajustar las estad√≠sticas? Esto sobrescribir√° los valores actuales.")) return;
    
    const newStats = {
      points: parseInt(document.getElementById("adjustPoints").value) || 0,
      wins: parseInt(document.getElementById("adjustWins").value) || 0,
      draws: parseInt(document.getElementById("adjustDraws").value) || 0,
      losses: parseInt(document.getElementById("adjustLosses").value) || 0,
      goalsScored: parseInt(document.getElementById("adjustGoalsScored").value) || 0,
      goalsConceded: parseInt(document.getElementById("adjustGoalsConceded").value) || 0,
      yellowCards: parseInt(document.getElementById("adjustYellow").value) || 0,
      blueCards: parseInt(document.getElementById("adjustBlue").value) || 0,
      redCards: parseInt(document.getElementById("adjustRed").value) || 0,
      totalReferee: parseFloat(document.getElementById("adjustReferee").value) || 0,
    };
    
    const manualMatches = parseInt(document.getElementById("adjustMatches").value) || 0;
    
    await updateDoc(doc(db, "tournaments", currentTournament), {
      stats: newStats,
      manualMatches: manualMatches,
    });
    
    await loadTournamentData();
    updateAllViews();
    alert("‚úÖ Estad√≠sticas ajustadas exitosamente");
  };

  window.confirmResetTournament = async function () {
    if (!confirm("¬øEst√°s seguro de reiniciar el torneo? Se perder√°n todos los datos de partidos, pagos, estad√≠sticas y registros de cobro de arbitraje.")) return;
    
    for (const player of players) {
      await updateDoc(doc(db, "players", player.id), {
        payments: [],
        totalPaid: 0,
      });
    }
    
    await updateDoc(doc(db, "tournaments", currentTournament), {
      totalInscription: 0,
      inscriptionPerPlayer: 0,
      phase: "Fase de Grupos",
      matches: [],
      manualMatches: 0,
      stats: {
        points: 0, wins: 0, draws: 0, losses: 0,
        goalsScored: 0, goalsConceded: 0,
        yellowCards: 0, blueCards: 0, redCards: 0,
        totalReferee: 0,
      },
    });
    
    await loadTournamentData();
    await loadPlayers();
    updateAllViews();
    alert("Torneo reiniciado exitosamente");
  };

  window.confirmDeleteAllPlayers = async function () {
    if (!confirm("¬øEst√°s seguro de eliminar TODOS los jugadores del torneo actual?")) return;
    
    for (const player of players) {
      await deleteDoc(doc(db, "players", player.id));
    }
    
    await loadPlayers();
    updateAllViews();
    alert("Todos los jugadores han sido eliminados");
  };

  function updateAllViews() {
    updatePlayersList();
    updatePaymentsList();
    updatePlayerSelectors();
    updateMatchesView();
    updateStatistics();
    updateInscriptionInfo();
  }

  function updatePlayersList() {
    const container = document.getElementById("playersList");
    
    if (players.length === 0) {
      container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No hay jugadores registrados</p>';
      return;
    }
    
    container.innerHTML = players
      .map(
        (player) => `
      <div class="player-card">
        <h3>${player.name} - #${player.number}</h3>
        <div class="player-actions">
          <button class="btn-warning" onclick="editPlayer('${player.id}')">‚úèÔ∏è Editar</button>
          <button class="btn-danger" onclick="deletePlayer('${player.id}')">üóëÔ∏è Eliminar</button>
        </div>
      </div>
    `
      )
      .join("");
  }

  function updatePaymentsList() {
    const tbody = document.getElementById("paymentsTableBody");
    
    if (players.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #999; padding: 20px;">No hay jugadores registrados</td></tr>';
      return;
    }
    
    const perPlayer = tournamentData.inscriptionPerPlayer || 0;
    
    tbody.innerHTML = players
      .map((player) => {
        const paid = player.totalPaid || 0;
        const pending = perPlayer - paid;
        const percentage = perPlayer > 0 ? ((paid / perPlayer) * 100).toFixed(1) : 0;
        const statusBadge = pending <= 0 
          ? '<span class="badge badge-success">Completo</span>'
          : '<span class="badge badge-warning">Pendiente</span>';
        
        return `
      <tr>
        <td><strong>${player.name}</strong></td>
        <td>${player.number}</td>
        <td>$${perPlayer.toFixed(0)}</td>
        <td style="color: var(--success); font-weight: 600;">$${paid.toFixed(0)}</td>
        <td style="color: var(--warning); font-weight: 600;">$${pending.toFixed(0)}</td>
        <td>
          ${statusBadge}
          <div class="progress-bar">
            <div class="progress-fill" style="width: ${percentage}%; background: ${pending <= 0 ? 'var(--success)' : 'var(--warning)'};"></div>
          </div>
          <small>${percentage}%</small>
        </td>
        <td>
          <div class="actions">
            <button class="btn btn-sm btn-info" onclick="openPaymentModal('${player.id}')">üìù Gestionar</button>
          </div>
        </td>
      </tr>
    `;
      })
      .join("");
  }

  function updatePlayerSelectors() {
    const select = document.getElementById("playerSelectPayment");
    select.innerHTML =
      '<option value="">-- Seleccionar --</option>' +
      players.map((p) => `<option value="${p.id}">${p.name} - #${p.number}</option>`).join("");
    
    const checkboxContainer = document.getElementById("playersPresent");
    checkboxContainer.innerHTML = players
      .map(
        (p) => `
      <div class="checkbox-item-payment">
        <div class="player-name-wrapper">
          <input type="checkbox" id="attendance_${p.id}" name="attendance_${p.id}" value="${p.id}" onchange="updateRefereeSummary()" />
          <label for="attendance_${p.id}">${p.name} - #${p.number}</label>
        </div>
        <div class="payment-checkbox-wrapper">
          <input type="checkbox" id="payment_${p.id}" name="payment_${p.id}" onchange="updateRefereeSummary()" />
          <label for="payment_${p.id}">üíµ Pag√≥</label>
        </div>
      </div>
    `
      )
      .join("");
  }

  window.updateRefereeSummary = function () {
    const refereeValue = parseFloat(document.getElementById("refereeValue").value) || 0;
    
    let presentCount = 0;
    let paidCount = 0;
    
    document.querySelectorAll("#playersPresent .checkbox-item-payment").forEach((item) => {
      const attendanceCheckbox = item.querySelector('input[name^="attendance_"]');
      const paymentCheckbox = item.querySelector('input[name^="payment_"]');
      
      if (attendanceCheckbox && attendanceCheckbox.checked) {
        presentCount++;
        
        if (paymentCheckbox && paymentCheckbox.checked) {
          paidCount++;
          item.classList.add('paid');
          item.classList.remove('not-paid');
        } else {
          item.classList.add('not-paid');
          item.classList.remove('paid');
        }
      } else {
        item.classList.remove('paid', 'not-paid');
        if (paymentCheckbox) {
          paymentCheckbox.checked = false;
        }
      }
    });
    
    const perPlayer = presentCount > 0 ? refereeValue / presentCount : 0;
    const pendingCount = presentCount - paidCount;
    const totalCollected = paidCount * perPlayer;
    const totalPending = pendingCount * perPlayer;
    
    const summary = document.getElementById("refereeSummary");
    summary.innerHTML = `
      <div class="summary-row">
        <span>Total Arbitraje:</span>
        <strong>$${refereeValue.toFixed(0)} COP</strong>
      </div>
      <div class="summary-row">
        <span>Jugadores Presentes:</span>
        <strong>${presentCount}</strong>
      </div>
      <div class="summary-row">
        <span>Por Jugador:</span>
        <strong>$${perPlayer.toFixed(0)} COP</strong>
      </div>
      <div class="payment-status-section">
        <div class="payment-status-title">Estado de Cobro:</div>
        <div class="summary-row">
          <span>Jugadores que Pagaron:</span>
          <strong id="playersPaidCount">${paidCount}</strong>
        </div>
        <div class="summary-row">
          <span>Jugadores Pendientes:</span>
          <strong id="playersPendingCount">${pendingCount}</strong>
        </div>
        <div class="summary-row">
          <span>Total Recaudado:</span>
          <strong id="totalCollectedReferee">$${totalCollected.toFixed(0)} COP</strong>
        </div>
        <div class="summary-row">
          <span>Total Pendiente:</span>
          <strong id="totalPendingReferee">$${totalPending.toFixed(0)} COP</strong>
        </div>
      </div>
    `;
  };

  document.getElementById("refereeValue")?.addEventListener("input", updateRefereeSummary);

  function updateMatchesView() {
    const container = document.getElementById("matchesList");
    const matches = tournamentData.matches || [];
    
    if (matches.length === 0) {
      container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No hay partidos registrados</p>';
      return;
    }
    
    container.innerHTML = matches
      .map((match, index) => {
        const date = new Date(match.date).toLocaleDateString("es-CO");
        
        let paymentDetailsHTML = '';
        if (match.refereePayments) {
          const paymentList = match.presentPlayers.map(playerId => {
            const player = players.find(p => p.id === playerId);
            const playerName = player ? `${player.name} - #${player.number}` : 'Jugador no encontrado';
            const paid = match.refereePayments[playerId];
            const badge = paid 
              ? '<span class="payment-badge paid">‚úì Pagado</span>' 
              : '<span class="payment-badge pending">‚è≥ Pendiente</span>';
            
            return `
              <div class="payment-list-item">
                <span class="player-name">${playerName}</span>
                ${badge}
              </div>
            `;
          }).join('');
          
          const paidCount = Object.values(match.refereePayments).filter(paid => paid).length;
          const pendingCount = match.presentPlayers.length - paidCount;
          
          paymentDetailsHTML = `
            <div class="payment-detail">
              <div class="payment-detail-title">Control de Cobro (${paidCount} pagaron / ${pendingCount} pendientes)</div>
              <div class="payment-list">
                ${paymentList}
              </div>
            </div>
          `;
        }
        
        return `
      <div class="match-card">
        <h4 style="color: var(--primary); margin-bottom: 10px;">Partido #${index + 1} - ${date}</h4>
        <div class="summary-row">
          <span>Resultado:</span>
          <strong>${match.result} (${match.points} pts)</strong>
        </div>
        <div class="summary-row">
          <span>Goles:</span>
          <strong>${match.goalsScored} - ${match.goalsConceded}</strong>
        </div>
        <div class="summary-row">
          <span>Tarjetas:</span>
          <strong>üü®${match.yellowCards} üü¶${match.blueCards} üü•${match.redCards}</strong>
        </div>
        <div class="summary-row">
          <span>Arbitraje Total:</span>
          <strong>$${match.refereeValue.toFixed(0)}</strong>
        </div>
        <div class="summary-row">
          <span>Por Jugador:</span>
          <strong>$${match.refereePerPlayer.toFixed(0)} (${match.presentPlayers.length} presentes)</strong>
        </div>
        ${paymentDetailsHTML}
      </div>
    `;
      })
      .join("");
  }

  function updateStatistics() {
    const stats = tournamentData.stats || {};
    const matches = tournamentData.matches || [];
    const manualMatches = tournamentData.manualMatches || 0;
    const totalMatches = matches.length + manualMatches;
    
    document.getElementById("totalPoints").textContent = stats.points || 0;
    document.getElementById("totalMatches").textContent = totalMatches;
    document.getElementById("totalGoalsScored").textContent = stats.goalsScored || 0;
    document.getElementById("totalGoalsConceded").textContent = stats.goalsConceded || 0;
    
    const avgGoalsScored = totalMatches > 0 ? (stats.goalsScored || 0) / totalMatches : 0;
    const avgGoalsConceded = totalMatches > 0 ? (stats.goalsConceded || 0) / totalMatches : 0;
    document.getElementById("avgGoalsScored").textContent = avgGoalsScored.toFixed(2);
    document.getElementById("avgGoalsConceded").textContent = avgGoalsConceded.toFixed(2);
    
    document.getElementById("totalWins").textContent = stats.wins || 0;
    document.getElementById("totalDraws").textContent = stats.draws || 0;
    document.getElementById("totalLosses").textContent = stats.losses || 0;
    
    const winPercent = totalMatches > 0 ? ((stats.wins || 0) / totalMatches) * 100 : 0;
    const drawPercent = totalMatches > 0 ? ((stats.draws || 0) / totalMatches) * 100 : 0;
    const lossPercent = totalMatches > 0 ? ((stats.losses || 0) / totalMatches) * 100 : 0;
    
    document.getElementById("winPercent").textContent = winPercent.toFixed(1) + "%";
    document.getElementById("drawPercent").textContent = drawPercent.toFixed(1) + "%";
    document.getElementById("lossPercent").textContent = lossPercent.toFixed(1) + "%";
    
    document.getElementById("goalDifference").textContent = (stats.goalsScored || 0) - (stats.goalsConceded || 0);
    
    document.getElementById("totalYellow").textContent = stats.yellowCards || 0;
    document.getElementById("totalBlue").textContent = stats.blueCards || 0;
    document.getElementById("totalRed").textContent = stats.redCards || 0;
    
    const totalCards = (stats.yellowCards || 0) + (stats.blueCards || 0) + (stats.redCards || 0);
    const avgCards = totalMatches > 0 ? totalCards / totalMatches : 0;
    document.getElementById("avgCards").textContent = avgCards.toFixed(2);
    
    const totalPaid = players.reduce((sum, p) => sum + (p.totalPaid || 0), 0);
    document.getElementById("totalCollected").textContent = `$${totalPaid.toFixed(0)}`;
    document.getElementById("totalInscriptionNeeded").textContent = `$${(tournamentData.totalInscription || 0).toFixed(0)}`;
    document.getElementById("totalRefereeSpent").textContent = `$${(stats.totalReferee || 0).toFixed(0)}`;
    
    let totalRefereeCollected = 0;
    let totalRefereePending = 0;
    
    matches.forEach(match => {
      if (match.refereePayments) {
        const paidCount = Object.values(match.refereePayments).filter(paid => paid).length;
        const pendingCount = match.presentPlayers.length - paidCount;
        
        totalRefereeCollected += paidCount * match.refereePerPlayer;
        totalRefereePending += pendingCount * match.refereePerPlayer;
      }
    });
    
    document.getElementById("totalRefereeCollected").textContent = `$${totalRefereeCollected.toFixed(0)}`;
    document.getElementById("totalRefereePending").textContent = `$${totalRefereePending.toFixed(0)}`;
  }

  function updateInscriptionInfo() {
    const perPlayer = tournamentData.inscriptionPerPlayer || 0;
    const total = tournamentData.totalInscription || 0;
    
    document.getElementById("inscriptionInfo").innerHTML = `
      <strong>Valor de Inscripci√≥n:</strong> $${perPlayer.toFixed(0)} COP por jugador<br>
      <strong>Inscripci√≥n Total del Torneo:</strong> $${total.toFixed(0)} COP
    `;
  }

  window.addEventListener("load", async () => {
    await selectTournament("torneo1");
  });
</script>
</body>
</html>
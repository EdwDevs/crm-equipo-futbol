<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>‚≠ê IMPERIO ANDINO - Champions Edition</title>
<style>
  /* ===== SISTEMA DE DISE√ëO MEJORADO ===== */
  
  :root {
    /* Colores principales */
    --color-primary: #001e47;
    --color-primary-dark: #002b5c;
    --color-secondary: #0066cc;
    --color-accent: #00bfff;
    
    /* Estado sem√°ntico */
    --color-success: #00c853;
    --color-warning: #ffab00;
    --color-danger: #dc3545;
    --color-info: #2962ff;
    
    /* Neutrales */
    --color-white: #ffffff;
    --color-gray-50: #f8f9fa;
    --color-gray-100: #eef2f7;
    --color-gray-200: #dee2e6;
    --color-gray-600: #6c757d;
    --color-gray-900: #0a1628;
    
    /* Espaciado (sistema 8px) */
    --space-1: 4px;
    --space-2: 8px;
    --space-3: 12px;
    --space-4: 16px;
    --space-5: 20px;
    --space-6: 24px;
    --space-8: 32px;
    
    /* Sombras sutiles */
    --shadow-sm: 0 2px 4px rgba(0, 30, 71, 0.08);
    --shadow-md: 0 4px 12px rgba(0, 30, 71, 0.12);
    --shadow-lg: 0 8px 24px rgba(0, 30, 71, 0.16);
    
    /* Tipograf√≠a */
    --font-size-xs: 12px;
    --font-size-sm: 14px;
    --font-size-md: 15px;
    --font-size-lg: 18px;
    --font-size-xl: 24px;
    --font-size-2xl: 32px;
    
    /* Layout */
    --container-max-width: 1100px;
    --border-radius: 8px;
    --border-radius-lg: 12px;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
    min-height: 100vh;
    padding: var(--space-4);
    color: var(--color-gray-900);
    font-size: var(--font-size-md);
    line-height: 1.6;
    position: relative;
    overflow-x: hidden;
  }

  /* Efecto de estrellas optimizado */
  body::before {
    content: "";
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background-image: 
      radial-gradient(2px 2px at 20% 30%, rgba(255, 215, 0, 0.3), transparent),
      radial-gradient(2px 2px at 60% 70%, rgba(0, 191, 255, 0.3), transparent),
      radial-gradient(1px 1px at 50% 50%, rgba(139, 0, 255, 0.2), transparent);
    background-size: 200% 200%;
    animation: starfield 25s ease-in-out infinite;
    pointer-events: none;
    z-index: 0;
  }

  @keyframes starfield {
    0%, 100% { background-position: 0% 0%; }
    50% { background-position: 100% 100%; }
  }

  .container {
    max-width: var(--container-max-width);
    margin: 0 auto;
    background: var(--color-white);
    border-radius: var(--border-radius-lg);
    box-shadow: var(--shadow-lg);
    overflow: hidden;
    display: flex;
    flex-direction: column;
    max-height: 95vh;
    position: relative;
    z-index: 1;
  }

  /* Header mejorado */
  .header {
    background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-secondary) 100%);
    color: var(--color-white);
    padding: var(--space-5) var(--space-4);
    text-align: center;
    flex-shrink: 0;
    position: relative;
  }

  .header h1 { 
    font-size: var(--font-size-xl);
    margin-bottom: var(--space-2);
    font-weight: 700;
    letter-spacing: 1px;
    text-transform: uppercase;
  }

  .header .team-name {
    font-size: var(--font-size-lg);
    font-weight: 600;
    margin-top: var(--space-1);
    background: linear-gradient(90deg, var(--color-accent), var(--color-warning));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .header p {
    font-size: var(--font-size-sm);
    opacity: 0.9;
    margin-top: var(--space-2);
  }

  /* Tabs mejoradas */
  .nav-tabs {
    display: flex;
    overflow-x: auto;
    background: var(--color-primary-dark);
    border-bottom: 2px solid var(--color-secondary);
    flex-shrink: 0;
    scrollbar-width: thin;
  }

  .nav-tabs button {
    flex: 1;
    min-width: 100px;
    padding: var(--space-3) var(--space-4);
    border: none;
    background: transparent;
    cursor: pointer;
    font-size: var(--font-size-sm);
    font-weight: 600;
    color: rgba(255, 255, 255, 0.7);
    transition: all 0.3s ease;
    white-space: nowrap;
  }

  .nav-tabs button.active {
    color: var(--color-white);
    background: rgba(0, 102, 204, 0.2);
  }

  .nav-tabs button:hover { 
    color: var(--color-white);
    background: rgba(0, 102, 204, 0.15);
  }

  .content {
    padding: var(--space-4);
    overflow-y: auto;
    flex: 1;
  }

  /* Tournament selector */
  .tournament-selector {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: var(--space-3);
    margin-bottom: var(--space-5);
  }

  .tournament-selector button {
    padding: var(--space-3);
    border: 2px solid var(--color-secondary);
    background: var(--color-white);
    color: var(--color-primary);
    border-radius: var(--border-radius);
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .tournament-selector button.active {
    background: var(--color-secondary);
    color: var(--color-white);
    transform: scale(1.02);
  }

  /* Formularios */
  .form-group {
    margin-bottom: var(--space-4);
  }

  .form-group label {
    display: block;
    margin-bottom: var(--space-2);
    font-weight: 600;
    color: var(--color-primary);
    font-size: var(--font-size-sm);
  }

  .form-group input, 
  .form-group select {
    width: 100%;
    padding: var(--space-3);
    border: 2px solid var(--color-gray-200);
    border-radius: var(--border-radius);
    font-size: var(--font-size-md);
    transition: all 0.3s ease;
  }

  .form-group input:focus, 
  .form-group select:focus {
    outline: none;
    border-color: var(--color-secondary);
    box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
  }

  .form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: var(--space-3);
  }

  @media (min-width: 768px) {
    .form-grid { grid-template-columns: repeat(2, 1fr); }
  }

  /* Botones mejorados */
  .btn {
    width: 100%;
    padding: var(--space-3);
    border: none;
    border-radius: var(--border-radius);
    font-weight: 600;
    cursor: pointer;
    font-size: var(--font-size-sm);
    transition: all 0.3s ease;
    margin-top: var(--space-3);
    position: relative;
    overflow: hidden;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
  }

  .btn-primary { background: var(--color-secondary); color: var(--color-white); }
  .btn-success { background: var(--color-success); color: var(--color-white); }
  .btn-danger { background: var(--color-danger); color: var(--color-white); }
  .btn-warning { background: var(--color-warning); color: var(--color-white); }
  .btn-info { background: var(--color-info); color: var(--color-white); }

  .btn-sm {
    padding: var(--space-2) var(--space-3);
    font-size: var(--font-size-xs);
    width: auto;
    margin: 0;
  }

  /* ===== TABLAS MEJORADAS (MANTENIDAS) ===== */
  .table-container {
    overflow-x: auto;
    margin-top: var(--space-5);
    border-radius: var(--border-radius);
    border: 1px solid var(--color-gray-200);
    box-shadow: var(--shadow-sm);
    background: var(--color-white);
  }

  .table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    font-size: var(--font-size-sm);
  }

  .table thead {
    background: var(--color-primary);
    color: var(--color-white);
    position: sticky;
    top: 0;
    z-index: 10;
  }

  .table th {
    padding: var(--space-3) var(--space-4);
    text-align: left;
    font-weight: 600;
    font-size: var(--font-size-xs);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    white-space: nowrap;
    border-bottom: 2px solid var(--color-secondary);
  }

  .table td {
    padding: var(--space-3) var(--space-4);
    border-bottom: 1px solid var(--color-gray-100);
    vertical-align: middle;
  }

  .table tbody tr:hover {
    background-color: var(--color-gray-50);
  }

  .table tbody tr:last-child td {
    border-bottom: none;
  }

  /* Badges */
  .badge {
    display: inline-flex;
    align-items: center;
    gap: var(--space-1);
    padding: var(--space-2) var(--space-3);
    border-radius: 20px;
    font-size: var(--font-size-xs);
    font-weight: 600;
  }

  .badge-success { background: rgba(0, 200, 83, 0.1); color: var(--color-success); }
  .badge-warning { background: rgba(255, 171, 0, 0.1); color: var(--color-warning); }
  .badge-danger { background: rgba(220, 53, 69, 0.1); color: var(--color-danger); }
  .badge-info { background: rgba(41, 98, 255, 0.1); color: var(--color-info); }

  /* Progress bars */
  .progress-bar {
    height: 6px;
    background: var(--color-gray-100);
    border-radius: 3px;
    overflow: hidden;
    margin-top: var(--space-1);
  }

  .progress-fill {
    height: 100%;
    transition: width 0.4s ease;
    background: linear-gradient(90deg, var(--color-accent), var(--color-secondary));
  }

  /* Filter bar */
  .filter-bar {
    display: flex;
    gap: var(--space-3);
    margin-bottom: var(--space-4);
    flex-wrap: wrap;
    align-items: center;
  }

  .filter-bar input,
  .filter-bar select {
    padding: var(--space-3);
    border: 2px solid var(--color-gray-200);
    border-radius: var(--border-radius);
    font-size: var(--font-size-sm);
    min-width: 200px;
  }

  /* Modales */
  .modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0; top: 0;
    width: 100%; height: 100%;
    background: rgba(0, 30, 71, 0.8);
    backdrop-filter: blur(4px);
  }

  .modal.active { display: flex; align-items: center; justify-content: center; }

  .modal-content {
    background: var(--color-white);
    padding: var(--space-5);
    border-radius: var(--border-radius-lg);
    max-width: 800px;
    width: 90%;
    max-height: 85vh;
    overflow-y: auto;
    box-shadow: var(--shadow-lg);
    border: 2px solid var(--color-gray-200);
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-4);
    padding-bottom: var(--space-4);
    border-bottom: 2px solid var(--color-gray-200);
  }

  .modal-close {
    background: none;
    border: none;
    font-size: 28px;
    cursor: pointer;
    color: var(--color-gray-600);
    transition: color 0.2s ease;
  }

  .modal-close:hover { color: var(--color-danger); }

  /* Payment history */
  .payment-history {
    max-height: 250px;
    overflow-y: auto;
    border: 1px solid var(--color-gray-200);
    border-radius: var(--border-radius);
    padding: var(--space-3);
    margin-top: var(--space-3);
  }

  .payment-item {
    display: flex;
    justify-content: space-between;
    padding: var(--space-3);
    margin-bottom: var(--space-2);
    background: var(--color-gray-50);
    border-radius: var(--border-radius);
    align-items: center;
  }

  .payment-item:last-child { margin-bottom: 0; }

  /* Checkbox group */
  .checkbox-group {
    max-height: 250px;
    overflow-y: auto;
    border: 1px solid var(--color-gray-200);
    border-radius: var(--border-radius);
    padding: var(--space-3);
    margin-bottom: var(--space-4);
  }

  .checkbox-item-payment {
    display: grid;
    grid-template-columns: 1fr auto;
    align-items: center;
    padding: var(--space-3);
    margin-bottom: var(--space-2);
    background: var(--color-white);
    border-radius: var(--border-radius);
    gap: var(--space-3);
  }

  .checkbox-item-payment.paid {
    background: rgba(0, 200, 83, 0.05);
    border-left: 3px solid var(--color-success);
  }

  .checkbox-item-payment.not-paid {
    background: rgba(255, 171, 0, 0.05);
    border-left: 3px solid var(--color-warning);
  }

  /* Stats cards */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--space-4);
    margin-bottom: var(--space-5);
  }

  .stat-card {
    background: var(--color-white);
    padding: var(--space-4);
    border-radius: var(--border-radius-lg);
    box-shadow: var(--shadow-sm);
    transition: all 0.3s ease;
    border-left: 4px solid var(--color-secondary);
  }

  .stat-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
  }

  .stat-card h3 {
    font-size: var(--font-size-2xl);
    margin-bottom: var(--space-1);
    color: var(--color-primary);
    font-weight: 700;
  }

  .stat-card p {
    font-size: var(--font-size-xs);
    color: var(--color-gray-600);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  /* Alertas */
  .alert {
    padding: var(--space-4);
    border-radius: var(--border-radius);
    margin-bottom: var(--space-4);
    font-size: var(--font-size-sm);
    border-left: 4px solid;
  }

  .alert-info { 
    background: rgba(41, 98, 255, 0.08);
    color: var(--color-info);
    border-color: var(--color-info);
  }

  .alert-warning { 
    background: rgba(255, 171, 0, 0.08);
    color: var(--color-warning);
    border-color: var(--color-warning);
  }

  .alert-success { 
    background: rgba(0, 200, 83, 0.08);
    color: var(--color-success);
    border-color: var(--color-success);
  }

  /* Secciones */
  .section-divider {
    border-top: 2px solid var(--color-gray-100);
    margin: var(--space-6) 0;
    padding-top: var(--space-6);
  }

  h3.section-title {
    margin-top: var(--space-6);
    margin-bottom: var(--space-4);
    color: var(--color-primary);
    font-size: var(--font-size-lg);
    font-weight: 700;
  }

  /* Deudas */
  .debt-summary-card {
    background: linear-gradient(135deg, var(--color-white), var(--color-gray-50));
    border-left: 5px solid var(--color-danger);
    padding: var(--space-5);
    border-radius: var(--border-radius-lg);
    margin: var(--space-5) 0;
    box-shadow: var(--shadow-sm);
  }

  .debt-stat-item {
    text-align: center;
    padding: var(--space-3);
    background: var(--color-white);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-sm);
  }

  .debt-amount {
    color: var(--color-danger);
    font-weight: 700;
  }

  /* Botones de acci√≥n r√°pida */
  .quick-actions {
    position: fixed;
    bottom: var(--space-4);
    right: var(--space-4);
    z-index: 999;
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
  }

  .quick-actions button {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    border: 2px solid var(--color-secondary);
    background: var(--color-primary);
    color: var(--color-white);
    font-size: 24px;
    cursor: pointer;
    box-shadow: var(--shadow-md);
    transition: all 0.3s ease;
  }

  .quick-actions button:hover {
    transform: scale(1.1);
    box-shadow: var(--shadow-lg);
  }

  /* Clases utilitarias */
  .hidden { display: none !important; }
  .numeric { text-align: right; font-variant-numeric: tabular-nums; }

  @media (max-width: 360px) {
    .tournament-selector { grid-template-columns: 1fr; }
    .phase-selector { grid-template-columns: repeat(2, 1fr); }
  }

  /* ===== SISTEMA DE TOAST (Notificaciones) ===== */
  #toast-container {
    position: fixed;
    bottom: var(--space-4);
    right: var(--space-4);
    z-index: 9999;
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
    max-width: 400px;
  }

  .toast {
    background: var(--color-white);
    padding: var(--space-3) var(--space-4);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-lg);
    display: flex;
    align-items: center;
    gap: var(--space-3);
    font-size: var(--font-size-sm);
    min-width: 300px;
    transform: translateX(100%);
    opacity: 0;
    transition: all 0.3s ease;
  }

  .toast.show {
    transform: translateX(0);
    opacity: 1;
  }

  .toast-icon {
    font-size: 20px;
    width: 24px;
    text-align: center;
  }

  .toast-success .toast-icon { color: var(--color-success); }
  .toast-error .toast-icon { color: var(--color-danger); }
  .toast-warning .toast-icon { color: var(--color-warning); }
  .toast-info .toast-icon { color: var(--color-info); }

  .toast-message { flex: 1; font-weight: 500; }
  .toast-close { background: none; border: none; font-size: 20px; cursor: pointer; color: var(--color-gray-600); }
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>‚öΩ CRM F√∫tbol PRO</h1>
    <p id="currentTournamentName">Selecciona un torneo</p>
  </div>
  
  <div class="nav-tabs">
    <button class="nav-tab active" onclick="showTab('jugadores')">üë• Jugadores</button>
    <button class="nav-tab" onclick="showTab('pagos')">üí∞ Pagos</button>
    <button class="nav-tab" onclick="showTab('partidos')">‚öΩ Partidos</button>
    <button class="nav-tab" onclick="showTab('estadisticas')">üìä Estad√≠sticas</button>
    <button class="nav-tab" onclick="showTab('config')">‚öôÔ∏è Config</button>
  </div>
  
  <div class="content">
    <!-- JUGADORES -->
    <div id="jugadores" class="tab-content">
      <div class="tournament-selector">
        <button id="torneo1Btn" onclick="selectTournament('torneo1')">üèÜ Torneo 1</button>
        <button id="torneo2Btn" onclick="selectTournament('torneo2')">üèÜ Torneo 2</button>
      </div>
      
      <div class="form-group">
        <label>Nombre del Jugador</label>
        <input type="text" id="playerName" placeholder="Ej: Juan P√©rez" />
      </div>
      
      <div class="form-group">
        <label>N√∫mero de Camiseta</label>
        <input type="number" id="playerNumber" placeholder="Ej: 10" min="1" max="99" />
      </div>
      
      <button class="btn btn-primary" onclick="addPlayer()">‚ûï Agregar Jugador</button>
      
      <h3 class="section-title">Lista de Jugadores</h3>
      
      <div class="filter-bar">
        <input type="text" id="playerFilter" placeholder="üîç Buscar por nombre o n√∫mero..." onkeyup="filterPlayers()">
        <button class="btn btn-sm btn-info" onclick="clearPlayerFilter()">Limpiar</button>
      </div>
      
      <div class="table-container">
        <table class="table">
          <thead>
            <tr>
              <th>Nombre</th>
              <th class="numeric">#</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="playersTableBody">
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- PAGOS -->
    <div id="pagos" class="tab-content hidden">
      <div class="tournament-selector">
        <button id="torneo1BtnPagos" onclick="selectTournament('torneo1')">üèÜ Torneo 1</button>
        <button id="torneo2BtnPagos" onclick="selectTournament('torneo2')">üèÜ Torneo 2</button>
      </div>
      
      <div class="alert alert-info" id="inscriptionInfo">
        <strong>Valor de Inscripci√≥n:</strong> $0 COP por jugador
      </div>
      
      <div class="form-group">
        <label>Valor Total de Inscripci√≥n del Torneo</label>
        <input type="number" id="totalInscription" placeholder="Ej: 500000" min="0" />
      </div>
      
      <button class="btn btn-success" onclick="setInscriptionValue()">üìä Calcular Inscripci√≥n por Jugador</button>
      
      <h3 class="section-title">Registrar Abono</h3>
      
      <div class="form-group">
        <label>Seleccionar Jugador</label>
        <select id="playerSelectPayment">
          <option value="">-- Seleccionar --</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>Monto del Abono (COP)</label>
        <input type="number" id="paymentAmount" placeholder="Ej: 50000" min="0" />
      </div>
      
      <button class="btn btn-primary" onclick="registerPayment()">üí∞ Registrar Abono</button>
      
      <h3 class="section-title">Estado de Pagos de Inscripci√≥n</h3>
      
      <div class="filter-bar">
        <input type="text" id="paymentFilter" placeholder="üîç Buscar jugador..." onkeyup="filterPayments()">
        <select id="paymentStatusFilter" onchange="filterPayments()">
          <option value="all">Todos los estados</option>
          <option value="complete">Completo</option>
          <option value="pending">Pendiente</option>
        </select>
        <button class="btn btn-sm btn-info" onclick="clearPaymentFilters()">Limpiar</button>
      </div>
      
      <div class="table-container">
        <table class="table" id="paymentsTable">
          <thead>
            <tr>
              <th>Jugador</th>
              <th class="numeric">#</th>
              <th class="numeric">Debe Pagar</th>
              <th class="numeric">Ha Pagado</th>
              <th class="numeric">Pendiente</th>
              <th>Progreso</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="paymentsTableBody">
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- PARTIDOS -->
    <div id="partidos" class="tab-content hidden">
      <div class="tournament-selector">
        <button id="torneo1BtnPartidos" onclick="selectTournament('torneo1')">üèÜ Torneo 1</button>
        <button id="torneo2BtnPartidos" onclick="selectTournament('torneo2')">üèÜ Torneo 2</button>
      </div>
      
      <h3 class="section-title">Registrar Partido</h3>
      
      <div class="form-grid">
        <div class="form-group">
          <label>‚öΩ Goles Anotados</label>
          <input type="number" id="goalsScored" placeholder="0" value="0" min="0" />
        </div>
        
        <div class="form-group">
          <label>ü•Ö Goles Recibidos</label>
          <input type="number" id="goalsConceded" placeholder="0" value="0" min="0" />
        </div>
      </div>
      
      <div class="form-grid">
        <div class="form-group">
          <label>üü® Tarjetas Amarillas</label>
          <input type="number" id="yellowCards" placeholder="0" value="0" min="0" />
        </div>
        
        <div class="form-group">
          <label>üü¶ Tarjetas Azules</label>
          <input type="number" id="blueCards" placeholder="0" value="0" min="0" />
        </div>
      </div>
      
      <div class="form-group">
        <label>üü• Tarjetas Rojas</label>
        <input type="number" id="redCards" placeholder="0" value="0" min="0" />
      </div>
      
      <div class="form-group">
        <label>üíµ Valor del Arbitraje (COP)</label>
        <input type="number" id="refereeValue" placeholder="Ej: 80000" min="0" />
      </div>
      
      <h4 style="margin-bottom: var(--space-2); color: var(--color-primary);">Jugadores Presentes y Control de Cobro</h4>
      <div class="checkbox-group" id="playersPresent"></div>
      
      <div class="summary-extended" id="refereeSummary">
        <div class="summary-row">
          <span>Total Arbitraje:</span>
          <strong>$0 COP</strong>
        </div>
        <div class="summary-row">
          <span>Jugadores Presentes:</span>
          <strong>0</strong>
        </div>
        <div class="summary-row">
          <span>Por Jugador:</span>
          <strong>$0 COP</strong>
        </div>
        <div class="payment-status-section">
          <div class="payment-status-title">Estado de Cobro:</div>
          <div class="summary-row">
            <span>Jugadores que Pagaron:</span>
            <strong id="playersPaidCount">0</strong>
          </div>
          <div class="summary-row">
            <span>Jugadores Pendientes:</span>
            <strong id="playersPendingCount">0</strong>
          </div>
          <div class="summary-row">
            <span>Total Recaudado:</span>
            <strong id="totalCollectedReferee">$0 COP</strong>
          </div>
          <div class="summary-row">
            <span>Total Pendiente:</span>
            <strong id="totalPendingReferee">$0 COP</strong>
          </div>
        </div>
      </div>
      
      <button class="btn btn-success" onclick="registerMatch()">‚öΩ Registrar Partido</button>
      
      <h3 class="section-title">Historial de Partidos</h3>
      
      <div class="filter-bar">
        <select id="matchResultFilter" onchange="filterMatches()">
          <option value="all">Todos los resultados</option>
          <option value="Victoria">Victorias</option>
          <option value="Empate">Empates</option>
          <option value="Derrota">Derrotas</option>
        </select>
        <select id="matchPaymentFilter" onchange="filterMatches()">
          <option value="all">Todos los pagos</option>
          <option value="complete">Pagos completos</option>
          <option value="pending">Pagos pendientes</option>
        </select>
        <button class="btn btn-sm btn-info" onclick="clearMatchFilters()">Limpiar</button>
      </div>
      
      <div id="matchesList"></div>
    </div>
    
    <!-- ESTAD√çSTICAS -->
    <div id="estadisticas" class="tab-content hidden">
      <div class="tournament-selector">
        <button id="torneo1BtnStats" onclick="selectTournament('torneo1')">üèÜ Torneo 1</button>
        <button id="torneo2BtnStats" onclick="selectTournament('torneo2')">üèÜ Torneo 2</button>
      </div>
      
      <div class="alert alert-info" id="phaseInfo">
        <strong>Fase Actual:</strong> Fase de Grupos
      </div>
      
      <h3 class="section-title">üìä Estad√≠sticas del Equipo</h3>
      
      <div class="table-container">
        <table class="table">
          <thead>
            <tr>
              <th>Categor√≠a</th>
              <th>Valor</th>
              <th>Promedio</th>
            </tr>
          </thead>
          <tbody id="teamStatsTable">
          </tbody>
        </table>
      </div>
      
      <div class="stat-card" style="margin-top: var(--space-5);">
        <h3>üíº Finanzas del Equipo</h3>
        <div class="summary-row">
          <span>üí∞ Total Recaudado (Inscripciones):</span>
          <strong id="totalCollected">$0</strong>
        </div>
        <div class="summary-row">
          <span>üìä Inscripci√≥n Total:</span>
          <strong id="totalInscriptionNeeded">$0</strong>
        </div>
        <div class="summary-row">
          <span>‚öΩ Total Arbitrajes Gastados:</span>
          <strong id="totalRefereeSpent">$0</strong>
        </div>
        <div class="summary-row">
          <span>üíµ Total Arbitrajes Recaudados:</span>
          <strong id="totalRefereeCollected">$0</strong>
        </div>
        <div class="summary-row">
          <span>‚è≥ Total Arbitrajes Pendientes:</span>
          <strong id="totalRefereePending">$0</strong>
        </div>
      </div>
      
      <!-- DEUDAS AGRUPADAS -->
      <h3 class="section-title" style="margin-top: var(--space-6);">üìã Deudas por Jugador</h3>
      <div id="debtSummarySection"></div>
      <div id="debtTableContainer"></div>
      
      <h3 class="section-title" style="margin-top: var(--space-6);">üë• Estad√≠sticas por Jugador</h3>
      
      <div class="filter-bar">
        <input type="text" id="playerStatsFilter" placeholder="üîç Buscar jugador..." onkeyup="filterPlayerStats()">
        <select id="playerStatsSortBy" onchange="sortPlayerStats()">
          <option value="matches">Partidos</option>
          <option value="goals">Goles</option>
          <option value="avgGoals">Promedio Goles</option>
          <option value="yellowCards">Amarillas</option>
          <option value="blueCards">Azules</option>
          <option value="redCards">Rojas</option>
          <option value="attendance">Asistencia %</option>
        </select>
        <button class="btn btn-sm btn-info" onclick="clearPlayerStatsFilters()">Limpiar</button>
      </div>
      
      <div class="table-container">
        <table class="table">
          <thead>
            <tr>
              <th>Jugador</th>
              <th class="numeric">#</th>
              <th class="numeric">Partidos</th>
              <th>Asistencia</th>
              <th class="numeric">‚öΩ Goles</th>
              <th>Prom. Goles</th>
              <th class="numeric">üü®</th>
              <th class="numeric">üü¶</th>
              <th class="numeric">üü•</th>
              <th class="numeric">Total Tarjetas</th>
              <th>Prom. Tarjetas</th>
            </tr>
          </thead>
          <tbody id="playerStatsTable">
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- CONFIG -->
    <div id="config" class="tab-content hidden">
      <div class="tournament-selector">
        <button id="torneo1BtnConfig" onclick="selectTournament('torneo1')">üèÜ Torneo 1</button>
        <button id="torneo2BtnConfig" onclick="selectTournament('torneo2')">üèÜ Torneo 2</button>
      </div>
      
      <div class="form-group">
        <label>Nombre del Torneo</label>
        <input type="text" id="tournamentName" placeholder="Ej: Liga de Verano 2025" />
      </div>
      
      <button class="btn btn-primary" onclick="updateTournamentName()">üíæ Guardar Nombre</button>
      
      <h3 class="section-title">Fase del Torneo</h3>
      
      <div class="phase-selector">
        <button class="phase-btn" onclick="setPhase('Fase de Grupos')">Grupos</button>
        <button class="phase-btn" onclick="setPhase('Dieciseisavos de Final')">1/16</button>
        <button class="phase-btn" onclick="setPhase('Octavos de Final')">1/8</button>
        <button class="phase-btn" onclick="setPhase('Cuartos de Final')">1/4</button>
        <button class="phase-btn" onclick="setPhase('Semifinal')">Semifinal</button>
        <button class="phase-btn" onclick="setPhase('Final')">Final</button>
      </div>
      
      <div class="alert alert-warning">
        <strong>‚ö†Ô∏è Fase Actual:</strong> <span id="currentPhase">Fase de Grupos</span>
      </div>
      
      <div class="section-divider">
        <div class="stat-card">
          <h4>üìä Ajustar Estad√≠sticas Manualmente</h4>
          <p style="font-size: var(--font-size-xs); color: var(--color-gray-600); margin-bottom: var(--space-4);">
            Usa esta opci√≥n para ingresar datos de partidos ya jugados antes de usar el sistema.
          </p>
          
          <div class="form-grid">
            <div class="form-group">
              <label>Puntos</label>
              <input type="number" id="adjustPoints" placeholder="0" value="0" min="0" />
            </div>
            <div class="form-group">
              <label>Partidos Jugados</label>
              <input type="number" id="adjustMatches" placeholder="0" value="0" min="0" />
            </div>
          </div>
          
          <div class="form-grid">
            <div class="form-group">
              <label>Goles Anotados</label>
              <input type="number" id="adjustGoalsScored" placeholder="0" value="0" min="0" />
            </div>
            <div class="form-group">
              <label>Goles Recibidos</label>
              <input type="number" id="adjustGoalsConceded" placeholder="0" value="0" min="0" />
            </div>
          </div>
          
          <div class="form-grid">
            <div class="form-group">
              <label>Victorias</label>
              <input type="number" id="adjustWins" placeholder="0" value="0" min="0" />
            </div>
            <div class="form-group">
              <label>Empates</label>
              <input type="number" id="adjustDraws" placeholder="0" value="0" min="0" />
            </div>
          </div>
          
          <div class="form-grid">
            <div class="form-group">
              <label>Derrotas</label>
              <input type="number" id="adjustLosses" placeholder="0" value="0" min="0" />
            </div>
            <div class="form-group">
              <label>üü® Amarillas</label>
              <input type="number" id="adjustYellow" placeholder="0" value="0" min="0" />
            </div>
          </div>
          
          <div class="form-grid">
            <div class="form-group">
              <label>üü¶ Azules</label>
              <input type="number" id="adjustBlue" placeholder="0" value="0" min="0" />
            </div>
            <div class="form-group">
              <label>üü• Rojas</label>
              <input type="number" id="adjustRed" placeholder="0" value="0" min="0" />
            </div>
          </div>
          
          <div class="form-group">
            <label>Total Gastado en Arbitrajes (COP)</label>
            <input type="number" id="adjustReferee" placeholder="0" value="0" min="0" />
          </div>
          
          <div style="display: flex; gap: var(--space-3);">
            <button class="btn btn-info" onclick="loadCurrentStats()">üì• Cargar Valores Actuales</button>
            <button class="btn btn-success" onclick="saveAdjustedStats()">üíæ Guardar Ajustes</button>
          </div>
        </div>
      </div>
      
      <h3 class="section-title">Reiniciar Torneo</h3>
      <p style="margin-bottom: var(--space-4); font-size: var(--font-size-sm); color: var(--color-gray-600);">
        Esta acci√≥n reiniciar√° todos los valores del torneo actual, incluyendo puntos, goles, pagos, partidos y registros de cobro de arbitraje, pero mantendr√° la lista de jugadores.
      </p>
      <button class="btn btn-danger" onclick="confirmResetTournament()">üîÑ Reiniciar Torneo</button>
      
      <h3 class="section-title" style="margin-top: var(--space-6);">Eliminar Todos los Jugadores</h3>
      <p style="margin-bottom: var(--space-4); font-size: var(--font-size-sm); color: var(--color-gray-600);">
        Esta acci√≥n eliminar√° todos los jugadores del torneo actual junto con sus datos.
      </p>
      <button class="btn btn-danger" onclick="confirmDeleteAllPlayers()">üóëÔ∏è Eliminar Todos los Jugadores</button>
    </div>
  </div>
</div>

<!-- Botones de acci√≥n r√°pida -->
<div class="quick-actions">
  <button onclick="openDebtModal()" title="Ver deudas totales">üí≥</button>
</div>

<!-- Modal para gestionar abonos -->
<div id="paymentModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>üí∞ Gestionar Abonos</h3>
      <button class="modal-close" onclick="closePaymentModal()">&times;</button>
    </div>
    <div id="modalPlayerInfo" style="margin-bottom: var(--space-4); padding: var(--space-3); background: var(--color-gray-50); border-radius: var(--border-radius);"></div>
    <h4 style="margin-bottom: var(--space-3); color: var(--color-primary);">Historial de Abonos</h4>
    <div class="payment-history" id="paymentHistoryList"></div>
  </div>
</div>

<!-- Modal para editar jugador -->
<div id="editPlayerModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>‚úèÔ∏è Editar Jugador</h3>
      <button class="modal-close" onclick="closeEditPlayerModal()">&times;</button>
    </div>
    <div class="form-group">
      <label>Nombre del Jugador</label>
      <input type="text" id="editPlayerName" placeholder="Nombre del jugador" />
    </div>
    <div class="form-group">
      <label>N√∫mero de Camiseta</label>
      <input type="number" id="editPlayerNumber" placeholder="N√∫mero" min="1" max="99" />
    </div>
    <button class="btn btn-success" onclick="savePlayerEdit()">üíæ Guardar Cambios</button>
  </div>
</div>

<!-- Modal para gestionar partidos -->
<div id="matchModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>‚öΩ Gestionar Partido</h3>
      <button class="modal-close" onclick="closeMatchModal()">&times;</button>
    </div>
    <div id="modalMatchInfo" style="margin-bottom: var(--space-4); padding: var(--space-3); background: var(--color-gray-50); border-radius: var(--border-radius);"></div>
    
    <h4 style="margin-bottom: var(--space-3); color: var(--color-primary);">Datos del Partido</h4>
    <div class="form-grid" style="margin-bottom: var(--space-4);">
      <div class="form-group">
        <label>‚öΩ Goles Anotados</label>
        <input type="number" id="editGoalsScored" min="0" />
      </div>
      <div class="form-group">
        <label>ü•Ö Goles Recibidos</label>
        <input type="number" id="editGoalsConceded" min="0" />
      </div>
      <div class="form-group">
        <label>üü® Amarillas (Equipo)</label>
        <input type="number" id="editYellowCards" min="0" />
      </div>
      <div class="form-group">
        <label>üü¶ Azules (Equipo)</label>
        <input type="number" id="editBlueCards" min="0" />
      </div>
      <div class="form-group">
        <label>üü• Rojas (Equipo)</label>
        <input type="number" id="editRedCards" min="0" />
      </div>
      <div class="form-group">
        <label>üíµ Valor Arbitraje</label>
        <input type="number" id="editRefereeValue" min="0" />
      </div>
    </div>
    
    <h4 style="margin-bottom: var(--space-3); color: var(--color-primary);">Estad√≠sticas Individuales</h4>
    <div id="playerIndividualStats" style="max-height: 300px; overflow-y: auto; border: 1px solid var(--color-gray-200); border-radius: var(--border-radius); padding: var(--space-3); margin-bottom: var(--space-4);"></div>
    
    <h4 style="margin-bottom: var(--space-3); color: var(--color-primary);">Control de Cobro de Arbitraje</h4>
    <div class="payment-history" id="matchPaymentsList" style="max-height: 200px;"></div>
    
    <div style="display: flex; gap: var(--space-3); margin-top: var(--space-5);">
      <button class="btn btn-success" onclick="saveMatchChanges()" style="flex: 1;">üíæ Guardar Cambios</button>
      <button class="btn btn-danger" onclick="deleteMatch()" style="flex: 1;">üóëÔ∏è Eliminar Partido</button>
    </div>
  </div>
</div>

<!-- Modal para ver deudas totales -->
<div id="debtModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>üí≥ Reporte de Deudas Totales</h3>
      <button class="modal-close" onclick="closeDebtModal()">&times;</button>
    </div>
    <div class="debt-summary" id="debtSummaryTotal"></div>
    <h4 style="margin-bottom: var(--space-4); color: var(--color-primary);">Detalle por Jugador</h4>
    <div id="debtDetailsList" style="max-height: 400px; overflow-y: auto;"></div>
  </div>
</div>

<!-- ===== TOAST CONTAINER (A√±adido autom√°ticamente) ===== -->
<script>
  class ToastSystem {
    constructor() {
      this.container = this.createContainer();
    }
    
    createContainer() {
      const container = document.createElement('div');
      container.id = 'toast-container';
      document.body.appendChild(container);
      return container;
    }
    
    show(message, type = 'info', duration = 3000) {
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.innerHTML = `
        <span class="toast-icon">${this.getIcon(type)}</span>
        <span class="toast-message">${message}</span>
        <button class="toast-close" onclick="this.parentElement.remove()">‚úï</button>
      `;
      
      toast.style.cssText = `
        background: var(--color-white);
        padding: var(--space-3) var(--space-4);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-lg);
        display: flex;
        align-items: center;
        gap: var(--space-3);
        font-size: var(--font-size-sm);
        min-width: 300px;
        transform: translateX(100%);
        opacity: 0;
        transition: all 0.3s ease;
        border-left: 4px solid ${this.getColor(type)};
      `;
      
      this.container.appendChild(toast);
      
      setTimeout(() => {
        toast.style.transform = 'translateX(0)';
        toast.style.opacity = '1';
      }, 10);
      
      if (duration > 0) {
        setTimeout(() => this.hide(toast), duration);
      }
      
      return toast;
    }
    
    hide(toast) {
      toast.style.transform = 'translateX(100%)';
      toast.style.opacity = '0';
      setTimeout(() => toast.remove(), 300);
    }
    
    getIcon(type) {
      const icons = {
        success: '‚úì',
        error: '‚úï',
        warning: '‚ö†',
        info: '‚Ñπ'
      };
      return icons[type] || '‚Ñπ';
    }
    
    getColor(type) {
      const colors = {
        success: 'var(--color-success)',
        error: 'var(--color-danger)',
        warning: 'var(--color-warning)',
        info: 'var(--color-info)'
      };
      return colors[type] || 'var(--color-info)';
    }
  }

  window.toast = new ToastSystem();
</script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getFirestore, collection, doc, setDoc, getDoc, getDocs, updateDoc, deleteDoc, query, where,
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBXylL77z6EPDy2EuXVLLF_hkW8CyQvns4",
    authDomain: "crm-futbol.firebaseapp.com",
    projectId: "crm-futbol",
    storageBucket: "crm-futbol.firebasestorage.app",
    messagingSenderId: "222709021751",
    appId: "1:222709021751:web:94168589472c2ee938d3b2",
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  let currentTournament = "torneo1";
  let players = [];
  let tournamentData = {};
  let currentEditingPlayer = null;
  let currentEditingMatchIndex = null;
  let filteredPlayers = [];
  let filteredPayments = [];
  let filteredMatches = [];
  let filteredPlayerStats = [];

  window.showTab = function (tabName) {
    document.querySelectorAll(".tab-content").forEach((tab) => tab.classList.add("hidden"));
    document.getElementById(tabName).classList.remove("hidden");
    document.querySelectorAll(".nav-tabs button").forEach((btn) => btn.classList.remove("active"));
    event.target.classList.add("active");
    
    if (tabName === "estadisticas") {
      updateStatistics();
    }
  };

  window.selectTournament = async function (tournament) {
    currentTournament = tournament;
    
    // ‚úÖ CORREGIDO: Limpiar todos los filtros al cambiar de torneo (con validaci√≥n)
    const filterElements = {
      "playerFilter": "",
      "paymentFilter": "",
      "paymentStatusFilter": "all",
      "matchResultFilter": "all",
      "matchPaymentFilter": "all",
      "playerStatsFilter": "",
      "playerStatsSortBy": "matches"
    };
    
    Object.entries(filterElements).forEach(([id, defaultValue]) => {
      const el = document.getElementById(id);
      if (el) el.value = defaultValue;
    });
    
    document.querySelectorAll(".tournament-selector button").forEach((btn) => {
      btn.classList.remove("active");
    });
    
    [
      "torneo1Btn", "torneo2Btn", "torneo1BtnPagos", "torneo2BtnPagos",
      "torneo1BtnPartidos", "torneo2BtnPartidos", "torneo1BtnStats", "torneo2BtnStats",
      "torneo1BtnConfig", "torneo2BtnConfig",
    ].forEach((id) => {
      const el = document.getElementById(id);
      if (el) el.classList.toggle("active", id.includes(tournament));
    });

    await loadTournamentData();
    await loadPlayers();
    
    // ‚úÖ CORREGIDO: Reiniciar arrays filtrados con datos del nuevo torneo
    filteredPlayers = [...players];
    filteredPayments = [...players];
    filteredMatches = [...(tournamentData.matches || [])];
    filteredPlayerStats = [];
    
    updateAllViews();
    
    toast.show(`Torneo cambiado: ${tournamentData.name}`, "info", 2000);
  };

  async function loadTournamentData() {
    const docRef = doc(db, "tournaments", currentTournament);
    const docSnap = await getDoc(docRef);
    
    if (docSnap.exists()) {
      tournamentData = docSnap.data();
    } else {
      tournamentData = {
        name: currentTournament === "torneo1" ? "Torneo 1" : "Torneo 2",
        totalInscription: 0,
        inscriptionPerPlayer: 0,
        phase: "Fase de Grupos",
        matches: [],
        manualMatches: 0,
        stats: {
          points: 0, wins: 0, draws: 0, losses: 0,
          goalsScored: 0, goalsConceded: 0,
          yellowCards: 0, blueCards: 0, redCards: 0,
          totalReferee: 0,
        },
      };
      await setDoc(docRef, tournamentData);
    }
    
    document.getElementById("currentTournamentName").textContent = tournamentData.name;
    document.getElementById("tournamentName").value = tournamentData.name;
    document.getElementById("currentPhase").textContent = tournamentData.phase;
    document.getElementById("phaseInfo").innerHTML = `<strong>Fase Actual:</strong> ${tournamentData.phase}`;
    
    // ‚úÖ CORREGIDO: Sincronizar el input de inscripci√≥n total con el valor guardado
    document.getElementById("totalInscription").value = tournamentData.totalInscription || "";
  }

  async function loadPlayers() {
    const q = query(collection(db, "players"), where("tournament", "==", currentTournament));
    const querySnapshot = await getDocs(q);
    players = [];
    
    for (const docSnap of querySnapshot.docs) {
      const playerData = { id: docSnap.id, ...docSnap.data() };
      
      if (playerData.payments && playerData.payments.length > 0) {
        let needsUpdate = false;
        const updatedPayments = playerData.payments.map((payment, index) => {
          if (!payment.id) {
            needsUpdate = true;
            return {
              ...payment,
              id: Date.now().toString() + "_" + index + "_" + Math.random().toString(36).substr(2, 9)
            };
          }
          return payment;
        });
        
        if (needsUpdate) {
          await updateDoc(doc(db, "players", docSnap.id), {
            payments: updatedPayments
          });
          playerData.payments = updatedPayments;
        }
      }
      
      players.push(playerData);
    }
    
    filteredPlayers = [...players];
    filteredPayments = [...players];
  }

  window.addPlayer = async function () {
    const name = document.getElementById("playerName").value.trim();
    const number = document.getElementById("playerNumber").value;
    
    if (!name || !number) {
      toast.show("Por favor completa todos los campos", "warning", 3000);
      return;
    }
    
    const playerData = {
      name: name,
      number: parseInt(number),
      tournament: currentTournament,
      payments: [],
      totalPaid: 0,
    };
    
    await setDoc(doc(collection(db, "players")), playerData);
    document.getElementById("playerName").value = "";
    document.getElementById("playerNumber").value = "";
    
    await loadPlayers();
    updateAllViews();
    toast.show("Jugador agregado exitosamente", "success", 3000);
  };

  window.openEditPlayerModal = function(playerId) {
    const player = players.find(p => p.id === playerId);
    if (!player) return;
    
    currentEditingPlayer = player;
    document.getElementById("editPlayerName").value = player.name;
    document.getElementById("editPlayerNumber").value = player.number;
    document.getElementById("editPlayerModal").classList.add("active");
  };

  window.closeEditPlayerModal = function() {
    document.getElementById("editPlayerModal").classList.remove("active");
    currentEditingPlayer = null;
  };

  window.savePlayerEdit = async function() {
    if (!currentEditingPlayer) return;
    
    const newName = document.getElementById("editPlayerName").value.trim();
    const newNumber = parseInt(document.getElementById("editPlayerNumber").value);
    
    if (!newName || !newNumber) {
      toast.show("Por favor completa todos los campos", "warning", 3000);
      return;
    }
    
    await updateDoc(doc(db, "players", currentEditingPlayer.id), {
      name: newName,
      number: newNumber,
    });
    
    await loadPlayers();
    closeEditPlayerModal();
    updateAllViews();
    toast.show("Jugador actualizado exitosamente", "success", 3000);
  };

  window.deletePlayer = async function (playerId) {
    if (confirm("¬øEst√°s seguro de eliminar este jugador? Se perder√°n todos sus datos de pagos.")) {
      await deleteDoc(doc(db, "players", playerId));
      await loadPlayers();
      updateAllViews();
      toast.show("Jugador eliminado exitosamente", "success", 3000);
    }
  };

  window.setInscriptionValue = async function () {
    const total = parseFloat(document.getElementById("totalInscription").value);
    
    if (!total || players.length === 0) {
      toast.show("Ingresa un valor v√°lido y aseg√∫rate de tener jugadores registrados", "warning", 3000);
      return;
    }
    
    const perPlayer = total / players.length;
    tournamentData.totalInscription = total;
    tournamentData.inscriptionPerPlayer = perPlayer;
    
    await updateDoc(doc(db, "tournaments", currentTournament), {
      totalInscription: total,
      inscriptionPerPlayer: perPlayer,
    });
    
    updateAllViews();
    toast.show(`Inscripci√≥n calculada: $${perPlayer.toFixed(0)} COP por jugador`, "success", 4000);
  };

  window.registerPayment = async function () {
    const playerId = document.getElementById("playerSelectPayment").value;
    const amount = parseFloat(document.getElementById("paymentAmount").value);
    
    if (!playerId || !amount || amount <= 0) {
      toast.show("Por favor completa todos los campos con valores v√°lidos", "warning", 3000);
      return;
    }
    
    const player = players.find((p) => p.id === playerId);
    if (!player) {
      toast.show("Jugador no encontrado", "error", 3000);
      return;
    }
    
    const newPayment = {
      id: Date.now().toString() + "_" + Math.random().toString(36).substr(2, 9),
      amount: amount,
      date: new Date().toISOString()
    };
    
    const newPayments = [...(player.payments || []), newPayment];
    const newTotal = newPayments.reduce((sum, p) => sum + p.amount, 0);
    
    await updateDoc(doc(db, "players", playerId), {
      payments: newPayments,
      totalPaid: newTotal,
    });
    
    document.getElementById("playerSelectPayment").value = "";
    document.getElementById("paymentAmount").value = "";
    await loadPlayers();
    updateAllViews();
    toast.show("Abono registrado exitosamente", "success", 3000);
  };

  window.openPaymentModal = function(playerId) {
    currentEditingPlayer = players.find(p => p.id === playerId);
    if (!currentEditingPlayer) return;
    
    const perPlayer = tournamentData.inscriptionPerPlayer || 0;
    const paid = currentEditingPlayer.totalPaid || 0;
    const pending = perPlayer - paid;
    
    document.getElementById("modalPlayerInfo").innerHTML = `
      <strong style="font-size: var(--font-size-md); color: var(--color-primary);">${currentEditingPlayer.name} - #${currentEditingPlayer.number}</strong><br>
      <div style="margin-top: var(--space-2); display: flex; gap: var(--space-4); flex-wrap: wrap;">
        <span>Debe pagar: <strong>$${perPlayer.toFixed(0)}</strong></span>
        <span>Ha pagado: <strong style="color: var(--color-success);">$${paid.toFixed(0)}</strong></span>
        <span>Pendiente: <strong style="color: var(--color-warning);">$${pending.toFixed(0)}</strong></span>
      </div>
    `;
    
    updatePaymentHistory();
    document.getElementById("paymentModal").classList.add("active");
  };

  window.closePaymentModal = function() {
    document.getElementById("paymentModal").classList.remove("active");
    currentEditingPlayer = null;
  };

  function updatePaymentHistory() {
    if (!currentEditingPlayer) return;
    
    const payments = currentEditingPlayer.payments || [];
    const historyList = document.getElementById("paymentHistoryList");
    
    if (payments.length === 0) {
      historyList.innerHTML = '<p style="text-align: center; color: var(--color-gray-600); padding: var(--space-4);">No hay abonos registrados</p>';
      return;
    }
    
    historyList.innerHTML = payments.map(payment => {
      const date = new Date(payment.date).toLocaleDateString("es-CO", {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
      });
      
      return `
        <div class="payment-item">
          <div>
            <div style="font-size: var(--font-size-xs); color: var(--color-gray-600);">${date}</div>
            <div style="font-weight: 600; color: var(--color-primary);">$${payment.amount.toFixed(0)} COP</div>
          </div>
          <div style="display: flex; gap: var(--space-2);">
            <button class="btn btn-sm btn-warning" onclick="editPayment('${payment.id}')">‚úèÔ∏è</button>
            <button class="btn btn-sm btn-danger" onclick="deletePayment('${payment.id}')">üóëÔ∏è</button>
          </div>
        </div>
      `;
    }).join('');
  }

  window.editPayment = async function(paymentId) {
    if (!currentEditingPlayer) {
      toast.show("Error: No hay jugador seleccionado", "error", 3000);
      return;
    }
    
    const payment = currentEditingPlayer.payments.find(p => p.id === paymentId);
    if (!payment) {
      toast.show("Error: Abono no encontrado", "error", 3000);
      return;
    }
    
    const dateStr = new Date(payment.date).toLocaleDateString("es-CO", {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });
    
    const newAmount = prompt(`Editar monto del abono\nFecha: ${dateStr}\nMonto actual: $${payment.amount.toFixed(0)}\n\nIngrese el nuevo monto:`, payment.amount);
    
    if (newAmount === null || newAmount === "") return;
    
    const amount = parseFloat(newAmount);
    if (isNaN(amount) || amount <= 0) {
      toast.show("Por favor ingrese un monto v√°lido mayor a 0", "warning", 3000);
      return;
    }
    
    const updatedPayments = currentEditingPlayer.payments.map(p => 
      p.id === paymentId ? { ...p, amount: amount } : p
    );
    
    const newTotal = updatedPayments.reduce((sum, p) => sum + p.amount, 0);
    
    await updateDoc(doc(db, "players", currentEditingPlayer.id), {
      payments: updatedPayments,
      totalPaid: newTotal,
    });
    
    await loadPlayers();
    currentEditingPlayer = players.find(p => p.id === currentEditingPlayer.id);
    updatePaymentHistory();
    updateAllViews();
    toast.show("Abono actualizado exitosamente", "success", 3000);
  };

  window.deletePayment = async function(paymentId) {
    if (!currentEditingPlayer) {
      toast.show("Error: No hay jugador seleccionado", "error", 3000);
      return;
    }
    
    const payment = currentEditingPlayer.payments.find(p => p.id === paymentId);
    if (!payment) {
      toast.show("Error: Abono no encontrado", "error", 3000);
      return;
    }
    
    const dateStr = new Date(payment.date).toLocaleDateString("es-CO");
    if (!confirm(`¬øEst√°s seguro de eliminar este abono?\n\nFecha: ${dateStr}\nMonto: $${payment.amount.toFixed(0)}`)) return;
    
    const updatedPayments = currentEditingPlayer.payments.filter(p => p.id !== paymentId);
    const newTotal = updatedPayments.reduce((sum, p) => sum + p.amount, 0);
    
    await updateDoc(doc(db, "players", currentEditingPlayer.id), {
      payments: updatedPayments,
      totalPaid: newTotal,
    });
    
    await loadPlayers();
    currentEditingPlayer = players.find(p => p.id === currentEditingPlayer.id);
    updatePaymentHistory();
    updateAllViews();
    toast.show("Abono eliminado exitosamente", "success", 3000);
  };

  window.registerMatch = async function () {
    const goalsScored = parseInt(document.getElementById("goalsScored").value) || 0;
    const goalsConceded = parseInt(document.getElementById("goalsConceded").value) || 0;
    const yellowCards = parseInt(document.getElementById("yellowCards").value) || 0;
    const blueCards = parseInt(document.getElementById("blueCards").value) || 0;
    const redCards = parseInt(document.getElementById("redCards").value) || 0;
    const refereeValue = parseFloat(document.getElementById("refereeValue").value) || 0;
    
    const presentPlayers = [];
    const refereePayments = {};
    
    document.querySelectorAll("#playersPresent .checkbox-item-payment").forEach((item) => {
      const attendanceCheckbox = item.querySelector('input[name^="attendance_"]');
      const paymentCheckbox = item.querySelector('input[name^="payment_"]');
      
      if (attendanceCheckbox && attendanceCheckbox.checked) {
        const playerId = attendanceCheckbox.value;
        presentPlayers.push(playerId);
        refereePayments[playerId] = paymentCheckbox ? paymentCheckbox.checked : false;
      }
    });
    
    if (presentPlayers.length === 0) {
      toast.show("Selecciona al menos un jugador presente", "warning", 3000);
      return;
    }
    
    let points = 0;
    let result = "";
    
    if (goalsScored > goalsConceded) {
      points = 2;
      result = "Victoria";
    } else if (goalsScored === goalsConceded) {
      points = 1;
      result = "Empate";
    } else {
      points = 0;
      result = "Derrota";
    }
    
    const refereePerPlayer = refereeValue / presentPlayers.length;
    const playerStats = {};
    presentPlayers.forEach(playerId => {
      playerStats[playerId] = { goals: 0, yellowCards: 0, blueCards: 0, redCards: 0 };
    });
    
    const matchData = {
      date: new Date().toISOString(),
      goalsScored, goalsConceded,
      yellowCards, blueCards, redCards,
      refereeValue, presentPlayers,
      refereePerPlayer, refereePayments,
      points, result,
      playerStats
    };
    
    const newMatches = [...(tournamentData.matches || []), matchData];
    const newStats = {
      points: (tournamentData.stats?.points || 0) + points,
      wins: (tournamentData.stats?.wins || 0) + (result === "Victoria" ? 1 : 0),
      draws: (tournamentData.stats?.draws || 0) + (result === "Empate" ? 1 : 0),
      losses: (tournamentData.stats?.losses || 0) + (result === "Derrota" ? 1 : 0),
      goalsScored: (tournamentData.stats?.goalsScored || 0) + goalsScored,
      goalsConceded: (tournamentData.stats?.goalsConceded || 0) + goalsConceded,
      yellowCards: (tournamentData.stats?.yellowCards || 0) + yellowCards,
      blueCards: (tournamentData.stats?.blueCards || 0) + blueCards,
      redCards: (tournamentData.stats?.redCards || 0) + redCards,
      totalReferee: (tournamentData.stats?.totalReferee || 0) + refereeValue,
    };
    
    await updateDoc(doc(db, "tournaments", currentTournament), {
      matches: newMatches,
      stats: newStats,
    });
    
    document.getElementById("goalsScored").value = "0";
    document.getElementById("goalsConceded").value = "0";
    document.getElementById("yellowCards").value = "0";
    document.getElementById("blueCards").value = "0";
    document.getElementById("redCards").value = "0";
    document.getElementById("refereeValue").value = "";
    document.querySelectorAll("#playersPresent input[type='checkbox']").forEach((cb) => (cb.checked = false));
    
    await loadTournamentData();
    updateAllViews();
    
    const paidCount = Object.values(refereePayments).filter(paid => paid).length;
    const pendingCount = presentPlayers.length - paidCount;
    
    toast.show(`Partido registrado: ${result} (${points} pts)\nPagados: ${paidCount} | Pendientes: ${pendingCount}`, "success", 4000);
  };

  window.openMatchModal = function(matchIndex) {
    currentEditingMatchIndex = matchIndex;
    const match = tournamentData.matches[matchIndex];
    if (!match) return;
    
    const date = new Date(match.date).toLocaleDateString("es-CO", {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });
    
    document.getElementById("modalMatchInfo").innerHTML = `
      <strong style="font-size: var(--font-size-md); color: var(--color-primary);">Partido #${matchIndex + 1} - ${date}</strong><br>
      <div style="margin-top: var(--space-2); display: flex; gap: var(--space-4); flex-wrap: wrap;">
        <span>Resultado: <strong>${match.result} (${match.points} pts)</strong></span>
        <span>Goles: <strong>${match.goalsScored} - ${match.goalsConceded}</strong></span>
      </div>
    `;
    
    document.getElementById("editGoalsScored").value = match.goalsScored;
    document.getElementById("editGoalsConceded").value = match.goalsConceded;
    document.getElementById("editYellowCards").value = match.yellowCards;
    document.getElementById("editBlueCards").value = match.blueCards;
    document.getElementById("editRedCards").value = match.redCards;
    document.getElementById("editRefereeValue").value = match.refereeValue;
    
    if (!match.playerStats) {
      match.playerStats = {};
      match.presentPlayers.forEach(playerId => {
        match.playerStats[playerId] = { goals: 0, yellowCards: 0, blueCards: 0, redCards: 0 };
      });
    }
    
    updatePlayerIndividualStats();
    updateMatchPaymentsList();
    document.getElementById("matchModal").classList.add("active");
  };

  function updatePlayerIndividualStats() {
    if (currentEditingMatchIndex === null) return;
    
    const match = tournamentData.matches[currentEditingMatchIndex];
    if (!match || !match.presentPlayers) return;
    
    const statsContainer = document.getElementById("playerIndividualStats");
    
    const html = match.presentPlayers.map(playerId => {
      const player = players.find(p => p.id === playerId);
      const playerName = player ? `${player.name} - #${player.number}` : 'Jugador no encontrado';
      const stats = match.playerStats?.[playerId] || { goals: 0, yellowCards: 0, blueCards: 0, redCards: 0 };
      
      return `
        <div style="background: var(--color-white); padding: var(--space-3); margin-bottom: var(--space-3); border-radius: var(--border-radius); border: 1px solid var(--color-gray-200);">
          <div style="font-weight: 600; margin-bottom: var(--space-3); color: var(--color-primary);">${playerName}</div>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: var(--space-3);">
            <div>
              <label style="font-size: var(--font-size-xs); color: var(--color-gray-600); display: block; margin-bottom: var(--space-1);">‚öΩ Goles</label>
              <input type="number" id="player_${playerId}_goals" value="${stats.goals}" min="0" 
                     style="width: 100%; padding: var(--space-2); border: 1px solid var(--color-gray-200); border-radius: var(--border-radius);"
                     onchange="updatePlayerStat('${playerId}', 'goals', this.value)">
            </div>
            <div>
              <label style="font-size: var(--font-size-xs); color: var(--color-gray-600); display: block; margin-bottom: var(--space-1);">üü® Amarillas</label>
              <input type="number" id="player_${playerId}_yellow" value="${stats.yellowCards}" min="0" 
                     style="width: 100%; padding: var(--space-2); border: 1px solid var(--color-gray-200); border-radius: var(--border-radius);"
                     onchange="updatePlayerStat('${playerId}', 'yellowCards', this.value)">
            </div>
            <div>
              <label style="font-size: var(--font-size-xs); color: var(--color-gray-600); display: block; margin-bottom: var(--space-1);">üü¶ Azules</label>
              <input type="number" id="player_${playerId}_blue" value="${stats.blueCards}" min="0" 
                     style="width: 100%; padding: var(--space-2); border: 1px solid var(--color-gray-200); border-radius: var(--border-radius);"
                     onchange="updatePlayerStat('${playerId}', 'blueCards', this.value)">
            </div>
            <div>
              <label style="font-size: var(--font-size-xs); color: var(--color-gray-600); display: block; margin-bottom: var(--space-1);">üü• Rojas</label>
              <input type="number" id="player_${playerId}_red" value="${stats.redCards}" min="0" 
                     style="width: 100%; padding: var(--space-2); border: 1px solid var(--color-gray-200); border-radius: var(--border-radius);"
                     onchange="updatePlayerStat('${playerId}', 'redCards', this.value)">
            </div>
          </div>
        </div>
      `;
    }).join('');
    
    statsContainer.innerHTML = html;
  }

  window.updatePlayerStat = function(playerId, stat, value) {
    if (currentEditingMatchIndex === null) return;
    
    const match = tournamentData.matches[currentEditingMatchIndex];
    if (!match || !match.playerStats) return;
    
    if (!match.playerStats[playerId]) {
      match.playerStats[playerId] = { goals: 0, yellowCards: 0, blueCards: 0, redCards: 0 };
    }
    
    match.playerStats[playerId][stat] = parseInt(value) || 0;
  };

  window.closeMatchModal = function() {
    document.getElementById("matchModal").classList.remove("active");
    currentEditingMatchIndex = null;
  };

  function updateMatchPaymentsList() {
    if (currentEditingMatchIndex === null) return;
    
    const match = tournamentData.matches[currentEditingMatchIndex];
    if (!match || !match.refereePayments) return;
    
    const paymentsList = document.getElementById("matchPaymentsList");
    
    const html = match.presentPlayers.map(playerId => {
      const player = players.find(p => p.id === playerId);
      const playerName = player ? `${player.name} - #${player.number}` : 'Jugador no encontrado';
      const isPaid = match.refereePayments[playerId] || false;
      
      return `
        <div class="payment-item">
          <div style="flex: 1;">
            <div style="font-weight: 500;">${playerName}</div>
            <div style="font-size: var(--font-size-xs); color: var(--color-gray-600);">$${match.refereePerPlayer.toFixed(0)} COP</div>
          </div>
          <div>
            <button class="btn btn-sm ${isPaid ? 'btn-success' : 'btn-warning'}" onclick="toggleMatchPayment('${playerId}')">
              ${isPaid ? '‚úì Pagado' : '‚è≥ Pendiente'}
            </button>
          </div>
        </div>
      `;
    }).join('');
    
    paymentsList.innerHTML = html;
  }

  window.toggleMatchPayment = function(playerId) {
    if (currentEditingMatchIndex === null) return;
    
    const match = tournamentData.matches[currentEditingMatchIndex];
    if (!match || !match.refereePayments) return;
    
    match.refereePayments[playerId] = !match.refereePayments[playerId];
    updateMatchPaymentsList();
  };

  window.saveMatchChanges = async function() {
    if (currentEditingMatchIndex === null) return;
    
    const match = tournamentData.matches[currentEditingMatchIndex];
    const oldStats = { ...tournamentData.stats };
    
    const newGoalsScored = parseInt(document.getElementById("editGoalsScored").value) || 0;
    const newGoalsConceded = parseInt(document.getElementById("editGoalsConceded").value) || 0;
    const newYellowCards = parseInt(document.getElementById("editYellowCards").value) || 0;
    const newBlueCards = parseInt(document.getElementById("editBlueCards").value) || 0;
    const newRedCards = parseInt(document.getElementById("editRedCards").value) || 0;
    const newRefereeValue = parseFloat(document.getElementById("editRefereeValue").value) || 0;
    
    let newPoints = 0;
    let newResult = "";
    if (newGoalsScored > newGoalsConceded) {
      newPoints = 2;
      newResult = "Victoria";
    } else if (newGoalsScored === newGoalsConceded) {
      newPoints = 1;
      newResult = "Empate";
    } else {
      newPoints = 0;
      newResult = "Derrota";
    }
    
    const updatedStats = {
      points: oldStats.points - match.points + newPoints,
      wins: oldStats.wins - (match.result === "Victoria" ? 1 : 0) + (newResult === "Victoria" ? 1 : 0),
      draws: oldStats.draws - (match.result === "Empate" ? 1 : 0) + (newResult === "Empate" ? 1 : 0),
      losses: oldStats.losses - (match.result === "Derrota" ? 1 : 0) + (newResult === "Derrota" ? 1 : 0),
      goalsScored: oldStats.goalsScored - match.goalsScored + newGoalsScored,
      goalsConceded: oldStats.goalsConceded - match.goalsConceded + newGoalsConceded,
      yellowCards: oldStats.yellowCards - match.yellowCards + newYellowCards,
      blueCards: oldStats.blueCards - match.blueCards + newBlueCards,
      redCards: oldStats.redCards - match.redCards + newRedCards,
      totalReferee: oldStats.totalReferee - match.refereeValue + newRefereeValue,
    };
    
    const newRefereePerPlayer = match.presentPlayers.length > 0 ? newRefereeValue / match.presentPlayers.length : 0;
    
    tournamentData.matches[currentEditingMatchIndex] = {
      ...match,
      goalsScored: newGoalsScored,
      goalsConceded: newGoalsConceded,
      yellowCards: newYellowCards,
      blueCards: newBlueCards,
      redCards: newRedCards,
      refereeValue: newRefereeValue,
      refereePerPlayer: newRefereePerPlayer,
      points: newPoints,
      result: newResult,
    };
    
    await updateDoc(doc(db, "tournaments", currentTournament), {
      matches: tournamentData.matches,
      stats: updatedStats,
    });
    
    await loadTournamentData();
    closeMatchModal();
    updateAllViews();
    toast.show("Partido actualizado exitosamente", "success", 3000);
  };

  window.deleteMatch = async function() {
    if (currentEditingMatchIndex === null) return;
    
    if (!confirm("¬øEst√°s seguro de eliminar este partido? Esta acci√≥n no se puede deshacer.")) return;
    
    const match = tournamentData.matches[currentEditingMatchIndex];
    const oldStats = { ...tournamentData.stats };
    
    const updatedStats = {
      points: oldStats.points - match.points,
      wins: oldStats.wins - (match.result === "Victoria" ? 1 : 0),
      draws: oldStats.draws - (match.result === "Empate" ? 1 : 0),
      losses: oldStats.losses - (match.result === "Derrota" ? 1 : 0),
      goalsScored: oldStats.goalsScored - match.goalsScored,
      goalsConceded: oldStats.goalsConceded - match.goalsConceded,
      yellowCards: oldStats.yellowCards - match.yellowCards,
      blueCards: oldStats.blueCards - match.blueCards,
      redCards: oldStats.redCards - match.redCards,
      totalReferee: oldStats.totalReferee - match.refereeValue,
    };
    
    tournamentData.matches.splice(currentEditingMatchIndex, 1);
    
    await updateDoc(doc(db, "tournaments", currentTournament), {
      matches: tournamentData.matches,
      stats: updatedStats,
    });
    
    await loadTournamentData();
    closeMatchModal();
    updateAllViews();
    toast.show("Partido eliminado exitosamente", "success", 3000);
  };

  window.openDebtModal = async function() {
    const torneo1Doc = await getDoc(doc(db, "tournaments", "torneo1"));
    const torneo2Doc = await getDoc(doc(db, "tournaments", "torneo2"));
    
    const torneo1Data = torneo1Doc.exists() ? torneo1Doc.data() : {};
    const torneo2Data = torneo2Doc.exists() ? torneo2Doc.data() : {};
    
    const q1 = query(collection(db, "players"), where("tournament", "==", "torneo1"));
    const q2 = query(collection(db, "players"), where("tournament", "==", "torneo2"));
    
    const [snapshot1, snapshot2] = await Promise.all([getDocs(q1), getDocs(q2)]);
    
    const allPlayers = new Map();
    
    snapshot1.forEach((docSnap) => {
      const player = { id: docSnap.id, ...docSnap.data() };
      const key = player.name.trim().toLowerCase() + "_" + player.number;
      
      if (!allPlayers.has(key)) {
        allPlayers.set(key, {
          name: player.name,
          number: player.number,
          torneos: []
        });
      }
      
      const inscriptionPending = (torneo1Data.inscriptionPerPlayer || 0) - (player.totalPaid || 0);
      allPlayers.get(key).torneos.push({
        tournament: "Torneo 1",
        inscriptionPending: Math.max(0, inscriptionPending),
        playerId: player.id
      });
    });
    
    snapshot2.forEach((docSnap) => {
      const player = { id: docSnap.id, ...docSnap.data() };
      const key = player.name.trim().toLowerCase() + "_" + player.number;
      
      if (!allPlayers.has(key)) {
        allPlayers.set(key, {
          name: player.name,
          number: player.number,
          torneos: []
        });
      }
      
      const inscriptionPending = (torneo2Data.inscriptionPerPlayer || 0) - (player.totalPaid || 0);
      allPlayers.get(key).torneos.push({
        tournament: "Torneo 2",
        inscriptionPending: Math.max(0, inscriptionPending),
        playerId: player.id
      });
    });
    
    let totalInscriptionDebt = 0;
    const debts = [];
    
    allPlayers.forEach((playerData) => {
      const totalInscriptionPending = playerData.torneos.reduce((sum, t) => sum + t.inscriptionPending, 0);
      
      if (totalInscriptionPending > 0) {
        debts.push({
          name: playerData.name,
          number: playerData.number,
          totalInscriptionPending: totalInscriptionPending,
          torneos: playerData.torneos.filter(t => t.inscriptionPending > 0)
        });
        totalInscriptionDebt += totalInscriptionPending;
      }
    });
    
    document.getElementById("debtSummaryTotal").innerHTML = `
      <h4>üí≥ Resumen Total de Deudas de Inscripci√≥n</h4>
      <p style="font-size: var(--font-size-xs); color: var(--color-gray-600); margin: var(--space-3) 0;">
        Consolidado de inscripciones pendientes en todos los torneos
      </p>
      <div style="text-align: center; background: var(--color-white); padding: var(--space-5); border-radius: var(--border-radius-lg); border: 2px solid var(--color-danger);">
        <div style="font-size: var(--font-size-2xl); font-weight: 700; color: var(--color-danger);">$${totalInscriptionDebt.toFixed(0)}</div>
        <div style="font-size: var(--font-size-sm); color: var(--color-gray-600); margin-top: var(--space-1);">Deuda Total de Inscripciones</div>
      </div>
    `;
    
    const detailsList = document.getElementById("debtDetailsList");
    
    if (debts.length === 0) {
      detailsList.innerHTML = '<div class="stat-card"><div style="text-align: center; color: var(--color-success); padding: var(--space-6);">üéâ ¬°No hay deudas de inscripci√≥n pendientes!</div></div>';
    } else {
      debts.sort((a, b) => b.totalInscriptionPending - a.totalInscriptionPending);
      
      detailsList.innerHTML = debts.map(debt => {
        const torneosDetail = debt.torneos.map(t => 
          `${t.tournament}: $${t.inscriptionPending.toFixed(0)}`
        ).join(' | ');
        
        return `
          <div class="payment-item" style="border-left: 3px solid var(--color-danger);">
            <div>
              <div style="font-weight: 600; color: var(--color-primary);">${debt.name} - #${debt.number}</div>
              <div style="font-size: var(--font-size-xs); color: var(--color-gray-600);">${torneosDetail}</div>
            </div>
            <div style="font-weight: 700; color: var(--color-danger); font-size: var(--font-size-md);">$${debt.totalInscriptionPending.toFixed(0)}</div>
          </div>
        `;
      }).join('');
    }
    
    document.getElementById("debtModal").classList.add("active");
  };

  window.closeDebtModal = function() {
    document.getElementById("debtModal").classList.remove("active");
  };

  window.filterPlayers = function() {
    const searchTerm = document.getElementById("playerFilter").value.toLowerCase();
    
    filteredPlayers = players.filter(player => {
      const nameMatch = player.name.toLowerCase().includes(searchTerm);
      const numberMatch = player.number.toString().includes(searchTerm);
      return nameMatch || numberMatch;
    });
    
    updatePlayersTable();
  };

  window.clearPlayerFilter = function() {
    document.getElementById("playerFilter").value = "";
    filteredPlayers = [...players];
    updatePlayersTable();
  };

  window.filterPayments = function() {
    const searchTerm = document.getElementById("paymentFilter").value.toLowerCase();
    const statusFilter = document.getElementById("paymentStatusFilter").value;
    const perPlayer = tournamentData.inscriptionPerPlayer || 0;
    
    filteredPayments = players.filter(player => {
      const nameMatch = player.name.toLowerCase().includes(searchTerm);
      const numberMatch = player.number.toString().includes(searchTerm);
      const searchMatch = nameMatch || numberMatch;
      
      if (!searchMatch) return false;
      
      if (statusFilter === "all") return true;
      
      const paid = player.totalPaid || 0;
      const pending = perPlayer - paid;
      
      if (statusFilter === "complete") return pending <= 0;
      if (statusFilter === "pending") return pending > 0;
      
      return true;
    });
    
    updatePaymentsTable();
  };

  window.clearPaymentFilters = function() {
    document.getElementById("paymentFilter").value = "";
    document.getElementById("paymentStatusFilter").value = "all";
    filteredPayments = [...players];
        updateAllViews();
  };

  // ‚úÖ FUNCI√ìN AGREGADA - Estaba faltando y causaba el error
  window.filterMatches = function() {
    const resultFilter = document.getElementById("matchResultFilter").value;
    const paymentFilter = document.getElementById("matchPaymentFilter").value;
    
    filteredMatches = (tournamentData.matches || []).filter(match => {
      // Filtrar por resultado
      if (resultFilter !== "all" && match.result !== resultFilter) {
        return false;
      }
      
      // Filtrar por estado de pago
      if (paymentFilter !== "all" && match.refereePayments) {
        const paidCount = Object.values(match.refereePayments).filter(paid => paid).length;
        const allPaid = paidCount === match.presentPlayers.length;
        
        if (paymentFilter === "complete" && !allPaid) return false;
        if (paymentFilter === "pending" && allPaid) return false;
      }
      
      return true;
    });
    
    updateMatchesList();
  };

  window.clearMatchFilters = function() {
    document.getElementById("matchResultFilter").value = "all";
    document.getElementById("matchPaymentFilter").value = "all";
    filteredMatches = [...(tournamentData.matches || [])];
    updateMatchesList();
  };

  window.updateTournamentName = async function () {
    const name = document.getElementById("tournamentName").value.trim();
    
    if (!name) {
      toast.show("Ingresa un nombre v√°lido", "warning", 3000);
      return;
    }
    
    await updateDoc(doc(db, "tournaments", currentTournament), { name });
    await loadTournamentData();
    toast.show("Nombre actualizado", "success", 3000);
  };

  window.setPhase = async function (phase) {
    await updateDoc(doc(db, "tournaments", currentTournament), { phase });
    await loadTournamentData();
    updateAllViews();
    toast.show(`Fase actualizada a: ${phase}`, "success", 3000);
  };

  window.loadCurrentStats = function () {
    const stats = tournamentData.stats || {};
    const manualMatches = tournamentData.manualMatches || 0;
    
    document.getElementById("adjustPoints").value = stats.points || 0;
    document.getElementById("adjustMatches").value = manualMatches;
    document.getElementById("adjustGoalsScored").value = stats.goalsScored || 0;
    document.getElementById("adjustGoalsConceded").value = stats.goalsConceded || 0;
    document.getElementById("adjustWins").value = stats.wins || 0;
    document.getElementById("adjustDraws").value = stats.draws || 0;
    document.getElementById("adjustLosses").value = stats.losses || 0;
    document.getElementById("adjustYellow").value = stats.yellowCards || 0;
    document.getElementById("adjustBlue").value = stats.blueCards || 0;
    document.getElementById("adjustRed").value = stats.redCards || 0;
    document.getElementById("adjustReferee").value = stats.totalReferee || 0;
    
    toast.show("Valores actuales cargados", "info", 3000);
  };

  window.saveAdjustedStats = async function () {
    if (!confirm("¬øEst√°s seguro de ajustar las estad√≠sticas? Esto sobrescribir√° los valores actuales.")) return;
    
    const newStats = {
      points: parseInt(document.getElementById("adjustPoints").value) || 0,
      wins: parseInt(document.getElementById("adjustWins").value) || 0,
      draws: parseInt(document.getElementById("adjustDraws").value) || 0,
      losses: parseInt(document.getElementById("adjustLosses").value) || 0,
      goalsScored: parseInt(document.getElementById("adjustGoalsScored").value) || 0,
      goalsConceded: parseInt(document.getElementById("adjustGoalsConceded").value) || 0,
      yellowCards: parseInt(document.getElementById("adjustYellow").value) || 0,
      blueCards: parseInt(document.getElementById("adjustBlue").value) || 0,
      redCards: parseInt(document.getElementById("adjustRed").value) || 0,
      totalReferee: parseFloat(document.getElementById("adjustReferee").value) || 0,
    };
    
    const manualMatches = parseInt(document.getElementById("adjustMatches").value) || 0;
    
    await updateDoc(doc(db, "tournaments", currentTournament), {
      stats: newStats,
      manualMatches: manualMatches,
    });
    
    await loadTournamentData();
    updateAllViews();
    toast.show("Estad√≠sticas ajustadas exitosamente", "success", 3000);
  };

  window.confirmResetTournament = async function () {
    if (!confirm("¬øEst√°s seguro de reiniciar el torneo? Se perder√°n todos los datos de partidos, pagos, estad√≠sticas y registros de cobro de arbitraje.")) return;
    
    for (const player of players) {
      await updateDoc(doc(db, "players", player.id), {
        payments: [],
        totalPaid: 0,
      });
    }
    
    await updateDoc(doc(db, "tournaments", currentTournament), {
      totalInscription: 0,
      inscriptionPerPlayer: 0,
      phase: "Fase de Grupos",
      matches: [],
      manualMatches: 0,
      stats: {
        points: 0, wins: 0, draws: 0, losses: 0,
        goalsScored: 0, goalsConceded: 0,
        yellowCards: 0, blueCards: 0, redCards: 0,
        totalReferee: 0,
      },
    });
    
    await loadTournamentData();
    await loadPlayers();
    updateAllViews();
    toast.show("Torneo reiniciado exitosamente", "success", 3000);
  };

  window.confirmDeleteAllPlayers = async function () {
    if (!confirm("¬øEst√°s seguro de eliminar TODOS los jugadores del torneo actual?")) return;
    
    for (const player of players) {
      await deleteDoc(doc(db, "players", player.id));
    }
    
    await loadPlayers();
    updateAllViews();
    toast.show("Todos los jugadores han sido eliminados", "success", 3000);
  };

  function updateAllViews() {
    updatePlayersTable();
    updatePaymentsTable();
    updatePlayerSelectors();
    filterMatches();
    updateStatistics();
    updateInscriptionInfo();
  }

  function updatePlayersTable() {
    const tbody = document.getElementById("playersTableBody");
    
    if (filteredPlayers.length === 0) {
      tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: var(--color-gray-600); padding: var(--space-5);">No hay jugadores registrados</td></tr>';
      return;
    }
    
    tbody.innerHTML = filteredPlayers.map(player => `
      <tr>
        <td><strong>${player.name}</strong></td>
        <td class="numeric">${player.number}</td>
        <td>
          <div style="display: flex; gap: var(--space-2);">
            <button class="btn btn-sm btn-warning" onclick="openEditPlayerModal('${player.id}')">‚úèÔ∏è Editar</button>
            <button class="btn btn-sm btn-danger" onclick="deletePlayer('${player.id}')">üóëÔ∏è</button>
          </div>
        </td>
      </tr>
    `).join('');
  }

  function updatePaymentsTable() {
    const tbody = document.getElementById("paymentsTableBody");
    
    if (filteredPayments.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--color-gray-600); padding: var(--space-5);">No hay jugadores para mostrar</td></tr>';
      return;
    }
    
    const perPlayer = tournamentData.inscriptionPerPlayer || 0;
    
    tbody.innerHTML = filteredPayments.map((player) => {
      const paid = player.totalPaid || 0;
      const pending = perPlayer - paid;
      const percentage = perPlayer > 0 ? ((paid / perPlayer) * 100).toFixed(1) : 0;
      const statusBadge = pending <= 0 
        ? `<span class="badge badge-success">Completo</span>`
        : `<span class="badge badge-warning">Pendiente</span>`;
      
      return `
        <tr>
          <td><strong>${player.name}</strong></td>
          <td class="numeric">${player.number}</td>
          <td class="numeric">$${perPlayer.toFixed(0)}</td>
          <td class="numeric" style="color: var(--color-success); font-weight: 600;">$${paid.toFixed(0)}</td>
          <td class="numeric" style="color: var(--color-warning); font-weight: 600;">$${pending.toFixed(0)}</td>
          <td>
            <div class="progress-cell">
              ${statusBadge}
              <div class="progress-bar" style="width: 100px;">
                <div class="progress-fill" style="width: ${percentage}%; ${pending <= 0 ? 'background: var(--color-success)' : ''}"></div>
              </div>
              <small style="color: var(--color-gray-600);">${percentage}%</small>
            </div>
          </td>
          <td>
            <button class="btn btn-sm btn-info" onclick="openPaymentModal('${player.id}')">üìù Gestionar</button>
          </td>
        </tr>
      `;
    }).join('');
  }

  function updatePlayerSelectors() {
    const select = document.getElementById("playerSelectPayment");
    select.innerHTML =
      '<option value="">-- Seleccionar --</option>' +
      players.map((p) => `<option value="${p.id}">${p.name} - #${p.number}</option>`).join("");
    
    const checkboxContainer = document.getElementById("playersPresent");
    checkboxContainer.innerHTML = players
      .map(
        (p) => `
          <div class="checkbox-item-payment">
            <div class="player-name-wrapper">
              <input type="checkbox" id="attendance_${p.id}" name="attendance_${p.id}" value="${p.id}" onchange="updateRefereeSummary()" />
              <label for="attendance_${p.id}">${p.name} - #${p.number}</label>
            </div>
            <div class="payment-checkbox-wrapper">
              <input type="checkbox" id="payment_${p.id}" name="payment_${p.id}" onchange="updateRefereeSummary()" />
              <label for="payment_${p.id}">üíµ Pag√≥</label>
            </div>
          </div>
        `
      )
      .join("");
  }

  window.updateRefereeSummary = function () {
    const refereeValue = parseFloat(document.getElementById("refereeValue").value) || 0;
    
    let presentCount = 0;
    let paidCount = 0;
    
    document.querySelectorAll("#playersPresent .checkbox-item-payment").forEach((item) => {
      const attendanceCheckbox = item.querySelector('input[name^="attendance_"]');
      const paymentCheckbox = item.querySelector('input[name^="payment_"]');
      
      if (attendanceCheckbox && attendanceCheckbox.checked) {
        presentCount++;
        
        if (paymentCheckbox && paymentCheckbox.checked) {
          paidCount++;
          item.classList.add('paid');
          item.classList.remove('not-paid');
        } else {
          item.classList.add('not-paid');
          item.classList.remove('paid');
        }
      } else {
        item.classList.remove('paid', 'not-paid');
        if (paymentCheckbox) {
          paymentCheckbox.checked = false;
        }
      }
    });
    
    const perPlayer = presentCount > 0 ? refereeValue / presentCount : 0;
    const pendingCount = presentCount - paidCount;
    const totalCollected = paidCount * perPlayer;
    const totalPending = pendingCount * perPlayer;
    
    const summary = document.getElementById("refereeSummary");
    summary.innerHTML = `
      <div class="summary-row">
        <span>Total Arbitraje:</span>
        <strong>$${refereeValue.toFixed(0)} COP</strong>
      </div>
      <div class="summary-row">
        <span>Jugadores Presentes:</span>
        <strong>${presentCount}</strong>
      </div>
      <div class="summary-row">
        <span>Por Jugador:</span>
        <strong>$${perPlayer.toFixed(0)} COP</strong>
      </div>
      <div class="payment-status-section">
        <div class="payment-status-title">Estado de Cobro:</div>
        <div class="summary-row">
          <span>Jugadores que Pagaron:</span>
          <strong id="playersPaidCount">${paidCount}</strong>
        </div>
        <div class="summary-row">
          <span>Jugadores Pendientes:</span>
          <strong id="playersPendingCount">${pendingCount}</strong>
        </div>
        <div class="summary-row">
          <span>Total Recaudado:</span>
          <strong id="totalCollectedReferee">$${totalCollected.toFixed(0)} COP</strong>
        </div>
        <div class="summary-row">
          <span>Total Pendiente:</span>
          <strong id="totalPendingReferee">$${totalPending.toFixed(0)} COP</strong>
        </div>
      </div>
    `;
  };

  function updateMatchesList() {
    const container = document.getElementById("matchesList");
    const matchesToShow = filteredMatches;
    
    if (matchesToShow.length === 0) {
      container.innerHTML = '<p style="text-align: center; color: var(--color-gray-600); padding: var(--space-5);">No hay partidos para mostrar</p>';
      return;
    }
    
    container.innerHTML = matchesToShow
      .map((match) => {
        const originalIndex = tournamentData.matches.indexOf(match);
        const date = new Date(match.date).toLocaleDateString("es-CO");
        
        let paymentDetailsHTML = '';
        if (match.refereePayments) {
          const paymentList = match.presentPlayers.map(playerId => {
            const player = players.find(p => p.id === playerId);
            const playerName = player ? `${player.name} - #${player.number}` : 'Jugador no encontrado';
            const paid = match.refereePayments[playerId];
            const badge = paid 
              ? `<span class="badge badge-success">‚úì Pagado</span>` 
              : `<span class="badge badge-warning">‚è≥ Pendiente</span>`;
            
            return `
              <div class="payment-list-item">
                <span class="player-name" style="flex: 1;">${playerName}</span>
                <span style="font-size: var(--font-size-xs); color: var(--color-gray-600);">$${match.refereePerPlayer.toFixed(0)} COP</span>
                ${badge}
              </div>
            `;
          }).join('');
          
          const paidCount = Object.values(match.refereePayments).filter(paid => paid).length;
          const pendingCount = match.presentPlayers.length - paidCount;
          
          paymentDetailsHTML = `
            <div style="margin-top: var(--space-3); padding: var(--space-3); background: var(--color-gray-50); border-radius: var(--border-radius);">
              <div style="font-weight: 600; margin-bottom: var(--space-2);">Control de Cobro (${paidCount} pagaron / ${pendingCount} pendientes)</div>
              <div style="display: grid; gap: var(--space-2);">${paymentList}</div>
            </div>
          `;
        }
        
        return `
          <div class="stat-card" style="border-left: 4px solid ${match.result === 'Victoria' ? 'var(--color-success)' : match.result === 'Empate' ? 'var(--color-warning)' : 'var(--color-danger)'};">
            <h4 style="color: var(--color-primary); margin-bottom: var(--space-3); font-size: var(--font-size-md);">Partido #${originalIndex + 1} - ${date}</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: var(--space-3); margin-bottom: var(--space-3);">
              <div>
                <span style="color: var(--color-gray-600);">Resultado:</span>
                <strong style="display: block; font-size: var(--font-size-lg);">${match.result} (${match.points} pts)</strong>
              </div>
              <div>
                <span style="color: var(--color-gray-600);">Goles:</span>
                <strong style="display: block; font-size: var(--font-size-lg);">${match.goalsScored} - ${match.goalsConceded}</strong>
              </div>
              <div>
                <span style="color: var(--color-gray-600);">Tarjetas:</span>
                <strong style="display: block; font-size: var(--font-size-lg);">üü®${match.yellowCards} üü¶${match.blueCards} üü•${match.redCards}</strong>
              </div>
              <div>
                <span style="color: var(--color-gray-600);">Arbitraje:</span>
                <strong style="display: block; font-size: var(--font-size-lg);">$${match.refereeValue.toFixed(0)}</strong>
              </div>
              <div>
                <span style="color: var(--color-gray-600);">Por Jugador:</span>
                <strong style="display: block; font-size: var(--font-size-lg);">$${match.refereePerPlayer.toFixed(0)} (${match.presentPlayers.length} presentes)</strong>
              </div>
            </div>
            ${paymentDetailsHTML}
            <button class="btn btn-info" onclick="openMatchModal(${originalIndex})" style="margin-top: var(--space-3);">
              üìù Gestionar Partido
            </button>
          </div>
        `;
      })
      .join("");
  }

  function updateStatistics() {
    const stats = tournamentData.stats || {};
    const matches = tournamentData.matches || [];
    const manualMatches = tournamentData.manualMatches || 0;
    const totalMatches = matches.length + manualMatches;
    
    const teamStatsTable = document.getElementById("teamStatsTable");
    
    const avgGoalsScored = totalMatches > 0 ? (stats.goalsScored || 0) / totalMatches : 0;
    const avgGoalsConceded = totalMatches > 0 ? (stats.goalsConceded || 0) / totalMatches : 0;
    const winPercent = totalMatches > 0 ? ((stats.wins || 0) / totalMatches) * 100 : 0;
    const drawPercent = totalMatches > 0 ? ((stats.draws || 0) / totalMatches) * 100 : 0;
    const lossPercent = totalMatches > 0 ? ((stats.losses || 0) / totalMatches) * 100 : 0;
    const goalDifference = (stats.goalsScored || 0) - (stats.goalsConceded || 0);
    const totalCards = (stats.yellowCards || 0) + (stats.blueCards || 0) + (stats.redCards || 0);
    const avgCards = totalMatches > 0 ? totalCards / totalMatches : 0;
    
    teamStatsTable.innerHTML = `
      <tr>
        <td><strong>‚öΩ Partidos Jugados</strong></td>
        <td class="numeric">${totalMatches}</td>
        <td>-</td>
      </tr>
      <tr>
        <td><strong>üèÜ Puntos</strong></td>
        <td class="numeric">${stats.points || 0}</td>
        <td class="numeric">${totalMatches > 0 ? ((stats.points || 0) / totalMatches).toFixed(2) : 0} pts/partido</td>
      </tr>
      <tr style="background: rgba(0, 200, 83, 0.05);">
        <td><strong>‚úÖ Victorias</strong></td>
        <td class="numeric">${stats.wins || 0}</td>
        <td class="numeric">${winPercent.toFixed(1)}%</td>
      </tr>
      <tr style="background: rgba(255, 171, 0, 0.05);">
        <td><strong>ü§ù Empates</strong></td>
        <td class="numeric">${stats.draws || 0}</td>
        <td class="numeric">${drawPercent.toFixed(1)}%</td>
      </tr>
      <tr style="background: rgba(220, 53, 69, 0.05);">
        <td><strong>‚ùå Derrotas</strong></td>
        <td class="numeric">${stats.losses || 0}</td>
        <td class="numeric">${lossPercent.toFixed(1)}%</td>
      </tr>
      <tr>
        <td><strong>‚öΩ Goles Anotados</strong></td>
        <td class="numeric">${stats.goalsScored || 0}</td>
        <td class="numeric">${avgGoalsScored.toFixed(2)} goles/partido</td>
      </tr>
      <tr>
        <td><strong>ü•Ö Goles Recibidos</strong></td>
        <td class="numeric">${stats.goalsConceded || 0}</td>
        <td class="numeric">${avgGoalsConceded.toFixed(2)} goles/partido</td>
      </tr>
      <tr style="background: ${goalDifference >= 0 ? 'rgba(0, 200, 83, 0.05)' : 'rgba(220, 53, 69, 0.05)'};">
        <td><strong>üìä Diferencia de Goles</strong></td>
        <td class="numeric">${goalDifference >= 0 ? '+' : ''}${goalDifference}</td>
        <td>-</td>
      </tr>
      <tr style="background: rgba(255, 171, 0, 0.05);">
        <td><strong>üü® Tarjetas Amarillas</strong></td>
        <td class="numeric">${stats.yellowCards || 0}</td>
        <td class="numeric">${totalMatches > 0 ? ((stats.yellowCards || 0) / totalMatches).toFixed(2) : 0} por partido</td>
      </tr>
      <tr style="background: rgba(41, 98, 255, 0.05);">
        <td><strong>üü¶ Tarjetas Azules</strong></td>
        <td class="numeric">${stats.blueCards || 0}</td>
        <td class="numeric">${totalMatches > 0 ? ((stats.blueCards || 0) / totalMatches).toFixed(2) : 0} por partido</td>
      </tr>
      <tr style="background: rgba(220, 53, 69, 0.05);">
        <td><strong>üü• Tarjetas Rojas</strong></td>
        <td class="numeric">${stats.redCards || 0}</td>
        <td class="numeric">${totalMatches > 0 ? ((stats.redCards || 0) / totalMatches).toFixed(2) : 0} por partido</td>
      </tr>
      <tr>
        <td><strong>üìã Total Tarjetas</strong></td>
        <td class="numeric">${totalCards}</td>
        <td class="numeric">${avgCards.toFixed(2)} por partido</td>
      </tr>
    `;
    
    const playerStatsMap = new Map();
    
    players.forEach(player => {
      playerStatsMap.set(player.id, {
        id: player.id,
        name: player.name,
        number: player.number,
        matchesPlayed: 0,
        goals: 0,
        yellowCards: 0,
        blueCards: 0,
        redCards: 0
      });
    });
    
    matches.forEach(match => {
      if (match.presentPlayers) {
        match.presentPlayers.forEach(playerId => {
          if (playerStatsMap.has(playerId)) {
            const playerStat = playerStatsMap.get(playerId);
            playerStat.matchesPlayed++;
            
            if (match.playerStats && match.playerStats[playerId]) {
              const stats = match.playerStats[playerId];
              playerStat.goals += stats.goals || 0;
              playerStat.yellowCards += stats.yellowCards || 0;
              playerStat.blueCards += stats.blueCards || 0;
              playerStat.redCards += stats.redCards || 0;
            }
          }
        });
      }
    });
    
    filteredPlayerStats = Array.from(playerStatsMap.values());
    sortPlayerStats();
    
    const totalPaid = players.reduce((sum, p) => sum + (p.totalPaid || 0), 0);
    document.getElementById("totalCollected").textContent = `$${totalPaid.toFixed(0)}`;
    document.getElementById("totalInscriptionNeeded").textContent = `$${(tournamentData.totalInscription || 0).toFixed(0)}`;
    document.getElementById("totalRefereeSpent").textContent = `$${(stats.totalReferee || 0).toFixed(0)}`;
    
    let totalRefereeCollected = 0;
    let totalRefereePending = 0;
    
    matches.forEach(match => {
      if (match.refereePayments) {
        const paidCount = Object.values(match.refereePayments).filter(paid => paid).length;
        const pendingCount = match.presentPlayers.length - paidCount;
        
        totalRefereeCollected += paidCount * match.refereePerPlayer;
        totalRefereePending += pendingCount * match.refereePerPlayer;
      }
    });
    
    document.getElementById("totalRefereeCollected").textContent = `$${totalRefereeCollected.toFixed(0)}`;
    document.getElementById("totalRefereePending").textContent = `$${totalRefereePending.toFixed(0)}`;
    
    updateDebtTable();
  }

  function updateDebtTable() {
    const debtSummarySection = document.getElementById('debtSummarySection');
    const debtTableContainer = document.getElementById('debtTableContainer');
    
    if (!debtSummarySection || !debtTableContainer) return;
    
    const playerDebtsMap = new Map();
    
    players.forEach(player => {
      const normalizedName = player.name.trim().toLowerCase();
      const key = normalizedName + "_" + player.number;
      
      if (!playerDebtsMap.has(key)) {
        playerDebtsMap.set(key, {
          name: player.name,
          number: player.number,
          numbers: new Set([player.number]),
          totalPaid: 0,
          inscriptionDebt: 0,
          refereeDebt: 0,
          totalDebt: 0,
          playerIds: []
        });
      }
      
      const debt = playerDebtsMap.get(key);
      debt.numbers.add(player.number);
      debt.totalPaid += (player.totalPaid || 0);
      debt.playerIds.push(player.id);
    });
    
    const inscriptionPerPlayer = tournamentData.inscriptionPerPlayer || 0;
    const matches = tournamentData.matches || [];
    
    playerDebtsMap.forEach((debt, key) => {
      const expectedInscription = inscriptionPerPlayer * debt.playerIds.length;
      debt.inscriptionDebt = Math.max(0, expectedInscription - debt.totalPaid);
    });
    
    matches.forEach(match => {
      if (match.presentPlayers && match.refereePayments) {
        match.presentPlayers.forEach(playerId => {
          const player = players.find(p => p.id === playerId);
          if (!player) return;
          
          const normalizedName = player.name.trim().toLowerCase();
          const key = normalizedName + "_" + player.number;
          const debt = playerDebtsMap.get(key);
          
          if (debt && !match.refereePayments[playerId]) {
            debt.refereeDebt += match.refereePerPlayer || 0;
          }
        });
      }
    });
    
    playerDebtsMap.forEach(debt => {
      debt.totalDebt = debt.inscriptionDebt + debt.refereeDebt;
    });
    
    const debtsArray = Array.from(playerDebtsMap.values())
      .sort((a, b) => b.totalDebt - a.totalDebt);
    
    const totalInscriptionDebt = debtsArray.reduce((sum, d) => sum + d.inscriptionDebt, 0);
    const totalRefereeDebt = debtsArray.reduce((sum, d) => sum + d.refereeDebt, 0);
    const totalDebt = debtsArray.reduce((sum, d) => sum + d.totalDebt, 0);
    const playersWithDebt = debtsArray.filter(d => d.totalDebt > 0).length;
    
    if (totalDebt > 0) {
      debtSummarySection.innerHTML = `
        <div class="debt-summary-card">
          <h3>üí° Resumen de Deudas</h3>
          <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); margin-top: var(--space-4);">
            <div class="stat-card">
              <div class="stat-card-value">${playersWithDebt}</div>
              <div class="stat-card-label">Jugadores con Deuda</div>
            </div>
            <div class="stat-card">
              <div class="stat-card-value" style="color: var(--color-danger);">$${totalInscriptionDebt.toFixed(0)}</div>
              <div class="stat-card-label">Deuda Inscripci√≥n</div>
            </div>
            <div class="stat-card">
              <div class="stat-card-value" style="color: var(--color-danger);">$${totalRefereeDebt.toFixed(0)}</div>
              <div class="stat-card-label">Deuda √Årbitros</div>
            </div>
            <div class="stat-card">
              <div class="stat-card-value" style="color: var(--color-danger); font-size: var(--font-size-xl);">$${totalDebt.toFixed(0)}</div>
              <div class="stat-card-label">Deuda Total</div>
            </div>
          </div>
        </div>
      `;
      
      const debtRows = debtsArray
        .filter(debt => debt.totalDebt > 0)
        .map(debt => {
          const numbersDisplay = Array.from(debt.numbers).sort((a, b) => a - b).join(', ');
          
          return `
            <tr>
              <td class="player-name-cell"><strong>${debt.name}</strong></td>
              <td class="numeric">#${numbersDisplay}</td>
              <td class="numeric debt-paid">$${debt.totalPaid.toFixed(0)}</td>
              <td class="numeric debt-amount">$${debt.inscriptionDebt.toFixed(0)}</td>
              <td class="numeric debt-amount">$${debt.refereeDebt.toFixed(0)}</td>
              <td class="numeric debt-amount debt-highlight">$${debt.totalDebt.toFixed(0)}</td>
            </tr>
          `;
        }).join('');
      
      debtTableContainer.innerHTML = `
        <div class="table-container">
          <table class="debt-table">
            <thead>
              <tr>
                <th>üë§ Jugador</th>
                <th class="numeric">üî¢ N√∫mero(s)</th>
                <th class="numeric">‚úÖ Pagado</th>
                <th class="numeric">üíµ Deuda Inscripci√≥n</th>
                <th class="numeric">‚öΩ Deuda √Årbitros</th>
                <th class="numeric">üí∞ Total a Pagar</th>
              </tr>
            </thead>
            <tbody>
              ${debtRows}
            </tbody>
          </table>
        </div>
      `;
    } else {
      debtSummarySection.innerHTML = `
        <div class="stat-card" style="border-left: 4px solid var(--color-success);">
          <div class="stat-card-icon" style="color: var(--color-success);">üéâ</div>
          <div class="stat-card-value" style="color: var(--color-success);">¬°Excelente!</div>
          <div class="stat-card-label">No hay deudas pendientes</div>
        </div>
      `;
      debtTableContainer.innerHTML = '';
    }
  }

  function updatePlayerStatsTable() {
    const tbody = document.getElementById("playerStatsTable");
    const totalMatches = (tournamentData.matches || []).length + (tournamentData.manualMatches || 0);
    
    if (filteredPlayerStats.length === 0) {
      tbody.innerHTML = '<tr><td colspan="11" style="text-align: center; color: var(--color-gray-600); padding: var(--space-5);">No hay estad√≠sticas de jugadores</td></tr>';
      return;
    }
    
    tbody.innerHTML = filteredPlayerStats.map(player => {
      const avgGoals = player.matchesPlayed > 0 ? (player.goals / player.matchesPlayed).toFixed(2) : '0.00';
      const totalCards = player.yellowCards + player.blueCards + player.redCards;
      const avgCards = player.matchesPlayed > 0 ? (totalCards / player.matchesPlayed).toFixed(2) : '0.00';
      const attendancePercent = totalMatches > 0 ? ((player.matchesPlayed / totalMatches) * 100).toFixed(1) : '0.0';
      
      return `
        <tr>
          <td><strong>${player.name}</strong></td>
          <td class="numeric">${player.number}</td>
          <td class="numeric">${player.matchesPlayed}</td>
          <td>
            <span class="badge ${attendancePercent >= 80 ? 'badge-success' : attendancePercent >= 50 ? 'badge-warning' : 'badge-danger'}">
              ${attendancePercent}%
            </span>
          </td>
          <td class="numeric" style="color: var(--color-success); font-weight: 600;"><strong>${player.goals}</strong></td>
          <td class="numeric">${avgGoals}</td>
          <td class="numeric">${player.yellowCards}</td>
          <td class="numeric">${player.blueCards}</td>
          <td class="numeric">${player.redCards}</td>
          <td class="numeric" style="font-weight: 600;">${totalCards}</td>
          <td class="numeric">${avgCards}</td>
        </tr>
      `;
    }).join('');
  }

  window.filterPlayerStats = function() {
    const searchTerm = document.getElementById("playerStatsFilter").value.toLowerCase();
    
    const playerStatsMap = new Map();
    
    players.forEach(player => {
      playerStatsMap.set(player.id, {
        id: player.id,
        name: player.name,
        number: player.number,
        matchesPlayed: 0,
        goals: 0,
        yellowCards: 0,
        blueCards: 0,
        redCards: 0
      });
    });
    
    const matches = tournamentData.matches || [];
    
    matches.forEach(match => {
      if (match.presentPlayers) {
        match.presentPlayers.forEach(playerId => {
          if (playerStatsMap.has(playerId)) {
            const playerStat = playerStatsMap.get(playerId);
            playerStat.matchesPlayed++;
            
            if (match.playerStats && match.playerStats[playerId]) {
              const stats = match.playerStats[playerId];
              playerStat.goals += stats.goals || 0;
              playerStat.yellowCards += stats.yellowCards || 0;
              playerStat.blueCards += stats.blueCards || 0;
              playerStat.redCards += stats.redCards || 0;
            }
          }
        });
      }
    });
    
    filteredPlayerStats = Array.from(playerStatsMap.values()).filter(player => {
      const nameMatch = player.name.toLowerCase().includes(searchTerm);
      const numberMatch = player.number.toString().includes(searchTerm);
      return nameMatch || numberMatch;
    });
    
    sortPlayerStats();
  };

  window.sortPlayerStats = function() {
    const sortBy = document.getElementById("playerStatsSortBy").value;
    const totalMatches = (tournamentData.matches || []).length + (tournamentData.manualMatches || 0);
    
    filteredPlayerStats.sort((a, b) => {
      switch(sortBy) {
        case 'matches':
          return b.matchesPlayed - a.matchesPlayed;
        case 'goals':
          return b.goals - a.goals;
        case 'avgGoals':
          const avgA = a.matchesPlayed > 0 ? a.goals / a.matchesPlayed : 0;
          const avgB = b.matchesPlayed > 0 ? b.goals / b.matchesPlayed : 0;
          return avgB - avgA;
        case 'yellowCards':
          return b.yellowCards - a.yellowCards;
        case 'blueCards':
          return b.blueCards - a.blueCards;
        case 'redCards':
          return b.redCards - a.redCards;
        case 'attendance':
          const attA = totalMatches > 0 ? a.matchesPlayed / totalMatches : 0;
          const attB = totalMatches > 0 ? b.matchesPlayed / totalMatches : 0;
          return attB - attA;
        default:
          return 0;
      }
    });
    
    updatePlayerStatsTable();
  };

  window.clearPlayerStatsFilters = function() {
    document.getElementById("playerStatsFilter").value = "";
    document.getElementById("playerStatsSortBy").value = "matches";
    filterPlayerStats();
  };

  function updateInscriptionInfo() {
    const perPlayer = tournamentData.inscriptionPerPlayer || 0;
    const total = tournamentData.totalInscription || 0;
    
    document.getElementById("inscriptionInfo").innerHTML = `
      <strong>Valor de Inscripci√≥n:</strong> $${perPlayer.toFixed(0)} COP por jugador<br>
      <strong>Inscripci√≥n Total del Torneo:</strong> $${total.toFixed(0)} COP
    `;
  }

  document.getElementById("refereeValue")?.addEventListener("input", updateRefereeSummary);

  window.addEventListener("load", async () => {
    try {
      await selectTournament("torneo1");
    } catch (error) {
      console.error("Error al cargar datos:", error);
      toast.show("Error al cargar datos: " + error.message, "error", 5000);
    }
  });
</script>
</body>
</html>